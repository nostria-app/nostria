<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Nostria</title>
  <base href="/" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, interactive-widget=resizes-content" />
  <!-- Android display cutout support -->
  <meta name="mobile-web-app-capable" content="yes" />
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <meta name="description" content="Nostria puts control back where it belongs: with you. Build your social network the way you want, keep your profile and data under your control, and share and explore a decentralized space that resists censorship while being quick to join and friendly to use.
" />
  <meta property="og:site_name" content="Nostria" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Nostria - Your Social Network" />
  <meta property="og:description" content="Nostria puts control back where it belongs: with you. Build your social network the way you want, keep your profile and data under your control, and share and explore a decentralized space that resists censorship while being quick to join and friendly to use.
" />
  <meta property="og:image" content="/assets/nostria-social.jpg" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Nostria - Your Social Network" />
  <meta name="twitter:description" content="Nostria puts control back where it belongs: with you. Build your social network the way you want, keep your profile and data under your control, and share and explore a decentralized space that resists censorship while being quick to join and friendly to use.
" />
  <meta name="twitter:image" content="/assets/nostria-social.jpg" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Protest+Strike&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet" />

  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#FEF7FA" />
</head>

<body class="mat-typography">
  <script>
    // Apply saved theme immediately to prevent flash
    (function () {
      var theme = localStorage.getItem('nostria-theme');
      var isDark = theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches);
      document.body.style.backgroundColor = isDark ? '#18111b' : '#FEF7FA';
      document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');

      // Detect Android and set platform attribute for CSS targeting
      var isAndroid = /android/i.test(navigator.userAgent);
      var isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
        window.navigator.standalone === true;
      if (isAndroid) {
        document.documentElement.setAttribute('data-platform', 'android');
      }
      if (isStandalone) {
        document.documentElement.setAttribute('data-display-mode', 'standalone');
      }

      // Early error handler for module loading failures during bootstrap
      // This catches MIME type errors before Angular's error handlers are initialized
      var hasTriedRecovery = sessionStorage.getItem('nostria-recovery-attempted');

      function handleModuleLoadError(message) {
        if (hasTriedRecovery) {
          // Already tried recovery once this session, show error to user
          console.error('[BOOTSTRAP] Module load failed after recovery attempt:', message);
          var loadingEl = document.getElementById('app-loading');
          if (loadingEl) {
            loadingEl.innerHTML = '<div style="text-align:center;padding:20px;">' +
              '<h2>Failed to Load</h2>' +
              '<p style="opacity:0.8;margin:16px 0;">Please try clearing your browser cache and refreshing.</p>' +
              '<button onclick="clearCachesAndReload()" style="padding:12px 24px;font-size:16px;cursor:pointer;border:none;border-radius:8px;background:#5953a9;color:white;">Clear Cache & Reload</button>' +
              '</div>';
          }
          return;
        }

        console.warn('[BOOTSTRAP] Module load error detected, attempting recovery:', message);
        sessionStorage.setItem('nostria-recovery-attempted', 'true');

        // Clear caches and reload
        if ('caches' in window) {
          caches.keys().then(function (names) {
            return Promise.all(names.map(function (name) { return caches.delete(name); }));
          }).then(function () {
            if ('serviceWorker' in navigator) {
              return navigator.serviceWorker.getRegistrations().then(function (regs) {
                return Promise.all(regs.map(function (r) { return r.unregister(); }));
              });
            }
          }).then(function () {
            window.location.reload();
          }).catch(function () {
            window.location.reload();
          });
        } else {
          window.location.reload();
        }
      }

      // Make clearCachesAndReload available globally for the button
      window.clearCachesAndReload = function () {
        sessionStorage.removeItem('nostria-recovery-attempted');
        if ('caches' in window) {
          caches.keys().then(function (names) {
            return Promise.all(names.map(function (name) { return caches.delete(name); }));
          }).then(function () {
            if ('serviceWorker' in navigator) {
              return navigator.serviceWorker.getRegistrations().then(function (regs) {
                return Promise.all(regs.map(function (r) { return r.unregister(); }));
              });
            }
          }).finally(function () {
            window.location.reload();
          });
        } else {
          window.location.reload();
        }
      };

      window.addEventListener('error', function (event) {
        if (event.message && (
          event.message.indexOf('MIME type') !== -1 ||
          event.message.indexOf('Failed to fetch dynamically imported module') !== -1 ||
          event.message.indexOf('Loading chunk') !== -1
        )) {
          event.preventDefault();
          handleModuleLoadError(event.message);
        }
      });

      window.addEventListener('unhandledrejection', function (event) {
        var reason = event.reason ? event.reason.toString() : '';
        if (
          reason.indexOf('MIME type') !== -1 ||
          reason.indexOf('Failed to fetch dynamically imported module') !== -1 ||
          reason.indexOf('Loading chunk') !== -1
        ) {
          event.preventDefault();
          handleModuleLoadError(reason);
        }
      });

      // Clear recovery flag on successful load (after a delay to ensure app is bootstrapped)
      setTimeout(function () {
        if (document.querySelector('app-root')?.children.length > 1) {
          sessionStorage.removeItem('nostria-recovery-attempted');
        }
      }, 10000);
    })();
  </script>
  <app-root>
    <!-- Initial loading indicator shown before Angular bootstraps -->
    <div id="app-loading" style="
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      width: 100%;
      font-family: Roboto, sans-serif;
    ">
      <style>
        /* Background is set on body via JS before this loads - inherit it */
        html,
        body {
          margin: 0;
          padding: 0;
        }

        #app-loading {
          color: #201923;
        }

        body[data-theme="dark"] #app-loading {
          color: #ecdeed;
        }

        @keyframes app-spinner {
          0% {
            transform: rotate(0deg);
          }

          100% {
            transform: rotate(360deg);
          }
        }

        .app-loading-spinner {
          width: 48px;
          height: 48px;
          border: 4px solid rgba(89, 83, 169, 0.2);
          border-top-color: #5953a9;
          border-radius: 50%;
          animation: app-spinner 1s linear infinite;
        }

        body[data-theme="dark"] .app-loading-spinner {
          border-color: rgba(197, 192, 255, 0.2);
          border-top-color: #c5c0ff;
        }

        .app-loading-text {
          margin-top: 16px;
          font-size: 16px;
          opacity: 0.8;
        }
      </style>
      <div class="app-loading-spinner"></div>
      <div class="app-loading-text">Loading Nostria...</div>
    </div>
  </app-root>
  <noscript>Please enable JavaScript to continue using this application.</noscript>
</body>

</html>