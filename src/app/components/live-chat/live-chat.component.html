<div class="live-chat-container" [attr.data-view]="viewMode()">
  <!-- Chat Header -->
  <div class="chat-header">
    <div class="chat-title">
      <mat-icon>{{ viewMode() === 'chat' ? 'chat' : (viewMode() === 'participants' ? 'people' : 'settings')
        }}</mat-icon>
      <h3 [matTooltip]="viewMode() === 'chat' ? activeRelays().join('\n') : ''" matTooltipClass="multiline-tooltip">{{
        viewMode() === 'chat' ? 'Live Chat' : (viewMode() === 'participants' ? 'Participants' : 'Settings') }}</h3>
      @if (viewMode() === 'chat') {
      <span class="message-count">({{ messages().length }})</span>
      }
    </div>

    <mat-button-toggle-group [hideSingleSelectionIndicator]="true" [value]="viewMode()"
      (change)="toggleView($event.value)" class="chat-toggle">
      <mat-button-toggle value="chat" matTooltip="Chat">
        <mat-icon>chat</mat-icon>
      </mat-button-toggle>
      <mat-button-toggle value="participants" matTooltip="Participants">
        <mat-icon>people</mat-icon>
      </mat-button-toggle>
      <mat-button-toggle value="settings" matTooltip="Settings">
        <mat-icon>settings</mat-icon>
      </mat-button-toggle>
    </mat-button-toggle-group>
  </div>

  <!-- Chat Messages -->
  @if (viewMode() === 'chat') {
  <div class="chat-content-wrapper">
    <div class="chat-messages" #messagesContainer (scroll)="onScroll()">
      @if (isLoadingOlderMessages()) {
      <div class="loading-older-messages">
        <mat-icon class="spinner">autorenew</mat-icon>
        <span>Loading older messages...</span>
      </div>
      }

      @if (messages().length === 0) {
      <div class="no-messages">
        <mat-icon>chat_bubble_outline</mat-icon>
        <p>No messages yet</p>
        <span>Be the first to send a message!</span>
      </div>
      }

      @for (message of messages(); track message.event.id) {
      @if (message.type === 'zap') {
      @if (showZaps()) {
      <div class="chat-message zap-message">
        <div class="zap-header">
          <mat-icon class="zap-icon">bolt</mat-icon>
          <app-user-profile [pubkey]="message.zapSender!" view="compact" [hostWidthAuto]="true"
            class="zap-sender-avatar" />
          <span class="zap-info">zapped <span class="zap-amount">{{ message.zapAmount | number }}</span> sats</span>
        </div>
        @if (message.content) {
        <div class="zap-content">{{ message.content }}</div>
        }
      </div>
      }
      } @else {
      <div class="chat-message" [class.has-reply]="message.replyTo">
        <div class="message-content">
          @if (message.replyTo) {
          @let replyMsg = getReplyMessage(message.replyTo);
          @if (replyMsg) {
          <div class="reply-reference">
            <mat-icon>reply</mat-icon>
            <app-profile-display-name [pubkey]="replyMsg.pubkey" class="reply-author" />
            <span class="reply-preview">{{ replyMsg.content | slice:0:50 }}{{ replyMsg.content.length > 50 ? '...' : ''
              }}</span>
          </div>
          }
          }
          <div class="message-header">
            <app-user-profile [pubkey]="message.pubkey" view="compact" [hostWidthAuto]="true" class="chat-avatar" />
            <span class="message-time">{{ message.formattedTime }}</span>
            <button mat-icon-button class="reply-button" (click)="replyTo(message)" matTooltip="Reply">
              <mat-icon>reply</mat-icon>
            </button>
            <button mat-icon-button class="reaction-button" [matMenuTriggerFor]="reactionMenu"
              matTooltip="Add reaction">
              <mat-icon>add_reaction</mat-icon>
            </button>
            <mat-menu #reactionMenu="matMenu" class="reaction-picker-menu">
              <div class="reaction-picker" (click)="$event.stopPropagation()">
                @for (emoji of quickReactions; track emoji) {
                <button mat-icon-button class="emoji-button" (click)="addReaction(message, emoji)">
                  {{ emoji }}
                </button>
                }
              </div>
            </mat-menu>
          </div>

          <div class="message-text">{{ message.content }}</div>

          @if (getReactionsArray(message).length > 0) {
          <div class="message-reactions">
            @for (reaction of getReactionsArray(message); track reaction.content) {
            <button class="reaction-chip" [class.user-reacted]="reaction.userReacted"
              [matTooltip]="reaction.pubkeys.length + ' reaction' + (reaction.pubkeys.length > 1 ? 's' : '')"
              (click)="addReaction(message, reaction.content)">
              <span class="reaction-emoji">{{ reaction.content }}</span>
              <span class="reaction-count">{{ reaction.count }}</span>
            </button>
            }
          </div>
          }
        </div>
      </div>
      }
      }
    </div>

    @if (showScrollToBottom()) {
    <button mat-mini-fab class="scroll-to-bottom-btn" (click)="scrollToBottom()" matTooltip="Go to end">
      <mat-icon>arrow_downward</mat-icon>
    </button>
    }

    <!-- Chat Input -->
    <div class="chat-input-container">
      @if (replyingTo()) {
      <div class="reply-indicator">
        <mat-icon>reply</mat-icon>
        <span class="reply-label">Replying to</span>
        <app-profile-display-name [pubkey]="replyingTo()!.pubkey" class="reply-to-author" />
        <button mat-icon-button class="cancel-reply" (click)="cancelReply()" matTooltip="Cancel reply">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      }
      <mat-form-field class="chat-input-field" appearance="outline">
        <input matInput [ngModel]="messageInput()" (ngModelChange)="messageInput.set($event)"
          (keydown.enter)="sendMessage()" placeholder="Type your message" autocomplete="off" />
        <button mat-icon-button matSuffix (click)="sendMessage()" [disabled]="!messageInput().trim()"
          matTooltip="Send message">
          <mat-icon>send</mat-icon>
        </button>
      </mat-form-field>
    </div>
  </div>
  }

  <!-- Participants View -->
  @if (viewMode() === 'participants') {
  <div class="participants-view">
    @if (participants().length > 0) {
    <div class="participants-section">
      <h4 class="section-title">
        <mat-icon>star</mat-icon>
        Hosts
      </h4>
      <div class="participants-list">
        @for (participant of participants(); track participant.pubkey) {
        <div class="participant-item">
          <app-user-profile [pubkey]="participant.pubkey" view="list" />
          @if (participant.role && participant.role !== 'Participant') {
          <span class="participant-role-badge">{{ participant.role }}</span>
          }
        </div>
        }
      </div>
    </div>
    }

    <div class="participants-section">
      <h4 class="section-title">
        <mat-icon>forum</mat-icon>
        Active in Chat ({{ activeParticipants().length }})
      </h4>
      @if (totalZapsAmount() > 0) {
      <div class="zaps-summary">
        <mat-icon>bolt</mat-icon>
        <span class="zaps-total">{{ totalZapsAmount() | number }}</span>
        <span class="zaps-label">sats from {{ totalZapsCount() }} zap{{ totalZapsCount() === 1 ? '' : 's' }}</span>
      </div>
      }
      @if (activeParticipants().length === 0) {
      <div class="no-participants">
        <mat-icon>people_outline</mat-icon>
        <p>No activity yet</p>
        <span>Be the first to chat or zap!</span>
      </div>
      } @else {
      <div class="participants-list">
        @for (participant of activeParticipants(); track participant.pubkey) {
        <div class="participant-item active-participant">
          <app-user-profile [pubkey]="participant.pubkey" view="list" />
          <div class="participant-stats">
            @if (participant.chatCount > 0) {
            <span class="stat-badge chat-badge" matTooltip="Messages sent">
              <mat-icon>chat</mat-icon>
              {{ participant.chatCount }}
            </span>
            }
            @if (participant.reactionCount > 0) {
            <span class="stat-badge reaction-badge" matTooltip="Reactions">
              <mat-icon>add_reaction</mat-icon>
              {{ participant.reactionCount }}
            </span>
            }
            @if (participant.zapCount > 0) {
            <span class="stat-badge zap-badge" matTooltip="Zaps sent">
              <mat-icon>bolt</mat-icon>
              {{ participant.totalZapAmount | number }}
            </span>
            }
          </div>
        </div>
        }
      </div>
      }
    </div>
  </div>
  }

  <!-- Settings View -->
  @if (viewMode() === 'settings') {
  <div class="settings-view">
    <div class="settings-list">
      <div class="setting-item">
        <div class="setting-label">
          <mat-icon>bolt</mat-icon>
          <span>Show Zaps</span>
        </div>
        <mat-slide-toggle [checked]="showZaps()" (change)="showZaps.set($event.checked)" color="primary">
        </mat-slide-toggle>
      </div>
    </div>
  </div>
  }
</div>