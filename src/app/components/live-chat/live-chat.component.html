<div class="live-chat-container" [attr.data-view]="viewMode()">
  <!-- Chat Header -->
  <div class="chat-header">
    <div class="chat-title">
      <mat-icon>{{ viewMode() === 'chat' ? 'chat' : (viewMode() === 'participants' ? 'people' : 'settings')
        }}</mat-icon>
      <h3 [matTooltip]="viewMode() === 'chat' ? activeRelays().join('\n') : ''" matTooltipClass="multiline-tooltip">{{
        viewMode() === 'chat' ? 'Live Chat' : (viewMode() === 'participants' ? 'Participants' : 'Settings') }}</h3>
      @if (viewMode() === 'chat') {
      <span class="message-count">({{ messages().length }})</span>
      }
    </div>

    <mat-button-toggle-group [hideSingleSelectionIndicator]="true" [value]="viewMode()"
      (change)="toggleView($event.value)" class="chat-toggle">
      <mat-button-toggle value="chat" matTooltip="Chat">
        <mat-icon>chat</mat-icon>
      </mat-button-toggle>
      <mat-button-toggle value="participants" matTooltip="Participants">
        <mat-icon>people</mat-icon>
      </mat-button-toggle>
      <mat-button-toggle value="settings" matTooltip="Settings">
        <mat-icon>settings</mat-icon>
      </mat-button-toggle>
    </mat-button-toggle-group>
  </div>

  <!-- Chat Messages -->
  @if (viewMode() === 'chat') {
  <div class="chat-content-wrapper">
    <div class="chat-messages" #messagesContainer (scroll)="onScroll()">
      @if (isLoadingOlderMessages()) {
      <div class="loading-older-messages">
        <mat-icon class="spinner">autorenew</mat-icon>
        <span>Loading older messages...</span>
      </div>
      }

      @if (messages().length === 0) {
      <div class="no-messages">
        <mat-icon>chat_bubble_outline</mat-icon>
        <p>No messages yet</p>
        <span>Be the first to send a message!</span>
      </div>
      }

      @for (message of messages(); track message.event.id) {
      @if (message.type === 'zap') {
      @if (showZaps()) {
      <div class="chat-message zap-message">
        <div class="zap-header">
          <mat-icon class="zap-icon">bolt</mat-icon>
          <app-user-profile [pubkey]="message.zapSender!" view="compact" [hostWidthAuto]="true"
            class="zap-sender-avatar" />
          <span class="zap-info">zapped <span class="zap-amount">{{ message.zapAmount | number }}</span> sats</span>
        </div>
        @if (message.content) {
        <div class="zap-content">{{ message.content }}</div>
        }
      </div>
      }
      } @else {
      <div class="chat-message" [class.reply]="message.replyTo">
        <div class="message-content">
          <div class="message-header">
            <app-user-profile [pubkey]="message.pubkey" view="compact" [hostWidthAuto]="true" class="chat-avatar" />
            <span class="message-time">{{ message.formattedTime }}</span>
          </div>

          <div class="message-text">{{ message.content }}</div>
        </div>
      </div>
      }
      }
    </div>

    @if (showScrollToBottom()) {
    <button mat-mini-fab class="scroll-to-bottom-btn" (click)="scrollToBottom()" matTooltip="Go to end">
      <mat-icon>arrow_downward</mat-icon>
    </button>
    }

    <!-- Chat Input -->
    <div class="chat-input-container">
      <mat-form-field class="chat-input-field" appearance="outline">
        <input matInput [ngModel]="messageInput()" (ngModelChange)="messageInput.set($event)"
          (keydown.enter)="sendMessage()" placeholder="Type your message" autocomplete="off" />
        <button mat-icon-button matSuffix (click)="sendMessage()" [disabled]="!messageInput().trim()"
          matTooltip="Send message">
          <mat-icon>send</mat-icon>
        </button>
      </mat-form-field>
    </div>
  </div>
  }

  <!-- Participants View -->
  @if (viewMode() === 'participants') {
  <div class="participants-view">
    @if (participants().length === 0) {
    <div class="no-participants">
      <mat-icon>people_outline</mat-icon>
      <p>No participants yet</p>
    </div>
    }

    <div class="participants-list">
      @for (participant of participants(); track participant.pubkey) {
      <div class="participant-item">
        <app-user-profile [pubkey]="participant.pubkey" view="list" />
        @if (participant.role && participant.role !== 'Participant') {
        <span class="participant-role-badge">{{ participant.role }}</span>
        }
      </div>
      }
    </div>
  </div>
  }

  <!-- Settings View -->
  @if (viewMode() === 'settings') {
  <div class="settings-view">
    <div class="settings-list">
      <div class="setting-item">
        <div class="setting-label">
          <mat-icon>bolt</mat-icon>
          <span>Show Zaps</span>
        </div>
        <mat-slide-toggle [checked]="showZaps()" (change)="showZaps.set($event.checked)" color="primary">
        </mat-slide-toggle>
      </div>
    </div>
  </div>
  }
</div>