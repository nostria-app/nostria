<div class="controls-overlay">
  <!-- Top gradient (for visibility when hovering) -->
  <div class="gradient-top"></div>

  <!-- Center play button (large, only when paused and never played) -->
  @if (mergedConfig().showCenterPlayButton && paused() && !hasPlayedOnce()) {
  <button class="center-play-btn" mat-icon-button (click)="onCenterPlayButtonClick(); $event.stopPropagation()"
    aria-label="Play">
    <mat-icon>play_arrow</mat-icon>
  </button>
  }

  <!-- Bottom gradient and controls -->
  <div class="gradient-bottom"></div>

  <div class="controls-bar"
    [class.progress-only-bottom]="!mergedConfig().showControlsRow && mergedConfig().progressPosition === 'bottom'"
    (mouseenter)="onControlsBarMouseEnter()" (mouseleave)="onControlsBarMouseLeave()"
    (click)="$event.stopPropagation()">
    <!-- Progress bar (hidden for live streams) -->
    @if (!mergedConfig().isLiveStream && mergedConfig().progressPosition !== 'bottom') {
    <div class="progress-container" [class.seeking]="isSeeking()" tabindex="0" aria-label="Video progress"
      (click)="onProgressClick($event)"
      (keydown)="$event.key === 'ArrowLeft' ? seekRelative(-5) : $event.key === 'ArrowRight' ? seekRelative(5) : null"
      (mousedown)="onProgressMouseDown($event)" (mousemove)="onProgressMouseMove($event)"
      (mouseleave)="onProgressMouseLeave()" (touchstart)="onProgressTouchStart($event)">
      <div class="progress-buffered" [style.width.%]="bufferedPercent()"></div>
      <div class="progress-played" [style.width.%]="isSeeking() ? seekPreviewPercent() : progressPercent()"></div>
      <div class="progress-thumb" [style.left.%]="isSeeking() ? seekPreviewPercent() : progressPercent()"></div>

      <!-- Seek preview time bubble -->
      @if (isShowingSeekPreview() && formattedSeekPreview()) {
      <div class="seek-preview-bubble" [style.left.%]="seekPreviewPercent()">
        {{ formattedSeekPreview() }}
      </div>
      }
    </div>
    }

    <!-- Controls row -->
    @if (mergedConfig().showControlsRow) {
    <div class="controls-row">
      <!-- Left controls -->
      <div class="controls-left">
        <!-- Play/Pause -->
        @if (mergedConfig().showPlayPauseButton) {
        <button mat-icon-button (click)="onPlayPause()" [matTooltip]="paused() ? 'Play (k)' : 'Pause (k)'"
          class="control-btn">
          <mat-icon>{{ paused() ? 'play_arrow' : 'pause' }}</mat-icon>
        </button>
        }

        <!-- Volume -->
        @if (mergedConfig().showVolumeControl) {
        <div class="volume-control" (mouseenter)="showVolumeSlider()" (mouseleave)="hideVolumeSlider()">
          <button mat-icon-button [matTooltip]="muted() ? 'Unmute (m)' : 'Mute (m)'" class="control-btn"
            appVolumeGesture (volumeChange)="onVolumeGestureChange($event)" (tap)="onMuteToggle()">
            <mat-icon>{{ volumeIcon() }}</mat-icon>
          </button>
          @if (volumeSliderVisible()) {
          <div class="volume-slider-container">
            <mat-slider [min]="0" [max]="100" [step]="1" class="volume-slider">
              <input matSliderThumb [value]="volume() * 100" (valueChange)="onVolumeSliderChange($event)"
                aria-label="Volume" />
            </mat-slider>
          </div>
          }
        </div>
        }

        <!-- Time display -->
        @if (mergedConfig().showTimeDisplay && !mergedConfig().isLiveStream) {
        <span class="time-display">
          {{ formattedCurrentTime() }} / {{ formattedDuration() }}
        </span>
        }
      </div>

      <!-- Right controls -->
      <div class="controls-right">
        <!-- Settings Menu (YouTube-style with Playback Speed and Quality) -->
        @if (mergedConfig().showQuality || mergedConfig().showPlaybackRate || (isSmallScreen() &&
        (mergedConfig().showCast || mergedConfig().showPiP)) || (mergedConfig().forceCastPiPInSettingsMenu &&
        (mergedConfig().showCast || mergedConfig().showPiP))) {
        <button mat-icon-button matTooltip="Settings" class="control-btn" [matMenuTriggerFor]="settingsMenu">
          <mat-icon>settings</mat-icon>
        </button>
        <mat-menu #settingsMenu="matMenu" class="video-controls-menu">
          <!-- Playback Speed submenu -->
          @if (mergedConfig().showPlaybackRate && !mergedConfig().isLiveStream) {
          <button mat-menu-item [matMenuTriggerFor]="speedMenu">
            <mat-icon>speed</mat-icon>
            <span>Playback speed</span>
            <span class="menu-value">{{ playbackRate() === 1 ? 'Normal' : playbackRate() + 'x' }}</span>
          </button>
          }
          <!-- Quality submenu -->
          @if (mergedConfig().showQuality && qualityLevels().length > 0) {
          <button mat-menu-item [matMenuTriggerFor]="qualityMenu">
            <mat-icon>tune</mat-icon>
            <span>Quality</span>
            <span class="menu-value">{{ currentQualityLabel() }}</span>
          </button>
          }
          <!-- Cast to TV (in menu on small screens) -->
          @if ((isSmallScreen() || mergedConfig().forceCastPiPInSettingsMenu) && mergedConfig().showCast) {
          <button mat-menu-item (click)="onCastToggle()">
            <mat-icon>cast</mat-icon>
            <span>Play on TV</span>
          </button>
          }
          <!-- Picture in Picture (in menu on small screens) -->
          @if ((isSmallScreen() || mergedConfig().forceCastPiPInSettingsMenu) && mergedConfig().showPiP) {
          <button mat-menu-item (click)="onPipToggle()">
            <mat-icon>picture_in_picture_alt</mat-icon>
            <span>Picture-in-picture</span>
          </button>
          }
        </mat-menu>

        <!-- Playback Speed submenu -->
        <mat-menu #speedMenu="matMenu" class="video-controls-menu">
          @for (rate of playbackRates; track rate) {
          <button mat-menu-item (click)="onPlaybackRateChange(rate)" [class.active]="playbackRate() === rate">
            {{ rate === 1 ? 'Normal' : rate + 'x' }}
          </button>
          }
        </mat-menu>

        <!-- Quality submenu -->
        <mat-menu #qualityMenu="matMenu" class="video-controls-menu">
          <button mat-menu-item (click)="onQualityChange(-1)" [class.active]="currentQuality() === -1">
            Auto
          </button>
          @for (level of qualityLevels(); track level.index) {
          <button mat-menu-item (click)="onQualityChange(level.index)"
            [class.active]="currentQuality() === level.index">
            {{ level.label }}
          </button>
          }
        </mat-menu>
        }

        <!-- Cast to TV (visible only on larger screens) -->
        @if (!isSmallScreen() && !mergedConfig().forceCastPiPInSettingsMenu && mergedConfig().showCast) {
        <button mat-icon-button (click)="onCastToggle()" matTooltip="Play on TV" class="control-btn">
          <mat-icon>cast</mat-icon>
        </button>
        }

        <!-- Picture in Picture (visible only on larger screens) -->
        @if (!isSmallScreen() && !mergedConfig().forceCastPiPInSettingsMenu && mergedConfig().showPiP) {
        <button mat-icon-button (click)="onPipToggle()" matTooltip="Picture-in-picture" class="control-btn">
          <mat-icon>picture_in_picture_alt</mat-icon>
        </button>
        }

        <!-- Fullscreen -->
        @if (mergedConfig().showFullscreen) {
        <button mat-icon-button (click)="onFullscreenToggle()" matTooltip="Fullscreen (f)" class="control-btn">
          <mat-icon>fullscreen</mat-icon>
        </button>
        }
      </div>
    </div>
    }

    @if (!mergedConfig().isLiveStream && mergedConfig().progressPosition === 'bottom') {
    <div class="progress-container" [class.seeking]="isSeeking()" tabindex="0" aria-label="Video progress"
      (click)="onProgressClick($event)"
      (keydown)="$event.key === 'ArrowLeft' ? seekRelative(-5) : $event.key === 'ArrowRight' ? seekRelative(5) : null"
      (mousedown)="onProgressMouseDown($event)" (mousemove)="onProgressMouseMove($event)"
      (mouseleave)="onProgressMouseLeave()" (touchstart)="onProgressTouchStart($event)">
      <div class="progress-buffered" [style.width.%]="bufferedPercent()"></div>
      <div class="progress-played" [style.width.%]="isSeeking() ? seekPreviewPercent() : progressPercent()"></div>
      <div class="progress-thumb" [style.left.%]="isSeeking() ? seekPreviewPercent() : progressPercent()"></div>

      @if (isShowingSeekPreview() && formattedSeekPreview()) {
      <div class="seek-preview-bubble" [style.left.%]="seekPreviewPercent()">
        {{ formattedSeekPreview() }}
      </div>
      }
    </div>
    }
  </div>
</div>