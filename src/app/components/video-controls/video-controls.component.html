<!-- Settings Panel Overlay (YouTube-style, outside controls-overlay for true glass effect) -->
@if (settingsPanel() !== 'closed') {
<div class="settings-panel-backdrop" (click)="closeSettingsPanel()"></div>
<div class="settings-panel" (click)="$event.stopPropagation()">
  @if (settingsPanel() === 'main') {
  <!-- Main settings menu -->
  <div class="settings-panel-content">
    @if (mergedConfig().showPlaybackRate && !mergedConfig().isLiveStream) {
    <button class="settings-item" (click)="openSpeedPanel()">
      <mat-icon>speed</mat-icon>
      <span class="settings-item-label">Playback speed</span>
      <span class="settings-item-value">{{ playbackRate() === 1 ? 'Normal' : speedDisplayText() }}</span>
      <mat-icon class="settings-item-arrow">chevron_right</mat-icon>
    </button>
    }
    @if (mergedConfig().showQuality && qualityLevels().length > 0) {
    <button class="settings-item" [matMenuTriggerFor]="qualityMenu">
      <mat-icon>tune</mat-icon>
      <span class="settings-item-label">Quality</span>
      <span class="settings-item-value">{{ currentQualityLabel() }}</span>
      <mat-icon class="settings-item-arrow">chevron_right</mat-icon>
    </button>
    <mat-menu #qualityMenu="matMenu" class="video-controls-menu">
      <button mat-menu-item (click)="onQualityChange(-1)" [class.active]="currentQuality() === -1">
        Auto
      </button>
      @for (level of qualityLevels(); track level.index) {
      <button mat-menu-item (click)="onQualityChange(level.index)"
        [class.active]="currentQuality() === level.index">
        {{ level.label }}
      </button>
      }
    </mat-menu>
    }
    @if ((isSmallScreen() || mergedConfig().forceCastPiPInSettingsMenu) && mergedConfig().showCast) {
    <button class="settings-item" (click)="onCastToggle(); closeSettingsPanel()">
      <mat-icon>cast</mat-icon>
      <span class="settings-item-label">Play on TV</span>
    </button>
    }
    @if ((isSmallScreen() || mergedConfig().forceCastPiPInSettingsMenu) && mergedConfig().showPiP) {
    <button class="settings-item" (click)="onPipToggle(); closeSettingsPanel()">
      <mat-icon>picture_in_picture_alt</mat-icon>
      <span class="settings-item-label">Picture-in-picture</span>
    </button>
    }
  </div>
  } @else if (settingsPanel() === 'speed') {
  <!-- YouTube-style speed panel -->
  <div class="speed-panel">
    <div class="speed-panel-header">
      <button class="speed-panel-back" (click)="backToSettingsMain()">
        <mat-icon>chevron_left</mat-icon>
      </button>
      <span class="speed-panel-title">Playback speed</span>
    </div>

    <div class="speed-panel-body">
      <!-- Current speed display -->
      <div class="speed-display">{{ speedDisplayText() }}</div>

      <!-- Slider row: minus button, range slider, plus button -->
      <div class="speed-slider-row">
        <button class="speed-adjust-btn" (click)="decrementSpeed()" [class.disabled]="playbackRate() <= speedMin">
          <mat-icon>remove</mat-icon>
        </button>
        <div class="speed-slider-track-wrapper">
          <input type="range"
            class="speed-slider"
            [min]="speedMin"
            [max]="speedMax"
            [step]="speedStep"
            [value]="playbackRate()"
            (input)="onSpeedSliderInput($event)"
            aria-label="Playback speed" />
          <div class="speed-slider-track-fill" [style.width.%]="speedSliderPercent()"></div>
        </div>
        <button class="speed-adjust-btn" (click)="incrementSpeed()" [class.disabled]="playbackRate() >= speedMax">
          <mat-icon>add</mat-icon>
        </button>
      </div>

      <!-- Preset buttons -->
      <div class="speed-presets">
        @for (preset of speedPresets; track preset) {
        <button class="speed-preset-btn"
          [class.active]="isActivePreset(preset)"
          (click)="setSpeedPreset(preset)">
          {{ speedPresetLabel(preset) }}
        </button>
        }
      </div>

      <!-- "Normal" label under the first preset -->
      <div class="speed-presets-labels">
        <span class="speed-preset-sublabel">Normal</span>
      </div>
    </div>
  </div>
  }
</div>
}

<div class="controls-overlay">
  <!-- Top gradient (for visibility when hovering) -->
  <div class="gradient-top"></div>

  <!-- Center play button (large, only when paused and never played) -->
  @if (mergedConfig().showCenterPlayButton && paused() && !hasPlayedOnce()) {
  <button class="center-play-btn" mat-icon-button (click)="onCenterPlayButtonClick(); $event.stopPropagation()"
    aria-label="Play">
    <mat-icon>play_arrow</mat-icon>
  </button>
  }

  <!-- Bottom gradient and controls -->
  <div class="gradient-bottom"></div>

  <div class="controls-bar"
    [class.progress-only-bottom]="!mergedConfig().showControlsRow && mergedConfig().progressPosition === 'bottom'"
    (mouseenter)="onControlsBarMouseEnter()" (mouseleave)="onControlsBarMouseLeave()"
    (click)="$event.stopPropagation()">
    <!-- Progress bar (hidden for live streams) -->
    @if (!mergedConfig().isLiveStream && mergedConfig().progressPosition !== 'bottom') {
    <div class="progress-container" [class.seeking]="isSeeking()" tabindex="0" aria-label="Video progress"
      (click)="onProgressClick($event)"
      (keydown)="$event.key === 'ArrowLeft' ? seekRelative(-5) : $event.key === 'ArrowRight' ? seekRelative(5) : null"
      (mousedown)="onProgressMouseDown($event)" (mousemove)="onProgressMouseMove($event)"
      (mouseleave)="onProgressMouseLeave()" (touchstart)="onProgressTouchStart($event)">
      <div class="progress-buffered" [style.width.%]="bufferedPercent()"></div>
      <div class="progress-played" [style.width.%]="isSeeking() ? seekPreviewPercent() : progressPercent()"></div>
      <div class="progress-thumb" [style.left.%]="isSeeking() ? seekPreviewPercent() : progressPercent()"></div>

      <!-- Seek preview time bubble -->
      @if (isShowingSeekPreview() && formattedSeekPreview()) {
      <div class="seek-preview-bubble" [style.left.%]="seekPreviewPercent()">
        {{ formattedSeekPreview() }}
      </div>
      }
    </div>
    }

    <!-- Controls row -->
    @if (mergedConfig().showControlsRow) {
    <div class="controls-row">
      <!-- Left controls -->
      <div class="controls-left">
        <!-- Play/Pause -->
        @if (mergedConfig().showPlayPauseButton) {
        <button mat-icon-button (click)="onPlayPause()" [matTooltip]="paused() ? 'Play (k)' : 'Pause (k)'"
          class="control-btn">
          <mat-icon>{{ paused() ? 'play_arrow' : 'pause' }}</mat-icon>
        </button>
        }

        <!-- Volume -->
        @if (mergedConfig().showVolumeControl) {
        <div class="volume-control" (mouseenter)="showVolumeSlider()" (mouseleave)="hideVolumeSlider()">
          <button mat-icon-button [matTooltip]="muted() ? 'Unmute (m)' : 'Mute (m)'" class="control-btn"
            appVolumeGesture (volumeChange)="onVolumeGestureChange($event)" (tap)="onMuteToggle()">
            <mat-icon>{{ volumeIcon() }}</mat-icon>
          </button>
          @if (volumeSliderVisible()) {
          <div class="volume-slider-container">
            <mat-slider [min]="0" [max]="100" [step]="1" class="volume-slider">
              <input matSliderThumb [value]="volume() * 100" (valueChange)="onVolumeSliderChange($event)"
                aria-label="Volume" />
            </mat-slider>
          </div>
          }
        </div>
        }

        <!-- Time display -->
        @if (mergedConfig().showTimeDisplay && !mergedConfig().isLiveStream) {
        <span class="time-display">
          {{ formattedCurrentTime() }} / {{ formattedDuration() }}
        </span>
        }
      </div>

      <!-- Right controls -->
      <div class="controls-right">
        <!-- Settings button (opens custom panel instead of mat-menu) -->
        @if (mergedConfig().showQuality || mergedConfig().showPlaybackRate || (isSmallScreen() &&
        (mergedConfig().showCast || mergedConfig().showPiP)) || (mergedConfig().forceCastPiPInSettingsMenu &&
        (mergedConfig().showCast || mergedConfig().showPiP))) {
        <button mat-icon-button matTooltip="Settings" class="control-btn" (click)="openSettingsPanel()">
          <mat-icon>settings</mat-icon>
        </button>
        }

        <!-- Cast to TV (visible only on larger screens) -->
        @if (!isSmallScreen() && !mergedConfig().forceCastPiPInSettingsMenu && mergedConfig().showCast) {
        <button mat-icon-button (click)="onCastToggle()" matTooltip="Play on TV" class="control-btn">
          <mat-icon>cast</mat-icon>
        </button>
        }

        <!-- Picture in Picture (visible only on larger screens) -->
        @if (!isSmallScreen() && !mergedConfig().forceCastPiPInSettingsMenu && mergedConfig().showPiP) {
        <button mat-icon-button (click)="onPipToggle()" matTooltip="Picture-in-picture" class="control-btn">
          <mat-icon>picture_in_picture_alt</mat-icon>
        </button>
        }

        <!-- Fullscreen -->
        @if (mergedConfig().showFullscreen) {
        <button mat-icon-button (click)="onFullscreenToggle()" matTooltip="Fullscreen (f)" class="control-btn">
          <mat-icon>fullscreen</mat-icon>
        </button>
        }
      </div>
    </div>
    }

    @if (!mergedConfig().isLiveStream && mergedConfig().progressPosition === 'bottom') {
    <div class="progress-container" [class.seeking]="isSeeking()" tabindex="0" aria-label="Video progress"
      (click)="onProgressClick($event)"
      (keydown)="$event.key === 'ArrowLeft' ? seekRelative(-5) : $event.key === 'ArrowRight' ? seekRelative(5) : null"
      (mousedown)="onProgressMouseDown($event)" (mousemove)="onProgressMouseMove($event)"
      (mouseleave)="onProgressMouseLeave()" (touchstart)="onProgressTouchStart($event)">
      <div class="progress-buffered" [style.width.%]="bufferedPercent()"></div>
      <div class="progress-played" [style.width.%]="isSeeking() ? seekPreviewPercent() : progressPercent()"></div>
      <div class="progress-thumb" [style.left.%]="isSeeking() ? seekPreviewPercent() : progressPercent()"></div>

      @if (isShowingSeekPreview() && formattedSeekPreview()) {
      <div class="seek-preview-bubble" [style.left.%]="seekPreviewPercent()">
        {{ formattedSeekPreview() }}
      </div>
      }
    </div>
    }
  </div>
</div>