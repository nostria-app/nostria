<div class="inline-video-container" (mouseenter)="onMouseEnter()" (mouseleave)="onMouseLeave()"
  (mousemove)="onMouseMove()" (touchstart)="onTouchStart()" (click)="$event.stopPropagation()">
  <video #videoElement class="video-element" [src]="effectiveSrc()" [poster]="poster()" [muted]="shouldBeMuted()"
    [loop]="loop()" playsinline preload="metadata" (loadedmetadata)="onVideoElementReady()" [class.blurred]="blurred()"
    (click)="onVideoClick($event)" (dblclick)="onVideoDoubleClick($event)"></video>

  <!-- Center play button - only visible before first play -->
  @if (paused() && !hasPlayedOnce() && !hasError()) {
  <button class="center-play-btn" (click)="onPlayButtonClick()" aria-label="Play">
    <mat-icon>play_arrow</mat-icon>
  </button>
  }

  <!-- Error overlay - shown when video fails to load -->
  @if (hasError()) {
  <div class="error-overlay">
    <mat-icon>error_outline</mat-icon>
    <span>Video failed to load</span>
    <a [href]="src()" target="_blank" rel="noopener noreferrer" class="open-link">
      Open in new tab
    </a>
  </div>
  }

  <!-- Controls overlay - visible on hover while playing, or when paused after first play -->
  <div class="controls-overlay" [class.visible]="(controlsVisible() && !paused()) || (paused() && hasPlayedOnce())">
    <!-- Gradient background -->
    <div class="gradient-bottom"></div>

    <!-- Bottom controls bar -->
    <div class="controls-bar">
      <!-- Progress bar -->
      <div class="progress-container" [class.dragging]="isDraggingProgress()" (click)="onProgressClick($event)"
        (touchstart)="onProgressTouchStart($event)" (keydown)="onProgressKeyDown($event)"
        role="slider" aria-label="Video progress" [attr.aria-valuenow]="progressPercent()" aria-valuemin="0"
        aria-valuemax="100" tabindex="0">
        <div class="progress-buffered" [style.width.%]="bufferedPercent()"></div>
        <div class="progress-played" [style.width.%]="progressPercent()"></div>
        <div class="progress-thumb" [style.left.%]="progressPercent()"></div>
      </div>

      <!-- Controls row -->
      <div class="controls-row">
        <!-- Left controls -->
        <div class="controls-left">
          <button mat-icon-button (click)="togglePlay()" [matTooltip]="paused() ? 'Play' : 'Pause'" class="control-btn">
            <mat-icon>{{ paused() ? 'play_arrow' : 'pause' }}</mat-icon>
          </button>

          <!-- Volume -->
          <div class="volume-control" (mouseenter)="showVolumeSlider()" (mouseleave)="hideVolumeSlider()">
            <button mat-icon-button (click)="toggleMute()" [matTooltip]="isMuted() ? 'Unmute (hold to adjust)' : 'Mute (hold to adjust)'"
              class="control-btn" appVolumeGesture (volumeChange)="onVolumeGestureChange($event)">
              <mat-icon>{{ volumeIcon() }}</mat-icon>
            </button>
            @if (volumeSliderVisible()) {
            <div class="volume-slider-container">
              <mat-slider [min]="0" [max]="100" [step]="1" class="volume-slider">
                <input matSliderThumb [value]="volume() * 100" (valueChange)="onVolumeSliderChange($event)"
                  aria-label="Volume" />
              </mat-slider>
            </div>
            }
          </div>

          <!-- Time display -->
          <span class="time-display">
            {{ formattedCurrentTime() }} / {{ formattedDuration() }}
          </span>
        </div>

        <!-- Right controls -->
        <div class="controls-right">
          <!-- Settings menu -->
          <button mat-icon-button matTooltip="Settings" class="control-btn" [matMenuTriggerFor]="settingsMenu">
            <mat-icon>settings</mat-icon>
          </button>
          <mat-menu #settingsMenu="matMenu" class="inline-video-menu">
            <button mat-menu-item [matMenuTriggerFor]="speedMenu">
              <mat-icon>speed</mat-icon>
              <span>Speed</span>
              <span class="menu-value">{{ playbackRate() === 1 ? 'Normal' : playbackRate() + 'x' }}</span>
            </button>
            <!-- Picture in Picture - shown in menu on small screens -->
            <button mat-menu-item (click)="pictureInPicture()" class="pip-menu-item">
              <mat-icon>picture_in_picture_alt</mat-icon>
              <span>Picture-in-picture</span>
            </button>
          </mat-menu>
          <mat-menu #speedMenu="matMenu" class="inline-video-menu">
            @for (rate of playbackRates; track rate) {
            <button mat-menu-item (click)="setPlaybackRate(rate)" [class.active]="playbackRate() === rate">
              {{ rate === 1 ? 'Normal' : rate + 'x' }}
            </button>
            }
          </mat-menu>

          <!-- Picture in Picture - hidden on small screens (shown in settings menu) -->
          <button mat-icon-button (click)="pictureInPicture()" matTooltip="Picture-in-picture" class="control-btn pip-button">
            <mat-icon>picture_in_picture_alt</mat-icon>
          </button>

          <!-- Fullscreen -->
          <button mat-icon-button (click)="toggleFullscreen()" matTooltip="Fullscreen" class="control-btn">
            <mat-icon>{{ isFullscreen() ? 'fullscreen_exit' : 'fullscreen' }}</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
