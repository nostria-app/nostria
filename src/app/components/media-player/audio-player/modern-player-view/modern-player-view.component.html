<div class="modern-player" [class.ios-safe-effects]="isIosSafeEffects()" appSwipeGesture [threshold]="60"
  [trackProgress]="true" [horizontalSwipe]="true" [verticalSwipe]="true" (swipe)="onSwipe($event)"
  (swipeProgress)="onSwipeProgress($event)" (swipeEnd)="onSwipeEnd()">
  <!-- Blurred background glow -->
  @if (displayedArtwork()) {
  <div class="background-glow" [@fadeBackground]="backgroundState()">
    <img [src]="displayedArtwork()" alt="" class="glow-image" />
  </div>
  }

  <!-- Pull down indicator -->
  <button class="pull-indicator" (click)="openQueue.emit()" aria-label="Open queue">
    <div class="pull-bar"></div>
    <span class="pull-hint">Pull down for queue</span>
  </button>

  <!-- Main content -->
  <div class="player-content">
    <!-- Album art with glow ring -->
    <div class="album-container" [@fadeContent]="contentState()">
      <div class="album-glow-ring"></div>
      @if (displayedArtwork()) {
      <img class="album-art" [src]="displayedArtwork()" alt="{{ displayedTitle() }}" />
      } @else {
      <div class="album-placeholder">
        <mat-icon>music_note</mat-icon>
      </div>
      }
    </div>

    <!-- Track info -->
    <div class="track-info" [@fadeContent]="contentState()">
      <h2 class="track-title">{{ displayedTitle() }}</h2>
      <p class="track-artist">{{ displayedArtist() }}</p>
    </div>

    <!-- Timeline -->
    <div class="timeline-container">
      <div class="custom-slider">
        <input type="range" [min]="0" [max]="duration() || 0" [value]="currentTime()" (input)="onTimeChange($event)"
          class="slider-input" [style.background-size]="progress() * 100 + '% 100%'" aria-label="Seek slider" />
      </div>
      <div class="time-labels">
        <span class="time-current">{{ formatTime(currentTime()) }}</span>
        <span class="time-total">{{ formatTime(duration()) }}</span>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <button mat-icon-button class="control-btn shuffle-btn" [class.active]="media.shuffle()"
        (click)="media.toggleShuffle()" matTooltip="Shuffle">
        <mat-icon>shuffle</mat-icon>
      </button>

      <button mat-icon-button class="control-btn" [disabled]="!media.canPrevious()" (click)="media.previous()"
        matTooltip="Previous">
        <mat-icon>skip_previous</mat-icon>
      </button>

      @if (media.paused) {
      <button mat-fab class="play-btn" (click)="media.resume()" matTooltip="Play" tabindex="-1">
        <mat-icon>play_arrow</mat-icon>
      </button>
      } @else {
      <button mat-fab class="play-btn" (click)="media.pause()" matTooltip="Pause" tabindex="-1">
        <mat-icon>pause</mat-icon>
      </button>
      }

      <button mat-icon-button class="control-btn" [disabled]="!media.canNext()" (click)="media.next()"
        matTooltip="Next">
        <mat-icon>skip_next</mat-icon>
      </button>

      <button mat-icon-button class="control-btn repeat-btn" [class.active]="media.repeat() !== 'off'"
        (click)="media.toggleRepeat()" [matTooltip]="getRepeatTooltip()">
        <mat-icon>{{ media.repeat() === 'one' ? 'repeat_one' : 'repeat' }}</mat-icon>
      </button>
    </div>

    <!-- Volume and Lyrics toggle -->
    <div class="bottom-controls">
      <div class="volume-container">
        <mat-icon class="volume-icon">
          {{ volume > 50 ? 'volume_up' : volume > 0 ? 'volume_down' : 'volume_off' }}
        </mat-icon>
        <mat-slider class="volume-slider" [min]="0" [max]="100" [step]="1">
          <input matSliderThumb [value]="volume" (valueChange)="onVolumeChange($event)" aria-label="Volume" />
        </mat-slider>
      </div>

      @if (canShowLyrics()) {
      <button mat-icon-button class="lyrics-btn" [class.active]="showLyrics()" (click)="toggleLyrics()"
        matTooltip="Lyrics">
        <mat-icon>lyrics</mat-icon>
      </button>
      }
    </div>
  </div>

  <!-- Lyrics overlay -->
  @if (showLyrics()) {
  <div class="lyrics-overlay">
    <app-lyrics-view (closeLyrics)="showLyrics.set(false)" />
  </div>
  }

  <!-- Swipe hints -->
  <div class="swipe-hints">
    @if (media.canPrevious()) {
    <span class="hint-left">← Previous</span>
    }
    @if (media.canNext()) {
    <span class="hint-right">Next →</span>
    }
  </div>
</div>