<div class="live-stream-container" [class.fullscreen]="!footer()" [class.footer-mode]="footer()"
  [class.chat-visible]="chatVisible() && !footer()" [class.cursor-hidden]="cursorHidden()">
  <!-- Single video element - always present, positioned via CSS -->
  @if (!isLiveKit() && !isExternal()) {
  <div class="video-wrapper" [class.in-footer]="footer()" [class.in-fullscreen]="!footer()"
    [class.chat-open]="chatVisible()" (mouseenter)="onVideoContainerMouseEnter()"
    (mouseleave)="onVideoContainerMouseLeave()" (mousemove)="onVideoContainerMouseMove()">
    <video #videoElement class="stream-video" [muted]="media.muted" autoplay playsinline
      (error)="onVideoError($event)"></video>
    @if (!footer()) {
    <!-- Stream controls overlay - positioned at top of video -->
    <div class="stream-controls-overlay" [class.visible]="!cursorHidden()">
      <div class="stream-actions">
        <button mat-icon-button matTooltip="Toggle chat" (click)="toggleChatVisibility()">
          <mat-icon>{{ chatVisible() ? 'chat' : 'chat_bubble_outline' }}</mat-icon>
        </button>
        <button mat-icon-button [matMenuTriggerFor]="streamMenu" matTooltip="More options">
          <mat-icon>more_vert</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Minimize" (click)="toggleFullscreen()">
          <mat-icon>minimize</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Close stream" (click)="exitStream()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>
    <app-video-controls [videoElement]="videoElement" [config]="{ isLiveStream: true, showQuality: true }"
      [qualityLevels]="qualityLevels()" [currentQuality]="currentQualityLevel()"
      [nativeFullscreen]="isNativeFullscreen()" (playPause)="onPlayPause()" (volumeChange)="onVideoVolumeChange($event)"
      (muteToggle)="onMuteToggle()" (qualityChange)="onQualityChange($event)"
      (fullscreenToggle)="onNativeFullscreenToggle()" (pipToggle)="pictureInPicture()" (castToggle)="castToDevice()" />
    }
  </div>
  } @else if (isLiveKit()) {
  <div class="livekit-placeholder" [class.in-footer]="footer()" [class.in-fullscreen]="!footer()">
    @if (!footer()) {
    <!-- Stream controls overlay -->
    <div class="stream-controls-overlay visible">
      <div class="stream-actions">
        <button mat-icon-button matTooltip="Toggle chat" (click)="toggleChatVisibility()">
          <mat-icon>{{ chatVisible() ? 'chat' : 'chat_bubble_outline' }}</mat-icon>
        </button>
        <button mat-icon-button [matMenuTriggerFor]="streamMenu" matTooltip="More options">
          <mat-icon>more_vert</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Minimize" (click)="toggleFullscreen()">
          <mat-icon>minimize</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Close stream" (click)="exitStream()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>
    }
    <div class="livekit-content">
      <mat-icon class="livekit-icon">groups</mat-icon>
      @if (!footer()) {
      <h3>Interactive Room</h3>
      <p>This is an interactive LiveKit room. Join to participate!</p>
      @if (joinUrl()) {
      <button mat-flat-button color="primary" (click)="openJoinUrl()">
        <mat-icon>login</mat-icon>
        Join Room
      </button>
      }
      }
    </div>
  </div>
  } @else if (isExternal()) {
  <div class="livekit-placeholder" [class.in-footer]="footer()" [class.in-fullscreen]="!footer()">
    @if (!footer()) {
    <!-- Stream controls overlay -->
    <div class="stream-controls-overlay visible">
      <div class="stream-actions">
        <button mat-icon-button matTooltip="Toggle chat" (click)="toggleChatVisibility()">
          <mat-icon>{{ chatVisible() ? 'chat' : 'chat_bubble_outline' }}</mat-icon>
        </button>
        <button mat-icon-button [matMenuTriggerFor]="streamMenu" matTooltip="More options">
          <mat-icon>more_vert</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Minimize" (click)="toggleFullscreen()">
          <mat-icon>minimize</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Close stream" (click)="exitStream()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>
    }
    <div class="livekit-content">
      <mat-icon class="livekit-icon">open_in_new</mat-icon>
      @if (!footer()) {
      <h3>External Stream</h3>
      <p>This stream is hosted on an external platform.</p>
      <button mat-flat-button color="primary" (click)="openExternalUrl()">
        <mat-icon>open_in_new</mat-icon>
        Open Stream
      </button>
      }
    </div>
  </div>
  }

  @if (footer()) {
  <!-- Footer mode - compact controls with video preview -->
  <div class="stream-footer-content">

    <div class="playback-controls">
      <div class="stream-info-footer">
        <span class="live-badge-small">
          <mat-icon>fiber_manual_record</mat-icon>
          LIVE
        </span>
        <span class="stream-title-footer">{{ streamTitle() }}</span>
      </div>

      <div class="control-buttons">
        @if (media.paused) {
        <button mat-icon-button matTooltip="Play" (click)="media.resume()">
          <mat-icon>play_arrow</mat-icon>
        </button>
        } @else {
        <button mat-icon-button matTooltip="Pause" (click)="media.pause()">
          <mat-icon>pause</mat-icon>
        </button>
        }

        @if (media.muted) {
        <button mat-icon-button matTooltip="Unmute (hold to adjust)" (click)="media.mute()" appVolumeGesture
          (volumeChange)="onVolumeChange($event)">
          <mat-icon>volume_off</mat-icon>
        </button>
        } @else {
        <button mat-icon-button matTooltip="Mute (hold to adjust)" (click)="media.mute()" appVolumeGesture
          (volumeChange)="onVolumeChange($event)">
          <mat-icon>volume_up</mat-icon>
        </button>
        }
      </div>

      <div class="control-actions">
        <button mat-icon-button [matMenuTriggerFor]="footerStreamMenu" matTooltip="More options">
          <mat-icon>more_vert</mat-icon>
        </button>
        <button class="hide-small" mat-icon-button matTooltip="Expand" (click)="toggleFullscreen()">
          <mat-icon>open_in_full</mat-icon>
        </button>
        <button class="hide-small" mat-icon-button matTooltip="Close stream" (click)="exitStream()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>
  </div>
  }

  @if (!footer()) {
  <!-- Stream info bar at bottom of video (hidden in native fullscreen) -->
  @if (liveEvent() && !isNativeFullscreen()) {
  <app-stream-info-bar [liveEvent]="liveEvent()!" />
  }

  <!-- Chat sidebar -->
  @if (liveEvent() && chatVisible()) {
  <div class="chat-sidebar">
    <app-live-chat [liveEvent]="liveEvent()!" />
  </div>
  }
  }

</div>

<!-- Context menu for fullscreen mode -->
<mat-menu #streamMenu="matMenu">
  @if (!isLiveKit() && !isExternal()) {
  <button mat-menu-item (click)="pictureInPicture()">
    <mat-icon>picture_in_picture</mat-icon>
    <span>Picture-in-Picture</span>
  </button>
  }
  <button mat-menu-item (click)="copyEventUrl()">
    <mat-icon>link</mat-icon>
    <span>Copy Stream URL</span>
  </button>
  <button mat-menu-item (click)="copyEventData()">
    <mat-icon>code</mat-icon>
    <span>Copy Event Data</span>
  </button>
</mat-menu>

<!-- Context menu for footer mode -->
<mat-menu #footerStreamMenu="matMenu">
  <button mat-menu-item (click)="copyEventUrl()">
    <mat-icon>link</mat-icon>
    <span>Copy Stream URL</span>
  </button>
  <button mat-menu-item (click)="copyEventData()">
    <mat-icon>code</mat-icon>
    <span>Copy Event Data</span>
  </button>
  @if (!isLiveKit() && !isExternal()) {
  <button mat-menu-item (click)="pictureInPicture()">
    <mat-icon>picture_in_picture</mat-icon>
    <span>Picture-in-Picture</span>
  </button>
  }
  <button mat-menu-item (click)="toggleFullscreen()">
    <mat-icon>open_in_full</mat-icon>
    <span>Fullscreen</span>
  </button>
  <button mat-menu-item (click)="exitStream()">
    <mat-icon>close</mat-icon>
    <span>Close Stream</span>
  </button>
</mat-menu>