@for (item of displayItems(); track item.id) {
@if (item.type === 'image-group' && item.images) {
<!-- Image Group Carousel -->
@if (item.images.length === 1) {
<!-- Single image - render normally -->
@let token = item.images[0];
@let imagePlaceholder = getImagePlaceholderUrl(token);
<div class="media-container image-container" [class.blurred]="shouldBlurImages() && !isImageRevealed(token.content)"
  [class.revealing]="shouldBlurImages() && isImageRevealed(token.content)"
  [class.image-loaded]="isImageLoaded(token.content)">
  @if (imagePlaceholder) {
  <img [src]="imagePlaceholder" alt="Blurred preview" class="blurhash-placeholder" aria-hidden="true"
    [style.aspect-ratio]="getImageAspectRatio(token)" />
  }
  <img [src]="token.content" alt="Content image" loading="lazy" (click)="openImageDialog(token.content)"
    [class.clickable-image]="!shouldBlurImages() || isImageRevealed(token.content)"
    [class.hidden]="shouldBlurImages() && !isImageRevealed(token.content)" [class.loaded]="isImageLoaded(token.content)"
    class="main-image" (load)="onImageLoaded(token.content)" />
  @if (shouldBlurImages() && !isImageRevealed(token.content)) {
  <div class="reveal-overlay">
    <div class="reveal-actions">
      <button class="reveal-btn" (click)="revealImage(token.content); $event.stopPropagation()">
        <mat-icon>visibility</mat-icon>
        <span>Reveal once</span>
      </button>
      <button class="reveal-btn trust-btn" (click)="trustAuthor(); $event.stopPropagation()">
        <mat-icon>verified_user</mat-icon>
        <span>Always reveal this user</span>
      </button>
    </div>
  </div>
  }
</div>
} @else {
<!-- Multiple images - render as carousel -->
@let currentIndex = getCarouselIndex(item.id);
@let currentImage = item.images[currentIndex];
@let carouselPlaceholder = getImagePlaceholderUrl(currentImage);
<div class="image-carousel-container" (touchstart)="onTouchStart($event)"
  (touchend)="onTouchEnd($event, item.id, item.images)">
  <div class="image-carousel">
    <div class="carousel-image-wrapper" [class.blurred]="shouldBlurImages() && !isImageRevealed(currentImage.content)"
      [class.revealing]="shouldBlurImages() && isImageRevealed(currentImage.content)"
      [class.image-loaded]="isImageLoaded(currentImage.content)">
      @if (carouselPlaceholder) {
      <img [src]="carouselPlaceholder" alt="Blurred preview" class="blurhash-placeholder" aria-hidden="true"
        [style.aspect-ratio]="getImageAspectRatio(currentImage)" />
      }
      <img [src]="currentImage.content" alt="Image {{ currentIndex + 1 }} of {{ item.images.length }}" loading="lazy"
        (click)="openCarouselImageDialog(item.images, currentIndex)"
        [class.clickable-image]="!shouldBlurImages() || isImageRevealed(currentImage.content)"
        [class.hidden]="shouldBlurImages() && !isImageRevealed(currentImage.content)"
        [class.loaded]="isImageLoaded(currentImage.content)" class="main-image"
        (load)="onImageLoaded(currentImage.content)" />
      @if (shouldBlurImages() && !isImageRevealed(currentImage.content)) {
      <div class="reveal-overlay">
        <div class="reveal-actions">
          <button class="reveal-btn" (click)="revealAllImages(item.images); $event.stopPropagation()">
            <mat-icon>visibility</mat-icon>
            <span>Reveal once</span>
          </button>
          <button class="reveal-btn trust-btn" (click)="trustAuthor(); $event.stopPropagation()">
            <mat-icon>verified_user</mat-icon>
            <span>Always reveal this user</span>
          </button>
        </div>
      </div>
      }
    </div>

    <!-- Navigation arrows -->
    @if (canGoToPrevious(item.id)) {
    <button mat-icon-button class="carousel-nav-btn carousel-prev"
      (click)="goToPrevious(item.id, item.images); $event.stopPropagation()" aria-label="Previous image">
      <mat-icon>chevron_left</mat-icon>
    </button>
    }
    @if (canGoToNext(item.id, item.images)) {
    <button mat-icon-button class="carousel-nav-btn carousel-next"
      (click)="goToNext(item.id, item.images); $event.stopPropagation()" aria-label="Next image">
      <mat-icon>chevron_right</mat-icon>
    </button>
    }

    <!-- Indicator dots -->
    <div class="carousel-indicators">
      @for (img of item.images; track img.id; let i = $index) {
      <button class="carousel-dot" [class.active]="i === currentIndex"
        (click)="setCarouselIndex(item.id, i); $event.stopPropagation()" [attr.aria-label]="'Go to image ' + (i + 1)"
        [attr.title]="'Image ' + (i + 1)">
      </button>
      }
    </div>

    <!-- Image counter -->
    <div class="carousel-counter">{{ currentIndex + 1 }} / {{ item.images.length }}</div>
  </div>
</div>
}
} @else if (item.type === 'single' && item.token) {
@let token = item.token;
<!-- Single token rendering -->
@if (token.type === 'text') {
@if (isJsonContent(token.content)) {
<pre class="json-content">{{ formatJsonContent(token.content) }}</pre>
} @else {
<span class="text-content">{{ token.content }}</span>
}
} @else if (token.type === 'linebreak') {
<br />
} @else if (token.type === 'emoji') {
@if (token.customEmoji) {
<!-- NIP-30 custom emoji rendered as image -->
<img class="custom-emoji" [src]="token.customEmoji" [alt]="token.content" [title]="token.content" loading="lazy" />
} @else {
<span class="emoji-token" [title]="token.content">{{ token.emoji }}</span>
}
} @else if (token.type === 'cashu') {
<div class="cashu-container">
  <app-cashu-token [token]="token.content" [mint]="token.cashuData?.mint" [amount]="token.cashuData?.amount"
    [unit]="token.cashuData?.unit || 'sat'">
  </app-cashu-token>
</div>
} @else if (token.type === 'url') {
<a class="url-link" [href]="token.content" target="_blank" rel="noopener noreferrer"
  (click)="onUrlClick(token.content, $event)">{{ token.content }}</a>
} @else if (token.type === 'youtube') {
<div class="media-container youtube-container">
  <div class="responsive-media-frame">
    <iframe class="responsive-media-element" [src]="token.processedUrl" frameborder="0" loading="lazy"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen
      title="YouTube video">
    </iframe>
  </div>
</div>
} @else if (token.type === 'audio') {
<div class="media-container">
  <app-audio-player [src]="token.content" [waveform]="token.waveform || []"
    [duration]="token.duration || 0"></app-audio-player>
</div>
} @else if (token.type === 'base64-audio') {
<div class="media-container">
  <app-audio-player [src]="token.content" [waveform]="token.waveform || []"
    [duration]="token.duration || 0"></app-audio-player>
</div>
} @else if (token.type === 'video') {
@let videoPlaceholder = getVideoPlaceholderUrl(token);
@let videoAspect = getVideoAspectRatio(token);
<div class="media-container video-container" [class.portrait-video]="isPortraitVideo(token)"
  [class.has-aspect-ratio]="videoAspect" [style.aspect-ratio]="videoAspect"
  [class.blurred]="shouldBlurImages() && !isImageRevealed(token.content)"
  [class.revealing]="shouldBlurImages() && isImageRevealed(token.content)"
  [class.video-ready]="isVideoReady(token.content)" [class.needs-rotation]="needsRotationCorrection(token)">
  <!-- Placeholder with fade transition -->
  @if (videoPlaceholder) {
  <img [src]="videoPlaceholder" class="video-placeholder-bg" [class.fade-out]="isVideoReady(token.content)" alt=""
    aria-hidden="true" />
  }
  @if (isVideoFormatSupported(token.content)) {
  <app-inline-video-player [src]="token.content" [poster]="videoPlaceholder || undefined"
    [blurred]="shouldBlurImages() && !isImageRevealed(token.content)"
    (videoLoadedMetadata)="onVideoMetadataLoaded($event, token.content)" (videoCanPlay)="onVideoReady(token.content)"
    class="main-video" [class.loaded]="isVideoReady(token.content)"
    [class.hidden]="shouldBlurImages() && !isImageRevealed(token.content)" />
  }
  @if (!isVideoFormatSupported(token.content)) {
  <div class="unsupported-video" [class.hidden]="shouldBlurImages() && !isImageRevealed(token.content)">
    <div class="video-placeholder">
      <mat-icon>videocam</mat-icon>
      <p>Video format may not be supported in browser</p>
      <a [href]="token.content" target="_blank" rel="noopener noreferrer" class="download-link">
        View/Download Video
      </a>
    </div>
  </div>
  }
  @if (shouldBlurImages() && !isImageRevealed(token.content)) {
  <div class="reveal-overlay">
    <div class="reveal-actions">
      <button class="reveal-btn" (click)="revealImage(token.content); $event.stopPropagation()">
        <mat-icon>visibility</mat-icon>
        <span>Reveal once</span>
      </button>
      <button class="reveal-btn trust-btn" (click)="trustAuthor(); $event.stopPropagation()">
        <mat-icon>verified_user</mat-icon>
        <span>Always reveal this user</span>
      </button>
    </div>
  </div>
  }
</div>
} @else if (token.type === 'base64-video') {
@let videoAspect = getVideoAspectRatio(token);
<div class="media-container video-container" [class.has-aspect-ratio]="videoAspect" [style.aspect-ratio]="videoAspect"
  [class.blurred]="shouldBlurImages() && !isImageRevealed(token.content)"
  [class.revealing]="shouldBlurImages() && isImageRevealed(token.content)">
  <video controls (play)="onVideoPlay($event)" (loadedmetadata)="onVideoMetadataLoaded($event, token.content)"
    [class.hidden]="shouldBlurImages() && !isImageRevealed(token.content)">
    <source [src]="token.content" />
    Your browser does not support the video element.
  </video>
  @if (shouldBlurImages() && !isImageRevealed(token.content)) {
  <div class="reveal-overlay">
    <div class="reveal-actions">
      <button class="reveal-btn" (click)="revealImage(token.content); $event.stopPropagation()">
        <mat-icon>visibility</mat-icon>
        <span>Reveal once</span>
      </button>
      <button class="reveal-btn trust-btn" (click)="trustAuthor(); $event.stopPropagation()">
        <mat-icon>verified_user</mat-icon>
        <span>Always reveal this user</span>
      </button>
    </div>
  </div>
  }
</div>
} @else if (token.type === 'nostr-mention' && (token.nostrData?.type === 'npub' || token.nostrData?.type ===
'nprofile')) {
<a class="nostr-mention" (click)="onNostrMentionClick(token)" (mouseenter)="onMentionMouseEnter($event, token)"
  (mouseleave)="onMentionMouseLeave()">&#64;{{ token.nostrData?.displayName }}</a>
} @else if (token.type === 'nostr-mention' && !token.nostrData) {
<!-- Nostr mention without resolved data yet - show loading placeholder but make it clickable with hover -->
<a class="nostr-mention loading" (click)="onNostrMentionClick(token)" (mouseenter)="onMentionMouseEnter($event, token)"
  (mouseleave)="onMentionMouseLeave()" title="{{ token.content }}">@...</a>
} @else if (token.type === 'nostr-mention' && (token.nostrData?.type === 'nevent' || token.nostrData?.type === 'note'))
{
@if (getEventLoadingState(token.id) === 'loading') {
<div class="nostr-event-placeholder loading">
  <div class="placeholder-content">
    <mat-spinner diameter="20"></mat-spinner>
    <span class="placeholder-text">Loading referenced event...</span>
  </div>
</div>
} @else if (getEventLoadingState(token.id) === 'failed') {
<div class="nostr-event-placeholder failed">
  <div class="placeholder-content">
    <mat-icon>error_outline</mat-icon>
    <span class="placeholder-text">Unable to load referenced event</span>
  </div>
</div>
} @else if (isPhotoEvent(token.id)) {
<!-- Render kind 20 photo events using PhotoEventComponent for full carousel/blurhash support -->
<div class="embedded-photo-event">
  <app-event-header [event]="getEventData(token.id)!" [compact]="true"></app-event-header>
  <app-photo-event [event]="getEventData(token.id)!" [hideComments]="true"
    [trustedByPubkey]="trustedByPubkey()"></app-photo-event>
</div>
} @else if (getEventPreview(token.id); as preview) {
<div class="nostr-event-preview" [innerHTML]="preview"></div>
} @else {
<a class="nostr-reference">{{ token.nostrData?.displayName }}</a>
}
} @else if (token.type === 'hashtag') {
<a class="hashtag-link" [routerLink]="['/search']" [queryParams]="{q: '#' + token.content}">#{{ token.content }}</a>
}
}
}