@for (item of displayItems(); track item.id) {
@if (item.type === 'image-group' && item.images) {
<!-- Image Group Carousel -->
@if (item.images.length === 1) {
<!-- Single image - render normally -->
@let token = item.images[0];
@let imagePlaceholder = getImagePlaceholderUrl(token);
<div class="media-container image-container" [class.blurred]="shouldBlurImages() && !isImageRevealed(token.content)"
  [class.revealing]="shouldBlurImages() && isImageRevealed(token.content)"
  [class.image-loaded]="isImageLoaded(token.content)">
  @if (imagePlaceholder) {
  <img [src]="imagePlaceholder" alt="Blurred preview" class="blurhash-placeholder" aria-hidden="true"
    [style.aspect-ratio]="getImageAspectRatio(token)" />
  }
  <img [src]="token.content" alt="Content image" loading="lazy" (click)="openImageDialog(token.content)"
    [class.clickable-image]="!shouldBlurImages() || isImageRevealed(token.content)"
    [class.hidden]="shouldBlurImages() && !isImageRevealed(token.content)" [class.loaded]="isImageLoaded(token.content)"
    class="main-image" (load)="onImageLoaded(token.content)" />
  @if (shouldBlurImages() && !isImageRevealed(token.content)) {
  <div class="reveal-overlay">
    <div class="reveal-actions">
      <button class="reveal-btn" (click)="revealImage(token.content); $event.stopPropagation()">
        <mat-icon>visibility</mat-icon>
        <span>Reveal once</span>
      </button>
      <button class="reveal-btn trust-btn" (click)="trustAuthor(); $event.stopPropagation()">
        <mat-icon>verified_user</mat-icon>
        <span>Always reveal this user</span>
      </button>
    </div>
  </div>
  }
</div>
} @else {
<!-- Multiple images - render as carousel -->
@let currentIndex = getCarouselIndex(item.id);
@let currentImage = item.images[currentIndex];
@let carouselPlaceholder = getImagePlaceholderUrl(currentImage);
<div class="image-carousel-container" (touchstart)="onTouchStart($event)"
  (touchend)="onTouchEnd($event, item.id, item.images)">
  <div class="image-carousel">
    <div class="carousel-image-wrapper" [class.blurred]="shouldBlurImages() && !isImageRevealed(currentImage.content)"
      [class.revealing]="shouldBlurImages() && isImageRevealed(currentImage.content)"
      [class.image-loaded]="isImageLoaded(currentImage.content)">
      @if (carouselPlaceholder) {
      <img [src]="carouselPlaceholder" alt="Blurred preview" class="blurhash-placeholder" aria-hidden="true"
        [style.aspect-ratio]="getImageAspectRatio(currentImage)" />
      }
      <img [src]="currentImage.content" alt="Image {{ currentIndex + 1 }} of {{ item.images.length }}" loading="lazy"
        (click)="openCarouselImageDialog(item.images, currentIndex)"
        [class.clickable-image]="!shouldBlurImages() || isImageRevealed(currentImage.content)"
        [class.hidden]="shouldBlurImages() && !isImageRevealed(currentImage.content)"
        [class.loaded]="isImageLoaded(currentImage.content)" class="main-image"
        (load)="onImageLoaded(currentImage.content)" />
      @if (shouldBlurImages() && !isImageRevealed(currentImage.content)) {
      <div class="reveal-overlay">
        <div class="reveal-actions">
          <button class="reveal-btn" (click)="revealAllImages(item.images); $event.stopPropagation()">
            <mat-icon>visibility</mat-icon>
            <span>Reveal once</span>
          </button>
          <button class="reveal-btn trust-btn" (click)="trustAuthor(); $event.stopPropagation()">
            <mat-icon>verified_user</mat-icon>
            <span>Always reveal this user</span>
          </button>
        </div>
      </div>
      }
    </div>

    <!-- Navigation arrows -->
    @if (canGoToPrevious(item.id)) {
    <button mat-icon-button class="carousel-nav-btn carousel-prev"
      (click)="goToPrevious(item.id, item.images); $event.stopPropagation()" aria-label="Previous image">
      <mat-icon>chevron_left</mat-icon>
    </button>
    }
    @if (canGoToNext(item.id, item.images)) {
    <button mat-icon-button class="carousel-nav-btn carousel-next"
      (click)="goToNext(item.id, item.images); $event.stopPropagation()" aria-label="Next image">
      <mat-icon>chevron_right</mat-icon>
    </button>
    }

    <!-- Indicator dots -->
    <div class="carousel-indicators">
      @for (img of item.images; track img.id; let i = $index) {
      <button class="carousel-dot" [class.active]="i === currentIndex"
        (click)="setCarouselIndex(item.id, i); $event.stopPropagation()" [attr.aria-label]="'Go to image ' + (i + 1)"
        [attr.title]="'Image ' + (i + 1)">
      </button>
      }
    </div>

    <!-- Image counter -->
    <div class="carousel-counter">{{ currentIndex + 1 }} / {{ item.images.length }}</div>
  </div>
</div>
}
} @else if (item.type === 'single' && item.token) {
@let token = item.token;
<!-- Single token rendering -->
@if (token.type === 'text') {
@if (isJsonContent(token.content)) {
<pre class="json-content">{{ formatJsonContent(token.content) }}</pre>
} @else {
<span class="text-content">{{ token.content }}</span>
}
} @else if (token.type === 'linebreak') {
<br />
} @else if (token.type === 'emoji') {
@if (token.customEmoji) {
<!-- NIP-30 custom emoji rendered as image -->
<img class="custom-emoji" [src]="token.customEmoji" [alt]="token.content" [title]="token.content" loading="lazy" />
} @else {
<span class="emoji-token" [title]="token.content">{{ token.emoji }}</span>
}
} @else if (token.type === 'cashu') {
<div class="cashu-container">
  <app-cashu-token [token]="token.content" [mint]="token.cashuData?.mint" [amount]="token.cashuData?.amount"
    [unit]="token.cashuData?.unit || 'sat'">
  </app-cashu-token>
</div>
} @else if (token.type === 'bolt11') {
<div class="bolt11-container">
  <app-bolt11-invoice [invoice]="token.content">
  </app-bolt11-invoice>
</div>
} @else if (token.type === 'bolt12') {
<div class="bolt12-container">
  <app-bolt12-offer [offer]="token.content" [type]="token.bolt12Data?.type || 'offer'">
  </app-bolt12-offer>
</div>
} @else if (token.type === 'audio') {
<div class="media-container">
  <app-audio-player [src]="token.content" [waveform]="token.waveform || []"
    [duration]="token.duration || 0"></app-audio-player>
</div>
} @else if (token.type === 'base64-audio') {
<div class="media-container">
  <app-audio-player [src]="token.content" [waveform]="token.waveform || []"
    [duration]="token.duration || 0"></app-audio-player>
</div>
} @else if (token.type === 'video') {
@let videoPlaceholder = getVideoPlaceholderUrl(token);
@let videoAspect = getVideoAspectRatio(token);
<div class="media-container video-container" [class.portrait-video]="isPortraitVideo(token)"
  [class.has-aspect-ratio]="videoAspect" [class.blurred]="shouldBlurImages() && !isImageRevealed(token.content)"
  [class.revealing]="shouldBlurImages() && isImageRevealed(token.content)"
  [class.needs-rotation]="needsRotationCorrection(token)">
  @if (isVideoFormatSupported(token.content)) {
  <app-inline-video-player [src]="token.content" [poster]="videoPlaceholder || undefined"
    [blurred]="shouldBlurImages() && !isImageRevealed(token.content)" [autoplay]="shouldAutoPlayVideo(token)"
    [loop]="shouldLoopVideo(token)" [inFeedsPanel]="inFeedsPanel()"
    (videoLoadedMetadata)="onVideoMetadataLoaded($event, token.content)" class="main-video"
    [class.hidden]="shouldBlurImages() && !isImageRevealed(token.content)" />
  }
  @if (!isVideoFormatSupported(token.content)) {
  <div class="unsupported-video" [class.hidden]="shouldBlurImages() && !isImageRevealed(token.content)">
    <div class="video-placeholder">
      <mat-icon>videocam</mat-icon>
      <p>Video format may not be supported in browser</p>
      <a [href]="token.content" target="_blank" rel="noopener noreferrer" class="download-link">
        View/Download Video
      </a>
    </div>
  </div>
  }
  @if (shouldBlurImages() && !isImageRevealed(token.content)) {
  <div class="reveal-overlay">
    <div class="reveal-actions">
      <button class="reveal-btn" (click)="revealImage(token.content); $event.stopPropagation()">
        <mat-icon>visibility</mat-icon>
        <span>Reveal once</span>
      </button>
      <button class="reveal-btn trust-btn" (click)="trustAuthor(); $event.stopPropagation()">
        <mat-icon>verified_user</mat-icon>
        <span>Always reveal this user</span>
      </button>
    </div>
  </div>
  }
</div>
} @else if (token.type === 'base64-video') {
@let videoAspect = getVideoAspectRatio(token);
<div class="media-container video-container" [class.has-aspect-ratio]="videoAspect" [style.aspect-ratio]="videoAspect"
  [class.blurred]="shouldBlurImages() && !isImageRevealed(token.content)"
  [class.revealing]="shouldBlurImages() && isImageRevealed(token.content)">
  <video controls (play)="onVideoPlay($event)" (loadedmetadata)="onVideoMetadataLoaded($event, token.content)"
    [class.hidden]="shouldBlurImages() && !isImageRevealed(token.content)">
    <source [src]="token.content" />
    Your browser does not support the video element.
  </video>
  @if (shouldBlurImages() && !isImageRevealed(token.content)) {
  <div class="reveal-overlay">
    <div class="reveal-actions">
      <button class="reveal-btn" (click)="revealImage(token.content); $event.stopPropagation()">
        <mat-icon>visibility</mat-icon>
        <span>Reveal once</span>
      </button>
      <button class="reveal-btn trust-btn" (click)="trustAuthor(); $event.stopPropagation()">
        <mat-icon>verified_user</mat-icon>
        <span>Always reveal this user</span>
      </button>
    </div>
  </div>
  }
</div>
} @else if (token.type === 'nostr-mention' && (token.nostrData?.type === 'npub' || token.nostrData?.type ===
'nprofile')) {
<a class="nostr-mention" (click)="onNostrMentionClick(token)" (mouseenter)="onMentionMouseEnter($event, token)"
  (mouseleave)="onMentionMouseLeave()">&#64;{{ token.nostrData?.displayName }}</a>
} @else if (token.type === 'nostr-mention' && !token.nostrData) {
<!-- Nostr mention without resolved data yet - show loading placeholder but make it clickable with hover -->
<a class="nostr-mention loading" (click)="onNostrMentionClick(token)" (mouseenter)="onMentionMouseEnter($event, token)"
  (mouseleave)="onMentionMouseLeave()" title="{{ token.content }}">@...</a>
} @else if (token.type === 'nostr-mention' && (token.nostrData?.type === 'nevent' || token.nostrData?.type === 'note'))
{
<!-- Inline event mention (nevent/note) -->
@let mention = getEventMention(token.id);
@if (isEventMentionBlocked(token.id)) {
<!-- Event mention is blocked by mute rules - hide it -->
<mat-card appearance="outlined" class="event-mention-card blocked-card">
  <mat-card-content>
    <div class="event-blocked-placeholder">
      <mat-icon>visibility_off</mat-icon>
      <span class="blocked-text">Content hidden (muted)</span>
    </div>
  </mat-card-content>
</mat-card>
} @else if (mention?.loading) {
<!-- Loading placeholder for event mention -->
<mat-card appearance="outlined" class="event-mention-card loading-card">
  <mat-card-header class="loading-header">
    <div class="skeleton-avatar"></div>
    <div class="skeleton-text-container">
      <div class="skeleton-text skeleton-name"></div>
      <div class="skeleton-text skeleton-date"></div>
    </div>
  </mat-card-header>
  <mat-card-content>
    <div class="skeleton-content">
      <div class="skeleton-text skeleton-line"></div>
      <div class="skeleton-text skeleton-line short"></div>
    </div>
  </mat-card-content>
</mat-card>
} @else if (mention?.event) {
@if (mention!.event!.event.kind === 8) {
<!-- Badge Award (kind 8) - show as simple link for now -->
<a class="nostr-reference badge-reference" (click)="onEventMentionClick($event, mention!.event!.event)">
  <mat-icon>military_tech</mat-icon>
  Badge Award
</a>
} @else if (mention!.event!.event.kind === 20) {
<!-- Photo Event (kind 20, NIP-68) -->
<div class="embedded-photo-event">
  <app-event-header [event]="mention!.event!.event" [compact]="true"></app-event-header>
  <app-photo-event [event]="mention!.event!.event" [hideComments]="true"
    [trustedByPubkey]="trustedByPubkey()"></app-photo-event>
</div>
} @else if (mention!.event!.event.kind === 21 || mention!.event!.event.kind === 22 || mention!.event!.event.kind === 34235 || mention!.event!.event.kind === 34236) {
<!-- Video Event (kind 21/22/34235/34236, NIP-71) - show as clickable card -->
<mat-card appearance="outlined" class="event-mention-card video-mention-card" tabindex="0" role="button"
  (click)="onEventMentionClick($event, mention!.event!.event)"
  (keydown.enter)="onEventMentionClick($event, mention!.event!.event)"
  (keydown.space)="onEventMentionClick($event, mention!.event!.event)">
  <mat-card-header>
    <app-user-profile [pubkey]="mention!.event!.event.pubkey" view="compact">
      <span class="date-link" [matTooltip]="mention!.event!.event.created_at | timestamp: 'medium'"
        matTooltipPosition="below">
        {{ mention!.event!.event.created_at | ago }}
      </span>
    </app-user-profile>
  </mat-card-header>
  <mat-card-content class="media-mention-content">
    <div class="video-placeholder">
      <mat-icon>videocam</mat-icon>
      <span>Video</span>
    </div>
  </mat-card-content>
</mat-card>
} @else {
<!-- Regular event mention (kind 1, etc.) -->
<mat-card appearance="outlined" class="event-mention-card" tabindex="0" role="button"
  (click)="onEventMentionClick($event, mention!.event!.event)"
  (keydown.enter)="onEventMentionClick($event, mention!.event!.event)"
  (keydown.space)="onEventMentionClick($event, mention!.event!.event)">
  <mat-card-header>
    <app-user-profile [pubkey]="mention!.event!.event.pubkey" view="compact">
      <span class="date-link" [matTooltip]="mention!.event!.event.created_at | timestamp: 'medium'"
        matTooltipPosition="below">
        {{ mention!.event!.event.created_at | ago }}
      </span>
    </app-user-profile>
  </mat-card-header>
  <mat-card-content [class.collapsed]="isMentionContentLong(token.id) && !mention!.expanded">
    <div class="content-container">
      <app-note-content [contentTokens]="mention!.contentTokens" [authorPubkey]="mention!.event!.event.pubkey"
        [trustedByPubkey]="trustedByPubkey() || authorPubkey()" [inFeedsPanel]="inFeedsPanel()"></app-note-content>
    </div>
  </mat-card-content>
  @if (isMentionContentLong(token.id)) {
  @if (!mention!.expanded) {
  <button mat-button class="show-more-btn" (click)="toggleMentionExpand(token.id, $event)">
    <mat-icon>expand_more</mat-icon>
    Show more
  </button>
  } @else {
  <button mat-button class="show-less-btn" (click)="toggleMentionExpand(token.id, $event)">
    <mat-icon>expand_less</mat-icon>
    Show less
  </button>
  }
  }
</mat-card>
}
} @else {
<!-- Event not found placeholder -->
<mat-card appearance="outlined" class="event-mention-card not-found-card">
  <mat-card-content>
    <div class="event-not-found-placeholder">
      <mat-icon>link_off</mat-icon>
      <span class="not-found-text">Referenced event not found</span>
    </div>
  </mat-card-content>
</mat-card>
}
} @else if (token.type === 'nostr-mention' && token.nostrData?.type === 'naddr') {
<!-- Inline naddr mention (articles, music, emoji sets) -->
@let naddrData = getNaddrData(token);
@if (naddrData) {
@if (isMusicMention(token)) {
<!-- Music embed (track or playlist) -->
<app-music-embed [identifier]="naddrData.identifier" [pubkey]="naddrData.pubkey" [kind]="naddrData.kind"
  [relayHints]="naddrData.relayHints"></app-music-embed>
} @else if (isEmojiSetMention(token)) {
<!-- Emoji set -->
<app-emoji-set-mention [identifier]="naddrData.identifier" [pubkey]="naddrData.pubkey"></app-emoji-set-mention>
} @else {
<!-- Article -->
<app-article [slug]="naddrData.identifier" [pubkey]="naddrData.pubkey" [kind]="naddrData.kind"
  [relayHints]="naddrData.relayHints" mode="compact" [showAuthor]="true" [showMetadata]="true"
  [clickable]="true"></app-article>
}
}
} @else if (token.type === 'hashtag') {
<a class="hashtag-link" [routerLink]="['/f']" [queryParams]="{t: token.content}">#{{ token.content }}</a>
}
}
}