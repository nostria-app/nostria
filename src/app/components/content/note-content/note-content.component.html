@for (token of contentTokens(); track token.id) {
@if (token.type === 'text') {
<span>{{ token.content }}</span>
} @else if (token.type === 'linebreak') {
<br />
} @else if (token.type === 'emoji') {
@if (token.customEmoji) {
<!-- NIP-30 custom emoji rendered as image -->
<img class="custom-emoji" [src]="token.customEmoji" [alt]="token.content" [title]="token.content" loading="lazy" />
} @else {
<span class="emoji-token" [title]="token.content">{{ token.emoji }}</span>
}
} @else if (token.type === 'cashu') {
<div class="cashu-container">
  <app-cashu-token [token]="token.content" [mint]="token.cashuData?.mint" [amount]="token.cashuData?.amount"
    [unit]="token.cashuData?.unit || 'sat'">
  </app-cashu-token>
</div>
} @else if (token.type === 'url') {
&nbsp;<a class="url-link" [href]="token.content" target="_blank" rel="noopener noreferrer">{{ token.content }}</a>&nbsp;
} @else if (token.type === 'youtube') {
<div class="media-container">
  <iframe width="560" height="315" [src]="token.processedUrl" frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
  </iframe>
</div>
} @else if (token.type === 'image') {
<div class="media-container image-container" [class.blurred]="shouldBlurImages() && !isImageRevealed(token.content)"
  [class.revealing]="shouldBlurImages() && isImageRevealed(token.content)">
  @if (shouldBlurImages() && getBlurhashDataUrl(token.content); as blurhashUrl) {
  <img [src]="blurhashUrl" alt="Blurred preview" class="blurhash-placeholder" loading="lazy" />
  }
  <img [src]="token.content" alt="Content image" loading="lazy" (click)="openImageDialog(token.content)"
    [class.clickable-image]="!shouldBlurImages() || isImageRevealed(token.content)"
    [class.hidden]="shouldBlurImages() && !isImageRevealed(token.content)" />
  @if (shouldBlurImages() && !isImageRevealed(token.content)) {
  <div class="reveal-overlay" (click)="revealImage(token.content); $event.stopPropagation()">
    <mat-icon>visibility</mat-icon>
    <span>Click to reveal</span>
  </div>
  }
</div>
} @else if (token.type === 'base64-image') {
<div class="media-container image-container" [class.blurred]="shouldBlurImages() && !isImageRevealed(token.content)"
  [class.revealing]="shouldBlurImages() && isImageRevealed(token.content)">
  @if (shouldBlurImages() && getBlurhashDataUrl(token.content); as blurhashUrl) {
  <img [src]="blurhashUrl" alt="Blurred preview" class="blurhash-placeholder" loading="lazy" />
  }
  <img [src]="token.content" alt="Embedded image" (click)="openImageDialog(token.content)"
    [class.clickable-image]="!shouldBlurImages() || isImageRevealed(token.content)"
    [class.hidden]="shouldBlurImages() && !isImageRevealed(token.content)" />
  @if (shouldBlurImages() && !isImageRevealed(token.content)) {
  <div class="reveal-overlay" (click)="revealImage(token.content); $event.stopPropagation()">
    <mat-icon>visibility</mat-icon>
    <span>Click to reveal</span>
  </div>
  }
</div>
} @else if (token.type === 'audio') {
<div class="media-container">
  <app-audio-player [src]="token.content" [waveform]="token.waveform || []"
    [duration]="token.duration || 0"></app-audio-player>
</div>
} @else if (token.type === 'base64-audio') {
<div class="media-container">
  <app-audio-player [src]="token.content" [waveform]="token.waveform || []"
    [duration]="token.duration || 0"></app-audio-player>
</div>
} @else if (token.type === 'video') {
<div class="media-container video-container" [class.blurred]="shouldBlurImages() && !isImageRevealed(token.content)"
  [class.revealing]="shouldBlurImages() && isImageRevealed(token.content)">
  @if (isVideoFormatSupported(token.content)) {
  <video controls (error)="onVideoError($event, token.content)"
    [class.hidden]="shouldBlurImages() && !isImageRevealed(token.content)">
    <source [src]="token.content" type="video/{{ getVideoType(token.content) }}" />
    Your browser does not support the video element.
    <p>
      <a [href]="token.content" target="_blank" rel="noopener noreferrer">
        Download video file
      </a>
    </p>
  </video>
  } @else {
  <div class="unsupported-video" [class.hidden]="shouldBlurImages() && !isImageRevealed(token.content)">
    <div class="video-placeholder">
      <mat-icon>videocam</mat-icon>
      <p>Video format may not be supported in browser</p>
      <a [href]="token.content" target="_blank" rel="noopener noreferrer" class="download-link">
        View/Download Video
      </a>
    </div>
  </div>
  }
  @if (shouldBlurImages() && !isImageRevealed(token.content)) {
  <div class="reveal-overlay" (click)="revealImage(token.content); $event.stopPropagation()">
    <mat-icon>visibility</mat-icon>
    <span>Click to reveal</span>
  </div>
  }
</div>
} @else if (token.type === 'base64-video') {
<div class="media-container video-container" [class.blurred]="shouldBlurImages() && !isImageRevealed(token.content)"
  [class.revealing]="shouldBlurImages() && isImageRevealed(token.content)">
  <video controls [class.hidden]="shouldBlurImages() && !isImageRevealed(token.content)">
    <source [src]="token.content" />
    Your browser does not support the video element.
  </video>
  @if (shouldBlurImages() && !isImageRevealed(token.content)) {
  <div class="reveal-overlay" (click)="revealImage(token.content); $event.stopPropagation()">
    <mat-icon>visibility</mat-icon>
    <span>Click to reveal</span>
  </div>
  }
</div>
} @else if (
token.type === 'nostr-mention' &&
(token.nostrData?.type === 'npub' || token.nostrData?.type === 'nprofile')
) {
&nbsp;<a class="nostr-mention" (click)="onNostrMentionClick(token)" (mouseenter)="onMentionMouseEnter($event, token)"
  (mouseleave)="onMentionMouseLeave()">&#64;{{ token.nostrData?.displayName }}</a>&nbsp;
} @else if (
token.type === 'nostr-mention' &&
(token.nostrData?.type === 'nevent' || token.nostrData?.type === 'note')
) {
@if (getEventLoadingState(token.id) === 'loading') {
<div class="nostr-event-placeholder loading">
  <div class="placeholder-content">
    <mat-spinner diameter="20"></mat-spinner>
    <span class="placeholder-text">Loading referenced event...</span>
  </div>
</div>
} @else if (getEventLoadingState(token.id) === 'failed') {
<div class="nostr-event-placeholder failed">
  <div class="placeholder-content">
    <mat-icon>error_outline</mat-icon>
    <span class="placeholder-text">Unable to load referenced event</span>
  </div>
</div>
} @else if (getEventPreview(token.id); as preview) {
<div class="nostr-event-preview" [innerHTML]="preview"></div>
} @else {
&nbsp;<a class="nostr-reference">{{ token.nostrData?.displayName }}</a>&nbsp;
}
}
}