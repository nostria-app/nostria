<div class="content-container" #contentContainer>
  @if (shouldShowContent()) {
  <app-note-content [contentTokens]="contentTokens()" [authorPubkey]="event()?.pubkey"
    [trustedByPubkey]="trustedByPubkey()"></app-note-content>

  @for (mention of eventMentions(); track mention.eventId; let mentionIndex = $index) {
  @if (mention.loading) {
  <!-- Loading placeholder for event mention -->
  <mat-card appearance="outlined" class="event-mention-card loading-card">
    <mat-card-header class="loading-header">
      <div class="skeleton-avatar"></div>
      <div class="skeleton-text-container">
        <div class="skeleton-text skeleton-name"></div>
        <div class="skeleton-text skeleton-date"></div>
      </div>
    </mat-card-header>
    <mat-card-content>
      <div class="skeleton-content">
        <div class="skeleton-text skeleton-line"></div>
        <div class="skeleton-text skeleton-line short"></div>
      </div>
    </mat-card-content>
  </mat-card>
  } @else if (mention.event) {
  @if (mention.event.event.kind === 8) {
  <!-- Badge Award (kind 8) -->
  <app-badge [badge]="mention.event.event"></app-badge>
  } @else if (mention.event.event.kind === 20) {
  <!-- Photo Event (kind 20, NIP-68) - Use PhotoEventComponent for full blurhash/carousel support -->
  <div class="embedded-photo-event">
    <app-event-header [event]="mention.event.event" [compact]="true"></app-event-header>
    <app-photo-event [event]="mention.event.event" [hideComments]="true"
      [trustedByPubkey]="trustedByPubkey()"></app-photo-event>
  </div>
  } @else if (mention.event.event.kind === 21 || mention.event.event.kind === 22 || mention.event.event.kind === 34235
  || mention.event.event.kind === 34236) {
  <!-- Video Event (kind 21/22/34235/34236, NIP-71) - Inline rendering -->
  <mat-card appearance="outlined" class="event-mention-card video-mention-card" tabindex="0" role="button"
    (click)="onEventMentionClick($event, mention.event.event)"
    (keydown.enter)="onEventMentionClick($event, mention.event.event)"
    (keydown.space)="onEventMentionClick($event, mention.event.event)">
    <mat-card-header>
      <app-user-profile [pubkey]="mention.event.event.pubkey" view="compact">
        <span class="date-link" [matTooltip]="mention.event.event.created_at | timestamp: 'medium'"
          matTooltipPosition="below">
          {{ mention.event.event.created_at | ago }}
        </span>
      </app-user-profile>
    </mat-card-header>
    <mat-card-content class="media-mention-content">
      @if (getVideoThumbnail(mention.event.event); as thumbnail) {
      <div class="video-thumbnail-container">
        <img [src]="thumbnail" [alt]="getVideoTitle(mention.event.event) || 'Video thumbnail'"
          class="mention-video-thumbnail" loading="lazy" />
        <div class="video-play-overlay">
          <mat-icon>play_circle</mat-icon>
        </div>
      </div>
      } @else {
      <div class="video-placeholder">
        <mat-icon>videocam</mat-icon>
        <span>{{ getVideoTitle(mention.event.event) || 'Video' }}</span>
      </div>
      }
    </mat-card-content>
  </mat-card>
  } @else {
  <!-- Regular event mention -->
  <mat-card appearance="outlined" class="event-mention-card" tabindex="0" role="button"
    (click)="onEventMentionClick($event, mention.event.event)"
    (keydown.enter)="onEventMentionClick($event, mention.event.event)"
    (keydown.space)="onEventMentionClick($event, mention.event.event)">
    <mat-card-header>
      <app-user-profile [pubkey]="mention.event.event.pubkey" view="compact">
        <span class="date-link" [matTooltip]="mention.event.event.created_at | timestamp: 'medium'"
          matTooltipPosition="below">
          {{ mention.event.event.created_at | ago }}
        </span>
      </app-user-profile>
    </mat-card-header>
    <mat-card-content [class.collapsed]="isMentionContentLong(mention) && !mention.expanded">
      <div class="content-container">
        <app-note-content [contentTokens]="mention.contentTokens" [authorPubkey]="mention.event.event.pubkey"
          [trustedByPubkey]="trustedByPubkey() || event()?.pubkey"></app-note-content>
      </div>
    </mat-card-content>
    @if (isMentionContentLong(mention)) {
    @if (!mention.expanded) {
    <button mat-button class="show-more-btn" (click)="toggleMentionExpand(mention.eventId, $event)">
      <mat-icon>expand_more</mat-icon>
      Show more
    </button>
    } @else {
    <button mat-button class="show-less-btn" (click)="toggleMentionExpand(mention.eventId, $event)">
      <mat-icon>expand_less</mat-icon>
      Show less
    </button>
    }
    }
  </mat-card>
  }
  } @else {
  <!-- Event not found placeholder -->
  <mat-card appearance="outlined" class="event-mention-card not-found-card">
    <mat-card-content>
      <div class="event-not-found-placeholder">
        <mat-icon>link_off</mat-icon>
        <span class="not-found-text">Referenced event not found</span>
      </div>
    </mat-card-content>
  </mat-card>
  }
  }

  @for (article of articleMentions(); track article.identifier + article.pubkey) {
  <app-article [slug]="article.identifier" [pubkey]="article.pubkey" [kind]="article.kind"
    [relayHints]="article.relayHints" mode="compact" [showAuthor]="true" [showMetadata]="true"
    [clickable]="true"></app-article>
  }

  @for (music of musicMentions(); track music.identifier + music.pubkey) {
  <app-music-embed [identifier]="music.identifier" [pubkey]="music.pubkey" [kind]="music.kind"
    [relayHints]="music.relayHints"></app-music-embed>
  }

  @for (preview of socialPreviews(); track preview.url) {
  @if (settings.settings().socialSharingPreview) {
  <app-social-preview class="social-preview" [url]="preview.url"></app-social-preview>
  }
  }

  <!-- Tagged references (mentions and articles) - hidden when in comment context -->
  @if (event() && !hideTaggedReferences()) {
  <app-tagged-references [event]="event()!"></app-tagged-references>
  }
  } @else {
  <div class="content-placeholder"></div>
  }
</div>