<div class="favorites-container">

  <!-- Favorites preview in toolbar -->
  @if (favorites().length > 0) {
  <div class="favorites-preview">
    @for (item of topFavorites(); track item.pubkey) {
    <button class="favorite-avatar" (click)="navigateToProfile(item.pubkey)" (contextmenu)="$event.preventDefault()"
      (mouseenter)="onAvatarMouseEnter($event, item.pubkey)" (mouseleave)="onAvatarMouseLeave()" type="button"
      [attr.aria-label]="'View profile of ' + getDisplayName(item.profile)">
      @if (getPreviewAvatarUrl(item.profile)) {
      <img [src]="getPreviewAvatarUrl(item.profile)" [alt]="getDisplayName(item.profile)" draggable="false" />
      } @else {
      <span class="avatar-initials">{{ getInitials(item.profile) }}</span>
      }
    </button>
    }

    <!-- Show "..." button to show all following -->
    @if (hasFollowing()) {
    <button class="favorite-avatar more-button" (click)="toggleOverlay()" type="button" aria-label="Show all following">
      <mat-icon>more_horiz</mat-icon>
    </button>
    }
  </div>
  }

  <!-- Full overlay (shown on hover on desktop, click on mobile) -->
  @if (isVisible() && followingWithProfiles().length > 0) {
  <!-- Backdrop to allow clicking outside to dismiss (hidden when docked) -->
  @if (!isDocked()) {
  <div class="overlay-backdrop" (click)="hideOverlay()" (keydown.escape)="hideOverlay()" role="button" tabindex="0"
    aria-label="Close following overlay">
  </div>
  }

  <div class="favorites-overlay" [class.docked]="isDocked()" role="dialog" tabindex="0"
    (keydown.escape)="hideOverlay()">
    <div class="overlay-header">
      <h3>Following</h3>
      <div class="overlay-actions">
        <!-- @if (!layout.isHandset()) {
        <button mat-icon-button (click)="toggleDock(); $event.stopPropagation()" type="button"
          [matTooltip]="isDocked() ? 'Unpin sidebar' : 'Pin sidebar'"
          [attr.aria-label]="isDocked() ? 'Unpin sidebar' : 'Pin sidebar'" [class.docked-icon]="isDocked()">
          <mat-icon [fontIcon]="isDocked() ? 'push_pin' : 'push_pin'"></mat-icon>
        </button>
        } -->
        <button mat-icon-button (click)="hideOverlay(); $event.stopPropagation()" type="button" [matTooltip]="'Close'"
          aria-label="Close">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>

    <!-- Favorites Section -->
    @if (favoritesInOverlay().length > 0) {
    <div class="overlay-section">
      <h4 class="section-title">
        <mat-icon>star</mat-icon>
        Favorites
      </h4>
      <div class="favorites-grid">
        @for (item of favoritesInOverlay(); track item.pubkey; let i = $index) {
        <button class="favorite-item" [class.dragging]="draggedIndex() === i"
          [class.drop-target]="dropTargetIndex() === i" [attr.data-index]="i" draggable="true"
          (dragstart)="onDragStart($event, i)" (dragend)="onDragEnd($event)" (dragover)="onDragOver($event, i)"
          (dragleave)="onDragLeave($event)" (drop)="onDrop($event, i)" (touchstart)="onTouchStart($event, i)"
          (touchmove)="onTouchMove($event)" (touchend)="onTouchEnd($event)" (touchcancel)="onTouchCancel()"
          (contextmenu)="$event.preventDefault()" (click)="navigateToProfile(item.pubkey); $event.stopPropagation()"
          (mouseenter)="onAvatarMouseEnter($event, item.pubkey)" (mouseleave)="onAvatarMouseLeave()" type="button"
          [attr.aria-label]="'View profile of ' + getDisplayName(item.profile)">
          <div class="favorite-avatar-large">
            @if (getAvatarUrl(item.profile)) {
            <img [src]="getAvatarUrl(item.profile)" [alt]="getDisplayName(item.profile)"
              [title]="getDisplayName(item.profile)" draggable="false" />
            } @else {
            <span class="avatar-initials">{{ getInitials(item.profile) }}</span>
            }
          </div>
          <span class="favorite-name">{{ getDisplayName(item.profile) }}</span>
        </button>
        }
      </div>
    </div>
    }

    <!-- Other Following Section -->
    @if (nonFavoritesInOverlay().length > 0) {
    <div class="overlay-section">
      <h4 class="section-title">
        <mat-icon>people</mat-icon>
        Following
      </h4>
      <div class="favorites-grid">
        @for (item of nonFavoritesInOverlay(); track item.pubkey) {
        <button class="favorite-item" (click)="navigateToProfile(item.pubkey); $event.stopPropagation()"
          (contextmenu)="$event.preventDefault()" (mouseenter)="onAvatarMouseEnter($event, item.pubkey)"
          (mouseleave)="onAvatarMouseLeave()" type="button"
          [attr.aria-label]="'View profile of ' + getDisplayName(item.profile)">
          <div class="favorite-avatar-large">
            @if (getAvatarUrl(item.profile)) {
            <img [src]="getAvatarUrl(item.profile)" [alt]="getDisplayName(item.profile)"
              [title]="getDisplayName(item.profile)" draggable="false" />
            } @else {
            <span class="avatar-initials">{{ getInitials(item.profile) }}</span>
            }
          </div>
          <span class="favorite-name">{{ getDisplayName(item.profile) }}</span>
        </button>
        }
      </div>

      <!-- View All button when there are more profiles -->
      @if (hasMoreFollowing()) {
      <div class="view-all-container">
        <button mat-button (click)="navigateToPeople()">
          <mat-icon>groups</mat-icon>
          View All ({{remainingFollowingCount()}} more)
        </button>
      </div>
      }
    </div>
    }
  </div>
  }
</div>