<!-- Input State -->
@if (currentState() === 'input') {
<div dialog-content class="gift-premium-content">
  <!-- Recipient Preview -->
  @if (data.recipientPubkey) {
  <div class="recipient-preview">
    <span class="recipient-label">Gift to</span>
    <div class="recipient-info">
      <app-user-profile [pubkey]="data.recipientPubkey" [view]="'list'"></app-user-profile>
    </div>
  </div>
  }

  <form [formGroup]="giftForm" class="gift-form">
    <!-- Wallet Selection (if multiple) -->
    @if (availableWallets().length > 1) {
    <div class="wallet-selection">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Select Wallet</mat-label>
        <mat-select formControlName="selectedWallet">
          @for (wallet of availableWallets(); track wallet.id) {
          <mat-option [value]="wallet.id">
            <div class="wallet-option">
              <mat-icon>account_balance_wallet</mat-icon>
              <span class="wallet-name">{{ wallet.name }}</span>
              <span class="wallet-status" [class.connected]="wallet.connected">
                {{ wallet.connected ? 'Connected' : 'Disconnected' }}
              </span>
            </div>
          </mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>
    }

    <!-- Subscription Type Selection -->
    <div class="section-group">
      <h3 class="section-title">Choose Plan</h3>
      <mat-radio-group formControlName="premiumType" class="premium-type-group">
        <button type="button" class="plan-card" [class.selected]="giftForm.get('premiumType')?.value === 'premium'"
          (click)="giftForm.get('premiumType')?.setValue('premium')">
          <mat-radio-button value="premium" class="hidden-radio"></mat-radio-button>
          <div class="plan-icon-wrapper">
            <mat-icon class="plan-icon">workspace_premium</mat-icon>
          </div>
          <div class="plan-info">
            <span class="plan-name">Premium</span>
            <span class="plan-description">Enhanced features</span>
          </div>
          <div class="plan-check">
            @if (giftForm.get('premiumType')?.value === 'premium') {
            <mat-icon>check_circle</mat-icon>
            }
          </div>
        </button>

        <button type="button" class="plan-card premium-plus"
          [class.selected]="giftForm.get('premiumType')?.value === 'premium-plus'"
          (click)="giftForm.get('premiumType')?.setValue('premium-plus')">
          <mat-radio-button value="premium-plus" class="hidden-radio"></mat-radio-button>
          <div class="plan-icon-wrapper">
            <mat-icon class="plan-icon">stars</mat-icon>
          </div>
          <div class="plan-info">
            <span class="plan-name">Premium+</span>
            <span class="plan-description">All features + exclusive benefits</span>
          </div>
          <div class="plan-check">
            @if (giftForm.get('premiumType')?.value === 'premium-plus') {
            <mat-icon>check_circle</mat-icon>
            }
          </div>
        </button>
      </mat-radio-group>
    </div>

    <!-- Duration Selection -->
    <div class="section-group">
      <h3 class="section-title">Select Duration</h3>
      <mat-radio-group formControlName="duration" class="duration-group">
        <button type="button" class="duration-card" [class.selected]="giftForm.get('duration')?.value === 1"
          (click)="giftForm.get('duration')?.setValue(1)">
          <mat-radio-button [value]="1" class="hidden-radio"></mat-radio-button>
          <span class="duration-period">1 Month</span>
          <span class="duration-price">
            @if (loadingPrice()) {
            <mat-spinner diameter="16"></mat-spinner>
            } @else if (giftForm.get('premiumType')?.value === 'premium') {
            {{ (getDollarAmount('premium', 1) / bitcoinPrice()!.usd * 100000000) | number:'1.0-0' }} sats
            } @else {
            {{ (getDollarAmount('premium-plus', 1) / bitcoinPrice()!.usd * 100000000) | number:'1.0-0' }} sats
            }
          </span>
        </button>

        <button type="button" class="duration-card" [class.selected]="giftForm.get('duration')?.value === 3"
          (click)="giftForm.get('duration')?.setValue(3)">
          <mat-radio-button [value]="3" class="hidden-radio"></mat-radio-button>
          <span class="duration-period">3 Months</span>
          <span class="duration-price">
            @if (loadingPrice()) {
            <mat-spinner diameter="16"></mat-spinner>
            } @else if (giftForm.get('premiumType')?.value === 'premium') {
            {{ (getDollarAmount('premium', 3) / bitcoinPrice()!.usd * 100000000) | number:'1.0-0' }} sats
            } @else {
            {{ (getDollarAmount('premium-plus', 3) / bitcoinPrice()!.usd * 100000000) | number:'1.0-0' }} sats
            }
          </span>
        </button>
      </mat-radio-group>
    </div>

    <!-- Total Amount -->
    <div class="total-section">
      <div class="total-row">
        <span class="total-label">Total</span>
        <div class="total-amount">
          @if (loadingPrice()) {
          <mat-spinner diameter="20"></mat-spinner>
          } @else {
          <mat-icon class="lightning-icon">bolt</mat-icon>
          <span class="amount-sats">{{ totalAmount().toLocaleString() }}</span>
          <span class="amount-unit">sats</span>
          <span class="amount-usd">({{ pricingInfo()?.usd }})</span>
          }
        </div>
      </div>
    </div>
  </form>

  @if (errorMessage()) {
  <div class="error-message">
    <mat-icon>error</mat-icon>
    <span>{{ errorMessage() }}</span>
  </div>
  }
</div>

<div dialog-actions class="dialog-actions-input">
  <button mat-button (click)="onCancel()" [disabled]="isProcessing()">Cancel</button>
  <button mat-flat-button class="continue-button" (click)="proceedToConfirmation()"
    [disabled]="isProcessing() || !giftForm.valid || loadingPrice()">
    <mat-icon>arrow_forward</mat-icon>
    Continue
  </button>
</div>
}

<!-- Confirmation State -->
@if (currentState() === 'confirmation') {
<div dialog-content class="gift-premium-content confirmation-state">
  <!-- Summary Section -->
  <div class="confirmation-summary">
    <div class="summary-header">
      <mat-icon class="summary-icon">card_giftcard</mat-icon>
      <span>Gift Summary</span>
    </div>

    <div class="summary-details">
      <div class="summary-row">
        <span class="summary-label">Recipient</span>
        <div class="summary-recipient">
          <app-user-profile [pubkey]="data.recipientPubkey" [view]="'list'"></app-user-profile>
        </div>
      </div>

      <div class="summary-divider"></div>

      <div class="summary-row">
        <span class="summary-label">Plan</span>
        <span class="summary-value highlight">{{ getPremiumTypeName(giftForm.get('premiumType')?.value) }}</span>
      </div>

      <div class="summary-row">
        <span class="summary-label">Duration</span>
        <span class="summary-value">{{ getDurationText(giftForm.get('duration')?.value) }}</span>
      </div>

      <div class="summary-divider"></div>

      <div class="summary-row total">
        <span class="summary-label">Amount</span>
        <div class="summary-amount">
          <mat-icon class="lightning-icon">bolt</mat-icon>
          <span class="amount-value">{{ totalAmount().toLocaleString() }} sats</span>
          <span class="amount-fiat">({{ pricingInfo()?.usd }})</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Method Selection -->
  <div class="payment-section">
    <h3 class="section-title">Payment Method</h3>

    <div class="payment-method-buttons">
      <button type="button" class="payment-method-btn" [class.selected]="selectedPaymentMethod() === 'nwc'"
        (click)="selectPaymentMethod('nwc')">
        <mat-icon>account_balance_wallet</mat-icon>
        <span>Wallet</span>
      </button>

      <button type="button" class="payment-method-btn" [class.selected]="selectedPaymentMethod() === 'native'"
        (click)="selectPaymentMethod('native')">
        <mat-icon>smartphone</mat-icon>
        <span>Lightning</span>
      </button>

      <button type="button" class="payment-method-btn" [class.selected]="selectedPaymentMethod() === 'manual'"
        (click)="selectPaymentMethod('manual')">
        <mat-icon>qr_code</mat-icon>
        <span>QR Code</span>
      </button>
    </div>

    <div class="payment-method-content">
      <!-- NWC Content -->
      @if (selectedPaymentMethod() === 'nwc') {
      <div class="method-content-inner">
        @if (hasNwcWallet()) {
        <div class="wallet-info">
          <mat-icon>account_balance_wallet</mat-icon>
          <span>{{ getSelectedWalletName() }}</span>
        </div>
        <p class="method-hint">Pay automatically with your connected wallet</p>
        } @else {
        <div class="no-wallet-warning">
          <mat-icon class="warning-icon">warning</mat-icon>
          <div class="warning-text">
            <p>No wallet connected</p>
            <button mat-button (click)="openCredentials()">
              <mat-icon>settings</mat-icon>
              Connect Wallet
            </button>
          </div>
        </div>
        }

        @if (isProcessing() && selectedPaymentMethod() === 'nwc') {
        <div class="processing-indicator">
          <mat-spinner diameter="24"></mat-spinner>
          <span>Processing payment...</span>
        </div>
        }
      </div>
      }

      <!-- Native (Open Lightning) Content -->
      @if (selectedPaymentMethod() === 'native') {
      <div class="method-content-inner">
        @if (invoiceUrl()) {
        <p class="method-hint">Open your Lightning wallet app to pay</p>
        <button mat-flat-button class="open-wallet-btn" (click)="openLightningWallet()">
          <mat-icon>open_in_new</mat-icon>
          Open Lightning Wallet
        </button>
        <p class="copy-hint">
          Or <button type="button" class="text-btn" (click)="copyInvoice()">copy invoice</button> to paste manually
        </p>
        } @else if (isProcessing()) {
        <div class="processing-indicator">
          <mat-spinner diameter="24"></mat-spinner>
          <span>Generating invoice...</span>
        </div>
        } @else {
        <p class="method-hint">Generate an invoice for your Lightning wallet</p>
        }
      </div>
      }

      <!-- Manual (QR Code) Content -->
      @if (selectedPaymentMethod() === 'manual') {
      <div class="method-content-inner">
        @if (invoiceUrl()) {
        <p class="method-hint">Scan with any Lightning wallet</p>
        <div class="qr-code-wrapper">
          <qr-code [qrdata]="invoiceUrl()!" [width]="180" [height]="180"></qr-code>
        </div>
        <button type="button" class="invoice-copy-btn" (click)="copyInvoice()" matTooltip="Copy invoice">
          <span class="invoice-text">{{ truncateInvoice(invoiceUrl()!) }}</span>
          <mat-icon>content_copy</mat-icon>
        </button>
        } @else if (isProcessing()) {
        <div class="processing-indicator">
          <mat-spinner diameter="24"></mat-spinner>
          <span>Generating QR code...</span>
        </div>
        } @else {
        <p class="method-hint">Generate a QR code for manual payment</p>
        }
      </div>
      }
    </div>
  </div>

  @if (errorMessage()) {
  <div class="error-message">
    <mat-icon>error</mat-icon>
    <span>{{ errorMessage() }}</span>
  </div>
  }
</div>

<div dialog-actions class="dialog-actions-confirmation">
  <button mat-button (click)="backToInput()" [disabled]="isProcessing()">
    <mat-icon>arrow_back</mat-icon>
    Back
  </button>

  <div class="action-buttons">
    @if (selectedPaymentMethod() === 'nwc') {
    <button mat-flat-button class="send-button" (click)="confirmGift()" [disabled]="isProcessing() || !hasNwcWallet()">
      @if (isProcessing()) {
      <mat-spinner diameter="18"></mat-spinner>
      <span>Sending...</span>
      } @else {
      <ng-container>
        <mat-icon>send</mat-icon>
        <span>Send Gift</span>
      </ng-container>
      }
    </button>
    } @else if (selectedPaymentMethod() === 'native' || selectedPaymentMethod() === 'manual') {
    @if (!invoiceUrl()) {
    <button mat-flat-button class="generate-button" (click)="generateInvoice()" [disabled]="isProcessing()">
      @if (isProcessing()) {
      <mat-spinner diameter="18"></mat-spinner>
      <span>Generating...</span>
      } @else {
      <ng-container>
        <mat-icon>receipt</mat-icon>
        <span>{{ selectedPaymentMethod() === 'native' ? 'Generate Invoice' : 'Generate QR' }}</span>
      </ng-container>
      }
    </button>
    } @else {
    <button mat-flat-button class="paid-button" (click)="markAsPaid()">
      <mat-icon>check</mat-icon>
      <span>I've Paid</span>
    </button>
    }
    }
  </div>
</div>
}