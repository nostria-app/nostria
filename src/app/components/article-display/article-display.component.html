<div class="article-container">
  <!-- Header Section -->
  <header class="article-header">
    @if (image()) {
    <div class="article-hero-image">
      <img [src]="image()" [alt]="title()" [title]="title()" loading="lazy" />
    </div>
    }

    <div class="article-header-content">
      <h1 class="article-title">{{ title() || 'Untitled Article' }}</h1>

      @if (summary()) {
      <p class="article-summary">{{ summary() }}</p>
      }

      <div class="article-meta">
        @if (mode() === 'full') {
        <div class="meta-row">
          <div class="publish-date">
            <mat-icon>schedule</mat-icon>
            <app-date-toggle [date]="publishedAtTimestamp()"></app-date-toggle>
          </div>
          <div class="read-time">
            <mat-icon>timer</mat-icon>
            <span>{{ readTime() }} min read</span>
          </div>
        </div>

        <!-- Engagement Metrics Row -->
        <div class="engagement-row">
          <span class="engagement-item">
            <mat-icon>thumb_up</mat-icon>
            <span class="count">{{ reactionCount() }}</span>
          </span>
          <span class="engagement-item">
            <mat-icon>chat_bubble</mat-icon>
            <span class="count">{{ commentCount() }}</span>
          </span>
          <span class="engagement-item">
            <mat-icon>bolt</mat-icon>
            <span class="count">{{ formatZapAmount(zapTotal()) }}</span>
          </span>
        </div>

        <!-- Top Zappers -->
        @if (topZappers().length > 0) {
        <div class="top-zappers">
          <span class="zappers-label">Top zappers:</span>
          <div class="zappers-list">
            @for (zapper of topZappers(); track zapper.pubkey) {
            <div class="zapper-item" [title]="formatZapAmount(zapper.amount) + ' sats'">
              <app-user-profile [pubkey]="zapper.pubkey" view="icon"></app-user-profile>
            </div>
            }
          </div>
        </div>
        }
        }

        @if (hashtags().length > 0) {
        <div class="article-hashtags">
          <mat-chip-set>
            @for (hashtag of hashtags(); track hashtag) {
            <mat-chip highlighted>
              {{ hashtag }}
            </mat-chip>
            }
          </mat-chip-set>
        </div>
        }

        <!-- Text-to-Speech Controls (Header) - only in full mode -->
        @if (mode() === 'full') {
        <div class="article-tts-controls">
          <button mat-icon-button [matMenuTriggerFor]="translateMenu" title="Translate Article"
            [disabled]="isTranslating()">
            @if (isTranslating()) {
            <mat-progress-spinner mode="indeterminate" diameter="24"></mat-progress-spinner>
            } @else {
            <mat-icon>translate</mat-icon>
            }
          </button>
          <mat-menu #translateMenu="matMenu">
            <button mat-menu-item (click)="translate.emit('eng_Latn')">English</button>
            <button mat-menu-item (click)="translate.emit('spa_Latn')">Spanish</button>
            <button mat-menu-item (click)="translate.emit('fra_Latn')">French</button>
            <button mat-menu-item (click)="translate.emit('deu_Latn')">German</button>
            <button mat-menu-item (click)="translate.emit('ita_Latn')">Italian</button>
            <button mat-menu-item (click)="translate.emit('por_Latn')">Portuguese</button>
            <button mat-menu-item (click)="translate.emit('rus_Cyrl')">Russian</button>
            <button mat-menu-item (click)="translate.emit('zho_Hans')">Chinese (Simplified)</button>
            <button mat-menu-item (click)="translate.emit('jpn_Jpan')">Japanese</button>
          </mat-menu>

          <button mat-icon-button [matMenuTriggerFor]="voiceMenu" matTooltip="Voice Settings">
            <mat-icon>settings_voice</mat-icon>
          </button>
          <mat-menu #voiceMenu="matMenu">
            <button mat-menu-item (click)="toggleAiVoice.emit(!useAiVoice())">
              <mat-icon>{{ useAiVoice() ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
              <span>Use AI Voice (SpeechT5)</span>
            </button>
          </mat-menu>

          @if (!isSpeaking()) {
          <button mat-icon-button color="primary" (click)="startSpeech.emit()" title="Read article aloud"
            [disabled]="isSynthesizing()">
            @if (isSynthesizing()) {
            <mat-progress-spinner mode="indeterminate" diameter="24"></mat-progress-spinner>
            } @else {
            <mat-icon>volume_up</mat-icon>
            }
          </button>
          } @else {
          @if (isPaused()) {
          <button mat-icon-button color="primary" (click)="resumeSpeech.emit()" title="Resume reading">
            <mat-icon>play_arrow</mat-icon>
          </button>
          } @else {
          <button mat-icon-button color="primary" (click)="pauseSpeech.emit()" title="Pause reading">
            <mat-icon>pause</mat-icon>
          </button>
          }
          <button mat-icon-button color="primary" (click)="stopSpeech.emit()" title="Stop reading">
            <mat-icon>stop</mat-icon>
          </button>
          }
        </div>
        }
      </div>
    </div>
  </header>

  <!-- Author Section (only in full mode) -->
  @if (mode() === 'full') {
  <section class="article-author">
    <app-user-profile [pubkey]="authorPubkey()" mode="list"></app-user-profile>
  </section>
  }

  <!-- Article Content -->
  <main class="article-content">
    @if (isJsonContent()) {
    <div class="json-content">
      @if (jsonData(); as data) {
      @if (getObjectKeys(data).length > 0) {
      <div class="json-object">
        @for (key of getObjectKeys(data); track key) {
        <div class="json-property">
          <span class="json-key">{{ key }}</span>
          <span class="json-separator">:</span>
          @if (isPrimitive(getObjectValue(data, key))) {
          <span class="json-value">{{ formatJsonValue(getObjectValue(data, key)) }}</span>
          } @else {
          <pre class="json-complex-value">{{ stringifyValue(getObjectValue(data, key)) }}</pre>
          }
        </div>
        }
      </div>
      } @else {
      <pre class="json-raw">{{ stringifyValue(data) }}</pre>
      }
      }
    </div>
    } @else {
    <div class="markdown-content" [innerHTML]="parsedContent()" appMentionHover></div>
    }
  </main>

  <!-- Footer Actions (only in full mode) -->
  @if (mode() === 'full') {
  <footer class="article-footer">
    <div class="article-actions">
      @if (accountState.isCurrentUser(authorPubkey())) {
      <button mat-button color="primary" (click)="layout.createArticle(link())" title="Edit Article">
        <mat-icon>edit</mat-icon>
        Edit
      </button>
      }

      @if (bookmark.isBookmarked(id(), 'a')) {
      <button mat-button color="primary" title="Remove bookmark" (click)="bookmark.toggleBookmark(id(), 'a')">
        <mat-icon title="Remove bookmark">bookmark_remove</mat-icon>
        Bookmark
      </button>
      } @else {
      <button mat-button color="primary" title="Add bookmark" (click)="bookmark.toggleBookmark(id(), 'a')">
        <mat-icon title="Add bookmark">bookmark_add</mat-icon>
        Bookmark
      </button>
      }

      <button mat-button color="primary" (click)="share.emit()">
        <mat-icon>share</mat-icon>
        Share
      </button>

      @if (event()) {
      <app-reaction-button [event]="event()!" [view]="'full'"></app-reaction-button>
      <app-repost-button [event]="event()!" [view]="'full'"></app-repost-button>
      }

      <!-- Text-to-Speech Controls -->
      @if (!isSpeaking()) {
      <button mat-button color="primary" (click)="startSpeech.emit()" title="Read article aloud">
        <mat-icon>volume_up</mat-icon>
        Read Aloud
      </button>
      } @else {
      @if (isPaused()) {
      <button mat-button color="primary" (click)="resumeSpeech.emit()" title="Resume reading">
        <mat-icon>play_arrow</mat-icon>
        Resume
      </button>
      } @else {
      <button mat-button color="primary" (click)="pauseSpeech.emit()" title="Pause reading">
        <mat-icon>pause</mat-icon>
        Pause
      </button>
      }
      <button mat-button color="primary" (click)="stopSpeech.emit()" title="Stop reading">
        <mat-icon>stop</mat-icon>
        Stop
      </button>
      }

      @if (event()) {
      <app-event-menu [event]="event()!" [view]="'full'"></app-event-menu>
      }
    </div>
  </footer>
  }

  <!-- Comments Section (only in full mode) -->
  @if (mode() === 'full' && event()) {
  <section class="article-comments">
    <app-comments-list [event]="event()!"></app-comments-list>
  </section>
  }
</div>