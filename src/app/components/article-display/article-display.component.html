<div class="article-container">
  <!-- Top Actions Bar (only in full mode) -->
  @if (mode() === 'full') {
  <div class="article-top-actions">
    <div class="top-actions-left">
      @if (accountState.isCurrentUser(authorPubkey())) {
      <button mat-icon-button (click)="layout.createArticle(link())" title="Edit Article">
        <mat-icon>edit</mat-icon>
      </button>
      }
    </div>
    <div class="top-actions-right">
      <button mat-icon-button (click)="openBookmarkSelector()"
        [title]="bookmark.isBookmarkedInAnyList(id(), 'a') ? 'Manage bookmarks' : 'Add to bookmark list'">
        <mat-icon>{{ bookmark.getBookmarkIcon(id(), 'a') }}</mat-icon>
      </button>
      <button mat-icon-button (click)="share.emit()" title="Share Article">
        <mat-icon>share</mat-icon>
      </button>
      @if (event()) {
      <app-zap-button [event]="event()!"></app-zap-button>
      <app-event-menu [event]="event()!" [view]="'icon'"></app-event-menu>
      }
    </div>
  </div>
  }

  <!-- Header Section -->
  <header class="article-header">
    @if (image()) {
    <div class="article-hero-image">
      <img [src]="image()" [alt]="title()" [title]="title()" loading="lazy" />
    </div>
    }

    <div class="article-header-content">
      <h1 class="article-title">{{ title() || 'Untitled Article' }}</h1>

      @if (summary()) {
      <p class="article-summary">{{ summary() }}</p>
      }

      <div class="article-meta">
        @if (mode() === 'full') {
        <div class="meta-row">
          <div class="publish-date">
            <mat-icon>schedule</mat-icon>
            <app-date-toggle [date]="publishedAtTimestamp()"></app-date-toggle>
          </div>
          <div class="read-time">
            <mat-icon>timer</mat-icon>
            <span>{{ readTime() }} min read</span>
          </div>
        </div>

        <!-- Engagement Metrics Row - clickable to open reactions dialog -->
        <div class="engagement-row">
          <button class="engagement-item engagement-button" mat-button (click)="openReactionsDialog('likes')">
            <mat-icon>thumb_up</mat-icon>
            <span class="count">{{ reactionCount() }}</span>
          </button>
          <span class="engagement-item">
            <mat-icon>chat_bubble</mat-icon>
            <span class="count">{{ commentCount() }}</span>
          </span>
          <button class="engagement-item engagement-button" mat-button (click)="openReactionsDialog('zaps')">
            <mat-icon>bolt</mat-icon>
            <span class="count">{{ formatZapAmount(zapTotal()) }}</span>
          </button>
        </div>

        <!-- Top Zappers -->
        @if (topZappers().length > 0) {
        <div class="top-zappers">
          <app-zap-chips [zappers]="topZappers()" [maxDisplay]="4"></app-zap-chips>
        </div>
        }
        }

        <!-- Text-to-Speech Controls (Header) - only in full mode -->
        @if (mode() === 'full') {
        <div class="article-tts-controls">
          <button mat-icon-button [matMenuTriggerFor]="translateMenu" title="Translate Article"
            [disabled]="isTranslating()">
            @if (isTranslating()) {
            <mat-progress-spinner mode="indeterminate" diameter="24"></mat-progress-spinner>
            } @else {
            <mat-icon>translate</mat-icon>
            }
          </button>
          <mat-menu #translateMenu="matMenu">
            <button mat-menu-item (click)="translate.emit('eng_Latn')">English</button>
            <button mat-menu-item (click)="translate.emit('spa_Latn')">Spanish</button>
            <button mat-menu-item (click)="translate.emit('fra_Latn')">French</button>
            <button mat-menu-item (click)="translate.emit('deu_Latn')">German</button>
            <button mat-menu-item (click)="translate.emit('ita_Latn')">Italian</button>
            <button mat-menu-item (click)="translate.emit('por_Latn')">Portuguese</button>
            <button mat-menu-item (click)="translate.emit('rus_Cyrl')">Russian</button>
            <button mat-menu-item (click)="translate.emit('zho_Hans')">Chinese (Simplified)</button>
            <button mat-menu-item (click)="translate.emit('jpn_Jpan')">Japanese</button>
          </mat-menu>

          <!-- Playback Speed Menu -->
          <button mat-icon-button [matMenuTriggerFor]="speedMenu" matTooltip="Playback Speed">
            <mat-icon>speed</mat-icon>
          </button>
          <mat-menu #speedMenu="matMenu">
            <div class="menu-header">Playback Speed</div>
            @for (rate of playbackRates; track rate) {
            <button mat-menu-item (click)="playbackRateChange.emit(rate)" [class.selected]="playbackRate() === rate">
              <mat-icon>{{ playbackRate() === rate ? 'check' : '' }}</mat-icon>
              <span>{{ rate }}x</span>
            </button>
            }
          </mat-menu>

          <!-- Voice Selection Menu -->
          <button mat-icon-button [matMenuTriggerFor]="voiceMenu" matTooltip="Voice Settings">
            <mat-icon>settings_voice</mat-icon>
          </button>
          <mat-menu #voiceMenu="matMenu" class="voice-menu">
            <button mat-menu-item (click)="toggleAiVoice.emit(!useAiVoice())">
              <mat-icon>{{ useAiVoice() ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
              <span>Use AI Voice (SpeechT5)</span>
            </button>
            @if (!useAiVoice() && availableVoices().length > 0) {
            <mat-divider></mat-divider>
            <div class="menu-header">Select Voice</div>
            @for (lang of languageGroups(); track lang) {
            <div class="voice-group">
              <div class="voice-group-label">{{ lang }}</div>
              @for (voice of groupedVoices()[lang]; track voice.name) {
              <button mat-menu-item (click)="voiceChange.emit(voice)"
                [class.selected]="selectedVoice()?.name === voice.name"
                [class.natural-voice]="voice.name.includes('Natural') || voice.name.includes('Online')">
                <mat-icon>{{ selectedVoice()?.name === voice.name ? 'check' : '' }}</mat-icon>
                <span class="voice-name">{{ voice.name.replace('Microsoft ', '').replace(' Online', '') }}</span>
                @if (voice.name.includes('Natural') || voice.name.includes('Online')) {
                <span class="voice-badge">Natural</span>
                }
              </button>
              }
            </div>
            }
            }
          </mat-menu>

          @if (!isSpeaking()) {
          <button mat-icon-button color="primary" (click)="startSpeech.emit()" title="Read article aloud"
            [disabled]="isSynthesizing()">
            @if (isSynthesizing()) {
            <mat-progress-spinner mode="indeterminate" diameter="24"></mat-progress-spinner>
            } @else {
            <mat-icon>volume_up</mat-icon>
            }
          </button>
          } @else {
          @if (isPaused()) {
          <button mat-icon-button color="primary" (click)="resumeSpeech.emit()" title="Resume reading">
            <mat-icon>play_arrow</mat-icon>
          </button>
          } @else {
          <button mat-icon-button color="primary" (click)="pauseSpeech.emit()" title="Pause reading">
            <mat-icon>pause</mat-icon>
          </button>
          }
          <button mat-icon-button color="primary" (click)="stopSpeech.emit()" title="Stop reading">
            <mat-icon>stop</mat-icon>
          </button>
          }
        </div>
        }
      </div>
    </div>
  </header>

  <!-- Author Section (only in full mode) -->
  @if (mode() === 'full') {
  <section class="article-author">
    <app-user-profile [pubkey]="authorPubkey()" mode="list"></app-user-profile>
  </section>
  }

  <!-- Article Content -->
  <main class="article-content">
    @if (isJsonContent()) {
    <div class="json-content">
      @if (jsonData(); as data) {
      @if (getObjectKeys(data).length > 0) {
      <div class="json-object">
        @for (key of getObjectKeys(data); track key) {
        <div class="json-property">
          <span class="json-key">{{ key }}</span>
          <span class="json-separator">:</span>
          @if (isPrimitive(getObjectValue(data, key))) {
          <span class="json-value">{{ formatJsonValue(getObjectValue(data, key)) }}</span>
          } @else {
          <pre class="json-complex-value">{{ stringifyValue(getObjectValue(data, key)) }}</pre>
          }
        </div>
        }
      </div>
      } @else {
      <pre class="json-raw">{{ stringifyValue(data) }}</pre>
      }
      }
    </div>
    } @else {
    <div class="markdown-content" [innerHTML]="parsedContent()" appMentionHover (click)="handleContentClick($event)">
    </div>
    }
  </main>

  <!-- Tags Section (moved to bottom, only in full mode) -->
  @if (mode() === 'full' && uniqueHashtags().length > 0) {
  <section class="article-tags">
    <mat-chip-set>
      @for (hashtag of uniqueHashtags(); track hashtag) {
      <mat-chip highlighted>
        {{ hashtag }}
      </mat-chip>
      }
    </mat-chip-set>
  </section>
  }

  <!-- Footer Actions (only in full mode) -->
  @if (mode() === 'full') {
  <footer class="article-footer">
    <div class="article-actions">
      @if (accountState.isCurrentUser(authorPubkey())) {
      <button mat-icon-button (click)="layout.createArticle(link())" title="Edit Article">
        <mat-icon>edit</mat-icon>
      </button>
      }

      <button mat-icon-button (click)="openBookmarkSelector()"
        [title]="bookmark.isBookmarkedInAnyList(id(), 'a') ? 'Manage bookmarks' : 'Add to bookmark list'">
        <mat-icon>{{ bookmark.getBookmarkIcon(id(), 'a') }}</mat-icon>
      </button>

      <button mat-icon-button (click)="share.emit()" title="Share Article">
        <mat-icon>share</mat-icon>
      </button>

      @if (event()) {
      <app-reaction-button [event]="event()!" [view]="'icon'"></app-reaction-button>
      <app-zap-button [event]="event()!"></app-zap-button>
      <app-repost-button [event]="event()!" [view]="'icon'"></app-repost-button>
      <app-event-menu [event]="event()!" [view]="'icon'"></app-event-menu>
      }
    </div>
  </footer>
  }

  <!-- Comments Section (only in full mode) -->
  @if (mode() === 'full' && event()) {
  <section class="article-comments">
    <app-comments-list [event]="event()!"></app-comments-list>
  </section>
  }
</div>