<div class="login-dialog">
  <div class="dialog-header">
    <button mat-icon-button class="back-button" (click)="backToInitialDialog()" aria-label="Back to start">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <img src="icons/icon-128x128.png" alt="Nostria Logo" class="app-icon">
    <h2 mat-dialog-title>Sign in to Nostria</h2>
  </div>

  <!-- Previous Accounts Section (always shown if accounts exist) -->
  @if (nostrService.hasAccounts()) {
  <div class="accounts-section">
    <h3 class="section-title">Previous Accounts</h3>
    <div class="accounts-list-container">
      @for (account of nostrService.accounts(); track account.pubkey) {
      <mat-card class="account-card" (click)="selectExistingAccount(account.pubkey)">
        <mat-card-content class="account-content">
          <div class="account-avatar">
            @if (getAccountMetadata(account)?.picture) {
            <img [src]="getAccountMetadata(account)?.picture" alt="Profile picture" class="avatar-image">
            } @else {
            <mat-icon>account_circle</mat-icon>
            }
          </div>
          <div class="account-details">
            <div class="account-name">{{ getAccountMetadata(account)?.name || 'Unknown User' }}</div>
            <div class="account-source">{{ account.name }} · {{ account.source }}</div>
            <div class="last-used">Last used: {{ account.lastUsed | date:'short' }}</div>
          </div>
          <button mat-icon-button class="delete-button" (click)="removeAccount($event, account.pubkey)"
            matTooltip="Remove account">
            <mat-icon>delete</mat-icon>
          </button>
        </mat-card-content>
      </mat-card>
      }
    </div>
  </div>
  }

  <div class="login-options-section">
    <h3 class="section-title">Other Login Options</h3>

    <div class="login-options">
      <mat-card class="login-card private-key" (click)="currentView.set('nsec')">
        <mat-card-content>
          <div class="card-content">
            <mat-icon>key</mat-icon>
            <div class="card-text">
              <h3>Private Key</h3>
              <p>Sign in with your Nostr private key</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="login-card extension" (click)="loginWithExtension()">
        <mat-card-content>
          <div class="card-content">
            <mat-icon>extension</mat-icon>
            <div class="card-text">
              <h3>Browser Extension</h3>
              <p>Connect via Alby or nos2x</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="login-card connect" (click)="currentView.set('nostr-connect')">
        <mat-card-content>
          <div class="card-content">
            <mat-icon>phone_iphone</mat-icon>
            <div class="card-text">
              <h3>Nostr Connect</h3>
              <p>Sign in with Nostria Signer app</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="login-card preview" (click)="currentView.set('preview')">
        <mat-card-content>
          <div class="card-content">
            <mat-icon>visibility</mat-icon>
            <div class="card-text">
              <h3>Preview Only</h3>
              <p>Use any public key in read-only mode</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  @if (extensionError()) {
  <div class="extension-error">
    <p>{{ extensionError() }}</p>
    <p>Make sure you have a Nostr extension installed like Alby or nos2x</p>
  </div>
  }

  @if (currentView() === 'extension-loading') {
  <div mat-dialog-content class="loading-content">
    <mat-spinner diameter="48"></mat-spinner>
    <p class="loading-text">Connecting to your Nostr extension...</p>
  </div>
  }

  @if (currentView() === 'nsec') {
  <div mat-dialog-content>
    <p class="dialog-subtitle">Enter your nsec private key:</p>

    <mat-form-field appearance="fill" class="full-width">
      <mat-label>Private Key (nsec...)</mat-label>
      <input matInput [(ngModel)]="nsecKey" type="password" placeholder="nsec1..." autocomplete="off" autocorrect="off"
        spellcheck="false">
    </mat-form-field>

    <div class="nsec-warning">
      <p>⚠️ Your private key will be stored locally on your device.</p>
      <p>This form is configured to try and prevent password managers from saving your key. If your browser suggests to
        save, reject it.</p>
    </div>
  </div>

  <div mat-dialog-actions align="end">
    <button mat-button (click)="currentView.set('main')">Back</button>
    <button mat-raised-button color="primary" (click)="loginWithNsec()"
      [disabled]="!nsecKey">
      Login
    </button>
  </div>
  }

  @if (currentView() === 'existing-accounts') {
  <div mat-dialog-content>
    <p class="dialog-subtitle">Select an account to continue:</p>

    <mat-nav-list class="accounts-list">
      @for (account of nostrService.accounts(); track account.pubkey) {
      <a mat-list-item (click)="selectExistingAccount(account.pubkey)" class="account-item">
        @if (getAccountMetadata(account)?.picture) {
        <div class="account-avatar" matListItemIcon>
          <img [src]="getAccountMetadata(account)?.picture" alt="Profile picture" class="avatar-image">
        </div>  
        } @else {
        <mat-icon matListItemIcon>account_circle</mat-icon>
        }
        <span matListItemTitle>{{ getAccountMetadata(account)?.name || 'Unknown User' }}</span>
        <span matListItemLine class="account-source">{{ account.name }}<br>
          Type: {{ account.source }} - 
          Last used:
          {{ account.lastUsed | date:'short' }}
        </span>
        <button mat-icon-button class="delete-button" (click)="removeAccount($event, account.pubkey)"
          matTooltip="Remove account">
          <mat-icon>delete</mat-icon>
        </button>
      </a>
      }
    </mat-nav-list>
  </div>

  <div mat-dialog-actions align="end">
    <button mat-button (click)="currentView.set('main')">Back</button>
  </div>
  }

  @if (currentView() === 'nostr-connect') {
  <div mat-dialog-content>
    <p class="dialog-subtitle">Enter your Nostr Connect URL:</p>

    @if (nostrConnectError()) {
    <div class="extension-error">
      <p>{{ nostrConnectError() }}</p>
    </div>
    }

    <div class="nostr-connect-input-container">
      <mat-form-field appearance="fill" class="nostr-connect-input">
        <mat-label>Nostr Connect URL</mat-label>
        <input matInput [ngModel]="nostrConnectUrl()" (ngModelChange)="nostrConnectUrl.set($event)" placeholder="bunker://..." [disabled]="nostrConnectLoading()"
          autocomplete="off" autocorrect="off" spellcheck="false">
        <mat-hint>Scan QR code from Nostria Signer app to get this URL</mat-hint>
      </mat-form-field>
      
      <button mat-icon-button class="qr-scan-button" (click)="scanQrCodeForNostrConnect()" 
        [disabled]="nostrConnectLoading()" matTooltip="Scan QR code">
        <mat-icon>qr_code_scanner</mat-icon>
      </button>
    </div>

    <div class="nostr-connect-info">
      <p>Nostr Connect allows you to use your private key from a separate device.</p>
      <p>Use the Nostria Signer app to approve signing requests without exposing your private key to this browser.</p>
    </div>
  </div>

  <div mat-dialog-actions align="end">
    <button mat-button (click)="currentView.set('main')" [disabled]="nostrConnectLoading()">Back</button>
    <button mat-raised-button color="primary" (click)="loginWithNostrConnect()"
      [disabled]="!nostrConnectUrl() || nostrConnectUrl().length < 10 || nostrConnectLoading()">
      @if (nostrConnectLoading()) {
      <mat-spinner diameter="20" class="button-spinner"></mat-spinner>
      Connecting...
      } @else {
      Connect
      }
    </button>
  </div>
  }
  @if (currentView() === 'preview') {
  <div mat-dialog-content>
    <p class="dialog-subtitle">Enter a public key for preview only mode:</p>

    <mat-form-field appearance="fill" class="full-width">
      <mat-label>Public Key (npub...)</mat-label>
      <input matInput [(ngModel)]="previewPubkey" type="text" placeholder="npub1..." autocomplete="off" autocorrect="off"
        spellcheck="false">
      <mat-hint>You will be able to view content but not interact</mat-hint>
    </mat-form-field>
    
    <div class="preview-info">
      <p>Preview mode allows you to browse Nostr content using any public key.</p>
      <p>You will be able to view posts, profiles, and content but will not be able to interact or post.</p>
    </div>
  </div>

  <div mat-dialog-actions align="end">
    <button mat-button (click)="currentView.set('main')">Back</button>
    <button mat-raised-button color="primary" (click)="usePreviewAccount(previewPubkey)"
      [disabled]="!previewPubkey">
      Preview Only
    </button>
  </div>
  }
</div>