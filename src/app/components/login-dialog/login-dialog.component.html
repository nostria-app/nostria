<div class="unified-login-dialog no-select">
  <div class="dialog-content">
    <!-- Step 1: Initial welcome screen (from initial login dialog) -->
    @if (currentStep() === LoginStep.INITIAL) {

    <div class="login-options">
      <mat-card class="login-card new-user" (click)="startNewAccountFlow()">
        <mat-card-content>
          <div class="card-content">
            <div class="card-text">
              <h3><mat-icon>person_add</mat-icon>New User</h3>
              <p>Create a new account</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="login-card existing-user" (click)="goToStep(LoginStep.LOGIN_OPTIONS)">
        <mat-card-content>
          <div class="card-content">
            <div class="card-text">
              <h3><mat-icon>login</mat-icon>Sign In</h3>
              <p>Use your existing account</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <div class="terms-of-use-notice">
      <p>
        By using Nostria, you agree to our
        <a href="#" (click)="$event.preventDefault(); openTermsOfUse()">Terms of Use</a>.
      </p>
    </div>
    }

    <!-- Step 2: Region selection with discovery (from location selection dialog) -->
    @if (currentStep() === LoginStep.REGION_SELECTION) {
    @if (isDetectingRegion()) {
    <div class="region-detection-container">
      <div class="region-detection-loading">
        <mat-icon class="spinning">autorenew</mat-icon>
        <span>Finding closest region...</span>
      </div>
      <p>
        Your account will be ready in seconds â€” no email, no phone number, no personal details required.
      </p>
    </div>
    } @else {

    <div class="region-info-container">
      <button mat-button class="region-info-btn" (click)="toggleRegionSelector()">
        Region: <strong>{{ detectedRegion() }}</strong>
        <mat-icon>{{ showRegionSelector() ? 'expand_less' : 'expand_more' }}</mat-icon>
      </button>

      @if (showRegionSelector()) {
      <div class="region-selector">
        <h3>Choose your region:</h3>
        @for (region of availableRegions(); track region.name) {
        <button class="region-option" mat-button (click)="selectRegionManually(region)">
          <mat-icon class="region-flag">travel_explore</mat-icon>
          <span class="region-name">{{ region.name }}</span>&nbsp;
          <span class="region-latency">{{ region.latency }}</span>
        </button>
        }
      </div>
      }
    </div>

    <!-- Profile Setup Section -->
    <div class="profile-setup-section">
      <h3>Set up your profile (optional)</h3>
      <p>Add a name and photo so people can recognize you.</p>

      <div class="profile-setup-form">
        <div class="profile-avatar-section">
          <div class="profile-setup-avatar" (click)="fileInput.click()" (keydown.enter)="fileInput.click()"
            (keydown.space)="fileInput.click()" tabindex="0" role="button" aria-label="Select profile image">
            @if (profileImage()) {
            <img [src]="profileImage()" alt="Profile" class="profile-preview" />
            } @else {
            <div class="avatar-placeholder">
              <mat-icon>add_a_photo</mat-icon>
            </div>
            }
            <input type="file" accept="image/*" (change)="onFileSelected($event)" #fileInput class="hidden-file-input"
              title="Select profile image" />
          </div>
          @if (profileImage()) {
          <button mat-icon-button class="clear-avatar-button" (click)="clearProfileImage()"
            matTooltip="Remove profile image" aria-label="Remove profile image">
            <mat-icon>close</mat-icon>
          </button>
          }
        </div>

        <div class="profile-name-section">
          <mat-form-field appearance="outline" class="profile-name-field">
            <mat-label>What should we call you?</mat-label>
            <input matInput [ngModel]="displayName()" (ngModelChange)="displayName.set($event)"
              placeholder="Display name (optional)" maxlength="50" />
          </mat-form-field>
        </div>
      </div>
    </div>
    }
    }

    <!-- Step 3: Login options (from login dialog) -->
    @if (currentStep() === LoginStep.LOGIN_OPTIONS) {

    <div class="login-options-section">
      <div class="login-options">
        <mat-card class="login-card nsec" (click)="goToStep(LoginStep.NSEC_LOGIN)">
          <mat-card-content>
            <div class="card-content">
              <div class="card-text">
                <h3><mat-icon>key</mat-icon>Private Key</h3>
                <p>Sign in with your Nostr private key</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="login-card extension" (click)="loginWithExtension()">
          <mat-card-content>
            <div class="card-content">
              <div class="card-text">
                <h3><mat-icon>extension</mat-icon>Extension</h3>
                <p>Connect via browser extension</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="login-card connect" (click)="goToStep(LoginStep.NOSTR_CONNECT)">
          <mat-card-content>
            <div class="card-content">
              <div class="card-text">
                <h3><mat-icon>phone_iphone</mat-icon>Remote Key</h3>
                <p>Sign in with remote signer</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="login-card external" (click)="goToStep(LoginStep.EXTERNAL_SIGNER)">
          <mat-card-content>
            <div class="card-content">
              <div class="card-text">
                <h3><mat-icon>open_in_new</mat-icon>External Signer</h3>
                <p>Use an external signer app (NIP-55)</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="login-card preview" (click)="goToStep(LoginStep.PREVIEW)">
          <mat-card-content>
            <div class="card-content">
              <div class="card-text">
                <h3><mat-icon>visibility</mat-icon>Preview Only</h3>
                <p>Use any public key in read-only mode</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    @if (extensionError()) {
    <mat-card class="extension-error">
      <mat-card-content>
        <div class="error-header">
          <mat-icon color="warn">extension_off</mat-icon>
          <h3>Extension Not Found</h3>
        </div>
        <p>Install a Nostr extension (Blockcore Wallet, Alby, or nos2x), then refresh this page.</p>
      </mat-card-content>
    </mat-card>
    }
    }

    <!-- Extension Loading State -->
    @if (currentStep() === LoginStep.EXTENSION_LOADING) {
    <div class="loading-content">
      <mat-spinner diameter="48"></mat-spinner>
      <p class="loading-text">Connecting to your Nostr extension...</p>
    </div>
    }

    <!-- NSEC Key Login -->
    @if (currentStep() === LoginStep.NSEC_LOGIN) {

    <div class="nsec-input-container">
      <mat-form-field class="nsec-input">
        <mat-label>Private Key or Recovery Phrase</mat-label>
        <input matInput [(ngModel)]="nsecKey" type="password" placeholder="nsec1... or 12-word phrase"
          autocomplete="off" autocorrect="off" spellcheck="false" name="nostr-private-key" readonly
          onfocus="this.removeAttribute('readonly');" />
      </mat-form-field>

      <button mat-icon-button class="qr-scan-button" (click)="scanQrCodeForNsec()" matTooltip="Scan QR code">
        <mat-icon>qr_code_scanner</mat-icon>
      </button>
    </div>

    <div class="file-upload-section">
      <p>Load from backup file:</p>
      <input #fileInput type="file" accept=".json" (change)="loadCredentialsFromFile($event)" class="hidden-file-input"
        title="Select JSON backup file" />
      <button mat-stroked-button type="button" (click)="fileInput.click()" class="file-upload-button">
        <mat-icon>upload_file</mat-icon>
        <span>Choose JSON backup file</span>
      </button>
    </div>

    <mat-card class="nsec-warning">
      <mat-card-content>
        <div class="warning-header">
          <mat-icon color="warn">warning</mat-icon>
          <h3>Security Notice</h3>
        </div>
        <p>Your private key will be stored locally on your device. Never share it with anyone.</p>
      </mat-card-content>
    </mat-card>
    }

    <!-- Nostr Connect -->
    @if (currentStep() === LoginStep.NOSTR_CONNECT) {

    @if (nostrConnectError()) {
    <div class="extension-error">
      <p>Error: {{ nostrConnectError() }}</p>
    </div>
    }

    <div class="nostr-connect-input-container">
      <mat-form-field class="nostr-connect-input">
        <mat-label>Nostr Connect URL</mat-label>
        <input matInput [ngModel]="nostrConnectUrl()" (ngModelChange)="nostrConnectUrl.set($event)"
          placeholder="bunker://..." [disabled]="nostrConnectLoading()" autocomplete="off" autocorrect="off"
          spellcheck="false" />
        <mat-hint>Scan QR code from Nostria Signer app to get this URL</mat-hint>
      </mat-form-field>

      <button mat-icon-button class="qr-scan-button" (click)="scanQrCodeForNostrConnect()"
        [disabled]="nostrConnectLoading()" matTooltip="Scan QR code">
        <mat-icon>qr_code_scanner</mat-icon>
      </button>
    </div>

    <mat-card class="nostr-connect-info">
      <mat-card-content>
        <div class="info-header">
          <mat-icon color="primary">info</mat-icon>
          <h3>About Nostr Connect</h3>
        </div>
        <p>Use your private key from a separate device for enhanced security. Scan QR code from Nostria Signer app.</p>
      </mat-card-content>
    </mat-card>
    }

    <!-- Preview Mode -->
    @if (currentStep() === LoginStep.PREVIEW) {

    <mat-form-field class="full-width">
      <mat-label>Public Key (npub...)</mat-label>
      <input matInput [(ngModel)]="previewPubkey" type="text" placeholder="npub1..." autocomplete="off"
        autocorrect="off" spellcheck="false" />
      <mat-hint>Read-only mode - you cannot post or interact</mat-hint>
    </mat-form-field>

    <mat-card class="preview-info">
      <mat-card-content>
        <div class="info-header">
          <mat-icon color="accent">visibility</mat-icon>
          <h3>Preview Mode</h3>
        </div>
        <p>Browse Nostr content using any public key. View posts and profiles without posting or interacting.</p>
      </mat-card-content>
    </mat-card>
    }

    <!-- External Signer Login -->
    @if (currentStep() === LoginStep.EXTERNAL_SIGNER) {
    <div class="external-signer-section">
      <p class="instruction-text">
        Use an external signer app like Amber to log in.
      </p>

      <div class="actions">
        <a mat-flat-button color="primary" [href]="safeExternalSignerUrl">
          <mat-icon>open_in_new</mat-icon>
          Open Signer App
        </a>
      </div>

      <div class="divider">
        <span>OR</span>
      </div>

      <p class="instruction-text">
        Paste your public key (npub or hex) below if the signer app copied it to clipboard:
      </p>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Public Key (npub...)</mat-label>
        <input matInput [(ngModel)]="externalSignerPubkey" placeholder="npub1..." autocomplete="off"
          #externalSignerInput />
      </mat-form-field>

      <div class="actions-row">
        <button mat-button (click)="goToStep(LoginStep.LOGIN_OPTIONS)">Back</button>
        <button mat-flat-button color="primary" [disabled]="!externalSignerPubkey" (click)="loginWithExternalSigner()">
          @if (loading()) {
          <mat-spinner diameter="20"></mat-spinner>
          } @else {
          Login
          }
        </button>
      </div>
    </div>
    }
  </div>
</div>

<!-- Terms of Use Dialog -->
@if (layout.showTermsDialog()) {
<app-standalone-terms-dialog (closed)="closeTermsDialog()" />
}