<div class="runes-sidebar" (mouseenter)="onSidebarEnter()" (mouseleave)="onSidebarLeave()">
  @for (rune of visibleRunes(); track rune.id) {
  <button mat-icon-button class="rune-button" [class.rune-active]="isRuneActive(rune.id)"
    (mouseenter)="onRuneEnter($event, rune.id)" (mouseleave)="onRuneLeave(rune.id)" (click)="toggleRuneOpen(rune.id)"
    [attr.aria-label]="rune.title">
    @if (rune.id === 'weather') {
    <span class="weather-mini" [class.loading]="weather().loading" [class.error]="!!weather().error">
      <mat-icon>{{ weatherMiniIcon() }}</mat-icon>
      <span class="weather-mini-temp">{{ weatherMiniTemp() }}</span>
    </span>
    } @else if (rune.id === 'bitcoin-price') {
    <span class="bitcoin-mini" [class.loading]="bitcoinPrice().loading" [class.error]="!!bitcoinPrice().error">
      @if (bitcoinPrice().usd === null) {
      <mat-icon>currency_bitcoin</mat-icon>
      }
      <span class="bitcoin-mini-price">{{ bitcoinMiniPrice() }}</span>
    </span>
    } @else {
    <mat-icon>{{ rune.icon }}</mat-icon>
    }
  </button>
  }

  <button mat-icon-button class="rune-button rune-settings" [class.rune-active]="settingsOpen()"
    (mouseenter)="onSettingsEnter($event)" (mouseleave)="onSettingsLeave()" (click)="toggleSettings()"
    aria-label="Runes settings">
    <mat-icon>tune</mat-icon>
  </button>
</div>

@if (hoverPreviewRuneId(); as previewRuneId) {
<div class="rune-flyout rune-hover-preview" [style.top.px]="hoverPreviewPosition()?.top"
  [style.right.px]="hoverPreviewPosition()?.right" (mouseenter)="onFlyoutEnter(previewRuneId)"
  (mouseleave)="onFlyoutLeave(previewRuneId)">
  @if (previewRuneId === 'bitcoin-price' || previewRuneId === 'weather') {
  <div class="flyout-meta-row">
    <span class="flyout-updated">
      Updated: {{ formatUpdatedAt(previewRuneId === 'bitcoin-price' ? bitcoinPrice().updatedAt : weather().updatedAt) }}
    </span>
  </div>
  }

  @switch (previewRuneId) {
  @case ('bitcoin-price') {
  <div class="rune-content">
    <div class="btc-row">
      <span class="btc-label">USD</span>
      <span class="btc-value">
        {{ formatRoundedCurrency(bitcoinPrice().usd, '$') }}
      </span>
    </div>
    <div class="btc-row">
      <span class="btc-label">EUR</span>
      <span class="btc-value">
        {{ formatRoundedCurrency(bitcoinPrice().eur, '€') }}
      </span>
    </div>
    <div class="btc-meta-row">
      <button mat-icon-button class="btc-reload-button" [disabled]="bitcoinPrice().loading"
        (click)="reloadBitcoinPrice()" aria-label="Reload Bitcoin price">
        <mat-icon>{{ bitcoinPrice().loading ? 'hourglass_top' : 'refresh' }}</mat-icon>
      </button>
    </div>
    @if (bitcoinPrice().error) {
    <div class="rune-error">{{ bitcoinPrice().error }}</div>
    }
  </div>
  }

  @case ('weather') {
  <div class="rune-content weather-card">
    <div class="weather-hero">
      <div class="weather-main">
        <mat-icon class="weather-main-icon">{{ weatherMiniIcon() }}</mat-icon>
        <div class="weather-main-temp">
          {{ formatWeatherValue(weather().temperatureC, '°') }}
        </div>
      </div>
      <div class="weather-details">
        <div class="weather-condition">{{ weatherConditionLabel() }}</div>
        <div class="weather-location">{{ weather().locationLabel }}</div>
      </div>
      <button mat-icon-button class="weather-reload-button" [disabled]="weather().loading" (click)="reloadWeather()"
        aria-label="Reload weather">
        <mat-icon>{{ weather().loading ? 'hourglass_top' : 'refresh' }}</mat-icon>
      </button>
    </div>

    <div class="weather-metrics">
      <div class="weather-chip">
        <span>Feels</span>
        <strong>{{ formatWeatherValue(weather().feelsLikeC, '°') }}</strong>
      </div>
      <div class="weather-chip">
        <span>Humidity</span>
        <strong>{{ formatWeatherValue(weather().humidityPercent, '%') }}</strong>
      </div>
      <div class="weather-chip">
        <span>Wind</span>
        <strong>{{ formatWeatherValue(weather().windKmh, ' km/h') }}</strong>
      </div>
      <div class="weather-chip">
        <span>Today</span>
        <strong>{{ formatWeatherDailyRange(weather().minTempC, weather().maxTempC) }}</strong>
      </div>
    </div>

    <div class="weather-location-controls">
      <div class="weather-location-input-row">
        <input class="weather-location-input" type="text" placeholder="Search city" [value]="weatherLocationQuery()"
          (input)="updateWeatherLocationQuery($any($event.target).value)"
          (keydown.enter)="$event.preventDefault(); searchWeatherLocations()" />
        <button mat-icon-button class="weather-search-button"
          [disabled]="weatherLocationSearching() || !weatherLocationQuery().trim()" (click)="searchWeatherLocations()"
          aria-label="Search weather location">
          <mat-icon>{{ weatherLocationSearching() ? 'hourglass_top' : 'search' }}</mat-icon>
        </button>
        <button mat-stroked-button class="weather-auto-location-button" [disabled]="!weatherUsingManualLocation()"
          (click)="useAutomaticWeatherLocation()">
          Auto
        </button>
      </div>

      @if (weatherLocationResults().length > 0) {
      <div class="weather-location-results">
        @for (result of weatherLocationResults(); track result.label + result.latitude + result.longitude) {
        <button class="weather-location-result" type="button" (click)="applyWeatherLocation(result)">
          {{ result.label }}
        </button>
        }
      </div>
      }
    </div>

    @if (weather().error) {
    <div class="rune-error">{{ weather().error }}</div>
    }
  </div>
  }

  @case ('nostr-swiss-knife') {
  <div class="rune-content">
    <label class="swiss-label" for="rune-swiss-input-preview">Paste npub/nevent/note/naddr/nprofile/hex</label>
    <textarea id="rune-swiss-input-preview" class="swiss-input" [value]="swissKnifeInput()"
      (input)="updateSwissKnifeInput($any($event.target).value)"></textarea>

    @if (swissKnifeResults().length > 0) {
    <div class="swiss-results">
      @for (result of swissKnifeResults(); track result.type + result.primaryValue) {
      <div class="swiss-row">
        <span class="swiss-type">{{ result.type }}</span>
        <span class="swiss-value">{{ result.primaryValue }}</span>
      </div>
      }
    </div>
    }
  </div>
  }

  @case ('music-favorites') {
  <div class="rune-content music-actions">
    <div class="music-item-row">
      <button mat-stroked-button (click)="openMusicLiked()">
        <mat-icon>favorite</mat-icon>
        Liked Songs
      </button>
      <button mat-icon-button class="music-quick-play" [disabled]="isPlayingLikedSongs()"
        (click)="quickPlayLikedSongs()" matTooltip="Quick play liked songs" aria-label="Quick play liked songs">
        @if (isPlayingLikedSongs()) {
        <mat-icon>hourglass_top</mat-icon>
        } @else {
        <mat-icon>play_arrow</mat-icon>
        }
      </button>
    </div>

    <div class="music-item-row">
      <button mat-stroked-button (click)="openMusicLikedPlaylists()">
        <mat-icon>playlist_play</mat-icon>
        Liked Playlists
      </button>
      <button mat-icon-button class="music-quick-play" [disabled]="isPlayingLikedPlaylists()"
        (click)="quickPlayLikedPlaylists()" matTooltip="Quick play first liked playlist"
        aria-label="Quick play first liked playlist">
        @if (isPlayingLikedPlaylists()) {
        <mat-icon>hourglass_top</mat-icon>
        } @else {
        <mat-icon>play_arrow</mat-icon>
        }
      </button>
    </div>

    <button mat-stroked-button (click)="openMusicHome()">
      <mat-icon>library_music</mat-icon>
      Open Music
    </button>
  </div>
  }
  }
</div>
}

@if (activeRunes().length > 0 || settingsPreviewVisible()) {
<div class="rune-flyout-stack">
  @for (activeRuneIdValue of activeRunes(); track activeRuneIdValue) {
  <div class="rune-flyout" [class.pinned]="openRunes().includes(activeRuneIdValue)"
    (mouseenter)="onFlyoutEnter(activeRuneIdValue)" (mouseleave)="onFlyoutLeave(activeRuneIdValue)">
    @if (openRunes().includes(activeRuneIdValue) || activeRuneIdValue === 'bitcoin-price' || activeRuneIdValue ===
    'weather') {
    <div class="flyout-meta-row" [class.has-close]="openRunes().includes(activeRuneIdValue)">
      @if (activeRuneIdValue === 'bitcoin-price' || activeRuneIdValue === 'weather') {
      <span class="flyout-updated">
        Updated: {{ formatUpdatedAt(activeRuneIdValue === 'bitcoin-price' ? bitcoinPrice().updatedAt :
        weather().updatedAt) }}
      </span>
      }
      @if (openRunes().includes(activeRuneIdValue)) {
      <button mat-icon-button class="rune-close-button" (click)="closeRune(activeRuneIdValue)" aria-label="Close rune">
        <mat-icon>close</mat-icon>
      </button>
      }
    </div>
    }

    @switch (activeRuneIdValue) {
    @case ('bitcoin-price') {
    <div class="rune-content">
      <div class="btc-row">
        <span class="btc-label">USD</span>
        <span class="btc-value">
          {{ formatRoundedCurrency(bitcoinPrice().usd, '$') }}
        </span>
      </div>
      <div class="btc-row">
        <span class="btc-label">EUR</span>
        <span class="btc-value">
          {{ formatRoundedCurrency(bitcoinPrice().eur, '€') }}
        </span>
      </div>
      <div class="btc-meta-row">
        <button mat-icon-button class="btc-reload-button" [disabled]="bitcoinPrice().loading"
          (click)="reloadBitcoinPrice()" aria-label="Reload Bitcoin price">
          <mat-icon>{{ bitcoinPrice().loading ? 'hourglass_top' : 'refresh' }}</mat-icon>
        </button>
      </div>
      @if (bitcoinPrice().error) {
      <div class="rune-error">{{ bitcoinPrice().error }}</div>
      }
    </div>
    }

    @case ('weather') {
    <div class="rune-content weather-card">
      <div class="weather-hero">
        <div class="weather-main">
          <mat-icon class="weather-main-icon">{{ weatherMiniIcon() }}</mat-icon>
          <div class="weather-main-temp">
            {{ formatWeatherValue(weather().temperatureC, '°') }}
          </div>
        </div>
        <div class="weather-details">
          <div class="weather-condition">{{ weatherConditionLabel() }}</div>
          <div class="weather-location">{{ weather().locationLabel }}</div>
        </div>
        <button mat-icon-button class="weather-reload-button" [disabled]="weather().loading" (click)="reloadWeather()"
          aria-label="Reload weather">
          <mat-icon>{{ weather().loading ? 'hourglass_top' : 'refresh' }}</mat-icon>
        </button>
      </div>

      <div class="weather-metrics">
        <div class="weather-chip">
          <span>Feels</span>
          <strong>{{ formatWeatherValue(weather().feelsLikeC, '°') }}</strong>
        </div>
        <div class="weather-chip">
          <span>Humidity</span>
          <strong>{{ formatWeatherValue(weather().humidityPercent, '%') }}</strong>
        </div>
        <div class="weather-chip">
          <span>Wind</span>
          <strong>{{ formatWeatherValue(weather().windKmh, ' km/h') }}</strong>
        </div>
        <div class="weather-chip">
          <span>Today</span>
          <strong>{{ formatWeatherDailyRange(weather().minTempC, weather().maxTempC) }}</strong>
        </div>
      </div>

      <div class="weather-location-controls">
        <div class="weather-location-input-row">
          <input class="weather-location-input" type="text" placeholder="Search city" [value]="weatherLocationQuery()"
            (input)="updateWeatherLocationQuery($any($event.target).value)"
            (keydown.enter)="$event.preventDefault(); searchWeatherLocations()" />
          <button mat-icon-button class="weather-search-button"
            [disabled]="weatherLocationSearching() || !weatherLocationQuery().trim()" (click)="searchWeatherLocations()"
            aria-label="Search weather location">
            <mat-icon>{{ weatherLocationSearching() ? 'hourglass_top' : 'search' }}</mat-icon>
          </button>
          <button mat-stroked-button class="weather-auto-location-button" [disabled]="!weatherUsingManualLocation()"
            (click)="useAutomaticWeatherLocation()">
            Auto
          </button>
        </div>

        @if (weatherLocationResults().length > 0) {
        <div class="weather-location-results">
          @for (result of weatherLocationResults(); track result.label + result.latitude + result.longitude) {
          <button class="weather-location-result" type="button" (click)="applyWeatherLocation(result)">
            {{ result.label }}
          </button>
          }
        </div>
        }
      </div>

      @if (weather().error) {
      <div class="rune-error">{{ weather().error }}</div>
      }
    </div>
    }

    @case ('nostr-swiss-knife') {
    <div class="rune-content">
      <label class="swiss-label" for="rune-swiss-input">Paste npub/nevent/note/naddr/nprofile/hex</label>
      <textarea id="rune-swiss-input" class="swiss-input" [value]="swissKnifeInput()"
        (input)="updateSwissKnifeInput($any($event.target).value)"></textarea>

      @if (swissKnifeResults().length > 0) {
      <div class="swiss-results">
        @for (result of swissKnifeResults(); track result.type + result.primaryValue) {
        <div class="swiss-row">
          <span class="swiss-type">{{ result.type }}</span>
          <span class="swiss-value">{{ result.primaryValue }}</span>
        </div>
        }
      </div>
      }
    </div>
    }

    @case ('music-favorites') {
    <div class="rune-content music-actions">
      <div class="music-item-row">
        <button mat-stroked-button (click)="openMusicLiked()">
          <mat-icon>favorite</mat-icon>
          Liked Songs
        </button>
        <button mat-icon-button class="music-quick-play" [disabled]="isPlayingLikedSongs()"
          (click)="quickPlayLikedSongs()" matTooltip="Quick play liked songs" aria-label="Quick play liked songs">
          @if (isPlayingLikedSongs()) {
          <mat-icon>hourglass_top</mat-icon>
          } @else {
          <mat-icon>play_arrow</mat-icon>
          }
        </button>
      </div>

      <div class="music-item-row">
        <button mat-stroked-button (click)="openMusicLikedPlaylists()">
          <mat-icon>playlist_play</mat-icon>
          Liked Playlists
        </button>
        <button mat-icon-button class="music-quick-play" [disabled]="isPlayingLikedPlaylists()"
          (click)="quickPlayLikedPlaylists()" matTooltip="Quick play first liked playlist"
          aria-label="Quick play first liked playlist">
          @if (isPlayingLikedPlaylists()) {
          <mat-icon>hourglass_top</mat-icon>
          } @else {
          <mat-icon>play_arrow</mat-icon>
          }
        </button>
      </div>

      <button mat-stroked-button (click)="openMusicHome()">
        <mat-icon>library_music</mat-icon>
        Open Music
      </button>
    </div>
    }
    }
  </div>
  }

  @if (settingsPreviewVisible()) {
  <div class="rune-flyout" [class.pinned]="settingsOpen()" [class.rune-hover-preview]="!settingsOpen()"
    [class.rune-settings-preview]="!settingsOpen()"
    [style.top.px]="settingsOpen() ? null : settingsPreviewPosition()?.top"
    [style.right.px]="settingsOpen() ? null : settingsPreviewPosition()?.right" (mouseenter)="onSettingsFlyoutEnter()"
    (mouseleave)="onSettingsFlyoutLeave()">
    @if (settingsOpen()) {
    <div class="flyout-meta-row has-close">
      <button mat-icon-button class="rune-close-button" (click)="toggleSettings()" aria-label="Close runes settings">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    }

    <div class="rune-content settings-list">
      <h4 class="settings-section-title">Sidebar Widgets</h4>
      @for (widget of orderedSidebarWidgets(); track widget.id) {
      <button class="settings-item" type="button" draggable="true" [class.dragging]="draggedWidgetId() === widget.id"
        [class.drop-target]="dropTargetWidgetId() === widget.id" (dragstart)="onWidgetDragStart($event, widget.id)"
        (dragover)="onWidgetDragOver($event, widget.id)" (drop)="onWidgetDrop($event, widget.id)"
        (dragend)="onWidgetDragEnd()" (keydown)="onWidgetItemKeyDown($event, widget.id)"
        (click)="setSidebarWidgetEnabled(widget.id, !isSidebarWidgetEnabled(widget.id))">
        <mat-icon class="drag-handle">drag_indicator</mat-icon>
        <mat-icon>{{ isSidebarWidgetEnabled(widget.id) ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
        <mat-icon>{{ widget.icon }}</mat-icon>
        <span>{{ widget.title }}</span>
      </button>
      }

      <h4 class="settings-section-title">Runes</h4>
      @for (rune of orderedRunes(); track rune.id) {
      <button class="settings-item" type="button" draggable="true" [class.dragging]="draggedRuneId() === rune.id"
        [class.drop-target]="dropTargetRuneId() === rune.id" (dragstart)="onSettingsDragStart($event, rune.id)"
        (dragover)="onSettingsDragOver($event, rune.id)" (drop)="onSettingsDrop($event, rune.id)"
        (dragend)="onSettingsDragEnd()" (keydown)="onSettingsItemKeyDown($event, rune.id)"
        (click)="setRuneEnabled(rune.id, !isRuneEnabled(rune.id))">
        <mat-icon class="drag-handle">drag_indicator</mat-icon>
        <mat-icon>{{ isRuneEnabled(rune.id) ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
        <span>{{ rune.title }}</span>
      </button>
      }
    </div>
  </div>
  }
</div>
}