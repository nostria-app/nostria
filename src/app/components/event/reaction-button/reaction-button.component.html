<div class="reaction-container">
  @if (view() === 'icon') {
  <!-- Icon view: single-tap sends default reaction, long-press opens picker -->
  <button mat-icon-button [class.active]="!!userReaction()" [class.reacted]="!!userReaction()"
    [disabled]="isLoadingReactions()"
    (pointerdown)="onPointerDown()"
    (pointerup)="onPointerUp($event)"
    (pointerleave)="onPointerLeave()"
    (click)="$event.stopPropagation(); $event.preventDefault()">
    @if (userReaction()) {
    @if (getCustomEmojiUrl(userReaction()!.event)) {
    <img [src]="getCustomEmojiUrl(userReaction()!.event)!" [alt]="userReaction()!.event.content" class="emoji-icon-img">
    } @else {
    <span class="emoji-icon">{{ getReactionDisplay(userReaction()!.event.content) }}</span>
    }
    } @else {
    <mat-icon>favorite_border</mat-icon>
    }
  </button>

  <!-- Hidden menu trigger for programmatic opening -->
  <div class="hidden-menu-trigger" [matMenuTriggerFor]="reactionMenu" #menuTrigger="matMenuTrigger"></div>

  <!-- Reaction picker menu -->
  <mat-menu #reactionMenu="matMenu" class="reaction-picker-menu">
    <div class="emoji-picker-container" tabindex="-1" (click)="$event.stopPropagation()"
      (keydown)="$event.stopPropagation()">
      
      <!-- Search bar -->
      <div class="emoji-search">
        <mat-icon class="search-icon">search</mat-icon>
        <input type="text" 
          placeholder="Search emojis..." 
          [ngModel]="emojiSearchQuery()"
          (ngModelChange)="emojiSearchQuery.set($event)"
          (click)="$event.stopPropagation()">
        @if (emojiSearchQuery()) {
        <button mat-icon-button class="clear-search" (click)="emojiSearchQuery.set(''); $event.stopPropagation()">
          <mat-icon>close</mat-icon>
        </button>
        }
      </div>

      <!-- Search results -->
      @if (emojiSearchQuery()) {
      <div class="search-results">
        <div class="emoji-grid">
          @for (emoji of searchResults()?.unicode || []; track emoji) {
          <button mat-icon-button class="emoji-button" 
            [class.selected]="userReaction()?.event?.content === emoji"
            (click)="addReaction(emoji); $event.stopPropagation()" 
            [disabled]="isLoadingReactions()">
            {{ emoji }}
          </button>
          }
          @for (emoji of searchResults()?.custom || []; track emoji.shortcode) {
          <button mat-icon-button class="emoji-button custom-emoji"
            [class.selected]="userReaction()?.event?.content === ':' + emoji.shortcode + ':'"
            (click)="addReaction(':' + emoji.shortcode + ':'); $event.stopPropagation()"
            [disabled]="isLoadingReactions()" [matTooltip]="emoji.shortcode">
            <img [src]="emoji.url" [alt]="emoji.shortcode" class="custom-emoji-img">
          </button>
          }
        </div>
        @if (!searchResults()?.unicode?.length && !searchResults()?.custom?.length) {
        <div class="no-results">No emojis found</div>
        }
      </div>
      } @else {
      <!-- Category tabs with icons -->
      <mat-tab-group [selectedIndex]="activeTabIndex()" (selectedIndexChange)="activeTabIndex.set($event)"
        class="emoji-category-tabs">
        
        <!-- Recent/Frequently used tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon matTooltip="Recent">schedule</mat-icon>
          </ng-template>
          <div class="emoji-tab-content">
            @if (recentEmojis().length > 0) {
            <div class="emoji-grid">
              @for (recent of recentEmojis(); track recent.emoji) {
              <button mat-icon-button class="emoji-button"
                [class.selected]="userReaction()?.event?.content === recent.emoji"
                (click)="addReaction(recent.emoji); $event.stopPropagation()" 
                [disabled]="isLoadingReactions()"
                [matTooltip]="recent.emoji.startsWith(':') ? recent.emoji.slice(1, -1) : ''">
                @if (recent.url) {
                <img [src]="recent.url" [alt]="recent.emoji" class="custom-emoji-img">
                } @else if (getCustomEmojiUrlByShortcode(recent.emoji)) {
                <img [src]="getCustomEmojiUrlByShortcode(recent.emoji)!" [alt]="recent.emoji" class="custom-emoji-img">
                } @else {
                {{ recent.emoji }}
                }
              </button>
              }
            </div>
            } @else {
            <div class="empty-tab-message">
              <mat-icon>sentiment_satisfied</mat-icon>
              <span>Your recent emojis will appear here</span>
            </div>
            }
            <!-- Quick reactions as suggestions when no recent -->
            @if (recentEmojis().length === 0) {
            <div class="quick-suggestions">
              <div class="section-label">Popular</div>
              <div class="emoji-grid">
                @for (emoji of quickReactions; track emoji) {
                <button mat-icon-button class="emoji-button"
                  (click)="addReaction(emoji); $event.stopPropagation()" 
                  [disabled]="isLoadingReactions()">
                  {{ emoji }}
                </button>
                }
              </div>
            </div>
            }
            <!-- Link to emoji collections -->
            <div class="emoji-collections-link">
              <a routerLink="/collections/emojis" (click)="closeMenu()">
                <mat-icon>add_circle_outline</mat-icon>
                <span i18n="@@reaction-button.get-more-emojis">Get more emojis</span>
              </a>
            </div>
          </div>
        </mat-tab>

        <!-- Unicode emoji category tabs -->
        @for (category of emojiCategories; track category.id) {
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon [matTooltip]="category.label">{{ category.icon }}</mat-icon>
          </ng-template>
          <div class="emoji-tab-content">
            <div class="emoji-grid">
              @for (emoji of category.emojis; track emoji) {
              <button mat-icon-button class="emoji-button" 
                [class.selected]="userReaction()?.event?.content === emoji"
                (click)="addReaction(emoji); $event.stopPropagation()" 
                [disabled]="isLoadingReactions()">
                {{ emoji }}
              </button>
              }
            </div>
          </div>
        </mat-tab>
        }

        <!-- Custom emoji sets tab -->
        @if (emojiSets().length > 0) {
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon matTooltip="Custom Emojis">add_reaction</mat-icon>
          </ng-template>
          <div class="emoji-tab-content custom-emojis-tab">
            @for (set of emojiSets(); track set.id) {
            <div class="emoji-set-section">
              <div class="set-title">{{ set.title }}</div>
              <div class="emoji-grid">
                @for (emoji of set.emojis; track emoji.shortcode) {
                <button mat-icon-button class="emoji-button custom-emoji"
                  [class.selected]="userReaction()?.event?.content === ':' + emoji.shortcode + ':'"
                  (click)="addReaction(':' + emoji.shortcode + ':'); $event.stopPropagation()"
                  [disabled]="isLoadingReactions()" [matTooltip]="emoji.shortcode">
                  <img [src]="emoji.url" [alt]="emoji.shortcode" class="custom-emoji-img">
                </button>
                }
              </div>
            </div>
            }
          </div>
        </mat-tab>
        }
      </mat-tab-group>
      }
    </div>
  </mat-menu>
  } @else {
  <!-- Full view with reaction groups -->
  <div class="reaction-full-view">
    <!-- Main reaction button -->
    <button mat-button [class.active]="!!userReaction()" [class.reacted]="!!userReaction()"
      [disabled]="isLoadingReactions()" [matMenuTriggerFor]="reactionMenuFull" #menuTriggerFull="matMenuTrigger"
      (click)="$event.stopPropagation()">
      @if (userReaction()) {
      @if (getCustomEmojiUrl(userReaction()!.event)) {
      <img [src]="getCustomEmojiUrl(userReaction()!.event)!" [alt]="userReaction()!.event.content"
        class="emoji-icon-img">
      } @else {
      <span class="emoji-icon">{{ getReactionDisplay(userReaction()!.event.content) }}</span>
      }
      Unlike
      } @else {
      <ng-container>
        <mat-icon>favorite_border</mat-icon>
        Like
      </ng-container>
      }
    </button>

    <!-- Reaction picker menu (full view) -->
    <mat-menu #reactionMenuFull="matMenu" class="reaction-picker-menu">
      <div class="emoji-picker-container" tabindex="-1" (click)="$event.stopPropagation()"
        (keydown)="$event.stopPropagation()">
        
        <!-- Search bar -->
        <div class="emoji-search">
          <mat-icon class="search-icon">search</mat-icon>
          <input type="text" 
            placeholder="Search emojis..." 
            [ngModel]="emojiSearchQuery()"
            (ngModelChange)="emojiSearchQuery.set($event)"
            (click)="$event.stopPropagation()">
          @if (emojiSearchQuery()) {
          <button mat-icon-button class="clear-search" (click)="emojiSearchQuery.set(''); $event.stopPropagation()">
            <mat-icon>close</mat-icon>
          </button>
          }
        </div>

        <!-- Search results -->
        @if (emojiSearchQuery()) {
        <div class="search-results">
          <div class="emoji-grid">
            @for (emoji of searchResults()?.unicode || []; track emoji) {
            <button mat-icon-button class="emoji-button" 
              [class.selected]="userReaction()?.event?.content === emoji"
              (click)="addReaction(emoji); $event.stopPropagation()" 
              [disabled]="isLoadingReactions()">
              {{ emoji }}
            </button>
            }
            @for (emoji of searchResults()?.custom || []; track emoji.shortcode) {
            <button mat-icon-button class="emoji-button custom-emoji"
              [class.selected]="userReaction()?.event?.content === ':' + emoji.shortcode + ':'"
              (click)="addReaction(':' + emoji.shortcode + ':'); $event.stopPropagation()"
              [disabled]="isLoadingReactions()" [matTooltip]="emoji.shortcode">
              <img [src]="emoji.url" [alt]="emoji.shortcode" class="custom-emoji-img">
            </button>
            }
          </div>
          @if (!searchResults()?.unicode?.length && !searchResults()?.custom?.length) {
          <div class="no-results">No emojis found</div>
          }
        </div>
        } @else {
        <!-- Category tabs with icons -->
        <mat-tab-group [selectedIndex]="activeTabIndex()" (selectedIndexChange)="activeTabIndex.set($event)"
          class="emoji-category-tabs">
          
          <!-- Recent/Frequently used tab -->
          <mat-tab>
            <ng-template mat-tab-label>
              <mat-icon matTooltip="Recent">schedule</mat-icon>
            </ng-template>
            <div class="emoji-tab-content">
              @if (recentEmojis().length > 0) {
              <div class="emoji-grid">
                @for (recent of recentEmojis(); track recent.emoji) {
                <button mat-icon-button class="emoji-button"
                  [class.selected]="userReaction()?.event?.content === recent.emoji"
                  (click)="addReaction(recent.emoji); $event.stopPropagation()" 
                  [disabled]="isLoadingReactions()"
                  [matTooltip]="recent.emoji.startsWith(':') ? recent.emoji.slice(1, -1) : ''">
                  @if (recent.url) {
                  <img [src]="recent.url" [alt]="recent.emoji" class="custom-emoji-img">
                  } @else if (getCustomEmojiUrlByShortcode(recent.emoji)) {
                  <img [src]="getCustomEmojiUrlByShortcode(recent.emoji)!" [alt]="recent.emoji" class="custom-emoji-img">
                  } @else {
                  {{ recent.emoji }}
                  }
                </button>
                }
              </div>
              } @else {
              <div class="empty-tab-message">
                <mat-icon>sentiment_satisfied</mat-icon>
                <span>Your recent emojis will appear here</span>
              </div>
              }
              <!-- Quick reactions as suggestions when no recent -->
              @if (recentEmojis().length === 0) {
              <div class="quick-suggestions">
                <div class="section-label">Popular</div>
                <div class="emoji-grid">
                  @for (emoji of quickReactions; track emoji) {
                  <button mat-icon-button class="emoji-button"
                    (click)="addReaction(emoji); $event.stopPropagation()" 
                    [disabled]="isLoadingReactions()">
                    {{ emoji }}
                  </button>
                  }
                </div>
              </div>
              }
              <!-- Link to emoji collections -->
              <div class="emoji-collections-link">
                <a routerLink="/collections/emojis" (click)="closeMenu()">
                  <mat-icon>add_circle_outline</mat-icon>
                  <span i18n="@@reaction-button.get-more-emojis">Get more emojis</span>
                </a>
              </div>
            </div>
          </mat-tab>

          <!-- Unicode emoji category tabs -->
          @for (category of emojiCategories; track category.id) {
          <mat-tab>
            <ng-template mat-tab-label>
              <mat-icon [matTooltip]="category.label">{{ category.icon }}</mat-icon>
            </ng-template>
            <div class="emoji-tab-content">
              <div class="emoji-grid">
                @for (emoji of category.emojis; track emoji) {
                <button mat-icon-button class="emoji-button" 
                  [class.selected]="userReaction()?.event?.content === emoji"
                  (click)="addReaction(emoji); $event.stopPropagation()" 
                  [disabled]="isLoadingReactions()">
                  {{ emoji }}
                </button>
                }
              </div>
            </div>
          </mat-tab>
          }

          <!-- Custom emoji sets tab -->
          @if (emojiSets().length > 0) {
          <mat-tab>
            <ng-template mat-tab-label>
              <mat-icon matTooltip="Custom Emojis">add_reaction</mat-icon>
            </ng-template>
            <div class="emoji-tab-content custom-emojis-tab">
              @for (set of emojiSets(); track set.id) {
              <div class="emoji-set-section">
                <div class="set-title">{{ set.title }}</div>
                <div class="emoji-grid">
                  @for (emoji of set.emojis; track emoji.shortcode) {
                  <button mat-icon-button class="emoji-button custom-emoji"
                    [class.selected]="userReaction()?.event?.content === ':' + emoji.shortcode + ':'"
                    (click)="addReaction(':' + emoji.shortcode + ':'); $event.stopPropagation()"
                    [disabled]="isLoadingReactions()" [matTooltip]="emoji.shortcode">
                    <img [src]="emoji.url" [alt]="emoji.shortcode" class="custom-emoji-img">
                  </button>
                  }
                </div>
              </div>
              }
            </div>
          </mat-tab>
          }
        </mat-tab-group>
        }
      </div>
    </mat-menu>
  </div>

  <!-- Display reaction groups as chips -->
  @if (reactionGroups().length > 0) {
  <div class="reaction-chips">
    @for (group of reactionGroups(); track group.content) {
    <button class="reaction-chip" [class.user-reacted]="group.userReacted"
      [matTooltip]="group.count + ' reaction' + (group.count > 1 ? 's' : '')"
      (click)="addReaction(group.content); $event.stopPropagation()">
      @if (group.content.startsWith(':') && group.content.endsWith(':')) {
        @if (getCustomEmojiUrlForGroup(group.content); as emojiUrl) {
          <img [src]="emojiUrl" [alt]="group.content" class="reaction-emoji-img">
        } @else {
          <span class="reaction-emoji">{{ group.content }}</span>
        }
      } @else {
        <span class="reaction-emoji">{{ getReactionDisplay(group.content) }}</span>
      }
      <span class="reaction-chip-count">{{ group.count }}</span>
    </button>
    }
  </div>
  }
  }
</div>

@if (showSigningErrorDialog()) {
<app-custom-dialog
  [title]="'Signing Error'"
  [width]="'480px'"
  (closed)="closeSigningErrorDialog()">

  <div dialog-content>
    <div class="signing-error-content">
      <mat-icon class="signing-error-icon">error_outline</mat-icon>
      <p class="signing-error-description">
        Your browser extension for signing Nostr events could not be reached. This can happen if:
      </p>
      <ul class="signing-error-reasons">
        <li>The extension (e.g. Alby, nos2x) has been disabled or uninstalled</li>
        <li>The extension is not responding</li>
        <li>The browser was updated and the extension needs to be re-enabled</li>
      </ul>
      <p class="signing-error-suggestion">
        Please check that your NIP-07 signing extension is installed and enabled, then try again.
        Alternatively, you can log out and log back in using your nsec key.
      </p>
    </div>
  </div>

  <div dialog-actions>
    <button mat-flat-button (click)="closeSigningErrorDialog()">Close</button>
  </div>
</app-custom-dialog>
}
