<div class="reaction-container">
  @if (view() === 'icon') {
  <!-- Icon view with reaction picker -->
  <button mat-icon-button [class.active]="!!userReaction()" [class.reacted]="!!userReaction()"
    [disabled]="isLoadingReactions()" [matMenuTriggerFor]="reactionMenu" #menuTrigger="matMenuTrigger"
    (click)="$event.stopPropagation()" matTooltip="React" matTooltipPosition="below">
    @if (userReaction()) {
    @if (getCustomEmojiUrl(userReaction()!.event)) {
    <img [src]="getCustomEmojiUrl(userReaction()!.event)!" [alt]="userReaction()!.event.content" class="emoji-icon-img">
    } @else {
    <span class="emoji-icon">{{ getReactionDisplay(userReaction()!.event.content) }}</span>
    }
    } @else {
    <mat-icon>favorite_border</mat-icon>
    }
  </button>

  <!-- Reaction picker menu -->
  <mat-menu #reactionMenu="matMenu" class="reaction-picker-menu">
    <div class="emoji-picker-container" tabindex="-1" (click)="$event.stopPropagation()"
      (keydown)="$event.stopPropagation()">
      <!-- Quick reactions row -->
      <div class="quick-reactions">
        @for (emoji of quickReactions; track emoji) {
        <button mat-icon-button class="emoji-button" [class.selected]="userReaction()?.event?.content === emoji"
          (click)="addReaction(emoji); $event.stopPropagation()" [disabled]="isLoadingReactions()">
          {{ emoji }}
        </button>
        }
      </div>

      <!-- Recent emojis section -->
      @if (recentEmojis().length > 0) {
      <div class="emoji-section">
        <div class="section-header">Recent</div>
        <div class="emoji-grid">
          @for (recent of recentEmojis(); track recent.emoji) {
          <button mat-icon-button class="emoji-button"
            [class.selected]="userReaction()?.event?.content === recent.emoji"
            (click)="addReaction(recent.emoji); $event.stopPropagation()" [disabled]="isLoadingReactions()"
            [matTooltip]="recent.emoji.startsWith(':') ? recent.emoji.slice(1, -1) : ''">
            @if (recent.url) {
            <img [src]="recent.url" [alt]="recent.emoji" class="custom-emoji-img">
            } @else if (getCustomEmojiUrlByShortcode(recent.emoji)) {
            <img [src]="getCustomEmojiUrlByShortcode(recent.emoji)!" [alt]="recent.emoji" class="custom-emoji-img">
            } @else {
            {{ recent.emoji }}
            }
          </button>
          }
        </div>
      </div>
      }

      <!-- Custom emoji sets tabs -->
      @if (emojiSets().length > 0) {
      <div class="emoji-sets-container">
        <mat-tab-group [selectedIndex]="activeTabIndex()" (selectedIndexChange)="activeTabIndex.set($event)"
          class="emoji-tabs">
          @for (set of emojiSets(); track set.id) {
          <mat-tab [label]="set.title">
            <div class="emoji-grid">
              @for (emoji of set.emojis; track emoji.shortcode) {
              <button mat-icon-button class="emoji-button custom-emoji"
                [class.selected]="userReaction()?.event?.content === ':' + emoji.shortcode + ':'"
                (click)="addReaction(':' + emoji.shortcode + ':'); $event.stopPropagation()"
                [disabled]="isLoadingReactions()" [matTooltip]="emoji.shortcode">
                <img [src]="emoji.url" [alt]="emoji.shortcode" class="custom-emoji-img">
              </button>
              }
            </div>
          </mat-tab>
          }
        </mat-tab-group>
      </div>
      } @else if (customEmojis().length > 0) {
      <!-- Fallback: show all custom emojis in a single grid if no sets loaded -->
      <div class="emoji-section">
        <div class="section-header">Custom Emojis</div>
        <div class="emoji-grid">
          @for (emoji of customEmojis(); track emoji.shortcode) {
          <button mat-icon-button class="emoji-button custom-emoji"
            [class.selected]="userReaction()?.event?.content === ':' + emoji.shortcode + ':'"
            (click)="addReaction(':' + emoji.shortcode + ':'); $event.stopPropagation()"
            [disabled]="isLoadingReactions()" [matTooltip]="emoji.shortcode">
            <img [src]="emoji.url" [alt]="emoji.shortcode" class="custom-emoji-img">
          </button>
          }
        </div>
      </div>
      }
    </div>
  </mat-menu>
  } @else {
  <!-- Full view with reaction groups -->
  <div class="reaction-full-view">
    <!-- Main reaction button -->
    <button mat-button [class.active]="!!userReaction()" [class.reacted]="!!userReaction()"
      [disabled]="isLoadingReactions()" [matMenuTriggerFor]="reactionMenuFull" #menuTriggerFull="matMenuTrigger"
      (click)="$event.stopPropagation()">
      @if (userReaction()) {
      @if (getCustomEmojiUrl(userReaction()!.event)) {
      <img [src]="getCustomEmojiUrl(userReaction()!.event)!" [alt]="userReaction()!.event.content"
        class="emoji-icon-img">
      } @else {
      <span class="emoji-icon">{{ getReactionDisplay(userReaction()!.event.content) }}</span>
      }
      Unlike
      } @else {
      <ng-container>
        <mat-icon>favorite_border</mat-icon>
        Like
      </ng-container>
      }
    </button>

    <!-- Reaction picker menu (full view) -->
    <mat-menu #reactionMenuFull="matMenu" class="reaction-picker-menu">
      <div class="emoji-picker-container" tabindex="-1" (click)="$event.stopPropagation()"
        (keydown)="$event.stopPropagation()">
        <!-- Quick reactions row -->
        <div class="quick-reactions">
          @for (emoji of quickReactions; track emoji) {
          <button mat-icon-button class="emoji-button" [class.selected]="userReaction()?.event?.content === emoji"
            (click)="addReaction(emoji); $event.stopPropagation()" [disabled]="isLoadingReactions()">
            {{ emoji }}
          </button>
          }
        </div>

        <!-- Recent emojis section -->
        @if (recentEmojis().length > 0) {
        <div class="emoji-section">
          <div class="section-header">Recent</div>
          <div class="emoji-grid">
            @for (recent of recentEmojis(); track recent.emoji) {
            <button mat-icon-button class="emoji-button"
              [class.selected]="userReaction()?.event?.content === recent.emoji"
              (click)="addReaction(recent.emoji); $event.stopPropagation()" [disabled]="isLoadingReactions()"
              [matTooltip]="recent.emoji.startsWith(':') ? recent.emoji.slice(1, -1) : ''">
              @if (recent.url) {
              <img [src]="recent.url" [alt]="recent.emoji" class="custom-emoji-img">
              } @else if (getCustomEmojiUrlByShortcode(recent.emoji)) {
              <img [src]="getCustomEmojiUrlByShortcode(recent.emoji)!" [alt]="recent.emoji" class="custom-emoji-img">
              } @else {
              {{ recent.emoji }}
              }
            </button>
            }
          </div>
        </div>
        }

        <!-- Custom emoji sets tabs -->
        @if (emojiSets().length > 0) {
        <div class="emoji-sets-container">
          <mat-tab-group [selectedIndex]="activeTabIndex()" (selectedIndexChange)="activeTabIndex.set($event)"
            class="emoji-tabs">
            @for (set of emojiSets(); track set.id) {
            <mat-tab [label]="set.title">
              <div class="emoji-grid">
                @for (emoji of set.emojis; track emoji.shortcode) {
                <button mat-icon-button class="emoji-button custom-emoji"
                  [class.selected]="userReaction()?.event?.content === ':' + emoji.shortcode + ':'"
                  (click)="addReaction(':' + emoji.shortcode + ':'); $event.stopPropagation()"
                  [disabled]="isLoadingReactions()" [matTooltip]="emoji.shortcode">
                  <img [src]="emoji.url" [alt]="emoji.shortcode" class="custom-emoji-img">
                </button>
                }
              </div>
            </mat-tab>
            }
          </mat-tab-group>
        </div>
        } @else if (customEmojis().length > 0) {
        <!-- Fallback: show all custom emojis in a single grid if no sets loaded -->
        <div class="emoji-section">
          <div class="section-header">Custom Emojis</div>
          <div class="emoji-grid">
            @for (emoji of customEmojis(); track emoji.shortcode) {
            <button mat-icon-button class="emoji-button custom-emoji"
              [class.selected]="userReaction()?.event?.content === ':' + emoji.shortcode + ':'"
              (click)="addReaction(':' + emoji.shortcode + ':'); $event.stopPropagation()"
              [disabled]="isLoadingReactions()" [matTooltip]="emoji.shortcode">
              <img [src]="emoji.url" [alt]="emoji.shortcode" class="custom-emoji-img">
            </button>
            }
          </div>
        </div>
        }
      </div>
    </mat-menu>
  </div>

  <!-- Display reaction groups as chips -->
  @if (reactionGroups().length > 0) {
  <div class="reaction-chips">
    @for (group of reactionGroups(); track group.content) {
    <button class="reaction-chip" [class.user-reacted]="group.userReacted"
      [matTooltip]="group.count + ' reaction' + (group.count > 1 ? 's' : '')"
      (click)="addReaction(group.content); $event.stopPropagation()">
      @if (group.content.startsWith(':') && group.content.endsWith(':')) {
        @if (getCustomEmojiUrlForGroup(group.content); as emojiUrl) {
          <img [src]="emojiUrl" [alt]="group.content" class="reaction-emoji-img">
        } @else {
          <span class="reaction-emoji">{{ group.content }}</span>
        }
      } @else {
      <span class="reaction-emoji">{{ getReactionDisplay(group.content) }}</span>
      }
      <span class="reaction-chip-count">{{ group.count }}</span>
    </button>
    }
  </div>
  }
  }
</div>
