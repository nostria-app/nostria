@let item = record();
@let targetItem = repostedRecord() || item;
@let repostedEvent = repostedRecord()?.event;
@let parentRecordData = parentRecord();
@let rootRecordData = rootRecord();

@if (isLoadingEvent()) {
<div class="loading-container">
  <mat-spinner diameter="32"></mat-spinner>
  <p class="loading-text">Loading event...</p>
</div>
} @else if (isAuthorMuted()) {
<!-- Don't render events from muted/blocked accounts at all -->
} @else if (targetItem && item) {
<mat-card class="note-card" [class.plain]="isPlain()" [class.clickable]="isCardClickable()" appearance="outlined"
  [class.selected]="isCurrentlySelected()" [attr.tabindex]="isCardClickable() ? 0 : null"
  [style.cursor]="isCardClickable() ? 'pointer' : 'auto'" (click)="onCardClick($event)">
  @if (repostedEvent) {
  <!-- Repost structure -->
  <mat-card-header class="repost-header">
    <mat-icon>repeat</mat-icon>
    <span>
      <app-profile-display-name [pubkey]="item.event.pubkey"></app-profile-display-name>
      reposted
      <span [matTooltip]="item.event.created_at * 1000 | date: 'medium'" matTooltipPosition="below">
        {{ item.event.created_at | ago }}
      </span>
    </span>
    <app-event-menu [event]="item.event" class="note-footer-right"></app-event-menu>
  </mat-card-header>

  <app-event-header [event]="repostService.decodeRepost(item.event).event"></app-event-header>
  <mat-card-content>
    @if (targetItem.event.kind === 20) {
    <app-photo-event [event]="targetItem.event" [hideComments]="hideComments()" [showOverlay]="showOverlay()"
      [allMediaEvents]="allMediaEvents()" [mediaEventIndex]="mediaEventIndex()"></app-photo-event>
    }
    <!-- Videos (NIP-71, kind 21/22/34235/34236) -->
    @else if (targetItem.event.kind === 21 || targetItem.event.kind === 22 || targetItem.event.kind === 34235 ||
    targetItem.event.kind === 34236) {
    <app-video-event [event]="targetItem.event" [hideComments]="hideComments()" [showOverlay]="showOverlay()"
      [allMediaEvents]="allMediaEvents()" [mediaEventIndex]="mediaEventIndex()"></app-video-event>
    }
    <!-- Audio (kind 1222, 1244) -->
    @else if (targetItem.event.kind === 1222 || targetItem.event.kind === 1244) {
    <app-audio-event [event]="targetItem.event" [hideComments]="hideComments()"></app-audio-event>
    }
    <!-- Articles (kind 30023) -->
    @else if (targetItem.event.kind === 30023) {
    <app-article-event [event]="targetItem.event"></app-article-event>
    }
    <!-- Polls (kind 1068) -->
    @else if (targetItem.event.kind === 1068) {
    <app-poll-event [event]="targetItem.event"></app-poll-event>
    }
    <!-- M3U Playlists (kind 32100) -->
    @else if (targetItem.event.kind === 32100) {
    <app-playlist-event [event]="targetItem.event"></app-playlist-event>
    }
    <!-- Starter Packs (kind 39089) -->
    @else if (targetItem.event.kind === 39089) {
    <app-starter-pack-event [event]="targetItem.event"></app-starter-pack-event>
    }
    <!-- Live Events (kind 30311) -->
    @else if (targetItem.event.kind === 30311) {
    <app-live-event [event]="targetItem.event"></app-live-event>
    }
    <!-- Profile events (kind 0) -->
    @else if (targetItem.event.kind === 0) {
    <app-user-profile [view]="'details'" [event]="targetItem.event"></app-user-profile>
    } @else {
    <app-content [content]="repostService.decodeRepost(item.event).data"
      [event]="repostService.decodeRepost(item.event).event"></app-content>
    }
  </mat-card-content>

  } @else if (isReply() && (parentRecordData || rootRecordData)) {
  <!-- Reply structure with thread context -->
  @if (mode() === 'timeline') {
  <mat-card-header class="reply-header">
    <mat-icon>reply</mat-icon>
    <span>
      <app-profile-display-name [pubkey]="item.event.pubkey"></app-profile-display-name>
      @if (isThreadedReply()) {
      replied in thread
      } @else {
      replied to
      }
    </span>
  </mat-card-header>
  }
  <!-- Show thread context only in timeline mode -->
  @if (mode() === 'timeline' && !hideParentEvent()) {
  <mat-card-content>
    <!-- Show root event if this is a threaded reply OR a direct reply to root -->
    @if ((isThreadedReply() && rootRecordData && parentRecordData) || (!isThreadedReply() && rootRecordData)) {
    <!-- Root event (original post) -->
    <div class="thread-context">
      @if (isThreadedReply()) {
      <!-- <h4 class="thread-label">Original Post</h4> -->
      } @else {
      <!-- <h4 class="thread-label">Replying to</h4> -->
      }
      <mat-card appearance="outlined" class="root-event" [style.cursor]="isRootCardClickable() ? 'pointer' : 'auto'"
        (click)="onRootEventClick($event)">
        <app-event-header [event]="rootRecordData.event" [compact]="true"></app-event-header>
        <mat-card-content [class.collapsed]="!isRootEventExpanded()">
          @if (rootRecordData.event.kind === 20) {
          <app-photo-event [event]="rootRecordData.event" [hideComments]="hideComments()" [showOverlay]="showOverlay()"
            [allMediaEvents]="allMediaEvents()" [mediaEventIndex]="mediaEventIndex()"></app-photo-event>
          }
          <!-- Videos (NIP-71, kind 21/22/34235/34236) -->
          @else if (rootRecordData.event.kind === 21 || rootRecordData.event.kind === 22 || rootRecordData.event.kind
          === 34235 || rootRecordData.event.kind === 34236) {
          <app-video-event [event]="rootRecordData.event" [hideComments]="hideComments()" [showOverlay]="showOverlay()"
            [allMediaEvents]="allMediaEvents()" [mediaEventIndex]="mediaEventIndex()"></app-video-event>
          }
          <!-- Audio (kind 1222, 1244) -->
          @else if (rootRecordData.event.kind === 1222 || rootRecordData.event.kind === 1244) {
          <app-audio-event [event]="rootRecordData.event" [hideComments]="hideComments()"></app-audio-event>
          }
          <!-- Articles (kind 30023) -->
          @else if (rootRecordData.event.kind === 30023) {
          <app-article-event [event]="rootRecordData.event"></app-article-event>
          }
          <!-- Polls (kind 1068) -->
          @else if (rootRecordData.event.kind === 1068) {
          <app-poll-event [event]="rootRecordData.event"></app-poll-event>
          }
          <!-- M3U Playlists (kind 32100) -->
          @else if (rootRecordData.event.kind === 32100) {
          <app-playlist-event [event]="rootRecordData.event"></app-playlist-event>
          }
          <!-- Starter Packs (kind 39089) -->
          @else if (rootRecordData.event.kind === 39089) {
          <app-starter-pack-event [event]="rootRecordData.event"></app-starter-pack-event>
          }
          <!-- Live Events (kind 30311) -->
          @else if (rootRecordData.event.kind === 30311) {
          <app-live-event [event]="rootRecordData.event"></app-live-event>
          }
          <!-- Profile events (kind 0) -->
          @else if (rootRecordData.event.kind === 0) {
          <app-user-profile [view]="'details'" [event]="rootRecordData.event"></app-user-profile>
          } @else {
          <app-content [content]="rootRecordData.data" [event]="rootRecordData.event"></app-content>
          }
        </mat-card-content>
        @if (!isRootEventExpanded()) {
        <button mat-button class="show-more-btn" (click)="onExpandClick($event, isRootEventExpanded, true)">
          <mat-icon>expand_more</mat-icon>
          Show more
        </button>
        } @else {
        <button mat-button class="show-less-btn" (click)="onExpandClick($event, isRootEventExpanded, false)">
          <mat-icon>expand_less</mat-icon>
          Show less
        </button>
        }
      </mat-card>
    </div>

    <!-- Thread indicator (only show for threaded replies with both root and parent) -->
    <!-- @if (isThreadedReply()) {
    <div class="thread-indicator">
      <hr />
      <span>Thread continues</span>
      <hr />
    </div>
    } -->
    }

    <!-- Immediate parent event (what this is replying to) -->
    <!-- Only show parent if it exists and is different from root -->
    @if (parentRecordData && isThreadedReply() && !hideParentEvent()) {
    <div class="reply-context">
      @if (isThreadedReply()) {
      <!-- <h4 class="thread-label">Replying to</h4> -->
      }
      <mat-card appearance="outlined" class="parent-event" [style.cursor]="isParentCardClickable() ? 'pointer' : 'auto'"
        (click)="onParentEventClick($event)">
        <app-event-header [event]="parentRecordData.event" [compact]="true"></app-event-header>
        <mat-card-content [class.collapsed]="!isParentEventExpanded()">
          @if (parentRecordData.event.kind === 20) {
          <app-photo-event [event]="parentRecordData.event" [hideComments]="hideComments()"
            [showOverlay]="showOverlay()" [allMediaEvents]="allMediaEvents()"
            [mediaEventIndex]="mediaEventIndex()"></app-photo-event>
          }
          <!-- Videos (NIP-71, kind 21/22/34235/34236) -->
          @else if (
          parentRecordData.event.kind === 21 || parentRecordData.event.kind === 22 || parentRecordData.event.kind ===
          34235 || parentRecordData.event.kind === 34236
          ) {
          <app-video-event [event]="parentRecordData.event" [hideComments]="hideComments()"
            [showOverlay]="showOverlay()" [allMediaEvents]="allMediaEvents()"
            [mediaEventIndex]="mediaEventIndex()"></app-video-event>
          }
          <!-- Audio (kind 1222, 1244) -->
          @else if (parentRecordData.event.kind === 1222 || parentRecordData.event.kind === 1244) {
          <app-audio-event [event]="parentRecordData.event" [hideComments]="hideComments()"></app-audio-event>
          }
          <!-- Articles (kind 30023) -->
          @else if (parentRecordData.event.kind === 30023) {
          <app-article-event [event]="parentRecordData.event"></app-article-event>
          }
          <!-- Polls (kind 1068) -->
          @else if (parentRecordData.event.kind === 1068) {
          <app-poll-event [event]="parentRecordData.event"></app-poll-event>
          }
          <!-- M3U Playlists (kind 32100) -->
          @else if (parentRecordData.event.kind === 32100) {
          <app-playlist-event [event]="parentRecordData.event"></app-playlist-event>
          }
          <!-- Starter Packs (kind 39089) -->
          @else if (parentRecordData.event.kind === 39089) {
          <app-starter-pack-event [event]="parentRecordData.event"></app-starter-pack-event>
          }
          <!-- Live Events (kind 30311) -->
          @else if (parentRecordData.event.kind === 30311) {
          <app-live-event [event]="parentRecordData.event"></app-live-event>
          }
          <!-- Profile events (kind 0) -->
          @else if (parentRecordData.event.kind === 0) {
          <app-user-profile [view]="'details'" [event]="parentRecordData.event"></app-user-profile>
          } @else {
          <app-content [content]="parentRecordData.data" [event]="parentRecordData.event"></app-content>
          }
        </mat-card-content>
        @if (!isParentEventExpanded()) {
        <button mat-button class="show-more-btn" (click)="onExpandClick($event, isParentEventExpanded, true)">
          <mat-icon>expand_more</mat-icon>
          Show more
        </button>
        } @else {
        <button mat-button class="show-less-btn" (click)="onExpandClick($event, isParentEventExpanded, false)">
          <mat-icon>expand_less</mat-icon>
          Show less
        </button>
        }
      </mat-card>
    </div>
    }
  </mat-card-content>
  }

  <!-- Current event (the reply) -->
  <app-event-header [event]="item.event"></app-event-header>
  <mat-card-content>
    @if (shouldHideContentDueToWarning()) {
    <app-content-warning [reason]="contentWarningReason()" (approve)="approveContentWarning()"></app-content-warning>
    } @else if (shouldHideContent()) {
    <app-reported-content [event]="item.event"></app-reported-content>
    } @else {
    @if (item.event.kind === 20) {
    <app-photo-event [event]="item.event" [hideComments]="hideComments()" [showOverlay]="showOverlay()"
      [allMediaEvents]="allMediaEvents()" [mediaEventIndex]="mediaEventIndex()"></app-photo-event>
    }
    <!-- Videos (NIP-71, kind 21/22/34235/34236) -->
    @else if (item.event.kind === 21 || item.event.kind === 22 || item.event.kind === 34235 || item.event.kind ===
    34236) {
    <app-video-event [event]="item.event" [hideComments]="hideComments()" [showOverlay]="showOverlay()"
      [allMediaEvents]="allMediaEvents()" [mediaEventIndex]="mediaEventIndex()"></app-video-event>
    }
    <!-- Audio (kind 1222, 1244) -->
    @else if (item.event.kind === 1222 || item.event.kind === 1244) {
    <app-audio-event [event]="item.event" [hideComments]="hideComments()"></app-audio-event>
    }
    <!-- Articles (kind 30023) -->
    @else if (item.event.kind === 30023) {
    <app-article-event [event]="item.event"></app-article-event>
    }
    <!-- Polls (kind 1068) -->
    @else if (item.event.kind === 1068) {
    <app-poll-event [event]="item.event"></app-poll-event>
    }
    @else if (item.event.kind === 3) {
    <div class="following-event">
      <mat-icon>people</mat-icon>
      <span>Following {{ followingCount() }} accounts</span>
    </div>
    }
    <!-- M3U Playlists (kind 32100) -->
    @else if (item.event.kind === 32100) {
    <app-playlist-event [event]="item.event"></app-playlist-event>
    } @else if (item.event.kind === 39089) {
    <!-- Starter Packs (kind 39089) -->
    <app-starter-pack-event [event]="item.event"></app-starter-pack-event>
    } @else if (item.event.kind === 8) {
    <app-badge [badge]="item.event"></app-badge>
    }
    <!-- Profile events (kind 0) -->
    @else if (item.event.kind === 0) {
    {{ item.data.about }}
    <!-- <app-user-profile [view]="'details'" [event]="item.event"></app-user-profile> -->
    } @else {
    <app-content [content]="item.data" [event]="item.event"></app-content>
    }
    }
  </mat-card-content>


  } @else {
  <!-- Normal event structure -->
  <app-event-header [event]="item.event"></app-event-header>
  <mat-card-content>
    @if (shouldHideContentDueToWarning()) {
    <app-content-warning [reason]="contentWarningReason()" (approve)="approveContentWarning()"></app-content-warning>
    } @else if (shouldHideContent()) {
    <app-reported-content [event]="item.event"></app-reported-content>
    } @else {
    @if (item.event.kind === 20) {
    <app-photo-event [event]="item.event" [hideComments]="hideComments()" [showOverlay]="showOverlay()"
      [allMediaEvents]="allMediaEvents()" [mediaEventIndex]="mediaEventIndex()"></app-photo-event>
    }
    <!-- Videos (NIP-71, kind 21/22/34235/34236) -->
    @else if (item.event.kind === 21 || item.event.kind === 22 || item.event.kind === 34235 || item.event.kind ===
    34236) {
    <app-video-event [event]="item.event" [hideComments]="hideComments()" [showOverlay]="showOverlay()"
      [allMediaEvents]="allMediaEvents()" [mediaEventIndex]="mediaEventIndex()"></app-video-event>
    }
    <!-- Audio (kind 1222, 1244) -->
    @else if (item.event.kind === 1222 || item.event.kind === 1244) {
    <app-audio-event [event]="item.event" [hideComments]="hideComments()"></app-audio-event>
    }
    <!-- Articles (kind 30023) -->
    @else if (item.event.kind === 30023) {
    <app-article-event [event]="item.event"></app-article-event>
    }
    <!-- Polls (kind 1068) -->
    @else if (item.event.kind === 1068) {
    <app-poll-event [event]="item.event"></app-poll-event>
    }
    @else if (item.event.kind === 3) {
    <div class="following-event">
      <mat-icon>people</mat-icon>
      <span>Following {{ followingCount() }} accounts</span>
    </div>
    }
    <!-- M3U Playlists (kind 32100) -->
    @else if (item.event.kind === 32100) {
    <app-playlist-event [event]="targetItem.event"></app-playlist-event>
    } @else if (item.event.kind === 39089) {
    <!-- Starter Packs (kind 39089) -->
    <app-starter-pack-event [event]="item.event"></app-starter-pack-event>
    } @else if (item.event.kind === 30311) {
    <!-- Live Events (kind 30311) -->
    <app-live-event [event]="item.event"></app-live-event>
    } @else if (item.event.kind === 8) {
    <app-badge [badge]="targetItem.event"></app-badge>
    }
    <!-- Profile events (kind 0) -->
    @else if (item.event.kind === 0) {
    {{ item.data.about }}
    <!-- <app-user-profile [view]="'details'" [event]="item.event"></app-user-profile> -->
    } @else {
    <app-content [content]="item.data" [event]="item.event"></app-content>
    }
    }
  </mat-card-content>
  }

  <!-- Zap Display -->
  <!-- @if (targetItem.event.kind === 1) {
  <app-zap-display [eventId]="targetItem.event.id"></app-zap-display>
  } -->

  @if (!hideFooter()) {
  <mat-card-actions class="note-footer">
    @if (item.event.kind === 1) {
    <div class="reactions-row" [class.compact]="compact()">
      <!-- Reply -->
      <div class="reaction-group">
        <app-reply-button [event]="targetItem.event"></app-reply-button>
        @if (!compact()) {
        <button mat-button class="count-button" disabled>
          <span>{{ replyCount() }}</span>
        </button>
        }
      </div>

      <!-- Repost -->
      <div class="reaction-group">
        <app-repost-button [event]="targetItem.event" [repostsFromParent]="reposts()"></app-repost-button>
        @if (!compact()) {
        <button mat-button class="count-button" (click)="openReactionsDialog('reposts'); $event.stopPropagation()">
          <span>{{ repostCount() }}</span>
        </button>
        }
      </div>

      <!-- Like -->
      <div class="reaction-group">
        <button mat-icon-button class="like-button" [ngClass]="{
                  active: !!likeReaction(),
                  liked: !!likeReaction()
                }" [disabled]="isLoadingReactions()" (click)="toggleLike($event)">
          <mat-icon>favorite</mat-icon>
        </button>
        @if (!compact()) {
        <button mat-button class="count-button" (click)="openReactionsDialog('likes'); $event.stopPropagation()">
          <span>{{ likes().length }}</span>
        </button>
        }
      </div>

      <!-- Zap -->
      <div class="reaction-group">
        <app-zap-button [event]="targetItem.event" [recipientPubkey]="targetItem.event.pubkey"
          (zapSent)="onZapSent($event)">
        </app-zap-button>
        @if (!compact()) {
        <button mat-button class="count-button" (click)="openReactionsDialog('zaps'); $event.stopPropagation()">
          @if (isLoadingZaps()) {
          <mat-spinner diameter="16"></mat-spinner>
          } @else {
          <span>
            @if (totalZapAmount() > 0) {
            {{ formatZapAmount(totalZapAmount()) }} sats
            } @else {
            0
            }
          </span>
          }
        </button>
        }
      </div>

      <!-- View All button (compact mode only) -->
      @if (compact()) {
      <button mat-icon-button class="view-all-button" (click)="openReactionsDialog('likes'); $event.stopPropagation()"
        matTooltip="View all reactions">
        <mat-icon>more_horiz</mat-icon>
      </button>
      }
    </div>
    }

    <div class="note-footer-right hide-small footer-right-group">
      @if (hasGeohash(targetItem.event)) {
      <a [href]="getGeohashUrl(targetItem.event)" target="_blank" rel="noopener noreferrer" class="geohash-link"
        [matTooltip]="'Location: ' + getGeohash(targetItem.event)" matTooltipPosition="below"
        (click)="$event.stopPropagation()">
        <mat-icon>location_on</mat-icon>
      </a>
      }

      @if (hasProofOfWork(targetItem.event)) {
      <div class="pow-indicator" [matTooltip]="getProofOfWorkTooltip(targetItem.event)" matTooltipPosition="below">
        <mat-icon [class.pow-strong]="getProofOfWorkDifficulty(targetItem.event) >= 20">verified</mat-icon>
        <span class="pow-difficulty">{{ getProofOfWorkDifficulty(targetItem.event) }}</span>
      </div>
      }

      @if (shouldShowClientTag() && getClientTag(targetItem.event) && getClientLogo(getClientTag(targetItem.event))) {
      <div class="client-indicator"
        [matTooltip]="'Published with ' + getClientDisplayName(getClientTag(targetItem.event))"
        matTooltipPosition="below">
        <img [src]="getClientLogo(getClientTag(targetItem.event))"
          [alt]="getClientDisplayName(getClientTag(targetItem.event)) + ' logo'" class="client-logo" />
      </div>
      }

      <button mat-icon-button (click)="onBookmarkClick($event)">
        <mat-icon [matTooltip]="getBookmarkTooltip(targetItem.event)" matTooltipPosition="below">
          {{ getBookmarkIcon(targetItem.event) }}
        </mat-icon>
      </button>
    </div>
  </mat-card-actions>
  }
</mat-card>
} @else if (id() && !isLoadingEvent()) {
<div class="event-content">
  @if (loadingError()) {
  <p class="error-message">{{ loadingError() }}</p>
  } @else {
  <p>Event not found</p>
  }
</div>
}