@let item = record();
@let targetItem = repostedRecord() || item;
@let repostedEvent = repostedRecord()?.event;
@let parentRecordData = parentRecord();
@let rootRecordData = rootRecord();

@if (isLoadingEvent()) {
<div class="loading-container">
  <mat-spinner diameter="32"></mat-spinner>
  <p class="loading-text">Loading event...</p>
</div>
} @else if (isAuthorMuted()) {
<!-- Don't render events from muted/blocked accounts at all -->
} @else if (isRepostEvent() && isRepostedContentFiltered()) {
<!-- Don't render reposts where the original content is muted/blocked -->
} @else if (isRepostEvent() && !repostedEvent && isLoadingRepostedEvent()) {
<!-- Loading reposted event from relay hint -->
<mat-card class="note-card" [class.plain]="isPlain()" appearance="outlined">
  <mat-card-header class="repost-header">
    <mat-icon>repeat</mat-icon>
    <span>
      <app-profile-display-name [pubkey]="item!.event.pubkey"></app-profile-display-name>
      reposted
      <span [matTooltip]="item!.event.created_at | timestamp: 'medium'" matTooltipPosition="below">
        {{ item!.event.created_at | ago }}
      </span>
    </span>
    <app-event-menu [event]="item!.event" class="note-footer-right"></app-event-menu>
  </mat-card-header>
  <mat-card-content>
    <div class="loading-container">
      <mat-spinner diameter="24"></mat-spinner>
      <p class="loading-text">Loading reposted event...</p>
    </div>
  </mat-card-content>
</mat-card>
} @else if (isRepostEvent() && !repostedEvent && !isLoadingRepostedEvent()) {
<!-- Repost event but couldn't load the referenced event -->
<mat-card class="note-card" [class.plain]="isPlain()" appearance="outlined">
  <mat-card-header class="repost-header">
    <mat-icon>repeat</mat-icon>
    <span>
      <app-profile-display-name [pubkey]="item!.event.pubkey"></app-profile-display-name>
      reposted
      <span [matTooltip]="item!.event.created_at | timestamp: 'medium'" matTooltipPosition="below">
        {{ item!.event.created_at | ago }}
      </span>
    </span>
    <app-event-menu [event]="item!.event" class="note-footer-right"></app-event-menu>
  </mat-card-header>
  <mat-card-content>
    <p class="event-not-found">Could not load the reposted event</p>
  </mat-card-content>
</mat-card>
} @else if (targetItem && item) {
<mat-card class="note-card" [class.plain]="isPlain()" [class.clickable]="isCardClickable()" appearance="outlined"
  [class.selected]="isCurrentlySelected()" [attr.tabindex]="isCardClickable() ? 0 : null"
  [style.cursor]="isCardClickable() ? 'pointer' : 'auto'" (click)="onCardClick($event)">
  @if (repostedEvent) {
  <!-- Repost structure -->
  <mat-card-header class="repost-header">
    <mat-icon>repeat</mat-icon>
    <span>
      <app-profile-display-name [pubkey]="item.event.pubkey"></app-profile-display-name>
      reposted
      <span [matTooltip]="item.event.created_at | timestamp: 'medium'" matTooltipPosition="below">
        {{ item.event.created_at | ago }}
      </span>
    </span>
    <app-event-menu [event]="item.event" class="note-footer-right"></app-event-menu>
  </mat-card-header>

  @if (!hideHeader()) {
  <app-event-header [event]="repostedEvent" [isEdited]="isEdited()" [editedAt]="editedAt()"></app-event-header>
  }
  <mat-card-content>
    @if (targetItem.event.kind === 20) {
    <app-photo-event [event]="targetItem.event" [hideComments]="hideComments()" [showOverlay]="showOverlay()"
      [allMediaEvents]="allMediaEvents()" [mediaEventIndex]="mediaEventIndex()"
      [trustedByPubkey]="item.event.pubkey"></app-photo-event>
    }
    <!-- Videos (NIP-71, kind 21/22/34235/34236) -->
    @else if (targetItem.event.kind === 21 || targetItem.event.kind === 22 || targetItem.event.kind === 34235 ||
    targetItem.event.kind === 34236) {
    <app-video-event [event]="targetItem.event" [hideComments]="hideComments()" [showOverlay]="showOverlay()"
      [allMediaEvents]="allMediaEvents()" [mediaEventIndex]="mediaEventIndex()"
      [trustedByPubkey]="item.event.pubkey"></app-video-event>
    }
    <!-- Audio (kind 1222, 1244) -->
    @else if (targetItem.event.kind === 1222 || targetItem.event.kind === 1244) {
    <app-audio-event [event]="targetItem.event" [hideComments]="hideComments()"></app-audio-event>
    }
    <!-- Music Track (kind 36787) -->
    @else if (targetItem.event.kind === 36787) {
    <app-music-event [event]="targetItem.event"></app-music-event>
    }
    <!-- Articles (kind 30023) -->
    @else if (targetItem.event.kind === 30023) {
    <app-article-event [event]="targetItem.event"></app-article-event>
    }
    <!-- Polls (kind 1068) -->
    @else if (targetItem.event.kind === 1068) {
    <app-poll-event [event]="targetItem.event"></app-poll-event>
    }
    <!-- M3U Playlists (kind 32100) & Nostr Playlists (kind 34139) -->
    @else if (targetItem.event.kind === 32100 || targetItem.event.kind === 34139) {
    <app-playlist-event [event]="targetItem.event"></app-playlist-event>
    }
    <!-- Starter Packs (kind 39089) -->
    @else if (targetItem.event.kind === 39089) {
    <app-starter-pack-event [event]="targetItem.event"></app-starter-pack-event>
    }
    <!-- Emoji Sets (kind 30030) -->
    @else if (targetItem.event.kind === 30030) {
    <app-emoji-set-event [event]="targetItem.event"></app-emoji-set-event>
    }
    <!-- People Sets (kind 30000) -->
    @else if (targetItem.event.kind === 30000) {
    <app-people-set-event [event]="targetItem.event"></app-people-set-event>
    }
    <!-- Live Events (kind 30311) -->
    @else if (targetItem.event.kind === 30311) {
    <app-live-event [event]="targetItem.event"></app-live-event>
    }
    <!-- Profile events (kind 0) -->
    @else if (targetItem.event.kind === 0) {
    <app-profile-update-event [event]="targetItem.event"></app-profile-update-event>
    } @else {
    <div class="main-content-wrapper" [class.collapsed]="isMainContentCollapsed()">
      <app-content [content]="displayedRecord()?.data" [event]="targetItem.event"
        [trustedByPubkey]="trustedByPubkey() || item.event.pubkey" [disableExpansion]="navigationDisabled()"
        [inFeedsPanel]="inFeedsPanel()" [hideSocialPreviews]="isMainContentCollapsed()"></app-content>
    </div>
    @if (isMainContentLong()) {
    <!-- Images and URLs for collapsed content -->
    @if (!isMainContentExpanded()) {
    <button mat-button class="show-more-btn" (click)="onExpandClick($event, isMainContentExpanded, true)">
      <mat-icon>expand_more</mat-icon>
      Show more
    </button>
    @if (mainCollapsedMedia().images.length > 0) {
    <div class="collapsed-images">
      @if (mainCollapsedMedia().images.length === 1) {
      <img [src]="mainCollapsedMedia().images[0]" alt="Image" loading="lazy"
        (click)="onCollapsedImageClick($event, mainCollapsedMedia().images[0], mainCollapsedMedia().images)" />
      } @else {
      <div class="image-grid">
        @for (image of mainCollapsedMedia().images; track image) {
        <img [src]="image" alt="Image" loading="lazy"
          (click)="onCollapsedImageClick($event, image, mainCollapsedMedia().images)" />
        }
      </div>
      }
    </div>
    }
    @if (mainCollapsedMedia().videos.length > 0) {
    <div class="collapsed-videos" (click)="$event.stopPropagation()">
      <app-inline-video-player [src]="mainCollapsedMedia().videos[0].url"
        [poster]="mainCollapsedMedia().videos[0].poster"
        [style.aspect-ratio]="mainCollapsedMedia().videos[0].aspectRatio"></app-inline-video-player>
      @if (mainCollapsedMedia().videos.length > 1 && !collapsedVideosExpanded()) {
      <button mat-button class="show-more-videos-btn" (click)="toggleCollapsedVideos($event)">
        +{{ mainCollapsedMedia().videos.length - 1 }} more {{ mainCollapsedMedia().videos.length - 1 === 1 ? 'video' :
        'videos' }}
      </button>
      }
      @if (collapsedVideosExpanded()) {
      @for (video of mainCollapsedMedia().videos.slice(1); track video.url) {
      <app-inline-video-player [src]="video.url" [poster]="video.poster"
        [style.aspect-ratio]="video.aspectRatio"></app-inline-video-player>
      }
      }
    </div>
    }
    @if (mainCollapsedMedia().urls.length > 0) {
    <div class="collapsed-urls">
      @for (url of mainCollapsedMedia().urls; track url) {
      <app-social-preview [url]="url" [compact]="true"></app-social-preview>
      }
    </div>
    }
    }
    }
    }
  </mat-card-content>

  } @else if (isReply() && (parentRecordData || rootRecordData)) {
  <!-- Reply structure with thread context -->
  @if (mode() === 'timeline') {
  <mat-card-header class="reply-header">
    <mat-icon>reply</mat-icon>
    <span>
      <app-profile-display-name [pubkey]="item.event.pubkey"></app-profile-display-name>
      @if (isThreadedReply()) {
      replied in thread
      } @else {
      replied to
      }
    </span>
  </mat-card-header>
  }
  <!-- Show thread context only in timeline mode -->
  @if (mode() === 'timeline' && !hideParentEvent()) {
  <mat-card-content>
    <!-- Show root event if this is a threaded reply OR a direct reply to root -->
    @if ((isThreadedReply() && rootRecordData && parentRecordData) || (!isThreadedReply() && rootRecordData)) {
    <!-- Root event (original post) -->
    <div class="thread-context">
      @if (isThreadedReply()) {
      <!-- <h4 class="thread-label">Original Post</h4> -->
      } @else {
      <!-- <h4 class="thread-label">Replying to</h4> -->
      }
      <mat-card appearance="outlined" class="root-event" [style.cursor]="isRootCardClickable() ? 'pointer' : 'auto'"
        (click)="onRootEventClick($event)">
        @if (!hideHeader()) {
        <app-event-header [event]="rootRecordData.event" [compact]="true"></app-event-header>
        }
        <mat-card-content [class.collapsed]="isRootContentLong() && !isRootEventExpanded()">
          @if (rootRecordData.event.kind === 20) {
          <app-photo-event [event]="rootRecordData.event" [hideComments]="hideComments()" [showOverlay]="showOverlay()"
            [allMediaEvents]="allMediaEvents()" [mediaEventIndex]="mediaEventIndex()"></app-photo-event>
          }
          <!-- Videos (NIP-71, kind 21/22/34235/34236) -->
          @else if (rootRecordData.event.kind === 21 || rootRecordData.event.kind === 22 || rootRecordData.event.kind
          === 34235 || rootRecordData.event.kind === 34236) {
          <app-video-event [event]="rootRecordData.event" [hideComments]="hideComments()" [showOverlay]="showOverlay()"
            [allMediaEvents]="allMediaEvents()" [mediaEventIndex]="mediaEventIndex()"></app-video-event>
          }
          <!-- Audio (kind 1222, 1244) -->
          @else if (rootRecordData.event.kind === 1222 || rootRecordData.event.kind === 1244) {
          <app-audio-event [event]="rootRecordData.event" [hideComments]="hideComments()"></app-audio-event>
          }
          <!-- Music Track (kind 36787) -->
          @else if (rootRecordData.event.kind === 36787) {
          <app-music-event [event]="rootRecordData.event"></app-music-event>
          }
          <!-- Articles (kind 30023) -->
          @else if (rootRecordData.event.kind === 30023) {
          <app-article-event [event]="rootRecordData.event"></app-article-event>
          }
          <!-- Polls (kind 1068) -->
          @else if (rootRecordData.event.kind === 1068) {
          <app-poll-event [event]="rootRecordData.event"></app-poll-event>
          }
          <!-- M3U Playlists (kind 32100) & Nostr Playlists (kind 34139) -->
          @else if (rootRecordData.event.kind === 32100 || rootRecordData.event.kind === 34139) {
          <app-playlist-event [event]="rootRecordData.event"></app-playlist-event>
          }
          <!-- Starter Packs (kind 39089) -->
          @else if (rootRecordData.event.kind === 39089) {
          <app-starter-pack-event [event]="rootRecordData.event"></app-starter-pack-event>
          }
          <!-- People Sets (kind 30000) -->
          @else if (rootRecordData.event.kind === 30000) {
          <app-people-set-event [event]="rootRecordData.event"></app-people-set-event>
          }
          <!-- Live Events (kind 30311) -->
          @else if (rootRecordData.event.kind === 30311) {
          <app-live-event [event]="rootRecordData.event"></app-live-event>
          }
          <!-- Profile events (kind 0) -->
          @else if (rootRecordData.event.kind === 0) {
          <app-profile-update-event [event]="rootRecordData.event"></app-profile-update-event>
          } @else {
          <app-content [content]="rootRecordData.data" [event]="rootRecordData.event"
            [trustedByPubkey]="trustedByPubkey() || item.event.pubkey" [disableExpansion]="navigationDisabled()"
            [inFeedsPanel]="inFeedsPanel()" [hideSocialPreviews]="isRootContentCollapsed()"></app-content>
          }
        </mat-card-content>
        @if (isRootContentLong()) {
        @if (!isRootEventExpanded()) {
        <button mat-button class="show-more-btn" (click)="onExpandClick($event, isRootEventExpanded, true)">
          <mat-icon>expand_more</mat-icon>
          Show more
        </button>
        @if (rootCollapsedMedia().images.length > 0) {
        <div class="collapsed-images">
          @if (rootCollapsedMedia().images.length === 1) {
          <img [src]="rootCollapsedMedia().images[0]" alt="Image" loading="lazy" />
          } @else {
          <div class="image-grid">
            @for (image of rootCollapsedMedia().images; track image) {
            <img [src]="image" alt="Image" loading="lazy" />
            }
          </div>
          }
        </div>
        }
        @if (rootCollapsedMedia().videos.length > 0) {
        <div class="collapsed-videos" (click)="$event.stopPropagation()">
          <app-inline-video-player [src]="rootCollapsedMedia().videos[0].url"
            [poster]="rootCollapsedMedia().videos[0].poster"
            [style.aspect-ratio]="rootCollapsedMedia().videos[0].aspectRatio"></app-inline-video-player>
          @if (rootCollapsedMedia().videos.length > 1 && !collapsedVideosExpanded()) {
          <button mat-button class="show-more-videos-btn" (click)="toggleCollapsedVideos($event)">
            +{{ rootCollapsedMedia().videos.length - 1 }} more {{ rootCollapsedMedia().videos.length - 1 === 1 ? 'video'
            : 'videos' }}
          </button>
          }
          @if (collapsedVideosExpanded()) {
          @for (video of rootCollapsedMedia().videos.slice(1); track video.url) {
          <app-inline-video-player [src]="video.url" [poster]="video.poster"
            [style.aspect-ratio]="video.aspectRatio"></app-inline-video-player>
          }
          }
        </div>
        }
        @if (rootCollapsedMedia().urls.length > 0) {
        <div class="collapsed-urls">
          @for (url of rootCollapsedMedia().urls; track url) {
          <app-social-preview [url]="url" [compact]="true"></app-social-preview>
          }
        </div>
        }
        }
        }
      </mat-card>
    </div>

    <!-- Thread indicator (only show for threaded replies with both root and parent) -->
    <!-- @if (isThreadedReply()) {
    <div class="thread-indicator">
      <hr />
      <span>Thread continues</span>
      <hr />
    </div>
    } -->
    }

    <!-- Immediate parent event (what this is replying to) -->
    <!-- Only show parent if it exists and is different from root -->
    @if (parentRecordData && isThreadedReply() && !hideParentEvent()) {
    <div class="reply-context">
      @if (isThreadedReply()) {
      <!-- <h4 class="thread-label">Replying to</h4> -->
      }
      <mat-card appearance="outlined" class="parent-event" [style.cursor]="isParentCardClickable() ? 'pointer' : 'auto'"
        (click)="onParentEventClick($event)">
        @if (!hideHeader()) {
        <app-event-header [event]="parentRecordData.event" [compact]="true"></app-event-header>
        }
        <mat-card-content [class.collapsed]="isParentContentLong() && !isParentEventExpanded()">
          @if (parentRecordData.event.kind === 20) {
          <app-photo-event [event]="parentRecordData.event" [hideComments]="hideComments()"
            [showOverlay]="showOverlay()" [allMediaEvents]="allMediaEvents()"
            [mediaEventIndex]="mediaEventIndex()"></app-photo-event>
          }
          <!-- Videos (NIP-71, kind 21/22/34235/34236) -->
          @else if (
          parentRecordData.event.kind === 21 || parentRecordData.event.kind === 22 || parentRecordData.event.kind ===
          34235 || parentRecordData.event.kind === 34236
          ) {
          <app-video-event [event]="parentRecordData.event" [hideComments]="hideComments()"
            [showOverlay]="showOverlay()" [allMediaEvents]="allMediaEvents()"
            [mediaEventIndex]="mediaEventIndex()"></app-video-event>
          }
          <!-- Audio (kind 1222, 1244) -->
          @else if (parentRecordData.event.kind === 1222 || parentRecordData.event.kind === 1244) {
          <app-audio-event [event]="parentRecordData.event" [hideComments]="hideComments()"></app-audio-event>
          }
          <!-- Music Track (kind 36787) -->
          @else if (parentRecordData.event.kind === 36787) {
          <app-music-event [event]="parentRecordData.event"></app-music-event>
          }
          <!-- Articles (kind 30023) -->
          @else if (parentRecordData.event.kind === 30023) {
          <app-article-event [event]="parentRecordData.event"></app-article-event>
          }
          <!-- Polls (kind 1068) -->
          @else if (parentRecordData.event.kind === 1068) {
          <app-poll-event [event]="parentRecordData.event"></app-poll-event>
          }
          <!-- M3U Playlists (kind 32100) & Nostr Playlists (kind 34139) -->
          @else if (parentRecordData.event.kind === 32100 || parentRecordData.event.kind === 34139) {
          <app-playlist-event [event]="parentRecordData.event"></app-playlist-event>
          }
          <!-- Starter Packs (kind 39089) -->
          @else if (parentRecordData.event.kind === 39089) {
          <app-starter-pack-event [event]="parentRecordData.event"></app-starter-pack-event>
          }
          <!-- People Sets (kind 30000) -->
          @else if (parentRecordData.event.kind === 30000) {
          <app-people-set-event [event]="parentRecordData.event"></app-people-set-event>
          }
          <!-- Live Events (kind 30311) -->
          @else if (parentRecordData.event.kind === 30311) {
          <app-live-event [event]="parentRecordData.event"></app-live-event>
          }
          <!-- Profile events (kind 0) -->
          @else if (parentRecordData.event.kind === 0) {
          <app-profile-update-event [event]="parentRecordData.event"></app-profile-update-event>
          } @else {
          <app-content [content]="parentRecordData.data" [event]="parentRecordData.event"
            [trustedByPubkey]="trustedByPubkey() || item.event.pubkey" [disableExpansion]="navigationDisabled()"
            [inFeedsPanel]="inFeedsPanel()" [hideSocialPreviews]="isParentContentCollapsed()"></app-content>
          }
        </mat-card-content>
        @if (isParentContentLong()) {
        @if (!isParentEventExpanded()) {
        <button mat-button class="show-more-btn" (click)="onExpandClick($event, isParentEventExpanded, true)">
          <mat-icon>expand_more</mat-icon>
          Show more
        </button>
        @if (parentCollapsedMedia().images.length > 0) {
        <div class="collapsed-images">
          @if (parentCollapsedMedia().images.length === 1) {
          <img [src]="parentCollapsedMedia().images[0]" alt="Image" loading="lazy" />
          } @else {
          <div class="image-grid">
            @for (image of parentCollapsedMedia().images; track image) {
            <img [src]="image" alt="Image" loading="lazy" />
            }
          </div>
          }
        </div>
        }
        @if (parentCollapsedMedia().videos.length > 0) {
        <div class="collapsed-videos" (click)="$event.stopPropagation()">
          <app-inline-video-player [src]="parentCollapsedMedia().videos[0].url"
            [poster]="parentCollapsedMedia().videos[0].poster"
            [style.aspect-ratio]="parentCollapsedMedia().videos[0].aspectRatio"></app-inline-video-player>
          @if (parentCollapsedMedia().videos.length > 1 && !collapsedVideosExpanded()) {
          <button mat-button class="show-more-videos-btn" (click)="toggleCollapsedVideos($event)">
            +{{ parentCollapsedMedia().videos.length - 1 }} more {{ parentCollapsedMedia().videos.length - 1 === 1 ?
            'video' : 'videos' }}
          </button>
          }
          @if (collapsedVideosExpanded()) {
          @for (video of parentCollapsedMedia().videos.slice(1); track video.url) {
          <app-inline-video-player [src]="video.url" [poster]="video.poster"
            [style.aspect-ratio]="video.aspectRatio"></app-inline-video-player>
          }
          }
        </div>
        }
        @if (parentCollapsedMedia().urls.length > 0) {
        <div class="collapsed-urls">
          @for (url of parentCollapsedMedia().urls; track url) {
          <app-social-preview [url]="url" [compact]="true"></app-social-preview>
          }
        </div>
        }
        }
        }
      </mat-card>
    </div>
    }
  </mat-card-content>
  }

  <!-- Current event (the reply) -->
  @if (!hideHeader()) {
  <app-event-header [event]="item.event" [isEdited]="isEdited()" [editedAt]="editedAt()"></app-event-header>
  }
  <mat-card-content>
    @if (shouldHideContentDueToWarning()) {
    <app-content-warning [reason]="contentWarningReason()" (approve)="approveContentWarning()"></app-content-warning>
    } @else if (shouldHideContent()) {
    <app-reported-content [event]="item.event"></app-reported-content>
    } @else {
    @if (item.event.kind === 20) {
    <app-photo-event [event]="item.event" [hideComments]="hideComments()" [showOverlay]="showOverlay()"
      [allMediaEvents]="allMediaEvents()" [mediaEventIndex]="mediaEventIndex()"
      [trustedByPubkey]="trustedByPubkey()"></app-photo-event>
    }
    <!-- Videos (NIP-71, kind 21/22/34235/34236) -->
    @else if (item.event.kind === 21 || item.event.kind === 22 || item.event.kind === 34235 || item.event.kind ===
    34236) {
    <app-video-event [event]="item.event" [hideComments]="hideComments()" [showOverlay]="showOverlay()"
      [allMediaEvents]="allMediaEvents()" [mediaEventIndex]="mediaEventIndex()"
      [trustedByPubkey]="trustedByPubkey()"></app-video-event>
    }
    <!-- Audio (kind 1222, 1244) -->
    @else if (item.event.kind === 1222 || item.event.kind === 1244) {
    <app-audio-event [event]="item.event" [hideComments]="hideComments()"></app-audio-event>
    }
    <!-- Music Track (kind 36787) -->
    @else if (item.event.kind === 36787) {
    <app-music-event [event]="item.event"></app-music-event>
    }
    <!-- Articles (kind 30023) -->
    @else if (item.event.kind === 30023) {
    <app-article-event [event]="item.event"></app-article-event>
    }
    <!-- Polls (kind 1068) -->
    @else if (item.event.kind === 1068) {
    <app-poll-event [event]="item.event"></app-poll-event>
    }
    <!-- Emoji Sets (kind 30030) -->
    @else if (item.event.kind === 30030) {
    <app-emoji-set-event [event]="item.event"></app-emoji-set-event>
    }
    @else if (item.event.kind === 3) {
    <div class="following-event">
      <mat-icon>people</mat-icon>
      <span>Following {{ followingCount() }} accounts</span>
    </div>
    }
    <!-- M3U Playlists (kind 32100) & Nostr Playlists (kind 34139) -->
    @else if (item.event.kind === 32100 || item.event.kind === 34139) {
    <app-playlist-event [event]="item.event"></app-playlist-event>
    } @else if (item.event.kind === 39089) {
    <!-- Starter Packs (kind 39089) -->
    <app-starter-pack-event [event]="item.event"></app-starter-pack-event>
    } @else if (item.event.kind === 30000) {
    <!-- People Sets (kind 30000) -->
    <app-people-set-event [event]="item.event"></app-people-set-event>
    } @else if (item.event.kind === 8) {
    <app-badge [badge]="item.event"></app-badge>
    }
    <!-- Profile events (kind 0) -->
    @else if (item.event.kind === 0) {
    <app-profile-update-event [event]="item.event"></app-profile-update-event>
    } @else {
    <div class="main-content-wrapper" [class.collapsed]="isMainContentCollapsed()">
      <app-content [content]="displayedRecord()?.data" [event]="item.event"
        [trustedByPubkey]="trustedByPubkey() || item.event.pubkey" [disableExpansion]="navigationDisabled()"
        [inFeedsPanel]="inFeedsPanel()" [hideSocialPreviews]="isMainContentCollapsed()"></app-content>
    </div>
    @if (isMainContentLong()) {
    @if (!isMainContentExpanded()) {
    <button mat-button class="show-more-btn" (click)="onExpandClick($event, isMainContentExpanded, true)">
      <mat-icon>expand_more</mat-icon>
      Show more
    </button>
    @if (mainCollapsedMedia().images.length > 0) {
    <div class="collapsed-images">
      @if (mainCollapsedMedia().images.length === 1) {
      <img [src]="mainCollapsedMedia().images[0]" alt="Image" loading="lazy"
        (click)="onCollapsedImageClick($event, mainCollapsedMedia().images[0], mainCollapsedMedia().images)" />
      } @else {
      <div class="image-grid">
        @for (image of mainCollapsedMedia().images; track image) {
        <img [src]="image" alt="Image" loading="lazy"
          (click)="onCollapsedImageClick($event, image, mainCollapsedMedia().images)" />
        }
      </div>
      }
    </div>
    }
    @if (mainCollapsedMedia().videos.length > 0) {
    <div class="collapsed-videos" (click)="$event.stopPropagation()">
      <app-inline-video-player [src]="mainCollapsedMedia().videos[0].url"
        [poster]="mainCollapsedMedia().videos[0].poster"
        [style.aspect-ratio]="mainCollapsedMedia().videos[0].aspectRatio"></app-inline-video-player>
      @if (mainCollapsedMedia().videos.length > 1 && !collapsedVideosExpanded()) {
      <button mat-button class="show-more-videos-btn" (click)="toggleCollapsedVideos($event)">
        +{{ mainCollapsedMedia().videos.length - 1 }} more {{ mainCollapsedMedia().videos.length - 1 === 1 ? 'video' :
        'videos' }}
      </button>
      }
      @if (collapsedVideosExpanded()) {
      @for (video of mainCollapsedMedia().videos.slice(1); track video.url) {
      <app-inline-video-player [src]="video.url" [poster]="video.poster"
        [style.aspect-ratio]="video.aspectRatio"></app-inline-video-player>
      }
      }
    </div>
    }
    @if (mainCollapsedMedia().urls.length > 0) {
    <div class="collapsed-urls">
      @for (url of mainCollapsedMedia().urls; track url) {
      <app-social-preview [url]="url" [compact]="true"></app-social-preview>
      }
    </div>
    }
    }
    }
    }
    }
  </mat-card-content>


  } @else {
  <!-- Normal event structure -->
  @if (!hideHeader()) {
  <app-event-header [event]="item.event" [isEdited]="isEdited()" [editedAt]="editedAt()"></app-event-header>
  }
  <mat-card-content>
    @if (shouldHideContentDueToWarning()) {
    <app-content-warning [reason]="contentWarningReason()" (approve)="approveContentWarning()"></app-content-warning>
    } @else if (shouldHideContent()) {
    <app-reported-content [event]="item.event"></app-reported-content>
    } @else {
    @if (item.event.kind === 20) {
    <app-photo-event [event]="item.event" [hideComments]="hideComments()" [showOverlay]="showOverlay()"
      [allMediaEvents]="allMediaEvents()" [mediaEventIndex]="mediaEventIndex()"
      [trustedByPubkey]="trustedByPubkey()"></app-photo-event>
    }
    <!-- Videos (NIP-71, kind 21/22/34235/34236) -->
    @else if (item.event.kind === 21 || item.event.kind === 22 || item.event.kind === 34235 || item.event.kind ===
    34236) {
    <app-video-event [event]="item.event" [hideComments]="hideComments()" [showOverlay]="showOverlay()"
      [allMediaEvents]="allMediaEvents()" [mediaEventIndex]="mediaEventIndex()"
      [trustedByPubkey]="trustedByPubkey()"></app-video-event>
    }
    <!-- Audio (kind 1222, 1244) -->
    @else if (item.event.kind === 1222 || item.event.kind === 1244) {
    <app-audio-event [event]="item.event" [hideComments]="hideComments()"></app-audio-event>
    }
    <!-- Music Track (kind 36787) -->
    @else if (item.event.kind === 36787) {
    <app-music-event [event]="item.event"></app-music-event>
    }
    <!-- Articles (kind 30023) -->
    @else if (item.event.kind === 30023) {
    <app-article-event [event]="item.event"></app-article-event>
    }
    <!-- Polls (kind 1068) -->
    @else if (item.event.kind === 1068) {
    <app-poll-event [event]="item.event"></app-poll-event>
    }
    <!-- Emoji Sets (kind 30030) -->
    @else if (item.event.kind === 30030) {
    <app-emoji-set-event [event]="item.event"></app-emoji-set-event>
    }
    @else if (item.event.kind === 3) {
    <div class="following-event">
      <mat-icon>people</mat-icon>
      <span>Following {{ followingCount() }} accounts</span>
    </div>
    }
    <!-- M3U Playlists (kind 32100) & Nostr Playlists (kind 34139) -->
    @else if (item.event.kind === 32100 || item.event.kind === 34139) {
    <app-playlist-event [event]="targetItem.event"></app-playlist-event>
    } @else if (item.event.kind === 39089) {
    <!-- Starter Packs (kind 39089) -->
    <app-starter-pack-event [event]="item.event"></app-starter-pack-event>
    } @else if (item.event.kind === 30000) {
    <!-- People Sets (kind 30000) -->
    <app-people-set-event [event]="item.event"></app-people-set-event>
    } @else if (item.event.kind === 30311) {
    <!-- Live Events (kind 30311) -->
    <app-live-event [event]="item.event"></app-live-event>
    } @else if (item.event.kind === 8) {
    <app-badge [badge]="targetItem.event"></app-badge>
    }
    <!-- Profile events (kind 0) -->
    @else if (item.event.kind === 0) {
    <app-profile-update-event [event]="item.event"></app-profile-update-event>
    } @else {
    <div class="main-content-wrapper" [class.collapsed]="isMainContentCollapsed()">
      <app-content [content]="displayedRecord()?.data" [event]="item.event"
        [trustedByPubkey]="trustedByPubkey() || item.event.pubkey" [disableExpansion]="navigationDisabled()"
        [inFeedsPanel]="inFeedsPanel()" [hideSocialPreviews]="isMainContentCollapsed()"></app-content>
    </div>
    @if (isMainContentLong()) {
    <!-- Images and URLs for collapsed content (normal event) -->
    @if (!isMainContentExpanded()) {
    <button mat-button class="show-more-btn" (click)="onExpandClick($event, isMainContentExpanded, true)">
      <mat-icon>expand_more</mat-icon>
      Show more
    </button>
    @if (mainCollapsedMedia().images.length > 0) {
    <div class="collapsed-images">
      @if (mainCollapsedMedia().images.length === 1) {
      <img [src]="mainCollapsedMedia().images[0]" alt="Image" loading="lazy"
        (click)="onCollapsedImageClick($event, mainCollapsedMedia().images[0], mainCollapsedMedia().images)" />
      } @else {
      <div class="image-grid">
        @for (image of mainCollapsedMedia().images; track image) {
        <img [src]="image" alt="Image" loading="lazy"
          (click)="onCollapsedImageClick($event, image, mainCollapsedMedia().images)" />
        }
      </div>
      }
    </div>
    }
    @if (mainCollapsedMedia().videos.length > 0) {
    <div class="collapsed-videos" (click)="$event.stopPropagation()">
      <app-inline-video-player [src]="mainCollapsedMedia().videos[0].url"
        [poster]="mainCollapsedMedia().videos[0].poster"
        [style.aspect-ratio]="mainCollapsedMedia().videos[0].aspectRatio"></app-inline-video-player>
      @if (mainCollapsedMedia().videos.length > 1 && !collapsedVideosExpanded()) {
      <button mat-button class="show-more-videos-btn" (click)="toggleCollapsedVideos($event)">
        +{{ mainCollapsedMedia().videos.length - 1 }} more {{ mainCollapsedMedia().videos.length - 1 === 1 ? 'video' :
        'videos' }}
      </button>
      }
      @if (collapsedVideosExpanded()) {
      @for (video of mainCollapsedMedia().videos.slice(1); track video.url) {
      <app-inline-video-player [src]="video.url" [poster]="video.poster"
        [style.aspect-ratio]="video.aspectRatio"></app-inline-video-player>
      }
      }
    </div>
    }
    @if (mainCollapsedMedia().urls.length > 0) {
    <div class="collapsed-urls">
      @for (url of mainCollapsedMedia().urls; track url) {
      <app-social-preview [url]="url" [compact]="true"></app-social-preview>
      }
    </div>
    }
    }
    }
    }
    }
  </mat-card-content>
  }

  <!-- Zap Display -->
  <!-- @if (targetItem.event.kind === 1) {
  <app-zap-display [eventId]="targetItem.event.id"></app-zap-display>
  } -->

  @if (!hideFooter()) {
  <mat-card-actions class="note-footer">
    @if (supportsReactions()) {

    <!-- Metadata indicators (PoW, geohash, client) -->
    @if (!compact() && (hasProofOfWork(targetItem.event) || hasGeohash(targetItem.event) || (shouldShowClientTag() &&
    getClientTag(targetItem.event) && getClientLogo(getClientTag(targetItem.event))))) {
    <div class="metadata-indicators">
      @if (hasGeohash(targetItem.event)) {
      <a [href]="getGeohashUrl(targetItem.event)" target="_blank" rel="noopener noreferrer" class="geohash-link"
        [matTooltip]="'Location: ' + getGeohash(targetItem.event)" matTooltipPosition="below"
        (click)="$event.stopPropagation()">
        <mat-icon>location_on</mat-icon>
      </a>
      }
      @if (hasProofOfWork(targetItem.event)) {
      <div class="pow-indicator" [matTooltip]="getProofOfWorkTooltip(targetItem.event)" matTooltipPosition="below">
        <mat-icon [class.pow-strong]="getProofOfWorkDifficulty(targetItem.event) >= 20">verified</mat-icon>
        <span class="pow-difficulty">{{ getProofOfWorkDifficulty(targetItem.event) }}</span>
      </div>
      }
      @if (shouldShowClientTag() && getClientTag(targetItem.event) && getClientLogo(getClientTag(targetItem.event))) {
      <div class="client-indicator"
        [matTooltip]="'Published with ' + getClientDisplayName(getClientTag(targetItem.event))"
        matTooltipPosition="below">
        <img [src]="getClientLogo(getClientTag(targetItem.event))"
          [alt]="getClientDisplayName(getClientTag(targetItem.event)) + ' logo'" class="client-logo" />
      </div>
      }
    </div>
    }

    <!-- Unified action toolbar -->
    <div class="actions-row" [class.compact]="compact()"
      [class.mode-labels-only]="actionsDisplayMode() === 'labels-only'"
      [class.mode-icons-only]="actionsDisplayMode() === 'icons-only'"
      [class.mode-icons-and-labels]="actionsDisplayMode() === 'icons-and-labels'">
      <!-- Like with count -->
      <div class="action-button like-action like-hover-container"
        (click)="reactionBtn.sendDefaultReaction(); $event.stopPropagation()" (mouseenter)="onLikeHoverEnter()"
        (mouseleave)="onLikeHoverLeave()">
        <app-reaction-button class="action-icon" #reactionBtn [event]="targetItem.event"
          [reactionsFromParent]="reactions()" (reactionChanged)="loadReactions(true)" view="icon"></app-reaction-button>
        @if (likes().length > 0) {
        <span class="action-count">{{ likes().length }}</span>
        }
        <span class="action-text">Like</span>

        <!-- Quick reaction hover popup -->
        <div class="quick-reaction-popup" [class.visible]="showQuickReactions()" (mouseenter)="onLikeHoverEnter()"
          (mouseleave)="onLikeHoverLeave()">
          @for (item of quickReactionEmojis(); track item.emoji) {
          <button class="quick-emoji-btn" (click)="onQuickReaction(item.emoji, reactionBtn, $event)" type="button">
            @if (item.url) {
            <img [src]="item.url" [alt]="item.emoji" [title]="item.emoji" class="quick-custom-emoji-img">
            } @else if (isCustomEmoji(item.emoji)) {
            <span class="quick-custom-emoji-text">{{ item.emoji }}</span>
            } @else {
            {{ item.emoji }}
            }
          </button>
          }
          <button class="quick-emoji-btn quick-emoji-more" (click)="reactionBtn.openMenu(); $event.stopPropagation()"
            type="button">
            <mat-icon>add</mat-icon>
          </button>
        </div>
      </div>

      <!-- Comments (opens event page) -->
      <div class="action-button comment-action" role="button" tabindex="0" (click)="navigateToComments($event)">
        <mat-icon class="action-icon">mode_comment</mat-icon>
        @if (replyCount() > 0) {
        <span class="action-count">{{ replyCount() }}</span>
        }
        <span class="action-text">Reply</span>
      </div>

      <!-- Share with count -->
      <div class="action-button share-action" role="button" tabindex="0"
        (click)="openShareDialog(); $event.stopPropagation()">
        <mat-icon class="action-icon">share</mat-icon>
        @if (repostCount() > 0) {
        <span class="action-count">{{ repostCount() }}</span>
        }
        <span class="action-text">Share</span>
      </div>

      <!-- Quotes -->
      @if (quoteCount() > 0) {
      <div class="action-button quote-action" role="button" tabindex="0"
        (click)="toggleReactionsSummary('quotes'); $event.stopPropagation()">
        <mat-icon class="action-icon">format_quote</mat-icon>
        <span class="action-count">{{ quoteCount() }}</span>
        <span class="action-text">Quotes</span>
      </div>
      }

      <!-- Zap with sats -->
      <div class="action-button zap-action" (click)="zapBtn.onClick($event); $event.stopPropagation()">
        <app-zap-button class="action-icon" #zapBtn [event]="targetItem.event"
          [recipientPubkey]="targetItem.event.pubkey" (zapSent)="onZapSent($event)">
        </app-zap-button>
        @if (totalZapAmount() > 0) {
        <span class="action-count">{{ formatZapAmount(totalZapAmount()) }}</span>
        }
        <span class="action-text">Zap</span>
      </div>

      <!-- Bookmark (inline) -->
      <div class="action-button bookmark-action" role="button" tabindex="0" (click)="onBookmarkClick($event)">
        <mat-icon class="action-icon">{{ getBookmarkIcon(targetItem.event) }}</mat-icon>
        <span class="action-text">Bookmark</span>
      </div>

      <!-- Top emojis indicator (right-aligned) -->
      @if (!compact() && likes().length > 0) {
      <div class="emoji-indicators" (click)="toggleReactionsSummary(); $event.stopPropagation()"
        (contextmenu)="onActionsDisplayModeToggle($event)" (touchstart)="onBookmarkLongPressStart($event)"
        (touchend)="onBookmarkLongPressEnd()" (touchcancel)="onBookmarkLongPressEnd()">
        <span class="aggregated-emojis">
          @for (emoji of topEmojis(); track emoji.emoji) {
          @if (emoji.url) {
          <img [src]="emoji.url" [alt]="emoji.emoji" class="emoji-item custom-emoji" />
          } @else {
          <span class="emoji-item">{{ emoji.emoji }}</span>
          }
          }
        </span>
        <span class="emoji-more">···</span>
      </div>
      }
    </div>

    <!-- Expandable reactions summary panel (below the toolbar border) -->
    @if (showReactionsSummary()) {
    <div class="reactions-summary-container" [@expandCollapse]>
      <app-reaction-summary [reactions]="likes()" [replyCount]="replyCount()" [repostCount]="repostCount()"
        [quoteCount]="quoteCount()" [reposts]="reposts()" [quotes]="quotes()" [zaps]="zaps()"
        [totalZapAmount]="totalZapAmount()" [zapCount]="zapCount()" [initialTab]="reactionsSummaryTab()"
        [hideTabs]="false">
      </app-reaction-summary>
    </div>
    }
    }

    <!-- Compact mode: view all button -->
    @if (compact() && supportsReactions()) {
    <button mat-icon-button class="view-all-button" (click)="openReactionsDialog('likes'); $event.stopPropagation()"
      matTooltip="View all reactions">
      <mat-icon>more_horiz</mat-icon>
    </button>
    }


  </mat-card-actions>
  }

</mat-card>
} @else if (id() && !isLoadingEvent()) {
<div class="event-content">
  @if (loadingError()) {
  <p class="error-message">{{ loadingError() }}</p>
  } @else {
  <p>Event not found</p>
  }
</div>
}