<div dialog-content class="start-chat-content">
  <!-- Selected profile display -->
  @if (selectedProfile()) {
  <div class="selected-profile">
    <div class="profile-info">
      <app-user-profile [pubkey]="selectedProfile()!.event.pubkey" view="small"></app-user-profile>
      <div class="profile-details">
        @if (selectedProfile()!.data.display_name || selectedProfile()!.data.name) {
        <span class="profile-display-name">{{ selectedProfile()!.data.display_name || selectedProfile()!.data.name
          }}</span>
        }
        <span class="profile-npub">{{ selectedProfile()!.event.pubkey | npub }}</span>
      </div>
    </div>
    <button mat-icon-button (click)="clearSelection()" matTooltip="Clear selection">
      <mat-icon>clear</mat-icon>
    </button>
  </div>

  <mat-divider></mat-divider>
  } @else {
  <!-- Unified search/npub input -->
  <div class="search-section">
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Search or enter npub</mat-label>
      <input matInput [(ngModel)]="searchInput" placeholder="Search by name or paste npub1..." autocomplete="off" />
      @if (isNpubInput()) {
      <mat-icon matSuffix>key</mat-icon>
      } @else {
      <mat-icon matSuffix>search</mat-icon>
      }
      @if (npubError()) {
      <mat-error>{{ npubError() }}</mat-error>
      }
    </mat-form-field>

    <!-- Show npub validation when detected -->
    @if (isNpubInput() && hasValidNpub()) {
    <div class="npub-valid-indicator">
      <mat-icon>check_circle</mat-icon>
      <span>Valid npub detected</span>
    </div>
    }

    <!-- Search results / Following list -->
    @if (!isNpubInput()) {
    <div class="search-results">
      @if (searchResults().length > 0) {
      <div class="results-header">
        @if (searchInput()) {
        <span>Search results</span>
        } @else {
        <span>People you follow</span>
        }
      </div>
      <div class="results-list">
        @for (profile of searchResults(); track profile.event.pubkey) {
        <div class="search-result-item" tabindex="0" (click)="selectProfile(profile)"
          (keydown.enter)="selectProfile(profile)" (keydown.space)="selectProfile(profile)">
          <app-user-profile [pubkey]="profile.event.pubkey" view="list"></app-user-profile>
        </div>
        }
      </div>
      } @else if (searchInput()) {
      <div class="no-results">
        <mat-icon>person_search</mat-icon>
        <p>No profiles found</p>
        <small>Try entering their npub directly (starts with npub1...)</small>
      </div>
      }
    </div>
    }
  </div>
  }

  <!-- Chat type selection -->
  <div class="chat-type-section">
    <h3>Chat Type</h3>
    <div class="chat-type-toggle">
      <mat-slide-toggle [(ngModel)]="isLegacy">
        Legacy Mode (NIP-04)
      </mat-slide-toggle>
      <div class="chat-type-info">
        @if (isLegacy()) {
        <div class="legacy-info">
          <mat-icon>warning</mat-icon>
          <span>Legacy mode uses older encryption. Use only for compatibility with older
            clients.</span>
        </div>
        } @else {
        <div class="modern-info">
          <mat-icon>security</mat-icon>
          <span>Modern mode uses improved encryption (NIP-44) for better security.</span>
        </div>
        }
      </div>
    </div>
  </div>
</div>

<div dialog-actions class="dialog-actions">
  <button mat-button (click)="close()">Cancel</button>
  <button mat-flat-button (click)="startChat()" [disabled]="!canStartChat()">
    <mat-icon>chat</mat-icon>
    Start Chat
  </button>
</div>