:host {
  display: block;
  width: 100%;
}

.user-profile {
  border-radius: 0; // Removed border radius
  margin-bottom: 0; // Removed margin
  transition: background-color 0.2s;
  // width: 100%;
  flex-shrink: 0; // Prevent shrinking in flex layouts
  touch-action: pan-y; // Enable touch scrolling in vertical direction

  // &:hover {
  //   background-color: rgba(0, 0, 0, 0.04);
  // }
  .user-profile-container {
    display: flex;
    align-items: center;
    padding: 0; // Removed padding
    width: 100%;
    gap: 0.4rem;
    justify-content: space-between;
  }

  // Banner styles
  .user-profile-banner {
    width: 100%;
    height: 80px;
    overflow: hidden;
    position: relative;

    .user-banner {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-banner-placeholder {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--mat-app-surface-variant) 0%, var(--mat-app-outline-variant) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;

      &::before {
        content: '';
        width: 32px;
        height: 32px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23757575' stroke-width='1.5'%3E%3Cpath d='M21 3H3v18h18V3zM9 17l3-3 3 3M12 14l3-3'/%3E%3C/svg%3E");
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        opacity: 0.3;
      }
    }
  }

  // Avatar container with trust badge
  .user-profile-avatar-container {
    position: relative;
    display: inline-block;
    flex-shrink: 0;
  }

  .user-profile-avatar {
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
    border: 2px solid;
    border-color: var(--mat-button-text-label-text-color, var(--mat-sys-primary));
    background-color: var(--mat-card-subtle-surface-color, #e0e0e0);
    // Allow touch scrolling to pass through
    touch-action: manipulation;
    // Prevent long-press context menu on touch devices
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;

    .user-avatar {
      width: 100%;
      height: 100%; // Remove the duplicate height: 420px which causes excessive zooming
      object-fit: cover; // Keep cover but adjust the container sizing
      border-radius: 50%;
    }

    .default-user-avatar {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--mat-caption-text-color, #757575);
      font-size: 100%;

      &.not-found-avatar {
        color: var(--mat-warn-color, #f44336);
        /* Use Material's warning color for not found or error profiles */
      }

      &.error-avatar {
        color: var(--mat-warn-color, #be09af);
        /* Use Material's warning color for not found or error profiles */
      }
    }

    mat-spinner {
      margin: 0;
    }
  }

  // Trust rank badge
  .trust-rank-badge {
    position: absolute;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--mat-sys-primary) 0%, var(--mat-sys-secondary) 100%);
    color: var(--mat-sys-on-primary);
    border-radius: 50%;
    font-weight: 600;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    z-index: 1;

    &.trust-rank-large {
      top: 2px;
      right: 2px;
      width: 32px;
      height: 32px;
      font-size: 14px;
    }

    &.trust-rank-medium {
      top: 1px;
      right: 1px;
      width: 24px;
      height: 24px;
      font-size: 11px;
    }

    &.trust-rank-small {
      top: 0px;
      right: 0px;
      width: 20px;
      height: 20px;
      font-size: 10px;
    }

    &.trust-rank-comfortable {
      top: 1px;
      right: 1px;
      width: 24px;
      height: 24px;
      font-size: 11px;
    }

    &.trust-rank-details {
      top: 0px;
      right: 0px;
      width: 18px;
      height: 18px;
      font-size: 9px;
    }
  }

  // Custom tooltip for touch devices (doesn't interfere with scrolling)
  .user-profile-avatar.has-custom-tooltip {
    position: relative;

    &::before {
      content: attr(data-tooltip);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 10px;
      line-height: 1.3;
      white-space: pre-line;
      max-width: 200px;
      width: max-content;
      word-wrap: break-word;
      text-align: center;
      opacity: 0;
      visibility: hidden;
      transition:
        opacity 0.3s,
        visibility 0.3s;
      z-index: 1000;
      pointer-events: none; // Important: prevents tooltip from blocking touch events

      // Prevent tooltip from going off-screen
      @media (max-width: 300px) {
        max-width: 160px;
        left: 50%;
        transform: translate(-50%, -50%);
      }
    }

    // Show tooltip on hover (desktop) - long press for mobile is handled differently
    @media (hover: hover) and (pointer: fine) {
      &:hover::before {
        opacity: 1;
        visibility: visible;
      }
    }

    // For touch devices, show tooltip on focus (when tapped)
    @media (hover: none) {
      &:focus::before {
        opacity: 1;
        visibility: visible;
      }
    }

    // Show tooltip when temporary class is added (for touch)
    &.show-tooltip::before {
      opacity: 1;
      visibility: visible;
    }
  }

  .user-profile-content {
    flex: 1;
    min-width: 0; // Enable text truncation
    margin-left: 0; // Removed margin
    display: flex;
    flex-direction: column;
    align-items: flex-start; // Align items to the start instead of stretching
  }

  .user-profile-custom-content {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    flex-shrink: 0;
  }

  app-profile-display-name,
  .user-profile-name {
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%; // Allow ellipsis to work
  }

  .user-profile-name-link {
    text-decoration: none;
    color: inherit;
    display: inline-block; // Changed from block to inline-block
    max-width: 100%; // Constrain width for ellipsis
    cursor: pointer;

    &:hover {
      text-decoration: underline;
    }
  }

  .user-profile-name-text {
    color: inherit;
    display: inline-block;
    max-width: 100%;
  }

  .user-profile-npub-link {
    text-decoration: none;
    color: inherit;
    display: inline-block; // Changed from block to inline-block
    max-width: 100%; // Constrain width for ellipsis
    cursor: pointer;

    &:hover {
      text-decoration: underline;
    }
  }

  @media (max-width: 700px) {

    .user-profile-name-link,
    .user-profile-npub-link {
      min-height: 40px;
      display: inline-flex;
      align-items: center;
      padding: 0 2px;
    }
  }

  .user-profile-npub {
    color: var(--mat-sys-on-surface-variant);
    font-size: 13px;
    opacity: 0.8;
    display: inline-flex;
    align-items: center;
    gap: 2px;
    max-width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    word-break: break-all;
    -webkit-text-size-adjust: 100%;
    /* Prevent iOS Safari from auto-adjusting font size */
    text-size-adjust: 100%;
    /* Standard property for other browsers */
  }

  .user-profile-npub>span,
  .user-profile-details>span {
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .nip05-icon {
    font-size: 13px;
    width: 13px;
    height: 13px;
    flex-shrink: 0;
    vertical-align: middle;

    &.nip05-valid {
      color: var(--mat-sys-primary);
    }

    &.nip05-invalid {
      color: var(--mat-sys-error);
    }
  }

  .user-profile-details {
    font-size: 0.8rem;
    color: var(--mat-sys-on-surface);
    display: inline-flex;
    align-items: center;
    gap: 2px;
    max-width: 100%; // Allow ellipsis to work
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    -webkit-text-size-adjust: 100%;
    /* Prevent iOS Safari from auto-adjusting font size */
    text-size-adjust: 100%;
    /* Standard property for other browsers */
  }

  .user-profile-about {
    font-size: 14px;
    margin-top: 8px;
    line-height: 1.4;
  }

  // View-specific styles
  &.comfortable {
    width: 100%;

    .user-profile-container {
      padding: 1rem;
      gap: 1rem;
      justify-content: flex-start;
    }

    .user-profile-avatar {
      width: 64px;
      height: 64px;
      flex-shrink: 0;
    }

    .default-user-avatar {
      font-size: 64px;
    }

    .user-profile-info {
      flex: 1;
      min-width: 0;
      display: flex;
      align-items: center;
    }

    app-profile-display-name,
    .user-profile-name {
      font-size: 1.125rem;
      font-weight: 500;
      line-height: 1.4;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-profile-nip05 {
      display: none;
    }

    .user-about {
      display: none;
    }

    .user-profile-actions {
      display: none;
    }
  }

  &.large {
    width: auto; // Changed from 300px to auto
    flex-shrink: 0;

    .user-profile-container {
      padding: 0; // Removed padding
      justify-content: center; // Center the avatar
      width: auto; // Container should only be as wide as its content
    }

    .user-profile-avatar {
      width: 256px;
      height: 256px;
      margin: 0; // Removed margin
    }

    .default-user-avatar {
      font-size: 256px;
    }

    app-profile-display-name,
    .user-profile-name {
      font-size: 18px;
      font-weight: 600;
      margin-top: 0; // Removed margin
    }
  }

  &.medium {
    width: auto; // Changed from 220px to auto
    flex-shrink: 0;

    .user-profile-container {
      justify-content: center; // Center the avatar
      padding: 0; // Removed padding
      width: auto; // Container should only be as wide as its content
    }

    .user-profile-avatar {
      width: 128px;
      height: 128px;
      margin: 0; // Removed margin
    }

    .default-user-avatar {
      font-size: 128px;
    }

    app-profile-display-name,
    .user-profile-name {
      font-size: 16px;
      margin-top: 0; // Removed margin
    }
  }

  &.small {
    width: auto; // Changed from 100px to auto
    flex-shrink: 0;

    .user-profile-container {
      justify-content: center; // Center the avatar
      padding: 0; // Removed padding
      width: auto; // Container should only be as wide as its content
    }

    .user-profile-avatar {
      width: 48px;
      height: 48px;
      margin: 0; // Removed margin
    }

    .default-user-avatar {
      font-size: 48px;
    }

    app-profile-display-name,
    .user-profile-name {
      font-size: 14px;
      margin-top: 0; // Removed margin
    }
  }

  &.compact {
    width: 100%; // Changed to 100% to take available space
    flex-shrink: 1; // Allow shrinking
    min-width: 0; // Enable proper shrinking

    .user-profile-container {
      justify-content: flex-start; // Changed from center to flex-start
      padding: 0; // Removed padding
      width: 100%; // Changed from auto to 100% to take available space
    }

    .user-profile-content {
      flex: 1;
      min-width: 0; // Enable text truncation
      overflow: hidden;
    }

    .user-profile-avatar {
      width: 24px;
      height: 24px;
      margin: 0; // Removed margin
      flex-shrink: 0;
    }

    .default-user-avatar {
      font-size: 24px;
    }

    app-profile-display-name,
    .user-profile-name {
      font-size: 14px;
      margin-top: 0; // Removed margin
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  }

  &.icon {
    width: auto; // Changed from 100px to auto
    flex-shrink: 0;

    .user-profile-container {
      justify-content: center; // Center the avatar
      padding: 0; // Removed padding
      width: auto; // Container should only be as wide as its content
    }

    .user-profile-avatar {
      width: 48px;
      height: 48px;
      margin: 0; // Removed margin
    }

    .default-user-avatar {
      font-size: 48px;
    }

    app-profile-display-name,
    .user-profile-name {
      font-size: 14px;
      margin-top: 0; // Removed margin
    }
  }

  &.thread {
    width: auto; // Changed from 100px to auto
    flex-shrink: 0;

    .user-profile-container {
      justify-content: center; // Center the avatar
      padding: 0; // Removed padding
      width: auto; // Container should only be as wide as its content
    }

    .user-profile-content {
      margin-left: 0.4rem;
    }

    .user-profile-avatar {
      width: 48px;
      height: 48px;
      margin: 0; // Removed margin
    }

    .default-user-avatar {
      font-size: 48px;
    }

    app-profile-display-name,
    .user-profile-name {
      font-size: 14px;
      margin-top: 0; // Removed margin
    }
  }

  &.details {
    box-shadow: var(--mat-sys-level1);
    border-radius: 8px;
    overflow: hidden;
    box-sizing: border-box;
    max-width: 100%; // Prevent container from exceeding parent width

    .user-profile-container {
      padding: 12px;
      flex-direction: row;
      align-items: flex-start;
      min-width: 0; // Allow flex item to shrink below its content size
    }

    .user-profile-avatar {
      width: 40px;
      height: 40px;
      margin-bottom: 8px;
      flex-shrink: 0; // Prevent avatar from shrinking
    }

    .user-profile-content {
      margin-left: 12px; // Add some spacing from avatar
      min-width: 0; // Allow content to shrink and wrap
      flex: 1; // Take up remaining space
      overflow-wrap: break-word; // Break long words
      word-wrap: break-word; // Legacy support
      -webkit-hyphens: auto; // Safari support
      hyphens: auto; // Add hyphenation for better breaking
    }

    // Override text styles for details view to handle overflow
    app-profile-display-name,
    .user-profile-name {
      white-space: normal; // Allow wrapping instead of nowrap
      overflow: visible; // Don't hide overflowing text
      text-overflow: unset; // Don't use ellipsis, wrap instead
      word-break: break-word; // Break long words
      line-height: 1.3; // Improve readability for wrapped text
    }

    .user-profile-npub {
      white-space: normal; // Allow wrapping instead of nowrap
      overflow: visible; // Don't hide overflowing text
      text-overflow: unset; // Don't use ellipsis, wrap instead
      word-break: break-all; // Break anywhere for long strings like npub
      font-family: 'Courier New', monospace; // Use monospace for better readability of codes
      font-size: 12px; // Slightly smaller for long strings
      line-height: 1.4; // Better spacing for wrapped monospace text
    }

    .user-profile-about {
      word-break: break-word; // Break long words
      overflow-wrap: break-word; // Modern browsers
      white-space: pre-wrap; // Preserve line breaks but allow wrapping
      max-width: 100%; // Ensure it doesn't exceed container
    }

    .user-profile-details {
      word-break: break-word; // Break long words in details
      overflow-wrap: break-word; // Modern browsers
      margin-top: 4px; // Add some spacing between detail lines
    }
  }

  &.grid {
    box-shadow: var(--mat-sys-level1);
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: 100%;
    background: var(--mat-sys-surface-container);
    transition: all 0.2s ease;

    &:hover {
      box-shadow: var(--mat-sys-level2);
      transform: translateY(-2px);
    }

    .user-profile-container {
      flex-direction: column;
      height: 100%;
      padding: 0;
      position: relative;
      align-items: center;
    }

    .user-profile-banner {
      width: 100%;
      height: 80px;
    }

    .user-profile-avatar {
      width: 60px;
      height: 60px;
      min-height: 60px;
      position: relative;
      margin-top: -30px;
      border-width: 0; // Removed border
      z-index: 1;
      margin-bottom: 0; // Removed margin
      background-color: var(--mat-card-subtle-surface-color, #e0e0e0);

      /* Fix the flex display issue */
      display: block;
      overflow: hidden;

      /* Fix avatar rendering */
      .user-avatar {
        display: block;
        width: 60px;
        height: 60px;
        object-fit: cover;
      }

      .default-user-avatar {
        font-size: 60px;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      mat-spinner {
        margin: auto;
      }

      &::after {
        content: '';
        position: absolute;
        inset: -3px;
        background-color: white;
        z-index: -1;
        border-radius: 50%;
      }
    }

    .user-profile-content {
      margin: 0; // Removed all margins
      text-align: center;
      padding: 8px 12px 12px;
      flex: 1;
      display: flex;
      flex-direction: column;
      width: 100%;
      box-sizing: border-box;
    }

    .user-profile-npub {
      font-size: 12px;
      color: var(--mat-sys-on-surface-variant);
      margin-bottom: 6px;
    }

    .user-profile-about {
      font-size: 13px;
      color: var(--mat-sys-on-surface-variant);
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 4px;
      word-break: break-word;
      overflow-wrap: break-word;
    }
  }

  &.list {
    .user-profile-avatar {
      width: 42px;
      height: 42px;
    }

    .default-user-avatar {
      font-size: 42px;
    }
  }
}

// Handle nested mat-list-item structure for list view
::ng-deep .mat-mdc-list-item-content {
  width: 100%;
}

// Custom tooltip styles
::ng-deep .user-profile-tooltip {
  white-space: pre-line; // Preserves line breaks in the tooltip
  max-width: 250px; // Limit tooltip width
  font-size: 12px;
  line-height: 1.4;
}

.user-info-status {
  position: absolute;
  margin-top: 0px;
  z-index: 1000;
}

.user-info-status-good {
  background-color: green;
}

.user-info-status-bad {
  background-color: red;
}

.user-info-status-medium {
  background-color: orange;
}

.user-info-icon {
  border-radius: 50%;
  width: 24px;
  height: 24px;
}

.user-profile.name {
  width: auto;
  flex-shrink: 0;

  .user-profile-container {
    justify-content: flex-start;
    padding: 0;
    width: auto;
  }

  .user-profile-content.name-view {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-left: 0;
    padding: 0;
    gap: 2px;
    min-width: 40px;
  }

  .user-profile-avatar.name-avatar {
    width: 24px;
    height: 24px;
    min-width: 24px;
    min-height: 24px;
    max-width: 24px;
    max-height: 24px;
    border-radius: 50%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0;
    border: 2px solid var(--mat-button-text-label-text-color, var(--mat-sys-primary));
    background-color: var(--mat-card-subtle-surface-color, #e0e0e0);
    box-sizing: border-box;
  }

  .user-profile-avatar.name-avatar .user-avatar,
  .user-profile-avatar.name-avatar .default-user-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    object-fit: cover;
    font-size: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .user-profile-name.name-label app-profile-display-name {
    font-size: 13px;
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-align: center;
    max-width: 60px;
    font-weight: 500;
    line-height: 1.1;
  }
}

.user-profile.tiny {
  width: auto;
  flex-shrink: 0;

  .user-profile-container {
    justify-content: flex-start;
    padding: 0;
    width: auto;
  }

  .user-profile-content.tiny-view {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-left: 0;
    padding: 0;
    gap: 2px;
    min-width: 40px;
  }

  .user-profile-avatar.name-avatar {
    width: 24px;
    height: 24px;
    min-width: 24px;
    min-height: 24px;
    max-width: 24px;
    max-height: 24px;
    border-radius: 50%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0;
    border: 2px solid var(--mat-button-text-label-text-color, var(--mat-sys-primary));
    background-color: var(--mat-card-subtle-surface-color, #e0e0e0);
    box-sizing: border-box;
  }

  .user-profile-avatar.name-avatar .user-avatar,
  .user-profile-avatar.name-avatar .default-user-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    object-fit: cover;
    font-size: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .user-profile-name.name-label app-profile-display-name {
    font-size: 13px;
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-align: center;
    max-width: 70px;
    font-weight: 500;
    line-height: 1.1;
  }
}

.user-profile.chip {
  width: auto;
  flex-shrink: 0;

  .user-profile-container {
    justify-content: flex-start;
    padding: 0;
    width: auto;
  }

  .user-profile-content.chip-view {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    margin-left: 0;
    padding: 0;
    gap: 4px;
    min-width: 48px;
  }

  .user-profile-avatar.chip-avatar {
    width: 40px;
    height: 40px;
    min-width: 40px;
    min-height: 40px;
    max-width: 40px;
    max-height: 40px;
    border-radius: 50%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0;
    border: 2px solid var(--mat-button-text-label-text-color, var(--mat-sys-primary));
    background-color: var(--mat-card-subtle-surface-color, #e0e0e0);
    box-sizing: border-box;
  }

  .user-profile-avatar.chip-avatar .user-avatar,
  .user-profile-avatar.chip-avatar .default-user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    font-size: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .user-profile-name.chip-label {
    color: var(--mat-sys-on-surface);

    app-profile-display-name {
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
      max-width: 72px;
      line-height: 1.2;
    }
  }
}

// Avatar-only view mode
.user-profile.avatar {
  width: 100%;
  height: 100%;

  .user-profile-container {
    justify-content: center;
    padding: 0;
    width: 100%;
    height: 100%;
  }

  .user-profile-avatar.avatar-only {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s ease;

    &:hover {
      transform: scale(1.05);
    }

    .user-avatar {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .default-user-avatar {
      font-size: 48px;
      width: 48px;
      height: 48px;
    }
  }
}