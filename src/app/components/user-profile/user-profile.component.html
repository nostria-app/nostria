<!-- <div [ngClass]="['user-profile', view()]" (click)="layout.navigateToProfile(pubkey())"> -->
<!-- <div [ngClass]="['user-profile', view()]" (touchstart)="handleTouchEvent($event)" (touchmove)="handleTouchEvent($event)"
  (touchend)="handleTouchEvent($event)"> -->

<!--
  Set [hostWidthAuto] to true to make the host width 'auto' instead of '100%'.
  Example: <app-user-profile [hostWidthAuto]="true" ...></app-user-profile>
-->
<div [ngClass]="['user-profile', view()]">
  <div class="user-profile-container">
    <!-- Banner section for grid view -->
    @if (view() === 'grid') {
    <div class="user-profile-banner">
      @if (profile()?.data?.banner) {
      <img [src]="profile().data.banner" onerror="this.onerror=null; this.src='images/banner-failure.png';"
        alt="User Banner" class="user-banner" />
      } @else {
      <div class="user-banner-placeholder"></div>
      }
    </div>
    }

    <!-- Avatar section - single image element -->
    @if (view() !== 'name' && view() !== 'tiny' && view() !== 'chip' && view() !== 'avatar') {
    <div class="user-profile-avatar-container">
      <a [attr.href]="disableLink() ? null : profileUrl()" class="user-profile-avatar"
        [class.has-custom-tooltip]="view() === 'large' || view() === 'medium' || view() === 'small'"
        [attr.data-tooltip]="getTooltipContent()" (touchstart)="showTooltipOnTouch($event)" #avatarElement
        (mouseenter)="onMouseEnter($event, avatarElement)" (mouseleave)="onMouseLeave()"
        (click)="onProfileClick($event)">
        @if (isLoading()) {
        <mat-spinner [diameter]="getSpinnerSize()" color="primary"></mat-spinner>
        } @else if (profile()?.data?.picture && !imageLoadError()) {
        @if (settingsService.settings().imageCacheEnabled) {
        <img [src]="getOptimizedImageUrl(profile().data.picture)" (error)="onImageLoadError()" alt="User Avatar"
          class="user-avatar" loading="lazy" />
        } @else {
        <img [src]="profile().data.picture" (error)="onImageLoadError()" alt="User Avatar" class="user-avatar"
          loading="lazy" />
        }
        } @else {
        <mat-icon [ngClass]="[
                'default-user-avatar',
                isProfileNotFound() ? 'not-found-avatar' : '',
                imageLoadError() ? 'error-avatar' : '',
              ]" [style.font-size]="getDefaultAvatarSize()" [style.height]="getDefaultAvatarSize()"
          [style.width]="getDefaultAvatarSize()">
          {{ isProfileNotFound() ? 'no_accounts' : 'account_circle' }}
        </mat-icon>
        }
      </a>

      <!-- Trust rank badge -->
      @if (showRank() && trustEnabled() && trustRank() !== undefined && (view() === 'large' || view() === 'medium' ||
      view() === 'small' || view() === 'comfortable' || view() === 'details')) {
      <div class="trust-rank-badge" [class]="'trust-rank-' + view()" [matTooltip]="'Trust Rank: ' + trustRank()">
        {{ trustRank() }}
      </div>
      }
    </div>
    }

    <!-- Comfortable view - show name only -->
    @if (view() === 'comfortable') {
    <div class="user-profile-content">
      <div class="user-profile-name-text" #nameElement (mouseenter)="onMouseEnter($event, nameElement)"
        (mouseleave)="onMouseLeave()">
        <app-profile-display-name [pubkey]="pubkey()" [disableLink]="disableLink()"></app-profile-display-name>
      </div>
    </div>
    }

    <!-- Content section with conditional rendering based on view -->

    @if (
    view() !== 'large' &&
    view() !== 'medium' &&
    view() !== 'small' &&
    view() !== 'comfortable' &&
    view() !== 'icon' &&
    view() !== 'tiny' &&
    view() !== 'chip' &&
    view() !== 'name'
    ) {
    <div class="user-profile-content">
      <!-- Name section -->
      <a [attr.href]="disableLink() ? null : profileUrl()" class="user-profile-name-link" #nameElement
        (mouseenter)="onMouseEnter($event, nameElement)" (mouseleave)="onMouseLeave()" (click)="onProfileClick($event)">
        <app-profile-display-name [pubkey]="pubkey()" [disableLink]="disableLink()"></app-profile-display-name>
      </a>

      <!-- NPUB section - only shown in appropriate views -->
      @if (view() === 'list' || view() === 'details' || view() === 'grid') {
      <a [attr.href]="disableLink() ? null : profileUrl()" class="user-profile-npub-link" #npubElement
        (mouseenter)="onMouseEnter($event, npubElement)" (mouseleave)="onMouseLeave()" (click)="onProfileClick($event)">
        <div class="user-profile-npub">{{ aliasOrNpub() }}</div>
      </a>
      }

      <!-- About section - shown in details and grid views -->
      @if ((view() === 'details' || view() === 'grid') && profile() && profile().data && profile().data.about) {
      <div class="user-profile-about">{{ profile().data.about }}</div>
      }

      @if (view() === 'details' && profile() && profile().data) {
      @if (profile().data.nip05) {
      <div class="user-profile-details">NIP-05: {{ profile().data.nip05 }}</div>
      }
      @if (profile().data.lud16) {
      <div class="user-profile-details">LUD16: {{ profile().data.lud16 }}</div>
      }
      @if (profile().data.website) {
      <div class="user-profile-details">Website: {{ profile().data.website }}</div>
      }
      }
    </div>
    }

    @if (view() === 'name') {
    <div class="user-profile-content name-view">
      <a [href]="profileUrl()" class="user-profile-avatar" (click)="onProfileClick($event)">
        <div class="user-profile-avatar name-avatar">
          @if (isLoading()) {
          <mat-spinner [diameter]="24" color="primary"></mat-spinner>
          } @else if (profile()?.data?.picture && !imageLoadError()) {
          @if (settingsService.settings().imageCacheEnabled) {
          <img [src]="getOptimizedImageUrl(profile().data.picture)" (error)="onImageLoadError()" alt="User Avatar"
            class="user-avatar" loading="lazy" />
          } @else {
          <img [src]="profile().data.picture" (error)="onImageLoadError()" alt="User Avatar" class="user-avatar"
            loading="lazy" />
          }
          } @else {
          <mat-icon [ngClass]="[
                  'default-user-avatar',
                  isProfileNotFound() ? 'not-found-avatar' : '',
                  imageLoadError() ? 'error-avatar' : '',
                ]" [style.font-size]="'24px'" [style.height]="'24px'" [style.width]="'24px'">
            {{ isProfileNotFound() ? 'no_accounts' : 'account_circle' }}
          </mat-icon>
          }
        </div>
        <span class="user-profile-name name-label">
          <app-profile-display-name [pubkey]="pubkey()" [disableLink]="disableLink()"></app-profile-display-name>
        </span>
      </a>
    </div>
    }

    @if (view() === 'tiny') {
    <a [href]="profileUrl()" class="user-profile-content tiny-view" (click)="onProfileClick($event)">
      <div class="user-profile-avatar name-avatar">
        @if (isLoading()) {
        <mat-spinner [diameter]="24" color="primary"></mat-spinner>
        } @else if (profile()?.data?.picture && !imageLoadError()) {
        @if (settingsService.settings().imageCacheEnabled) {
        <img [src]="getOptimizedImageUrl(profile().data.picture)" (error)="onImageLoadError()" alt="User Avatar"
          class="user-avatar" loading="lazy" />
        } @else {
        <img [src]="profile().data.picture" (error)="onImageLoadError()" alt="User Avatar" class="user-avatar"
          loading="lazy" />
        }
        } @else {
        <mat-icon [ngClass]="[
                'default-user-avatar',
                isProfileNotFound() ? 'not-found-avatar' : '',
                imageLoadError() ? 'error-avatar' : '',
              ]" [style.font-size]="'24px'" [style.height]="'24px'" [style.width]="'24px'">
          {{ isProfileNotFound() ? 'no_accounts' : 'account_circle' }}
        </mat-icon>
        }
      </div>
      <span class="user-profile-name name-label">
        <app-profile-display-name [pubkey]="pubkey()" [disableLink]="disableLink()"></app-profile-display-name>
      </span>
    </a>
    }

    @if (view() === 'chip') {
    <div class="user-profile-content chip-view">
      <div class="user-profile-avatar chip-avatar">
        @if (isLoading()) {
        <mat-spinner [diameter]="40" color="primary"></mat-spinner>
        } @else if (profile()?.data?.picture && !imageLoadError()) {
        @if (settingsService.settings().imageCacheEnabled) {
        <img [src]="getOptimizedImageUrl(profile().data.picture)" (error)="onImageLoadError()" alt="User Avatar"
          class="user-avatar" loading="lazy" />
        } @else {
        <img [src]="profile().data.picture" (error)="onImageLoadError()" alt="User Avatar" class="user-avatar"
          loading="lazy" />
        }
        } @else {
        <mat-icon [ngClass]="[
                'default-user-avatar',
                isProfileNotFound() ? 'not-found-avatar' : '',
                imageLoadError() ? 'error-avatar' : '',
              ]" [style.font-size]="'40px'" [style.height]="'40px'" [style.width]="'40px'">
          {{ isProfileNotFound() ? 'no_accounts' : 'account_circle' }}
        </mat-icon>
        }
      </div>
      <span class="user-profile-name chip-label">
        <app-profile-display-name [pubkey]="pubkey()" [disableLink]="true"></app-profile-display-name>
      </span>
    </div>
    }

    @if (view() === 'avatar') {
    <a [attr.href]="disableLink() ? null : profileUrl()" class="user-profile-avatar avatar-only"
      [matTooltip]="getTooltipContent()" (click)="onProfileClick($event)">
      @if (isLoading()) {
      <mat-spinner [diameter]="48" color="primary"></mat-spinner>
      } @else if (profile()?.data?.picture && !imageLoadError()) {
      @if (settingsService.settings().imageCacheEnabled) {
      <img [src]="getOptimizedImageUrl(profile().data.picture)" (error)="onImageLoadError()" alt="User Avatar"
        class="user-avatar" loading="lazy" />
      } @else {
      <img [src]="profile().data.picture" (error)="onImageLoadError()" alt="User Avatar" class="user-avatar"
        loading="lazy" />
      }
      } @else {
      <mat-icon [ngClass]="[
              'default-user-avatar',
              isProfileNotFound() ? 'not-found-avatar' : '',
              imageLoadError() ? 'error-avatar' : '',
            ]" [style.font-size]="'48px'" [style.height]="'48px'" [style.width]="'48px'">
        {{ isProfileNotFound() ? 'no_accounts' : 'account_circle' }}
      </mat-icon>
      }
    </a>
    }

    <!-- Named content projection for additional controls (like more options button) -->
    <div class="user-profile-custom-content">
      <ng-content></ng-content>
    </div>
  </div>
</div>