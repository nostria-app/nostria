@if (hasContentWarning()) {
<div class="content-warning">
  <mat-icon>warning</mat-icon>
  <span>{{ contentWarning() }}</span>
</div>
}

@if (title() && !showOverlay()) {
<h3 class="media-title">{{ title() }}</h3>
}

@if (hasValidVideo()) {
@let videoInfo = videoData()!;
@let blurhashUrl = blurhashDataUrl();
<div class="video-container" [class.clickable]="showOverlay()" [class.blurred]="shouldBlurMedia()"
  [class.revealing]="!shouldBlurMedia() && isRevealed()" [class.short-form]="isShortFormVideo()"
  [style.aspect-ratio]="videoAspectRatio()" (click)="$event.stopPropagation()">
  @if (!isExpanded()) {
  <!-- Video Thumbnail (Initial State) -->
  <div class="video-thumbnail-container" (click)="expandVideo($any($event))"
    [class.thumbnail-loaded]="thumbnailLoaded()">
    <!-- Video icon indicator (shown in grid view) -->
    @if (showOverlay()) {
    <div class="video-indicator">
      <mat-icon>play_circle_filled</mat-icon>
    </div>
    }

    <!-- Placeholder background (always shown initially) -->
    @if (blurhashUrl) {
    <img [src]="blurhashUrl" class="video-thumbnail blurhash-thumbnail" [alt]="videoInfo.alt || 'Video thumbnail'"
      title="Video thumbnail" [attr.title]="videoInfo.title || 'Video thumbnail'" aria-hidden="true" />
    }

    @if (videoInfo.thumbnail) {
    <!-- Use provided thumbnail image with progressive loading -->
    <img [src]="videoInfo.thumbnail" class="video-thumbnail main-thumbnail" [alt]="videoInfo.alt || 'Video thumbnail'"
      title="Video thumbnail" [attr.title]="videoInfo.title || videoInfo.alt || 'Video thumbnail'" loading="lazy"
      [class.hidden]="shouldBlurMedia()" [class.loaded]="thumbnailLoaded()" (load)="thumbnailLoaded.set(true)" />
    } @else if (!blurhashUrl) {
    <!-- Use video element with preload="metadata" to show first frame -->
    <video [src]="videoInfo.url" preload="metadata" class="video-thumbnail" [class.hidden]="shouldBlurMedia()"></video>
    }

    <!-- Reveal overlay for blurred media -->
    @if (shouldBlurMedia()) {
    <div class="reveal-overlay">
      <div class="reveal-actions">
        <button class="reveal-btn" (click)="revealMedia(); $event.stopPropagation()">
          <mat-icon>visibility</mat-icon>
          <span>Reveal once</span>
        </button>
        <button class="reveal-btn trust-btn" (click)="trustAuthor(); $event.stopPropagation()">
          <mat-icon>verified_user</mat-icon>
          <span>Always reveal this user</span>
        </button>
      </div>
    </div>
    }

    @if (videoInfo.duration) {
    <div class="video-duration">
      {{ formatDuration(videoInfo.duration) }}
    </div>
    }
  </div>
  } @else {
  <!-- Video Player (Expanded State) -->
  <div class="video-player-container" [style.aspect-ratio]="videoAspectRatio()" [class.video-ready]="videoReady()"
    [class.needs-rotation]="needsRotationCorrection()" [class.short-form]="isShortFormVideo()"
    (mouseenter)="onVideoContainerMouseEnter()" (mouseleave)="onVideoContainerMouseLeave()"
    (mousemove)="onVideoContainerMouseMove()">
    <!-- Placeholder shown until video is ready -->
    @if (blurhashUrl && !videoReady()) {
    <img [src]="blurhashUrl" class="video-placeholder-bg" alt="" aria-hidden="true" />
    }
    <!-- Video wrapper for proper play button positioning -->
    <div class="video-wrapper">
      <video #videoPlayer class="video-player" [class.loaded]="videoReady()" [loop]="shouldRepeat()"
        [muted]="shouldBeMuted()" [poster]="videoInfo.thumbnail || blurhashUrl || undefined"
        (play)="onVideoPlay($event)" (pause)="onVideoPause($event)" (timeupdate)="onTimeUpdate()"
        (loadedmetadata)="onLoadedMetadata()" (canplay)="onVideoCanPlay()" (click)="togglePlayPause()"
        (dblclick)="onVideoDoubleClick($event)">
        <source [src]="videoInfo.url" [type]="videoMimeType()" />
        Your browser does not support the video tag.
      </video>
      <!-- Center play button positioned relative to actual video -->
      @if (videoPaused() && !hasPlayedOnce()) {
      <button class="video-center-play-btn" (click)="onCenterPlayButtonClick(); $event.stopPropagation()"
        aria-label="Play video">
        <mat-icon>play_arrow</mat-icon>
      </button>
      }
    </div>
    <app-video-controls [videoElement]="videoElement()" [config]="{ showQuality: false, isLiveStream: false }"
      (playPause)="togglePlayPause()" (seek)="onSeek($event)" (volumeChange)="onVolumeChange($event)"
      (muteToggle)="onMuteToggle()" (playbackRateChange)="onPlaybackRateChange($event)"
      (fullscreenToggle)="toggleFullscreen()" (pipToggle)="togglePictureInPicture()" (castToggle)="castToDevice()" />
    <button mat-icon-button class="collapse-video-btn" (click)="collapseVideo()" matTooltip="Show thumbnail">
      <mat-icon>picture_in_picture_alt</mat-icon>
    </button>
  </div>
  }
</div>
} @else {
<!-- Fallback when no valid video found -->
<div class="video-error">
  <mat-icon>videocam_off</mat-icon>
  <p>No video available</p>
</div>
}

@if (description() && !showOverlay()) {
<p class="video-description">
  {{ description() }}
</p>
}

@if (!hideComments()) {
<!-- NIP-22 Comments Section -->
<app-comments-list [event]="event()"></app-comments-list>
}