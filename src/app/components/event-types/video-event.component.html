@if (hasContentWarning()) {
<div class="content-warning">
  <mat-icon>warning</mat-icon>
  <span>{{ contentWarning() }}</span>
</div>
}

@if (title() && !showOverlay()) {
<h3 class="media-title">{{ title() }}</h3>
}

@let videoInfo = videoData();
@let blurhashUrl = blurhashDataUrl();
@if (videoInfo) {
<div class="video-container" [class.clickable]="showOverlay()" [class.blurred]="shouldBlurMedia()"
  [class.revealing]="!shouldBlurMedia() && isRevealed()">
  @if (!isExpanded()) {
  <!-- Video Thumbnail (Initial State) -->
  <div class="video-thumbnail-container" tabindex="0" role="button" (click)="expandVideo($any($event))"
    (keyup.enter)="expandVideo($any($event))" (keyup.space)="expandVideo($any($event))">
    <!-- Video icon indicator (shown in grid view) -->
    @if (showOverlay()) {
    <div class="video-indicator">
      <mat-icon>play_circle_filled</mat-icon>
    </div>
    }

    @if (videoInfo.thumbnail) {
    <!-- Use provided thumbnail image -->
    <img [src]="videoInfo.thumbnail" class="video-thumbnail" [alt]="videoInfo.alt || 'Video thumbnail'"
      [title]="videoInfo.title || 'Video thumbnail'" loading="lazy" [class.hidden]="shouldBlurMedia()" />
    } @else if (videoInfo.blurhash && blurhashUrl) {
    <!-- Use blurhash as fallback -->
    <img [src]="blurhashUrl" class="video-thumbnail blurhash-thumbnail" [alt]="videoInfo.alt || 'Video thumbnail'"
      [title]="videoInfo.title || 'Video thumbnail'" />
    } @else {
    <!-- Use video element with preload="metadata" to show first frame -->
    <video [src]="videoInfo.url" preload="metadata" class="video-thumbnail" [class.hidden]="shouldBlurMedia()"></video>
    }

    <!-- Reveal overlay for blurred media -->
    @if (shouldBlurMedia()) {
    <div class="reveal-overlay" (click)="revealMedia(); $event.stopPropagation()">
      <mat-icon>visibility</mat-icon>
      <span>Click to reveal</span>
    </div>
    }

    @if (videoInfo.duration) {
    <div class="video-duration">
      {{ formatDuration(videoInfo.duration) }}
    </div>
    }
  </div>
  } @else {
  <!-- Video Player (Expanded State) -->
  <div class="video-player-container" (mouseenter)="onVideoContainerMouseEnter()"
    (mouseleave)="onVideoContainerMouseLeave()" (mousemove)="onVideoContainerMouseMove()">
    <video #videoPlayer class="video-player" [autoplay]="shouldAutoPlay()" [loop]="shouldRepeat()"
      [poster]="videoInfo.thumbnail || blurhashUrl || undefined" (play)="onVideoPlay($event)"
      (timeupdate)="onTimeUpdate()" (loadedmetadata)="onLoadedMetadata()">
      <source [src]="videoInfo.url" [type]="videoMimeType()" />
      Your browser does not support the video tag.
    </video>
    <app-video-controls [videoElement]="videoElement()" [config]="{ showQuality: false, isLiveStream: false }"
      (playPause)="togglePlayPause()" (seek)="onSeek($event)" (volumeChange)="onVolumeChange($event)"
      (muteToggle)="onMuteToggle()" (playbackRateChange)="onPlaybackRateChange($event)"
      (fullscreenToggle)="toggleFullscreen()" (pipToggle)="togglePictureInPicture()" (castToggle)="castToDevice()" />
    <button mat-icon-button class="collapse-video-btn" (click)="collapseVideo()" matTooltip="Show thumbnail">
      <mat-icon>picture_in_picture_alt</mat-icon>
    </button>
  </div>
  }
</div>
}

@if (description() && !showOverlay()) {
<p class="video-description">
  {{ description() }}
</p>
}

@if (!hideComments()) {
<!-- NIP-22 Comments Section -->
<app-comments-list [event]="event()"></app-comments-list>
}