@if (hasContentWarning()) {
<div class="content-warning">
  <mat-icon>warning</mat-icon>
  <span>{{ contentWarning() }}</span>
</div>
}

@if (title() && !showOverlay()) {
<h3 class="media-title">{{ title() }}</h3>
}

@let videoInfo = videoData();
@let blurhashUrl = blurhashDataUrl();
@if (videoInfo) {
<div class="video-container" [class.clickable]="showOverlay()" [class.blurred]="shouldBlurMedia()"
  [class.revealing]="!shouldBlurMedia() && isRevealed()" [style.aspect-ratio]="videoAspectRatio()">
  @if (!isExpanded()) {
  <!-- Video Thumbnail (Initial State) -->
  <div class="video-thumbnail-container" tabindex="0" role="button" (click)="expandVideo($any($event))"
    (keyup.enter)="expandVideo($any($event))" (keyup.space)="expandVideo($any($event))"
    [class.thumbnail-loaded]="thumbnailLoaded()">
    <!-- Video icon indicator (shown in grid view) -->
    @if (showOverlay()) {
    <div class="video-indicator">
      <mat-icon>play_circle_filled</mat-icon>
    </div>
    }

    <!-- Placeholder background (always shown initially) -->
    @if (blurhashUrl) {
    <img [src]="blurhashUrl" class="video-thumbnail blurhash-thumbnail" [alt]="videoInfo.alt || 'Video thumbnail'"
      [title]="videoInfo.title || 'Video thumbnail'" aria-hidden="true" />
    }

    @if (videoInfo.thumbnail) {
    <!-- Use provided thumbnail image with progressive loading -->
    <img [src]="videoInfo.thumbnail" class="video-thumbnail main-thumbnail" [alt]="videoInfo.alt || 'Video thumbnail'"
      [title]="videoInfo.title || 'Video thumbnail'" loading="lazy" [class.hidden]="shouldBlurMedia()"
      [class.loaded]="thumbnailLoaded()" (load)="thumbnailLoaded.set(true)" />
    } @else if (!blurhashUrl) {
    <!-- Use video element with preload="metadata" to show first frame -->
    <video [src]="videoInfo.url" preload="metadata" class="video-thumbnail" [class.hidden]="shouldBlurMedia()"></video>
    }

    <!-- Reveal overlay for blurred media -->
    @if (shouldBlurMedia()) {
    <div class="reveal-overlay">
      <div class="reveal-actions">
        <button class="reveal-btn" (click)="revealMedia(); $event.stopPropagation()">
          <mat-icon>visibility</mat-icon>
          <span>Reveal once</span>
        </button>
        <button class="reveal-btn trust-btn" (click)="trustAuthor(); $event.stopPropagation()">
          <mat-icon>verified_user</mat-icon>
          <span>Always reveal this user</span>
        </button>
      </div>
    </div>
    }

    @if (videoInfo.duration) {
    <div class="video-duration">
      {{ formatDuration(videoInfo.duration) }}
    </div>
    }
  </div>
  } @else {
  <!-- Video Player (Expanded State) -->
  <div class="video-player-container" [style.aspect-ratio]="videoAspectRatio()" [class.video-ready]="videoReady()"
    [class.needs-rotation]="needsRotationCorrection()" (mouseenter)="onVideoContainerMouseEnter()"
    (mouseleave)="onVideoContainerMouseLeave()" (mousemove)="onVideoContainerMouseMove()">
    <!-- Placeholder shown until video is ready -->
    @if (blurhashUrl && !videoReady()) {
    <img [src]="blurhashUrl" class="video-placeholder-bg" alt="" aria-hidden="true" />
    }
    <video #videoPlayer class="video-player" [class.loaded]="videoReady()" [autoplay]="shouldAutoPlay()"
      [loop]="shouldRepeat()" [poster]="videoInfo.thumbnail || blurhashUrl || undefined" (play)="onVideoPlay($event)"
      (pause)="onVideoPause($event)" (timeupdate)="onTimeUpdate()" (loadedmetadata)="onLoadedMetadata()"
      (canplay)="onVideoCanPlay()" (click)="togglePlayPause()">
      <source [src]="videoInfo.url" [type]="videoMimeType()" />
      Your browser does not support the video tag.
    </video>
    <app-video-controls [videoElement]="videoElement()" [config]="{ showQuality: false, isLiveStream: false }"
      (playPause)="togglePlayPause()" (seek)="onSeek($event)" (volumeChange)="onVolumeChange($event)"
      (muteToggle)="onMuteToggle()" (playbackRateChange)="onPlaybackRateChange($event)"
      (fullscreenToggle)="toggleFullscreen()" (pipToggle)="togglePictureInPicture()" (castToggle)="castToDevice()" />
    <button mat-icon-button class="collapse-video-btn" (click)="collapseVideo()" matTooltip="Show thumbnail">
      <mat-icon>picture_in_picture_alt</mat-icon>
    </button>
  </div>
  }
</div>
}

@if (description() && !showOverlay()) {
<p class="video-description">
  {{ description() }}
</p>
}

@if (!hideComments()) {
<!-- NIP-22 Comments Section -->
<app-comments-list [event]="event()"></app-comments-list>
}