<h2 mat-dialog-title>
  @if (customMode()) {
  Publish Custom Event
  } @else {
  Publish Event
  }
</h2>

<mat-dialog-content class="publish-dialog-content">
  @if (customMode()) {
  <div class="custom-event-section">
    <h3>Enter Nostr Event JSON</h3>
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Event JSON</mat-label>
      <textarea matInput [ngModel]="customEventJson()" (ngModelChange)="onCustomEventChange($event)"
        placeholder='{"kind":1,"created_at":1234567890,"tags":[],"content":"Hello Nostr!"}' rows="12"
        class="event-json-input"></textarea>
      @if (customEventError()) {
      <mat-error>{{ customEventError() }}</mat-error>
      }
      <mat-hint>Paste a Nostr event JSON (signed or unsigned - will be signed if needed)</mat-hint>
    </mat-form-field>
  </div>
  }

  <div class="publish-options">
    <h3>Select Publishing Targets</h3>

    @for (option of publishOptions; track option.id) {
    <!-- Only show "mentioned" option if there are p-tags in the event -->
    @if (option.id !== 'mentioned' || hasMentionedUsers()) {
    <div class="publish-option">
      <mat-checkbox [checked]="isOptionSelected(option.id)" (change)="onOptionChange(option.id, $event.checked)">
        <div class="option-content">
          <div class="option-label">{{ option.label }}</div>
          <div class="option-description">{{ option.description }}</div>

          @if (option.id === 'author' && loadingAuthorRelays()) {
          <mat-spinner diameter="20"></mat-spinner>
          }

          @if (option.id === 'author' && !loadingAuthorRelays()) {
          <div class="relay-count">
            {{ authorRelays().length }} relay{{ authorRelays().length !== 1 ? 's' : '' }}
            available
          </div>
          }

          @if (option.id === 'mentioned' && loadingMentionedRelays()) {
          <mat-spinner diameter="20"></mat-spinner>
          }

          @if (option.id === 'mentioned' && !loadingMentionedRelays()) {
          <div class="relay-count">
            @if (isOptionSelected('mentioned')) {
            {{ mentionedRelays().length }} relay{{ mentionedRelays().length !== 1 ? 's' : '' }}
            from {{ getMentionedPubkeys().length }} user{{ getMentionedPubkeys().length !== 1 ? 's' : '' }}
            } @else {
            ? relays from {{ getMentionedPubkeys().length }} user{{ getMentionedPubkeys().length !== 1 ? 's' : '' }}
            }
          </div>
          }

          @if (option.id === 'account') {
          <div class="relay-count">
            {{ accountRelay.getRelayUrls().length }} relay{{
            accountRelay.getRelayUrls().length !== 1 ? 's' : ''
            }}
            configured
          </div>
          }
        </div>
      </mat-checkbox>
    </div>
    }
    }
  </div>

  @if (isOptionSelected('custom')) {
  <div class="custom-relays-section">
    <h4>Additional Relays</h4>

    <div class="add-relay-form">
      <mat-form-field appearance="outline" class="relay-input">
        <mat-label>Relay URL</mat-label>
        <input matInput [ngModel]="customRelayInput()" (ngModelChange)="customRelayInput.set($event)"
          placeholder="wss://relay.example.com" (keyup.enter)="addCustomRelay()" />
      </mat-form-field>
      <button mat-raised-button color="primary" (click)="addCustomRelay()" [disabled]="!customRelayInput().trim()">
        <mat-icon>add</mat-icon>
        Add
      </button>
    </div>

    @if (customRelays().length > 0) {
    <div class="custom-relays-list">
      <mat-chip-listbox>
        @for (relay of customRelays(); track $index) {
        <mat-chip-option>
          {{ relay }}
          <button matChipRemove (click)="removeCustomRelay(relay)">
            <mat-icon>cancel</mat-icon>
          </button>
        </mat-chip-option>
        }
      </mat-chip-listbox>
    </div>
    }
  </div>
  }

  @if (publishResults().length > 0) {
  <div class="publish-results">
    <h4>Publish Results</h4>
    <mat-list>
      @for (result of publishResults(); track result.url) {
      <mat-list-item>
        <div class="result-content">
          <div class="relay-url">{{ result.url }}</div>
          <div [class]="'result-status status-' + result.status">
            @if (result.status === 'pending') {
            <mat-spinner diameter="16"></mat-spinner>
            <span>Publishing...</span>
            } @else if (result.status === 'success') {
            <mat-icon color="primary">check_circle</mat-icon>
            <span>Success</span>
            } @else {
            <mat-icon color="warn">error</mat-icon>
            <span>Failed: {{ result.message }}</span>
            }
          </div>
        </div>
      </mat-list-item>
      }
    </mat-list>
  </div>
  }

  @if (showJsonView()) {
  <div class="json-view-section">
    <h4>Event Data</h4>
    <pre class="json-content">{{ getEventJson() }}</pre>
  </div>
  }

  @if (showRelaysView()) {
  <div class="relays-view-section">
    <h4>Target Relays</h4>
    <div class="relays-list">
      @if (getTargetRelays().length > 0) {
      @for (relay of getTargetRelays(); track $index) {
      <div class="relay-item">
        <mat-icon>dns</mat-icon>
        <span class="relay-url">{{ relay }}</span>
      </div>
      }
      } @else {
      <div class="no-relays">
        <mat-icon>warning</mat-icon>
        <span>No relays selected for publishing</span>
      </div>
      }
    </div>
  </div>
  }
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-stroked-button (click)="toggleJsonView()">
    <mat-icon>{{ showJsonView() ? 'visibility_off' : 'code' }}</mat-icon>
    {{ showJsonView() ? 'Event' : 'Event' }}
  </button>
  <button mat-stroked-button (click)="toggleRelaysView()">
    <mat-icon>{{ showRelaysView() ? 'visibility_off' : 'dns' }}</mat-icon>
    {{ showRelaysView() ? 'Relays' : 'Relays' }}
  </button>
  <button mat-button (click)="close()">
    @if (publishResults().length > 0) {
    Close
    } @else {
    Cancel
    }
  </button>
  <button mat-flat-button (click)="publish()" [disabled]="!canPublish()">
    @if (isPublishing()) {
    <mat-spinner diameter="16"></mat-spinner>
    Publishing...
    } @else {
    @let relayCount = getTargetRelays().length;
    @if (relayCount > 0) {
    Publish to {{ relayCount }} Relay{{ relayCount !== 1 ? 's' : '' }}
    } @else {
    Select Publishing Targets
    }
    }
  </button>
</mat-dialog-actions>