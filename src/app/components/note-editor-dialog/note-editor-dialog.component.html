<!-- Inline Mode: Collapsed State -->
@if (inlineMode() && !isExpanded()) {
<div class="inline-collapsed-state" (click)="expandEditor()">
  <div class="avatar-wrapper">
    @if (currentAccountPubkey()) {
    <app-user-profile [pubkey]="currentAccountPubkey()!" view="icon" [disableLink]="true"></app-user-profile>
    } @else {
    <mat-icon class="default-avatar">account_circle</mat-icon>
    }
  </div>
  <span class="placeholder-text">Post your reply</span>
  <button mat-flat-button class="reply-button" [disabled]="!isLoggedIn()">
    Reply
  </button>
</div>
}

<!-- Main Editor Content (Dialog mode always, Inline mode when expanded) -->
@if (!inlineMode() || isExpanded()) {
<!-- Content Area -->
<div dialog-content class="note-editor-dialog" [class.inline-editor]="inlineMode()">
  <div class="dialog-content-wrapper" [attr.data-drag-enabled]="!showPreview() && !showAdvancedOptions() || null"
    (dragenter)="!showPreview() && !showAdvancedOptions() && onDragEnter($event)"
    (dragover)="!showPreview() && !showAdvancedOptions() && onDragOver($event)"
    (dragleave)="!showPreview() && !showAdvancedOptions() && onDragLeave($event)"
    (drop)="!showPreview() && !showAdvancedOptions() && onDrop($event)" [class.drag-over]="isDragOver()">

    <!-- Error display -->
    @if (mediaService.error()) {
    <div class="error-container">
      <mat-icon color="warn">error</mat-icon>
      <p>{{ mediaService.error() }}</p>
      <button mat-button (click)="dismissError()">Dismiss</button>
    </div>
    }

    <!-- Upload progress -->
    @if (isUploading()) {
    <div class="upload-progress">
      <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      <span class="upload-text">{{ uploadStatus() || 'Uploading...' }}</span>
    </div>
    }

    <!-- Reply context (inline mode shows who we're replying to) -->
    @if (isReply()) {
    <div class="reply-context">
      @if (inlineMode() && replyToEvent()) {
      <span class="reply-label">Replying to</span>
      <app-user-profile [pubkey]="replyToEvent()!.pubkey" view="tiny" class="reply-author"></app-user-profile>
      } @else {
      <mat-icon class="reply-icon">reply</mat-icon>
      <span class="reply-text">Replying to note</span>
      }
    </div>
    }

    <!-- Quote context -->
    @if (isQuote()) {
    <div class="quote-context">
      <mat-icon class="quote-icon">format_quote</mat-icon>
      <span class="quote-text">Quoting: "{{ (data.quote?.content || '').slice(0, 100)
        }}{{ (data.quote?.content || '').length > 100 ? '...' : '' }}"</span>
    </div>
    }

    <!-- Content editor with upload actions -->
    @if (!showPreview() && !showAdvancedOptions()) {
    <div class="content-editor-section">

      <!-- Media Mode Toggle Banner (not in inline mode) -->
      @if (isMediaModeAvailable() && !inlineMode()) {
      <div class="media-mode-banner" [class.active]="isMediaMode()">
        <div class="media-mode-info">
          <mat-icon class="media-icon">perm_media</mat-icon>
          <div class="media-text">
            <span class="media-label">Publish as Media Story</span>
            <span class="media-description">Create a rich media event optimized for media clients</span>
          </div>
        </div>
        <mat-slide-toggle [checked]="isMediaMode()" (change)="setMediaMode($event.checked)" color="primary">
        </mat-slide-toggle>
      </div>
      }

      <!-- Title Input for Media Mode -->
      @if (isMediaModeEnabled()) {
      <mat-form-field appearance="outline" class="title-field">
        <mat-label>Title</mat-label>
        <input matInput [ngModel]="title()" (ngModelChange)="title.set($event)" placeholder="Give your story a title">
      </mat-form-field>
      }

      <!-- Media Thumbnails (shown in both regular and media modes) -->
      @if (mediaMetadata().length > 0) {
      <div class="media-thumbnails" cdkDropList cdkDropListOrientation="horizontal" (cdkDropListDropped)="drop($event)">
        @for (media of mediaMetadata(); track media.url; let i = $index) {
        <div class="media-thumbnail" cdkDrag>
          <button mat-icon-button class="remove-media-btn" (click)="removeMedia(i)" matTooltip="Remove media">
            <mat-icon>close</mat-icon>
          </button>
          @if (media.mimeType?.startsWith('video/')) {
          <mat-icon class="video-icon">videocam</mat-icon>
          <!-- Use image preview if available -->
          @if (media.image) {
          <img [src]="media.image" class="thumbnail-img" alt="Video thumbnail">
          }
          } @else {
          <img [src]="media.url" class="thumbnail-img" alt="Image thumbnail">
          }
        </div>
        }
      </div>
      }

      <div class="textarea-container">
        <mat-form-field appearance="outline" class="content-field">
          <mat-label>{{ isMediaModeEnabled() ? 'Description' : (inlineMode() ? 'Post your reply' : "What's on your
            mind?") }}</mat-label>
          <textarea matInput [value]="content()" (input)="onContentInput($event)" (keydown)="onContentKeyDown($event)"
            (keyup)="onContentKeyUp($event)" (click)="onContentClick($event)"
            [placeholder]="inlineMode() ? 'Write your reply... Use @ to mention someone' : 'Write your note... Use @ to mention someone'"
            [rows]="inlineMode() ? 3 : 4" class="content-textarea" #contentTextarea>
          </textarea>
          <mat-hint align="end"> {{ characterCount() }} characters </mat-hint>
        </mat-form-field>

        <!-- Mentions (kept directly below text input) -->
        @if (visibleMentions().length > 0 && !showAdvancedOptions()) {
        <div class="mentions-section">
          <mat-chip-set class="mentions-chips">
            @for (mention of visibleMentions(); track mention) {
            <mat-chip [removable]="true" (removed)="removeMention(mention)">
              {{ getMentionDisplayName(mention) }}
              <mat-icon matChipRemove>cancel</mat-icon>
            </mat-chip>
            }
          </mat-chip-set>
        </div>
        }

        <!-- Hashtags -->
        @if (hashtags().length > 0 && !showAdvancedOptions()) {
        <div class="hashtags-section">
          <span class="hashtags-label">Tags:</span>
          <mat-chip-set class="hashtags-chips">
            @for (hashtag of hashtags(); track hashtag) {
            <mat-chip>
              #{{ hashtag }}
            </mat-chip>
            }
          </mat-chip-set>
        </div>
        }

        <!-- Mention Autocomplete positioned relative to textarea -->
        @if (mentionConfig()) {
        <app-mention-autocomplete [config]="mentionConfig()" [position]="mentionPosition()" [maxResults]="100"
          [maxHeight]="400" (mentionSelected)="onMentionSelected($event)"
          (dismissed)="onMentionDismissed()"></app-mention-autocomplete>
        }
      </div>

      <!-- Hidden file input -->
      <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*,video/*" multiple
        class="hidden-file-input" aria-label="Upload media files" />
    </div>
    }

    <!-- Advanced Options (not in inline mode) -->
    @if (showAdvancedOptions() && !inlineMode()) {
    <div class="advanced-options-section">
      <div class="advanced-options-header">
        <mat-icon class="options-icon">settings</mat-icon>
        <span class="options-title">Advanced Options</span>
      </div>

      <!-- Upload Original Option -->
      <div class="option-row">
        <div class="option-header">
          <mat-slide-toggle [checked]="uploadOriginal()" (change)="uploadOriginal.set($event.checked)" color="primary">
            Upload Original
          </mat-slide-toggle>
          <span class="option-description">
            Skip transcoding and optimization when uploading media files
          </span>
        </div>
      </div>

      <!-- Add Client Tag Option -->
      <div class="option-row">
        <div class="option-header">
          <mat-slide-toggle [checked]="addClientTag()" (change)="addClientTag.set($event.checked)" color="primary">
            Add Client Tag
          </mat-slide-toggle>
          <span class="option-description">
            Add the Nostria client tag to this event
          </span>
        </div>
      </div>

      <!-- Expiration Option -->
      <div class="option-row">
        <div class="option-header">
          <mat-slide-toggle [checked]="expirationEnabled()" (change)="onExpirationToggle($event.checked)"
            color="primary">
            Expiration
          </mat-slide-toggle>
          <span class="option-description">Set an expiration date and time for this note</span>
        </div>

        @if (expirationEnabled()) {
        <div class="option-content">
          <div class="expiration-inputs">
            <mat-form-field appearance="outline" class="date-field">
              <mat-label>Expiration Date</mat-label>
              <input matInput [matDatepicker]="expirationPicker" [value]="expirationDate()"
                (dateInput)="onExpirationDateChange($event.value)" (dateChange)="onExpirationDateChange($event.value)"
                placeholder="Select date" [min]="minDate()" readonly />
              <mat-datepicker-toggle matIconSuffix [for]="expirationPicker"></mat-datepicker-toggle>
              <mat-datepicker #expirationPicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline" class="time-field">
              <mat-label>Expiration Time</mat-label>
              <input matInput type="time" [value]="expirationTime()" (input)="onExpirationTimeChange($event)"
                placeholder="Select time" />
            </mat-form-field>
          </div>

          @if (!expirationValidation().valid) {
          <div class="expiration-error">
            <mat-icon color="warn">warning</mat-icon>
            <span>{{ expirationValidation().message }}</span>
          </div>
          }

          <mat-hint class="expiration-hint">Note will be considered expired after this date and time</mat-hint>
        </div>
        }
      </div>

      <!-- Proof of Work Option -->
      <div class="option-row">
        <div class="option-header">
          <div class="option-label">Proof of Work (Difficulty: {{ powTargetDifficulty() }})</div>
          <span class="option-description">Add computational proof to deter spam (NIP-13)</span>
        </div>

        <div class="option-content pow-content">
          <mat-slider min="0" max="26" step="1" showTickMarks discrete [disabled]="isPowMining()">
            <input matSliderThumb [value]="powTargetDifficulty()" (valueChange)="onPowDifficultySliderChange($event)"
              aria-label="Proof of Work Difficulty">
          </mat-slider>

          @if (powTargetDifficulty() > 0) {
          <mat-hint class="pow-hint">
            Mining will start automatically when you publish.
          </mat-hint>
          }
        </div>
      </div>

      <!-- Event JSON Preview Option -->
      <div class="option-row">
        <div class="option-header">
          <mat-slide-toggle [checked]="showEventJson()" (change)="showEventJson.set($event.checked)" color="primary">
            Show Event JSON
          </mat-slide-toggle>
          <span class="option-description">
            Display the raw JSON of the event being created (useful for debugging)
          </span>
        </div>

        @if (showEventJson()) {
        <div class="option-content">
          <div class="event-json-preview">
            <pre class="json-content">{{ previewEventJson() }}</pre>
          </div>
        </div>
        }
      </div>

      <!-- Zap Split Option (only shown when quoting and logged in) -->
      @if (zapSplitAvailable()) {
      <div class="option-row">
        <div class="option-header">
          <mat-slide-toggle [checked]="zapSplitEnabled()" (change)="onZapSplitToggle($event.checked)" color="primary">
            Enable Zap Split
          </mat-slide-toggle>
          <span class="option-description">
            Split zaps between the original author and yourself when people zap your quote
          </span>
        </div>

        @if (zapSplitEnabled()) {
        <div class="option-content">
          <div class="zap-split-sliders">
            <div class="zap-split-slider">
              <div class="slider-label">
                <span>Original Author</span>
                <span class="slider-value">{{ zapSplitOriginalPercent() }}%</span>
              </div>
              <mat-slider min="0" max="100" step="1" showTickMarks discrete>
                <input matSliderThumb [value]="zapSplitOriginalPercent()"
                  (valueChange)="onZapSplitOriginalChange($event)" aria-label="Original Author Percentage">
              </mat-slider>
            </div>

            <div class="zap-split-slider">
              <div class="slider-label">
                <span>You (Quoter)</span>
                <span class="slider-value">{{ zapSplitQuoterPercent() }}%</span>
              </div>
              <mat-slider min="0" max="100" step="1" showTickMarks discrete>
                <input matSliderThumb [value]="zapSplitQuoterPercent()" (valueChange)="onZapSplitQuoterChange($event)"
                  aria-label="Quoter Percentage">
              </mat-slider>
            </div>
          </div>

          <mat-hint class="zap-split-hint">
            When someone zaps your quote, the zap will be automatically split according to these percentages (NIP-57).
          </mat-hint>
        </div>
        }
      </div>
      }
    </div>
    }

    <!-- Preview section (not in inline mode) -->
    @if (showPreview() && !showAdvancedOptions() && !inlineMode()) {
    <div class="preview-section">
      <div class="preview-header">
        <mat-icon class="preview-icon">visibility</mat-icon>
        <span class="preview-title">Preview</span>
      </div>
      <app-content class="preview-content" [content]="previewContent()"
        [preloadedEvents]="previewEventsMap()"></app-content>
      <!-- <div class="preview-content" [innerHTML]="previewContent()"></div> -->
    </div>
    }

    <!-- Drag overlay -->
    @if (isDragOver()) {
    <div class="drag-overlay">
      <div class="drag-message">
        <mat-icon class="drag-icon">cloud_upload</mat-icon>
        <span>Drop files here to upload</span>
      </div>
    </div>
    }

    <!-- Character limit warning -->
    <!-- @if (isOverLimit()) {
    <div class="warning-message">
      <mat-icon color="warn">warning</mat-icon>
      <span>Note exceeds 280 character limit</span>
    </div>
    } -->
  </div>

  <div dialog-actions class="action-container" [class.inline-actions]="inlineMode()"
    (dragenter)="!showPreview() && !showAdvancedOptions() && onDragEnter($event)"
    (dragover)="!showPreview() && !showAdvancedOptions() && onDragOver($event)"
    (dragleave)="!showPreview() && !showAdvancedOptions() && onDragLeave($event)"
    (drop)="!showPreview() && !showAdvancedOptions() && onDrop($event)">
    <!-- Left side: Action buttons -->
    <div class="left-actions">
      @if (!inlineMode()) {
      <button mat-icon-button type="button" class="desktop-action action-priority-high" (click)="togglePreview()"
        [color]="showPreview() ? 'primary' : ''" [disabled]="showAdvancedOptions()"
        [class.button-disabled-visible]="showAdvancedOptions()" matTooltip="Toggle preview">
        <mat-icon>{{ showPreview() ? 'visibility_off' : 'visibility' }}</mat-icon>
      </button>
      <button mat-icon-button type="button" class="desktop-action action-priority-low" (click)="clearDraft()"
        [disabled]="!isDirty() || showAdvancedOptions()"
        [class.button-disabled-visible]="!isDirty() || showAdvancedOptions()" matTooltip="Clear draft">
        <mat-icon>delete_sweep</mat-icon>
      </button>
      }

      <!-- Media button (shown in both dialog and inline modes) -->
      <button mat-icon-button type="button" class="desktop-action action-priority-high" [matMenuTriggerFor]="mediaMenu"
        [disabled]="isUploading() || isPublishing() || showPreview() || showAdvancedOptions()"
        [class.button-disabled-visible]="showPreview() || showAdvancedOptions()" matTooltip="Add media">
        <mat-icon>perm_media</mat-icon>
      </button>
      <mat-menu #mediaMenu="matMenu">
        <button mat-menu-item (click)="openFileDialog()">
          <mat-icon>upload</mat-icon>
          <span>Upload media</span>
        </button>
        <button mat-menu-item (click)="openMediaChooser()">
          <mat-icon>photo_library</mat-icon>
          <span>Choose from library</span>
        </button>
      </mat-menu>

      @if (!inlineMode()) {
      <button mat-icon-button type="button" class="desktop-action action-priority-high"
        (click)="toggleAdvancedOptions()" [color]="showAdvancedOptions() ? 'primary' : ''"
        matTooltip="Advanced options">
        <mat-icon>settings</mat-icon>
      </button>
      }

      <!-- Emoji picker button (shown in both dialog and inline modes) -->
      @if (layout.isHandset()) {
      <button mat-icon-button type="button" class="desktop-action action-priority-medium"
        [disabled]="isUploading() || isPublishing() || showPreview() || showAdvancedOptions()"
        [class.button-disabled-visible]="showPreview() || showAdvancedOptions()" matTooltip="Emoji"
        (click)="openEmojiPickerDialog()">
        <mat-icon>sentiment_satisfied</mat-icon>
      </button>
      } @else {
      <button mat-icon-button type="button" class="desktop-action action-priority-medium"
        [matMenuTriggerFor]="emojiMenu"
        [disabled]="isUploading() || isPublishing() || showPreview() || showAdvancedOptions()"
        [class.button-disabled-visible]="showPreview() || showAdvancedOptions()" matTooltip="Emoji">
        <mat-icon>sentiment_satisfied</mat-icon>
      </button>
      <mat-menu #emojiMenu="matMenu" class="emoji-picker-menu">
        <app-emoji-picker (emojiSelected)="insertEmoji($event)"></app-emoji-picker>
      </mat-menu>
      }

      <!-- Dictation button (hidden on smaller screens) -->
      @if (!layout.isHandset()) {
      <button mat-icon-button type="button" class="desktop-action action-priority-medium dictation-action"
        (click)="toggleRecording()" [color]="isRecording() ? 'warn' : ''"
        [disabled]="isUploading() || isPublishing() || showPreview() || showAdvancedOptions() || isTranscribing()"
        [class.button-disabled-visible]="isUploading() || isPublishing() || showPreview() || showAdvancedOptions() || isTranscribing()"
        [matTooltip]="isRecording() ? 'Stop listening' : (inlineMode() ? 'Dictate reply' : 'Dictate note')">
        @if (isTranscribing()) {
        <mat-icon class="spinning">sync</mat-icon>
        } @else if (isRecording()) {
        <mat-icon>stop</mat-icon>
        } @else {
        <mat-icon>mic</mat-icon>
        }
      </button>
      }
      @if (recordingHistory.length > 0) {
      <button mat-icon-button type="button" class="desktop-action action-priority-low" (click)="undoLastRecording()"
        [disabled]="isUploading() || isPublishing() || showPreview() || showAdvancedOptions() || isTranscribing()"
        [class.button-disabled-visible]="isUploading() || isPublishing() || showPreview() || showAdvancedOptions() || isTranscribing()"
        matTooltip="Undo last recording">
        <mat-icon>undo</mat-icon>
      </button>
      }

      @if (!inlineMode()) {
      <button mat-icon-button type="button" class="desktop-action action-priority-low" [matMenuTriggerFor]="aiMenu"
        [disabled]="isUploading() || isPublishing() || showPreview() || showAdvancedOptions()"
        [class.button-disabled-visible]="showPreview() || showAdvancedOptions()" matTooltip="AI Tools">
        <mat-icon>psychology</mat-icon>
      </button>
      <mat-menu #aiMenu="matMenu">
        <button mat-menu-item (click)="openAiDialog('generate')" disabled matTooltip="Temporarily disabled">
          <mat-icon>auto_awesome</mat-icon>
          <span>Generate Text</span>
        </button>
        <button mat-menu-item (click)="openAiDialog('translate')">
          <mat-icon>translate</mat-icon>
          <span>Translate</span>
        </button>
        <button mat-menu-item (click)="openAiDialog('sentiment')">
          <mat-icon>mood</mat-icon>
          <span>Sentiment Analysis</span>
        </button>
      </mat-menu>

      <button mat-icon-button type="button" class="mobile-actions-trigger" [matMenuTriggerFor]="mobileActionsMenu"
        [disabled]="isUploading() || isPublishing()" matTooltip="More actions">
        <mat-icon>more_horiz</mat-icon>
      </button>

      <mat-menu #mobileActionsMenu="matMenu">
        <button mat-menu-item (click)="togglePreview()" [disabled]="showAdvancedOptions()">
          <mat-icon>{{ showPreview() ? 'visibility_off' : 'visibility' }}</mat-icon>
          <span>{{ showPreview() ? 'Hide preview' : 'Show preview' }}</span>
        </button>

        <button mat-menu-item (click)="clearDraft()" [disabled]="!isDirty() || showAdvancedOptions()">
          <mat-icon>delete_sweep</mat-icon>
          <span>Clear draft</span>
        </button>

        <button mat-menu-item (click)="openFileDialog()"
          [disabled]="isUploading() || isPublishing() || showPreview() || showAdvancedOptions()">
          <mat-icon>upload</mat-icon>
          <span>Upload media</span>
        </button>

        <button mat-menu-item (click)="openMediaChooser()"
          [disabled]="isUploading() || isPublishing() || showPreview() || showAdvancedOptions()">
          <mat-icon>photo_library</mat-icon>
          <span>Choose from library</span>
        </button>

        <button mat-menu-item (click)="openEmojiPickerDialog()"
          [disabled]="isUploading() || isPublishing() || showPreview() || showAdvancedOptions()">
          <mat-icon>sentiment_satisfied</mat-icon>
          <span>Emoji</span>
        </button>

        @if (!layout.isHandset()) {
        <button mat-menu-item (click)="toggleRecording()"
          [disabled]="isUploading() || isPublishing() || showPreview() || showAdvancedOptions() || isTranscribing()">
          <mat-icon [class.spinning]="isTranscribing()">{{ isTranscribing() ? 'sync' : (isRecording() ? 'stop' : 'mic')
            }}</mat-icon>
          <span>{{ isTranscribing() ? 'Transcribing...' : (isRecording() ? 'Stop listening' : 'Dictate note') }}</span>
        </button>
        }

        @if (recordingHistory.length > 0) {
        <button mat-menu-item (click)="undoLastRecording()"
          [disabled]="isUploading() || isPublishing() || showPreview() || showAdvancedOptions() || isTranscribing()">
          <mat-icon>undo</mat-icon>
          <span>Undo last recording</span>
        </button>
        }

        <button mat-menu-item (click)="openAiDialog('generate')" disabled matTooltip="Temporarily disabled">
          <mat-icon>auto_awesome</mat-icon>
          <span>Generate Text</span>
        </button>

        <button mat-menu-item (click)="openAiDialog('translate')"
          [disabled]="isUploading() || isPublishing() || showPreview() || showAdvancedOptions()">
          <mat-icon>translate</mat-icon>
          <span>Translate</span>
        </button>

        <button mat-menu-item (click)="openAiDialog('sentiment')"
          [disabled]="isUploading() || isPublishing() || showPreview() || showAdvancedOptions()">
          <mat-icon>mood</mat-icon>
          <span>Sentiment Analysis</span>
        </button>

        <button mat-menu-item (click)="toggleAdvancedOptions()">
          <mat-icon>settings</mat-icon>
          <span>{{ showAdvancedOptions() ? 'Hide advanced options' : 'Advanced options' }}</span>
        </button>
      </mat-menu>
      }
    </div>

    <!-- Right side: PoW indicator and primary actions -->
    <div class="right-actions">
      @if (powEnabled() && isPowMining()) {
      <div class="pow-progress-indicator">
        <mat-icon class="pow-icon spinning">auto_awesome</mat-icon>
        <span class="pow-text">Mining PoW: {{ powDifficulty() }}/{{ powTargetDifficulty() }} bits</span>
      </div>
      }

      @if (!inlineMode()) {
      <button mat-button (click)="cancel()" [disabled]="isPublishing()">Cancel</button>
      }

      <button mat-flat-button (click)="publishNote()" [disabled]="!canPublish() || isPublishing()"
        class="publish-button" [matTooltip]="inlineMode() ? 'Ctrl+Enter' : 'Alt+Enter'">
        @if (isPublishing()) {
        <ng-container>
          <mat-icon class="spinning">hourglass_empty</mat-icon>
          {{ inlineMode() ? 'Sending...' : 'Publishing...' }}
        </ng-container>
        } @else {
        <ng-container>
          @if (inlineMode()) {
          Reply
          } @else {
          <span>Publish</span>
          <span class="publish-note-word"> Note</span>
          }
        </ng-container>
        }
      </button>
    </div>
  </div>
</div>
}