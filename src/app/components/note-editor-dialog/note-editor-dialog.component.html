<div class="note-editor-dialog">
  <div mat-dialog-title class="dialog-header">
    <span>
      @if (isReply()) {
      Reply to Note
      } @else if (isQuote()) {
      Quote Note
      } @else {
      Create Note
      }
    </span>
    <button mat-icon-button (click)="cancel()" class="close-button">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div mat-dialog-content class="dialog-content" (dragenter)="onDragEnter($event)" (dragover)="onDragOver($event)"
    (dragleave)="onDragLeave($event)" (drop)="onDrop($event)" [class.drag-over]="isDragOver()">
    <!-- Drag overlay -->
    @if (isDragOver()) {
    <div class="drag-overlay">
      <div class="drag-message">
        <mat-icon class="drag-icon">cloud_upload</mat-icon>
        <span>Drop files here to upload</span>
      </div>
    </div>
    }

    <!-- Current Account Display -->
    <div class="current-account-banner">
      <div class="current-account-info">
        <div class="current-account-avatar">
          @if (currentAccountAvatar()) {
          <img [src]="currentAccountAvatar()" alt="Current account avatar" class="account-avatar-img" />
          } @else {
          <mat-icon class="account-avatar-icon">account_circle</mat-icon>
          }
        </div>
        <div class="current-account-details">
          <span class="current-account-label">Publishing as</span>
          <span class="current-account-name">{{ currentAccountDisplayName() }}</span>
        </div>
      </div>
    </div>

    <!-- Error display -->
    @if (mediaService.error()) {
    <div class="error-container">
      <mat-icon color="warn">error</mat-icon>
      <p>{{ mediaService.error() }}</p>
      <button mat-button (click)="dismissError()">Dismiss</button>
    </div>
    }

    <!-- Upload progress -->
    @if (isUploading()) {
    <div class="upload-progress">
      <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      <span class="upload-text">Uploading files...</span>
    </div>
    }
    <!-- Reply context -->
    @if (isReply()) {
    <div class="reply-context">
      <mat-icon class="reply-icon">reply</mat-icon>
      <span class="reply-text">Replying to note</span>
    </div>
    }

    <!-- Quote context -->
    @if (isQuote()) {
    <div class="quote-context">
      <mat-icon class="quote-icon">format_quote</mat-icon>
      <span class="quote-text">Quoting: "{{ (data.quote?.content || '').slice(0, 100)
        }}{{ (data.quote?.content || '').length > 100 ? '...' : '' }}"</span>
    </div>
    }

    <!-- Content editor with upload actions -->
    <div class="content-editor-section">
      <div class="textarea-container">
        <mat-form-field appearance="outline" class="content-field">
          <mat-label>What's on your mind?</mat-label>
          <textarea matInput [value]="content()" (input)="onContentInput($event)" (keydown)="onContentKeyDown($event)"
            (keyup)="onContentKeyUp($event)" (click)="onContentClick($event)"
            placeholder="Write your note... Use @ to mention someone" rows="4" class="content-textarea"
            #contentTextarea>
          </textarea>
          <mat-hint align="end"> {{ characterCount() }} characters </mat-hint>
        </mat-form-field>

        <!-- Mention Autocomplete positioned relative to textarea -->
        @if (mentionConfig()) {
        <app-mention-autocomplete [config]="mentionConfig()" [position]="mentionPosition()" [maxResults]="15"
          [maxHeight]="400" (mentionSelected)="onMentionSelected($event)"
          (dismissed)="onMentionDismissed()"></app-mention-autocomplete>
        }
      </div>

      <!-- Upload actions -->
      <div class="upload-actions">
        <button mat-icon-button type="button" (click)="togglePreview()" [color]="showPreview() ? 'primary' : ''"
          matTooltip="Toggle preview">
          <mat-icon>{{ showPreview() ? 'visibility_off' : 'visibility' }}</mat-icon>
        </button>
        <button mat-icon-button type="button" (click)="openFileDialog()" [disabled]="isUploading() || isPublishing()"
          matTooltip="Upload image">
          <mat-icon>image</mat-icon>
        </button>
        <button mat-icon-button type="button" (click)="toggleAdvancedOptions()"
          [color]="showAdvancedOptions() ? 'primary' : ''" matTooltip="Advanced options">
          <mat-icon>settings</mat-icon>
        </button>
      </div>

      <!-- Hidden file input -->
      <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" multiple
        class="hidden-file-input" aria-label="Upload image files" />
    </div>

    <!-- Advanced Options -->
    @if (showAdvancedOptions()) {
    <div class="advanced-options-section">
      <div class="advanced-options-header">
        <mat-icon class="options-icon">settings</mat-icon>
        <span class="options-title">Advanced Options</span>
      </div>

      <!-- Upload Original Option -->
      <div class="option-row">
        <div class="option-header">
          <mat-slide-toggle [checked]="uploadOriginal()" (change)="uploadOriginal.set($event.checked)" color="primary">
            Upload Original
          </mat-slide-toggle>
          <span class="option-description">
            Skip transcoding and optimization when uploading media files
          </span>
        </div>
      </div>

      <!-- Add Client Tag Option -->
      <div class="option-row">
        <div class="option-header">
          <mat-slide-toggle [checked]="addClientTag()" (change)="addClientTag.set($event.checked)" color="primary">
            Add Client Tag
          </mat-slide-toggle>
          <span class="option-description">
            Add the Nostria client tag to this event
          </span>
        </div>
      </div>

      <!-- Expiration Option -->
      <div class="option-row">
        <div class="option-header">
          <mat-slide-toggle [checked]="expirationEnabled()" (change)="onExpirationToggle($event.checked)"
            color="primary">
            Expiration
          </mat-slide-toggle>
          <span class="option-description">Set an expiration date and time for this note</span>
        </div>

        @if (expirationEnabled()) {
        <div class="option-content">
          <div class="expiration-inputs">
            <mat-form-field appearance="outline" class="date-field">
              <mat-label>Expiration Date</mat-label>
              <input matInput [matDatepicker]="expirationPicker" [value]="expirationDate()"
                (dateInput)="onExpirationDateChange($event.value)" (dateChange)="onExpirationDateChange($event.value)"
                placeholder="Select date" [min]="minDate()" readonly />
              <mat-datepicker-toggle matIconSuffix [for]="expirationPicker"></mat-datepicker-toggle>
              <mat-datepicker #expirationPicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline" class="time-field">
              <mat-label>Expiration Time</mat-label>
              <input matInput type="time" [value]="expirationTime()" (input)="onExpirationTimeChange($event)"
                placeholder="Select time" />
            </mat-form-field>
          </div>

          @if (!expirationValidation().valid) {
          <div class="expiration-error">
            <mat-icon color="warn">warning</mat-icon>
            <span>{{ expirationValidation().message }}</span>
          </div>
          }

          <mat-hint class="expiration-hint">Note will be considered expired after this date and time</mat-hint>
        </div>
        }
      </div>

      <!-- Proof of Work Option -->
      <div class="option-row">
        <div class="option-header">
          <mat-slide-toggle [checked]="powEnabled()" (change)="onPowToggle($event.checked)" color="primary">
            Proof of Work
          </mat-slide-toggle>
          <span class="option-description">Add computational proof to deter spam (NIP-13)</span>
        </div>

        @if (powEnabled()) {
        <div class="option-content pow-content">
          <!-- Target Difficulty Input -->
          <mat-form-field appearance="outline" class="difficulty-field">
            <mat-label>Target Difficulty (bits)</mat-label>
            <input matInput type="number" min="1" max="40" [value]="powTargetDifficulty()"
              (input)="onPowDifficultyChange($event)" [disabled]="isPowMining()" placeholder="20" />
            <mat-hint>Number of leading zero bits (recommended: 20-25)</mat-hint>
          </mat-form-field>

          <!-- Mining Controls -->
          <div class="pow-controls">
            @if (!isPowMining() && !hasPowResult()) {
            <button mat-raised-button color="primary" (click)="startPow()" [disabled]="!content().trim()">
              <mat-icon>auto_awesome</mat-icon>
              Generate Proof
            </button>
            }

            @if (isPowMining()) {
            <button mat-raised-button color="warn" (click)="stopPow()">
              <mat-icon>stop</mat-icon>
              Stop Mining
            </button>
            }

            @if (hasPowResult() && !isPowMining()) {
            <button mat-raised-button (click)="resetPow()">
              <mat-icon>refresh</mat-icon>
              Reset & Mine Again
            </button>
            }
          </div>

          <!-- Mining Progress -->
          @if (isPowMining() || hasPowResult()) {
          <div class="pow-progress-section">
            <div class="pow-stats">
              <div class="pow-stat">
                <span class="stat-label">Difficulty Achieved:</span>
                <span class="stat-value">{{ powDifficulty() }} bits</span>
              </div>
              <div class="pow-stat">
                <span class="stat-label">Attempts:</span>
                <span class="stat-value">{{ powAttempts().toLocaleString() }}</span>
              </div>
              @if (hasPowResult()) {
              <div class="pow-stat success">
                <mat-icon>check_circle</mat-icon>
                <span class="stat-label">Ready to publish with PoW!</span>
              </div>
              }
            </div>

            @if (isPowMining()) {
            <div class="pow-progress-bar">
              <mat-progress-bar mode="determinate" [value]="powProgressPercentage()" color="accent"></mat-progress-bar>
              <span class="progress-text">{{ powProgressPercentage().toFixed(1) }}% to target</span>
            </div>
            }
          </div>
          }

          <mat-hint class="pow-hint">
            Mining will find a nonce that makes the event ID start with zero bits.
            Higher difficulty takes exponentially longer but provides stronger spam protection.
          </mat-hint>
        </div>
        }
      </div>
    </div>
    }

    <!-- Preview section -->
    @if (showPreview()) {
    <div class="preview-section">
      <div class="preview-header">
        <mat-icon class="preview-icon">visibility</mat-icon>
        <span class="preview-title">Preview</span>
      </div>
      <app-content class="preview-content" [content]="previewContent()"></app-content>
      <!-- <div class="preview-content" [innerHTML]="previewContent()"></div> -->
    </div>
    }

    <!-- Mentions -->
    @if (mentions().length > 0) {
    <div class="mentions-section">
      <span class="mentions-label">Mentioning:</span>
      <mat-chip-set class="mentions-chips">
        @for (mention of mentions(); track mention) {
        <mat-chip removable (removed)="removeMention(mention)">
          {{ mention.slice(0, 16) }}...
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
        }
      </mat-chip-set>
    </div>
    }

    <!-- Character limit warning -->
    <!-- @if (isOverLimit()) {
    <div class="warning-message">
      <mat-icon color="warn">warning</mat-icon>
      <span>Note exceeds 280 character limit</span>
    </div>
    } -->
  </div>

  <div mat-dialog-actions class="dialog-actions">
    @if (powEnabled() && isPowMining()) {
    <div class="pow-progress-indicator">
      <mat-icon class="pow-icon spinning">auto_awesome</mat-icon>
      <span class="pow-text">Mining PoW: {{ powDifficulty() }}/{{ powTargetDifficulty() }} bits</span>
    </div>
    }

    <button mat-button (click)="cancel()" [disabled]="isPublishing()">Cancel</button>

    <button mat-flat-button (click)="publishNote()" [disabled]="!canPublish()" class="publish-button">
      @if (isPublishing()) {
      <ng-container>
        <mat-icon class="spinning">hourglass_empty</mat-icon>
        Publishing...
      </ng-container>
      } @else {
      <ng-container>
        <!-- <mat-icon>send</mat-icon> -->
        Publish Note
      </ng-container>
      }
    </button>
  </div>
</div>