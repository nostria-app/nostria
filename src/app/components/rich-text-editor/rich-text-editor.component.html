<div class="rich-editor-container" [class.drag-over]="isDragOver()"
  [class.preview-hidden]="previewActive() && !splitViewActive() && !showEditorContent()"
  (dragenter)="onDragEnter($event)" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)"
  (drop)="onDrop($event)">
  <!-- Hidden file input -->
  <input #fileInput type="file" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip,.rar"
    (change)="onFileSelected($event)" class="hidden-file-input" aria-label="Upload files" title="Upload files" />

  @if (!previewActive() || splitViewActive()) {
  <div class="editor-toolbar">
    <div class="toolbar-content">
      <div class="editor-actions">
        @if (showArticleActions()) {
        @if (!splitViewActive()) {
        <button mat-icon-button type="button" (click)="requestTogglePreview()" [disabled]="actionsDisabled()"
          [matTooltip]="previewActive() ? 'Edit' : 'Preview'">
          <mat-icon>{{ previewActive() ? 'visibility_off' : 'visibility' }}</mat-icon>
        </button>
        }

        @if (canUseSplitView()) {
        <button mat-icon-button type="button" (click)="requestToggleSplitView()" [disabled]="actionsDisabled()"
          matTooltip="Split view">
          <mat-icon>{{ splitViewActive() ? 'right_panel_open' : 'right_panel_close' }}</mat-icon>
        </button>
        }

        @if (showFeaturedImageAction() && !hasFeaturedImage()) {
        <button mat-icon-button [matMenuTriggerFor]="featuredImageMenu" type="button" [disabled]="actionsDisabled()"
          matTooltip="Add featured image">
          <mat-icon>add_photo_alternate</mat-icon>
        </button>
        <mat-menu #featuredImageMenu="matMenu">
          <button mat-menu-item (click)="requestFeaturedImageUpload()">
            <mat-icon>upload</mat-icon>
            <span>Upload Image</span>
          </button>
          <button mat-menu-item (click)="requestFeaturedImageLibrary()">
            <mat-icon>photo_library</mat-icon>
            <span>Choose from library</span>
          </button>
          <button mat-menu-item (click)="requestFeaturedImageUrl()">
            <mat-icon>link</mat-icon>
            <span>Image from URL</span>
          </button>
        </mat-menu>
        }

        <button mat-icon-button type="button" (mousedown)="preserveInsertionPoint($event)"
          (click)="requestInsertReference()" [disabled]="actionsDisabled()" matTooltip="Insert reference">
          <mat-icon>bookmarks</mat-icon>
        </button>

        <button mat-icon-button type="button" (click)="requestImportArticle()" [disabled]="actionsDisabled()"
          matTooltip="Import article event">
          <mat-icon>file_download</mat-icon>
        </button>

        <button mat-icon-button [matMenuTriggerFor]="aiMenu" [disabled]="actionsDisabled()" matTooltip="AI Tools">
          <mat-icon>psychology</mat-icon>
        </button>
        <mat-menu #aiMenu="matMenu">
          <button mat-menu-item (click)="requestAiAction('generate')" disabled matTooltip="Temporarily disabled">
            <mat-icon>auto_awesome</mat-icon>
            <span>Generate Text</span>
          </button>
          <button mat-menu-item (click)="requestAiAction('translate')">
            <mat-icon>translate</mat-icon>
            <span>Translate</span>
          </button>
          <button mat-menu-item (click)="requestAiAction('sentiment')">
            <mat-icon>mood</mat-icon>
            <span>Sentiment Analysis</span>
          </button>
        </mat-menu>

        <button mat-icon-button type="button" (click)="requestToggleRecording()"
          [disabled]="actionsDisabled() || transcribing()" matTooltip="Dictate content">
          @if (transcribing()) {
          <mat-icon class="spinning">sync</mat-icon>
          } @else {
          <mat-icon>{{ recording() ? 'mic_off' : 'mic' }}</mat-icon>
          }
        </button>

        <mat-divider [vertical]="true"></mat-divider>
        }

        <button mat-icon-button (click)="applyBold()" [disabled]="actionsDisabled()" matTooltip="Bold">
          <mat-icon>format_bold</mat-icon>
        </button>

        <button mat-icon-button (click)="applyItalic()" [disabled]="actionsDisabled()" matTooltip="Italic">
          <mat-icon>format_italic</mat-icon>
        </button>

        <mat-divider [vertical]="true"></mat-divider>

        <button mat-icon-button (click)="applyHeading(1)" [disabled]="actionsDisabled()" matTooltip="Heading 1">
          <mat-icon>looks_one</mat-icon>
        </button>

        <button mat-icon-button (click)="applyHeading(2)" [disabled]="actionsDisabled()" matTooltip="Heading 2">
          <mat-icon>looks_two</mat-icon>
        </button>

        <button mat-icon-button (click)="applyHeading(3)" [disabled]="actionsDisabled()" matTooltip="Heading 3">
          <mat-icon>looks_3</mat-icon>
        </button>

        <mat-divider [vertical]="true"></mat-divider>

        <button mat-icon-button (click)="applyQuote()" [disabled]="actionsDisabled()" matTooltip="Quote">
          <mat-icon>format_quote</mat-icon>
        </button>

        <button mat-icon-button (click)="applyUnorderedList()" [disabled]="actionsDisabled()" matTooltip="Bullet List">
          <mat-icon>format_list_bulleted</mat-icon>
        </button>

        <button mat-icon-button (click)="applyOrderedList()" [disabled]="actionsDisabled()" matTooltip="Numbered List">
          <mat-icon>format_list_numbered</mat-icon>
        </button>

        <mat-divider [vertical]="true"></mat-divider>

        <button mat-icon-button (click)="applyLink()" [disabled]="actionsDisabled()" matTooltip="Insert Link">
          <mat-icon>link</mat-icon>
        </button>

        <button mat-icon-button (click)="insertCode()" [disabled]="actionsDisabled()" matTooltip="Format as Code">
          <mat-icon>code</mat-icon>
        </button>

        <button mat-icon-button (click)="insertHorizontalRule()" [disabled]="actionsDisabled()" matTooltip="Divider">
          <mat-icon>horizontal_rule</mat-icon>
        </button>

        <mat-divider [vertical]="true"></mat-divider>

        <button mat-icon-button [matMenuTriggerFor]="imageMenu" [disabled]="isUploading() || actionsDisabled()"
          matTooltip="Insert Media">
          @if (isUploading()) {
          <mat-icon>hourglass_empty</mat-icon>
          } @else {
          <mat-icon>image</mat-icon>
          }
        </button>

        <mat-menu #imageMenu="matMenu">
          <button mat-menu-item (click)="openAnyFileDialog()">
            <mat-icon>upload</mat-icon>
            <span>Upload media</span>
          </button>
          <button mat-menu-item (click)="openMediaChooser()">
            <mat-icon>photo_library</mat-icon>
            <span>Choose from library</span>
          </button>
          <button mat-menu-item (click)="insertImageFromUrl()">
            <mat-icon>link</mat-icon>
            <span>Media from URL</span>
          </button>
        </mat-menu>

        <button mat-icon-button (click)="openAnyFileDialog()" [disabled]="isUploading() || actionsDisabled()"
          matTooltip="Upload File">
          <mat-icon>attach_file</mat-icon>
        </button>

        <div class="editor-mode-toggle" role="group" aria-label="Editor mode">
          <!-- <span class="toggle-label">Mode</span> -->
          <button mat-stroked-button type="button" class="mode-button" [class.active]="isRichTextMode()"
            (click)="setEditorMode(true)">
            Rich text
          </button>
          <button mat-stroked-button type="button" class="mode-button" [class.active]="!isRichTextMode()"
            (click)="setEditorMode(false)">
            Markdown
          </button>
        </div>
      </div>
    </div>
  </div>
  }

  <div class="editor-content-area" [class.content-hidden]="!showEditorContent()">
    @if (isUploading()) {
    <div class="upload-progress">
      <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      <span>Uploading files...</span>
    </div>
    }

    @if (isDragOver()) {
    <div class="drag-overlay">
      <div class="drag-message">
        <mat-icon>cloud_upload</mat-icon>
        <p>Drop files here to upload</p>
      </div>
    </div>
    }

    @if (isRichTextMode()) {
    <div #editorContent class="rich-text-content" contenteditable="true" (input)="onRichTextContentChange()"
      (mouseup)="onTextSelection()" (keyup)="onTextSelection()" [attr.placeholder]="'Start writing...'"
      (focus)="onEditorFocus()" (blur)="onEditorBlur()" (keydown)="onEditorKeyDown($event)">
    </div>
    } @else {
    <textarea #markdownTextarea class="markdown-content" [value]="markdownContent()"
      (input)="onMarkdownContentChange($event)" placeholder="Start writing your article content in Markdown..."
      (focus)="onEditorFocus()" (blur)="onEditorBlur()" (select)="onMarkdownSelectionChange($event)"
      (click)="onMarkdownSelectionChange($event)" (keyup)="onMarkdownSelectionChange($event)"
      (keydown)="onEditorKeyDown($event)">
      </textarea>
    }
  </div>

  <!-- Floating Toolbar -->
  <app-floating-toolbar [visible]="showFloatingToolbar()" [position]="floatingToolbarPosition()" (bold)="applyBold()"
    (italic)="applyItalic()" (link)="applyLink()" (heading1)="applyHeading(1)" (heading2)="applyHeading(2)"
    (heading3)="applyHeading(3)" (quote)="applyQuote()" />
</div>