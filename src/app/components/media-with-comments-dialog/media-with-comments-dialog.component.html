<div class="dialog-container" (keydown)="onKeyDown($event)" tabindex="0">
  <!-- Header with close and bookmark buttons -->
  <div class="dialog-header">
    <button mat-icon-button class="bookmark-button" (click)="toggleBookmark($event)"
      [matTooltip]="bookmark.getBookmarkTooltip(event().id)" matTooltipPosition="below">
      <mat-icon>{{ bookmark.getBookmarkIcon(event().id) }}</mat-icon>
    </button>

    <!-- Navigation buttons for media items -->
    @if (hasNavigation()) {
    <div class="header-navigation">
      <button mat-icon-button class="media-nav-button media-nav-left" (click)="goToPreviousMedia()"
        [disabled]="!canGoPrevious()" [matTooltip]="'Previous media (←)'" matTooltipPosition="below"
        aria-label="Previous media">
        <mat-icon>chevron_left</mat-icon>
      </button>
      <div class="media-counter">
        {{ currentIndex() + 1 }} / {{ allEvents().length }}
      </div>
      <button mat-icon-button class="media-nav-button media-nav-right" (click)="goToNextMedia()"
        [disabled]="!canGoNext()" [matTooltip]="'Next media (→)'" matTooltipPosition="below" aria-label="Next media">
        <mat-icon>chevron_right</mat-icon>
      </button>
    </div>
    }

    <div class="header-buttons-right">
      <app-event-menu [event]="event()" view="icon"></app-event-menu>
      <button mat-icon-button class="close-button" (click)="close()" aria-label="Close">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>

  <div class="split-view" (touchstart)="onTouchStart($event)" (touchend)="onTouchEnd($event)">
    <!-- Left side: Media -->
    <div class="media-side">
      @if (title()) {
      <h3 class="media-title">{{ title() }}</h3>
      }

      @if (isPhoto()) {
      <!-- Photo Carousel -->
      <div class="photo-carousel">
        <div class="photo-container clickable" (click)="openImagePreview()">
          <img [src]="currentImageUrl()" [alt]="title() || 'Photo'" [title]="title() || 'Photo'" class="photo-item"
            loading="lazy" [class.blurred]="shouldBlurMedia() && !isRevealed()" />
        </div>

        <!-- Blur overlay for privacy protection -->
        @if (shouldBlurMedia() && !isRevealed()) {
        <div class="blur-overlay">
          <div class="blur-content">
            <mat-icon class="blur-icon">visibility_off</mat-icon>
            <p class="blur-text">Content from unknown author</p>
            <div class="blur-actions">
              <button mat-stroked-button (click)="revealMedia(); $event.stopPropagation()">
                <mat-icon>visibility</mat-icon>
                Reveal this
              </button>
              <button mat-flat-button (click)="trustAuthor(); $event.stopPropagation()">
                <mat-icon>verified_user</mat-icon>
                Always reveal this user
              </button>
            </div>
          </div>
        </div>
        }

        @if (hasMultipleImages()) {
        <!-- Navigation buttons -->
        @if (canGoToPrevious()) {
        <button mat-icon-button class="carousel-nav-button carousel-nav-left"
          (click)="goToPrevious(); $event.stopPropagation()" aria-label="Previous photo">
          <mat-icon>chevron_left</mat-icon>
        </button>
        }

        @if (canGoToNext()) {
        <button mat-icon-button class="carousel-nav-button carousel-nav-right"
          (click)="goToNext(); $event.stopPropagation()" aria-label="Next photo">
          <mat-icon>chevron_right</mat-icon>
        </button>
        }

        <!-- Indicator dots -->
        <div class="carousel-indicators">
          @for (imageUrl of imageUrls(); track imageUrl) {
          <button class="indicator-dot" [class.active]="currentImageIndex() === $index"
            (click)="goToIndex($index); $event.stopPropagation()" [attr.aria-label]="'Go to photo ' + ($index + 1)"
            [title]="'Go to photo ' + ($index + 1)">
          </button>
          }
        </div>
        }
      </div>
      } @else if (isVideo()) {
      <!-- Video Player -->
      @let videoInfo = videoData();
      @if (videoInfo) {
      <div class="video-container">
        <!-- Use @for with track to force re-render when event changes -->
        @for (ev of [event()]; track ev.id) {
        <video controls class="video-player" autoplay [poster]="videoInfo.thumbnail"
          [class.blurred]="shouldBlurMedia() && !isRevealed()">
          <source [src]="videoInfo.url" [type]="videoMimeType()" />
          Your browser does not support the video tag.
        </video>
        }

        <!-- Blur overlay for privacy protection -->
        @if (shouldBlurMedia() && !isRevealed()) {
        <div class="blur-overlay">
          <div class="blur-content">
            <mat-icon class="blur-icon">visibility_off</mat-icon>
            <p class="blur-text">Content from unknown author</p>
            <div class="blur-actions">
              <button mat-stroked-button (click)="revealMedia(); $event.stopPropagation()">
                <mat-icon>visibility</mat-icon>
                Reveal this
              </button>
              <button mat-flat-button (click)="trustAuthor(); $event.stopPropagation()">
                <mat-icon>verified_user</mat-icon>
                Always reveal this user
              </button>
            </div>
          </div>
        </div>
        }
      </div>
      }
      }

      @if (description()) {
      <p class="media-description">{{ description() }}</p>
      }

      @if (hasGeohash()) {
      <div class="geohash-container">
        <a [href]="getGeohashUrl()" target="_blank" rel="noopener noreferrer" class="geohash-link"
          [matTooltip]="'Location: ' + getGeohash()" matTooltipPosition="above">
          <mat-icon>location_on</mat-icon>
          <span>View location</span>
        </a>
      </div>
      }

      @if (hashtags().length > 0) {
      <div class="hashtags-container">
        <mat-chip-set>
          @for (tag of hashtags(); track tag) {
          <mat-chip>#{{ tag }}</mat-chip>
          }
        </mat-chip-set>
      </div>
      }
    </div>

    <!-- Right side: Comments -->
    <div class="comments-side" aria-label="Comments">
      <div class="comments-header">
        <h2>Comments</h2>
      </div>

      <div class="comments-content" cdkScrollable>
        <app-comments-list [event]="event()" [autoExpand]="true"></app-comments-list>
      </div>

      @if (false) {
      <div class="comments-footer"><!-- placeholder for composer --></div>
      }
    </div>
  </div>
</div>