<div class="app-container" [class.dark-theme]="themeService.darkMode()">
  <!-- Top toolbar - now outside and above the sidenav container -->
  <mat-toolbar color="primary" class="app-toolbar">
    <button mat-icon-button (click)="toggleSidenav()" aria-label="Toggle sidenav">
      <mat-icon>menu</mat-icon>
    </button>
    <img src="icons/icon-128x128.png" class="app-icon" alt="Nostria icon">
    <span class="app-title">{{title}}</span>
    <span class="toolbar-spacer"></span>
    @if (pwaUpdateService.updateAvailable()) {
    <button mat-icon-button class="update-button" (click)="pwaUpdateService.updateApplication()"
      matTooltip="Update available! Click to update and reload." aria-label="Update application">
      <mat-icon class="update-icon">system_update</mat-icon>
    </button>
    }
    <button mat-icon-button (click)="themeService.toggleDarkMode()" aria-label="Toggle theme">
      <mat-icon>{{ themeService.darkMode() ? 'dark_mode' : 'light_mode' }}</mat-icon>
    </button>
    <button mat-icon-button (click)="toggleProfileSidenav()" aria-label="Toggle profile" class="profile-button">
      <mat-icon>account_circle</mat-icon>
    </button>
  </mat-toolbar>

  <!-- Sidenav container now below the toolbar -->
  <mat-sidenav-container class="sidenav-container" autosize="true">
    <!-- Side navigation -->
    <mat-sidenav #sidenav class="sidenav"
      [ngClass]="{ 'sidenav-labels': displayLabels(), 'sidenav-small': !displayLabels()  }" [opened]="opened()"
      [mode]="isHandset() ? 'over' : 'side'" [fixedInViewport]="false">
      <mat-nav-list>
        @for (item of navItems; track $index) {
        <a mat-list-item [routerLink]="item.action ? undefined : [item.path]" routerLinkActive="active-link"
          (click)="item.action ? item.action() : (isHandset() ? toggleSidenav() : null)">
          <mat-icon matListItemIcon>{{item.icon}}</mat-icon>
          @if(displayLabels()) {
          <span class="nav-label">{{item.label}}</span>
          }
        </a>
        }

        <a mat-list-item (click)="toggleMenuSize()">
          @if (displayLabels()) {
          <mat-icon>chevron_left</mat-icon>
          } @else {
          <mat-icon>chevron_right</mat-icon>
          }
        </a>
      </mat-nav-list>
    </mat-sidenav>

    <!-- Profile sidenav (right side) -->
    <mat-sidenav #profileSidenav position="end" class="profile-sidenav" mode="over">
      <mat-toolbar>
        <span>Profile</span>
        <span class="toolbar-spacer"></span>
        <button mat-icon-button (click)="toggleProfileSidenav()">
          <mat-icon>close</mat-icon>
        </button>
      </mat-toolbar>
      <div class="profile-content">
        <div class="profile-header">
          <div class="profile-avatar">
            <mat-icon class="avatar-icon">account_circle</mat-icon>
          </div>
          <h2>{{ nostrService.currentUser()?.name }}</h2>
        </div>
        <mat-divider></mat-divider>

        <!-- Account selection menu -->
        @if (nostrService.allUsers().length > 1) {
        <mat-nav-list class="accounts-list">
          @for (account of nostrService.allUsers(); track account.pubkey) {
            @if (account.pubkey !== nostrService.currentUser()?.pubkey) {
            <a mat-list-item (click)="switchAccount(account.pubkey)" class="account-item">
              <mat-icon matListItemIcon>account_circle</mat-icon>
              <span matListItemTitle>{{ account.name || getTruncatedNpub(account.pubkey) }}</span>
              <span matListItemLine class="account-source">
                {{ account.source }} â€¢ Last used: {{ account.lastUsed | date:'short' }}
              </span>
            </a>
            }
          }
        </mat-nav-list>
        <mat-divider></mat-divider>
        }

        <mat-nav-list>

          <a mat-list-item routerLink="/profile" (click)="isHandset() ? toggleProfileSidenav() : null">
            <mat-icon matListItemIcon>person</mat-icon>
            <span>My Profile</span>
          </a>
          <a mat-list-item routerLink="/credentials" (click)="isHandset() ? toggleProfileSidenav() : null">
            <mat-icon matListItemIcon>key</mat-icon>
            <span>Credentials</span>
          </a>
          <a mat-list-item (click)="logout(); toggleProfileSidenav()">
            <mat-icon matListItemIcon>logout</mat-icon>
            <span>Logout</span>
          </a>
        </mat-nav-list>
      </div>
    </mat-sidenav>

    <!-- Main content container -->
    <mat-sidenav-content>
      <!-- Page content -->
      <div class="content-wrapper">
        <router-outlet></router-outlet>
      </div>
    </mat-sidenav-content>
  </mat-sidenav-container>

  <!-- Mobile navigation footer - now outside of sidenav container -->
  @if (isHandset()) {
  <div class="mobile-nav">
    @for (item of navItems; track $index) {
    @if (item.showInMobile) {
    <a mat-button class="mobile-nav-button" [routerLink]="item.action ? undefined : [item.path]"
      routerLinkActive="active-link" (click)="item.action ? item.action() : null">
      <mat-icon>{{item.icon}}</mat-icon>
      <div class="mobile-nav-label">{{item.label}}</div>
    </a>
    }
    }
    <button mat-button class="mobile-nav-button" (click)="themeService.toggleDarkMode()">
      <mat-icon>{{ themeService.darkMode() ? 'light_mode' : 'dark_mode' }}</mat-icon>
      <div class="mobile-nav-label">Theme</div>
    </button>
  </div>
  }

  <!-- Loading overlay -->
  @if (dataLoadingService.isLoading()) {
  <app-loading-overlay [message]="dataLoadingService.loadingMessage()"></app-loading-overlay>
  }
</div>