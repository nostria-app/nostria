<div class="app-container" [class.dark-theme]="themeService.darkMode()" [class.has-right-content]="hasRightContent()"
  [attr.data-fullscreen]="layout.fullscreenMediaPlayer()"
  [style.background-color]="themeService.darkMode() ? '#0a0a0a' : '#efefef'">
  <!-- Success overlay with checkmark -->
  @if (appState.showSuccess()) {
  <div class="success-overlay">
    <div class="success-checkmark">
      <span class="success-icon">âœ“</span>
    </div>
  </div>
  }

  <!-- Sleep mode overlay -->
  <app-sleep-mode-overlay></app-sleep-mode-overlay>

  @if (layout.showWelcomeScreen()) {
  <app-welcome></app-welcome>
  }
  @if (!app.initialized()) {
  <!-- Loading state while services initialize - inline styles ensure visibility before CSS loads -->
  <div class="app-initializing" [style.background-color]="themeService.darkMode() ? '#0a0a0a' : '#efefef'">
    <div class="initializing-content">
      <img ngSrc="/icons/nostria.png" width="96" height="96" alt="Nostria" class="initializing-logo" />
      <div class="initializing-spinner"
        [style.border-color]="themeService.darkMode() ? 'rgba(255, 185, 97, 0.2)' : 'rgba(253, 161, 0, 0.2)'"
        [style.border-top-color]="themeService.darkMode() ? '#ffb961' : '#FDA100'"></div>
      <div class="initializing-text" [style.color]="themeService.darkMode() ? '#e4e4e4' : '#1a1a1a'"
        i18n="@@app.loading">Loading Nostria...</div>
    </div>
  </div>
  }
  @if (app.initialized()) {
  <!-- Sidenav container spans full height -->
  <mat-sidenav-container class="sidenav-container" [autosize]="true" (backdropClick)="onBackdropClick()">
    <!-- Side navigation -->
    <mat-sidenav #sidenav class="sidenav no-print" [class.sidenav-labels]="displayLabels()"
      [class.mobile-glass-menu]="layout.isHandset()" [class.sidenav-small]="!displayLabels()" [opened]="opened()"
      [mode]="layout.isHandset() ? 'over' : 'side'" [fixedInViewport]="false" (closed)="onSidenavClosed()"
      (opened)="onSidenavOpened()">

      <!-- User Profile Section at Top -->
      @if (displayLabels()) {
      <div class="sidenav-profile-section">
        <div class="sidenav-profile-row">
          <!-- Avatar button - closes sidenav (same position as toolbar avatar) -->
          <button (click)="toggleSidenav()" aria-label="Close menu" class="sidenav-avatar-button">
            @if (accountState.profile()?.data?.picture) {
            @if (settings.settings().imageCacheEnabled) {
            <img [src]="getOptimizedImageUrl(accountState.profile()?.data?.picture)" alt="Profile"
              class="avatar-image" />
            } @else {
            <img [src]="accountState.profile()?.data?.picture" alt="Profile" class="avatar-image" />
            }
            } @else {
            @if (app.authenticated()) {
            <mat-icon class="avatar-icon">account_circle</mat-icon>
            } @else {
            <mat-icon class="avatar-icon">account_circle_off</mat-icon>
            }
            }
          </button>
          <!-- Account info and expander - separate from avatar -->
          <div class="sidenav-account-header" [class.accounts-expanded]="accountsExpanded()"
            (click)="accountState.hasAccounts() ? toggleAccountsExpanded() : addAccount()"
            (keydown.enter)="accountState.hasAccounts() ? toggleAccountsExpanded() : addAccount()"
            (keydown.space)="$event.preventDefault(); accountState.hasAccounts() ? toggleAccountsExpanded() : addAccount()"
            tabindex="0" role="button"
            [attr.aria-label]="accountState.hasAccounts() ? (accountsExpanded() ? 'Collapse accounts' : 'Expand accounts') : 'Login or create account'">
            <div class="sidenav-profile-info">
              @if (accountState.profile()?.data; as profile) {
              <span class="sidenav-profile-name">{{ profile.display_name || profile.name || (accountState.pubkey() |
                npub)
                }}</span>
              } @else if (app.authenticated()) {
              <span class="sidenav-profile-name">{{ accountState.account()?.name || (accountState.pubkey() | npub)
                }}</span>
              } @else {
              <span class="sidenav-profile-name" i18n="@@app.profile.not-logged-in">Not logged in</span>
              }
              @if (accountState.hasActiveSubscription()) {
              <span class="sidenav-premium-badge" i18n="@@app.profile.premium"
                [matTooltip]="accountState.expiresWhen() ? ('Premium expires: ' + (accountState.expiresWhen() | date:'mediumDate')) : ''">Premium</span>
              }
            </div>
            <mat-icon class="expand-accounts-icon">{{ accountsExpanded() ? 'expand_less' : (accountState.hasAccounts() ?
              'expand_more' : 'login') }}</mat-icon>
          </div>
        </div>

        <!-- Expandable Accounts List -->
        @if (accountsExpanded() && accountState.hasAccounts()) {
        <div class="sidenav-accounts-list expanded">
          @for (item of accountsWithProfiles(); track item.account.pubkey) {
          <button class="sidenav-account-item" (click)="switchAccount(item.account.pubkey); closeSidenavOnMobile()">
            <div class="sidenav-account-avatar">
              @if (item.profile?.data?.picture) {
              @if (settings.settings().imageCacheEnabled) {
              <img [src]="getOptimizedImageUrl(item.profile!.data!.picture)" alt="Profile" class="avatar-image" />
              } @else {
              <img [src]="item.profile!.data!.picture" alt="Profile" class="avatar-image" />
              }
              } @else {
              <mat-icon>account_circle</mat-icon>
              }
            </div>
            <span class="sidenav-account-name">
              {{ item.profile?.data?.display_name || item.profile?.data?.name || item.account.name ||
              (item.account.pubkey | npub) }}
            </span>
          </button>
          }
          <button class="sidenav-account-item sidenav-add-account" (click)="addAccount(); closeSidenavOnMobile()">
            <mat-icon>person_add</mat-icon>
            <span i18n="@@app.profile.add-account">Add account</span>
          </button>
        </div>
        }

        <!-- Quick Actions Row -->
        <div class="sidenav-profile-actions">
          @if (app.authenticated()) {
          <button mat-icon-button [routerLink]="accountState.profilePath()" (click)="closeSidenavOnMobile()"
            matTooltip="My Profile" i18n-matTooltip="@@app.profile.my-profile">
            <mat-icon>person</mat-icon>
          </button>
          <button mat-icon-button routerLink="/wallet" (click)="closeSidenavOnMobile()" matTooltip="Wallet"
            i18n-matTooltip="@@app.profile.wallet">
            <mat-icon>wallet</mat-icon>
          </button>
          <button mat-icon-button routerLink="/accounts" (click)="closeSidenavOnMobile()" matTooltip="Manage Account"
            i18n-matTooltip="@@app.profile.manage-accounts">
            <mat-icon>manage_accounts</mat-icon>
          </button>
          } @else {
          <button mat-icon-button (click)="addAccount(); closeSidenavOnMobile()" matTooltip="Login"
            i18n-matTooltip="@@app.profile.login">
            <mat-icon>login</mat-icon>
          </button>
          <button mat-icon-button (click)="addAccount(); closeSidenavOnMobile()" matTooltip="Create account"
            i18n-matTooltip="@@app.profile.create-account">
            <mat-icon>person_add</mat-icon>
          </button>
          }
          <button mat-icon-button routerLink="/settings" (click)="closeSidenavOnMobile()" matTooltip="Settings"
            i18n-matTooltip="@@app.profile.settings">
            <mat-icon>settings</mat-icon>
          </button>
          <button mat-icon-button (click)="themeService.toggleDarkMode()"
            [matTooltip]="themeService.darkMode() ? 'Light mode' : 'Dark mode'">
            @if (themeService.darkMode()) {
            <mat-icon>light_mode</mat-icon>
            } @else {
            <mat-icon>dark_mode</mat-icon>
            }
          </button>
        </div>
      </div>
      <mat-divider></mat-divider>
      }

      <mat-nav-list>
        <!-- Profile avatar when sidenav is minimized - toggles sidenav -->
        @if (!displayLabels()) {
        <button mat-list-item (click)="toggleSidenav()"
          class="nav-item profile-nav-item sidenav-minimized-avatar-button" matTooltipPosition="right">
          @if (accountState.profile()?.data?.picture) {
          @if (settings.settings().imageCacheEnabled) {
          <img [src]="getOptimizedImageUrl(accountState.profile()?.data?.picture)" class="sidenav-minimized-avatar"
            alt="Profile" />
          } @else {
          <img [src]="accountState.profile()?.data?.picture" class="sidenav-minimized-avatar" alt="Profile" />
          }
          } @else {
          <mat-icon class="sidenav-minimized-icon">{{ app.authenticated() ? 'account_circle' : 'account_circle_off'
            }}</mat-icon>
          }
        </button>
        <!-- Settings gear icon - opens profile actions menu -->
        <button mat-list-item [matMenuTriggerFor]="minimizedProfileActionsMenu"
          class="nav-item sidenav-minimized-settings-button" matTooltip="Profile & Settings" matTooltipPosition="right">
          <mat-icon matListItemIcon>settings</mat-icon>
        </button>
        }

        @for (item of navigationItems(); track $index) {
        <!-- Main navigation item -->
        <a mat-list-item [routerLink]="item.action ? undefined : [item.path]" [queryParams]="item.queryParams"
          routerLinkActive="active-link" [routerLinkActiveOptions]="{ exact: item.path === 'people' ? false : true }"
          (click)="onNavItemClick($event, item)" class="nav-item" [class.expandable-nav-item]="item.expandable">
          <mat-icon matListItemIcon [matBadge]="item.badge ? item.badge() : null" matBadgeSize="small"
            aria-hidden="false">{{ item.icon
            }}</mat-icon>
          @if (displayLabels()) {
          <span class="nav-label">{{ item.label }}</span>
          @if (item.expandable) {
          <button mat-icon-button class="expand-button"
            (click)="$event.stopPropagation(); $event.preventDefault(); toggleMenuExpansion(item.path)"
            [attr.aria-label]="item.expanded ? 'Collapse' : 'Expand'" tabindex="0">
            <mat-icon class="expand-icon">
              {{ item.expanded ? 'keyboard_arrow_down' : 'keyboard_arrow_right' }}
            </mat-icon>
          </button>
          }
          }
        </a>

        <!-- Child items for expandable menus -->
        @if (item.expandable && item.expanded && item.children && displayLabels()) {
        @for (child of item.children; track child.path) {
        <div class="child-nav-item-container">
          <button mat-list-item class="child-nav-item" (click)="navigateToChildItem(child)"
            (keyup.enter)="navigateToChildItem(child)">
            <mat-icon matListItemIcon>{{ child.icon }}</mat-icon>
            <span class="nav-label child-label">{{ child.label }}</span>
          </button>
          @if (child.feedId) {
          <button mat-icon-button class="feed-edit-button"
            (click)="$event.stopPropagation(); openFeedEditDialog(child.feedId)" i18n-matTooltip="@@app.feed.edit"
            matTooltip="Edit feed" tabindex="0">
            <mat-icon>settings</mat-icon>
          </button>
          }
          @if (child.followSetId && item.path === 'people') {
          <button mat-icon-button class="feed-edit-button"
            (click)="$event.stopPropagation(); openFollowSetEditDialog(child.followSetId)"
            i18n-matTooltip="@@app.followset.edit" matTooltip="Edit people" tabindex="0">
            <mat-icon>settings</mat-icon>
          </button>
          }
          @if (child.mediaSettings) {
          <button mat-icon-button class="feed-edit-button" (click)="$event.stopPropagation(); openMediaSettings()"
            i18n-matTooltip="@@app.media.settings" matTooltip="Media servers" tabindex="0">
            <mat-icon>settings</mat-icon>
          </button>
          }
        </div>
        }
        }
        }

        <a mat-list-item (click)="toggleMenuSize()">
          @if (displayLabels()) {
          <mat-icon matListItemIcon>chevron_left</mat-icon>
          } @else {
          <mat-icon matListItemIcon>chevron_right</mat-icon>
          }
        </a>
      </mat-nav-list>
    </mat-sidenav>

    <mat-sidenav-content [class.following-sidebar-docked]="favoritesOverlay?.isDocked() ?? false"
      [class.media-player-shown]="layout.showMediaPlayer()" [class.clips-mobile-mode]="isClipsMode()">

      <!-- Top toolbar - beside sidenav -->
      <mat-toolbar class="app-toolbar no-print no-select" [class.hidden-for-clips]="isClipsMode()">



        <!-- Left section: hamburger menu/avatar and app icon -->
        <div class="toolbar-section toolbar-left" [class.toolbar-left-hidden]="opened() && !layout.isHandset()"
          [class.mobile-search-focused]="searchFocused() && layout.isHandset()">
          <button mat-icon-button (click)="toggleSidenav()" aria-label="Toggle menu" class="menu-profile-button"
            [class.profile-button-picture]="accountState.profile()?.data?.picture">
            <div class="menu-button-content">
              @if (accountState.profile()?.data?.picture) {
              @if (settings.settings().imageCacheEnabled) {
              <img [src]="getOptimizedImageUrl(accountState.profile()?.data?.picture)" class="menu-profile-avatar"
                alt="Menu" />
              } @else {
              <img [src]="accountState.profile()?.data?.picture" class="menu-profile-avatar" alt="Menu" />
              }
              } @else {
              @if (app.authenticated()) {
              <mat-icon class="profile-icon">account_circle</mat-icon>
              } @else {
              <mat-icon class="profile-icon">menu</mat-icon>
              }
              }
            </div>
          </button>
          <app-navigation></app-navigation>
        </div>

        <!-- Center section: Always-visible search -->
        <div class="toolbar-center" [class.mobile-search-expanded]="searchFocused() && layout.isHandset()">
          <div class="search-container toolbar-section" [class.search-active]="layout.search()"
            [class.has-results]="search.hasVisibleResults()" (focusout)="onSearchBlur($event)">
            <mat-icon class="search-icon">search</mat-icon>
            <input type="search" class="search-input" #searchInputElement [(ngModel)]="layout.searchInput"
              (input)="layout.onSearchInput($event)" (keydown)="onSearchInputKeyDown($event)"
              (paste)="onSearchInputPaste($event)" (focus)="onSearchFocus()" i18n-placeholder="@@app.search.placeholder"
              placeholder="Search..." autocomplete="off" name="nostria-global-search" />
            @if (layout.searchInput && layout.searchInput.length > 0) {
            <button mat-icon-button class="search-action-button clear-search-button" (click)="clearSearchInput()"
              matTooltip="Clear search">
              <mat-icon>close</mat-icon>
            </button>
            }
            @if (layout.search() && (!layout.searchInput || layout.searchInput.length === 0)) {
            <button mat-icon-button class="search-action-button voice-search-button" (click)="startSearchVoiceInput()"
              [disabled]="isSearchListening() || isSearchTranscribing()" matTooltip="Voice search">
              @if (isSearchListening()) {
              <mat-icon class="pulse-icon">mic</mat-icon>
              } @else if (isSearchTranscribing()) {
              <mat-icon class="spinning-icon">sync</mat-icon>
              } @else {
              <mat-icon>mic</mat-icon>
              }
            </button>
            <button mat-icon-button class="search-action-button qr-button" (click)="qrScan()">
              <mat-icon>qr_code_scanner</mat-icon>
            </button>
            }
            <button mat-icon-button class="search-action-button command-palette-button" (click)="openCommandPalette()"
              i18n-matTooltip="@@app.search.command-palette" matTooltip="Command palette (Ctrl+K)">
              <mat-icon>terminal</mat-icon>
            </button>
            @if (searchResultsMounted()) {
            <app-search-results></app-search-results>
            }
          </div>
        </div>

        <!-- Right section: action buttons and notifications (only when authenticated) -->
        @if (app.authenticated()) {
        <div class="toolbar-section toolbar-right"
          [class.mobile-search-focused]="searchFocused() && layout.isHandset()">
          <!-- Right panel actions (when right panel has content) -->
          @if (hasRightContent()) {
          @for (action of panelActions.rightPanelActions(); track action.id) {
          @if (action.menu) {
          <button mat-icon-button [matMenuTriggerFor]="rightPanelActionsMenu"
            [matTooltip]="action.tooltip || action.label" [disabled]="action.disabled" class="action-button">
            <mat-icon>{{ action.icon }}</mat-icon>
          </button>
          } @else {
          <button mat-icon-button (click)="action.action()" [matTooltip]="action.tooltip || action.label"
            [disabled]="action.disabled" class="action-button">
            <mat-icon>{{ action.icon }}</mat-icon>
          </button>
          }
          }
          }

          @if (pwaUpdateService.updateAvailable()) {
          <button mat-icon-button class="update-button" (click)="pwaUpdateService.updateApplication()"
            i18n-matTooltip="@@app.update.ready" matTooltip="Update ready!" i18n-aria-label="@@app.update.aria"
            aria-label="Update application">
            <mat-icon class="update-icon">system_update</mat-icon>
          </button>
          }

          @if (accountState.profileProcessingState().isProcessing) {
          <button mat-icon-button class="profile-cache-button" [matTooltip]="cachingTooltip()"
            i18n-aria-label="@@app.tooltip.caching-aria" aria-label="Profile caching progress">
            <mat-icon class="spinning-icon">cached</mat-icon>
            <span class="progress-badge">{{ accountState.processingProgress() }}%</span>
          </button>
          }
          <!-- Create new content button - hidden on mobile (there's one in mobile nav) -->
          <button mat-icon-button class="create-button hide-on-mobile" (click)="openCreateMenu($event)"
            i18n-matTooltip="@@app.create.tooltip" matTooltip="Create" i18n-aria-label="@@app.create.aria"
            aria-label="Create new content">
            <mat-icon>add</mat-icon>
          </button>
          @if (appState.isPublishing() || ai.processingState().isProcessing) {
          <button mat-icon-button class="profile-cache-button" (click)="navigateToNotifications()"
            [matTooltip]="ai.processingState().isProcessing ? ai.getTaskName(ai.processingState().task) : publishingEventLabel"
            i18n-aria-label="@@app.tooltip.processing-aria" aria-label="Processing in progress">
            <mat-icon class="spinning-icon">sync</mat-icon>
          </button>
          }
          @else {
          <button class="notification-toolbar" mat-icon-button (click)="navigateToNotifications()"
            i18n-matTooltip="@@app.notifications.tooltip" matTooltip="View notifications">
            <mat-icon [matBadge]="unreadNotificationsCount() > 0 ? unreadNotificationsCount() : null"
              aria-hidden="false">notifications</mat-icon>
          </button>
          }
        </div>
        }
      </mat-toolbar>

      <!-- Floating Offline Indicator -->
      @if (appState.showOfflineWarning()) {
      <div class="floating-offline-indicator">
        <div class="offline-content">
          <mat-icon class="offline-icon">wifi_off</mat-icon>
          <span i18n="@@app.offline.message">You are currently offline</span>
          <button mat-icon-button class="dismiss-button" (click)="app.reload()">
            <mat-icon>refresh</mat-icon>
          </button>
          <button mat-icon-button class="dismiss-button" (click)="appState.dismissOffline()">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>
      }

      <!-- Main content area - contains panels and right sidebar -->
      <div class="main-content-area">
        <!-- Two-Column Layout Container - Main scroll container for full-width scrollbars -->
        <div class="dual-panel-layout" [class.feeds-visible]="panelNav.showFeeds()"
          [class.wide-left]="twoColumnLayout.leftWidthMode() === 'wide'"
          [style.--left-column-width.px]="twoColumnLayout.leftColumnWidth()"
          [style.--right-column-width.px]="twoColumnLayout.rightColumnWidth()"
          [class.feeds-centered]="panelNav.feedsCentered()" [class.has-left-content]="panelNav.hasLeftContent()"
          [class.has-right-content]="hasRightContent()" [class.mobile-layout]="panelNav.isMobile()"
          [class.left-collapsed]="leftPanelCollapsed() && hasRightContent()">

          <!-- Left Panel: Feeds or list/root views - takes 50% or 100% width, scrollbar at panel edge -->
          <div class="left-panel" [class.has-content]="panelNav.hasLeftContent()"
            [class.hidden-mobile]="hasRightContent() && panelNav.isMobile()" (scroll)="onLeftPanelScroll($event)">

            <!-- Toggle to hide left panel - sticky at top-right of left panel, overlays the header area -->
            @if (hasRightContent() && !panelNav.isMobile() && !leftPanelCollapsed()) {
            <div class="left-panel-toggle-wrapper">
              <button mat-icon-button class="left-panel-toggle expanded-toggle" (click)="toggleLeftPanelCollapse()"
                matTooltip="Hide left panel">
                <mat-icon>chevron_right</mat-icon>
              </button>
            </div>
            }

            <!-- Feeds - Persistent, positioned directly in left-panel for scrollbar at panel edge -->
            <div class="feeds-container" [class.feeds-active]="panelNav.showFeeds()"
              [class.feeds-hidden]="!panelNav.showFeeds()">
              @if (feedsMounted()) {
              <app-feeds></app-feeds>
              }
            </div>

            <!-- Left panel sticky header - rendered at panel level for proper sticky behavior -->
            @if (leftPanelHeader.headerTemplate()) {
            <div class="panel-header-wrapper">
              <ng-container *ngTemplateOutlet="leftPanelHeader.headerTemplate()"></ng-container>
            </div>
            }

            <!-- Left panel inner content wrapper - constrains content to max 700px/1400px -->
            <div class="panel-content-wrapper">
              <!-- Left panel content - router outlet renders here for list routes -->
              <div class="panel-content left-panel-content">
                <router-outlet></router-outlet>
              </div>
            </div>
          </div>

          <!-- Right Panel: Detail views (routed) - takes 50% width, scrollbar at panel edge -->
          <div class="right-panel" [class.active]="hasRightContent()"
            [class.overlay-mode]="panelNav.isMobile() && hasRightContent()"
            [class.expanded]="leftPanelCollapsed() && hasRightContent()" (scroll)="onRightPanelScroll($event)">

            <!-- Right panel sticky header - rendered at panel level for proper sticky behavior -->
            @if (rightPanelHeader.headerTemplate()) {
            <div class="panel-header-wrapper">
              <ng-container *ngTemplateOutlet="rightPanelHeader.headerTemplate()"></ng-container>
            </div>
            }

            <!-- Right panel inner content wrapper - constrains content to max 700px -->
            <div class="panel-content-wrapper">
              <div class="panel-content right-panel-content">
                <!-- Router-based right panel content -->
                <router-outlet name="right"></router-outlet>
                <!-- Dynamic component-based right panel content (e.g., from RightPanelService) -->
                <app-right-panel-container></app-right-panel-container>
              </div>
            </div>
          </div>

          <!-- Floating toggle to show left panel when collapsed - positioned at top-left -->
          @if (hasRightContent() && !panelNav.isMobile() && leftPanelCollapsed()) {
          <button mat-icon-button class="left-panel-toggle collapsed-toggle" (click)="toggleLeftPanelCollapse()"
            matTooltip="Show left panel">
            <mat-icon>chevron_left</mat-icon>
          </button>
          }
        </div>

        <!-- Right sidebar - mini apps panel (shoutout, favorites, future mini apps) -->
        @if (app.authenticated() && !layout.isHandset()) {
        <div class="right-sidebar">
          <!-- <app-shoutout-overlay></app-shoutout-overlay> -->
          @for (widget of runesSettings.visibleSidebarWidgets(); track widget) {
          @if (widget === 'favorites') {
          <app-favorites-overlay></app-favorites-overlay>
          }
          @if (widget === 'runes') {
          <app-runes-sidebar></app-runes-sidebar>
          }
          }
        </div>
        }
      </div>
    </mat-sidenav-content>
  </mat-sidenav-container>

  <!-- Media player - positioned in footer or fullscreen based on state -->
  @if (layout.showMediaPlayer()) {
  <app-media-player></app-media-player>
  }

  <!-- Mobile navigation footer - now outside of sidenav container -->
  @if (layout.isHandset() && !layout.showMediaPlayer() && app.authenticated() && !layout.hideMobileNav() &&
  !isClipsMode()) {
  <div class="mobile-nav no-print" [class.scroll-hidden]="layout.mobileNavScrollHidden()"
    [class.sidenav-open]="opened()">
    <a mat-button class="mobile-nav-button" [routerLink]="['/']"
      (click)="$event.preventDefault(); onMobileNavClick('/')" routerLinkActive="active-link"
      [routerLinkActiveOptions]="{ exact: true }">
      <mat-icon>home</mat-icon>
      <div class="mobile-nav-label" i18n="@@app.mobile.home">Home</div>
    </a>

    <a mat-button class="mobile-nav-button" [routerLink]="['/f']"
      (click)="$event.preventDefault(); onMobileNavClick('/f')" routerLinkActive="active-link"
      [routerLinkActiveOptions]="{ exact: true }">
      <mat-icon>stacks</mat-icon>
      <div class="mobile-nav-label" i18n="@@app.mobile.feeds">Feeds</div>
    </a>

    <!-- FAB button in the middle with circular cut-out -->
    <div class="fab-container">
      <button mat-mini-fab color="primary" class="create-fab" i18n-aria-label="@@app.create.aria"
        aria-label="Create new content" (click)="openCreateOptions()">
        <mat-icon>add</mat-icon>
      </button>
    </div>

    <a mat-button class="mobile-nav-button" [routerLink]="['/messages']"
      (click)="$event.preventDefault(); onMobileNavClick('/messages')" routerLinkActive="active-link"
      [routerLinkActiveOptions]="{ exact: true }">
      <mat-icon>mail</mat-icon>
      <div class="mobile-nav-label" i18n="@@app.mobile.messages">Messages</div>
    </a>

    <a mat-button class="mobile-nav-button" [routerLink]="['/people']"
      (click)="$event.preventDefault(); onMobileNavClick('/people')" routerLinkActive="active-link"
      [routerLinkActiveOptions]="{ exact: false }">
      <mat-icon>group</mat-icon>
      <div class="mobile-nav-label" i18n="@@app.mobile.people">People</div>
    </a>
  </div>
  }
  }
</div>

<app-navigation-context-menu></app-navigation-context-menu>

<!-- Global fullscreen video container -->
<div id="global-fullscreen-container" class="global-fullscreen-video" style="display: none">
  <button class="fullscreen-minimize-button" (click)="exitFullscreen()" i18n-aria-label="@@app.fullscreen.exit"
    aria-label="Exit fullscreen">
    <mat-icon>close</mat-icon>
  </button>
</div>

<!-- Standalone login dialog -->
@if (layout.showStandaloneLogin()) {
<app-standalone-login-dialog (closed)="layout.handleLoginDialogClose()" />
}
<!-- Terms of Use Dialog -->
@if (layout.showTermsDialog()) {
<app-standalone-terms-dialog (closed)="layout.handleTermsDialogClose()" />
}
<!-- Feed Edit Dialog -->
@if (showFeedEditDialog()) {
<app-new-feed-dialog [icons]="feedIconOptions" [feed]="editingFeed()" (closed)="onFeedEditDialogClosed($event)" />
}

<!-- Global menu definitions - must be outside all conditional blocks for template scope -->
<mat-menu #globalLeftPanelActionsMenu="matMenu">
  @if (panelActions.leftPanelMenuTemplate()) {
  <ng-container *ngTemplateOutlet="panelActions.leftPanelMenuTemplate()!"></ng-container>
  }
</mat-menu>

<!-- Collapsed left panel actions menu for small screens -->
<mat-menu #leftPanelActionsCollapsedMenu="matMenu">
  @for (action of panelActions.leftPanelActions(); track action.id) {
  @if (action.menu) {
  <button mat-menu-item [matMenuTriggerFor]="globalLeftPanelActionsMenu" [disabled]="action.disabled">
    <mat-icon>{{ action.icon }}</mat-icon>
    <span>{{ action.label }}</span>
  </button>
  } @else {
  <button mat-menu-item (click)="action.action()" [disabled]="action.disabled">
    <mat-icon>{{ action.icon }}</mat-icon>
    <span>{{ action.label }}</span>
  </button>
  }
  }
</mat-menu>

<mat-menu #rightPanelActionsMenu="matMenu">
  @if (panelActions.rightPanelMenuTemplate()) {
  <ng-container *ngTemplateOutlet="panelActions.rightPanelMenuTemplate()!"></ng-container>
  }
</mat-menu>

<!-- Profile actions menu for minimized sidenav -->
<mat-menu #minimizedProfileActionsMenu="matMenu" xPosition="after">
  <!-- Account switching submenu -->
  @if (accountState.hasAccounts()) {
  <button mat-menu-item [matMenuTriggerFor]="accountSwitchSubMenu">
    <mat-icon>switch_account</mat-icon>
    <span i18n="@@app.profile.switch-account">Switch account</span>
  </button>
  }
  @if (app.authenticated()) {
  <button mat-menu-item [routerLink]="accountState.profilePath()" (click)="closeSidenavOnMobile()">
    <mat-icon>person</mat-icon>
    <span i18n="@@app.profile.my-profile">My Profile</span>
  </button>
  <button mat-menu-item routerLink="/wallet" (click)="closeSidenavOnMobile()">
    <mat-icon>wallet</mat-icon>
    <span i18n="@@app.profile.wallet">Wallet</span>
  </button>
  <button mat-menu-item routerLink="/accounts" (click)="closeSidenavOnMobile()">
    <mat-icon>manage_accounts</mat-icon>
    <span i18n="@@app.profile.manage-accounts">Manage Account</span>
  </button>
  } @else {
  <button mat-menu-item (click)="addAccount(); closeSidenavOnMobile()">
    <mat-icon>login</mat-icon>
    <span i18n="@@app.profile.login">Login</span>
  </button>
  <button mat-menu-item (click)="addAccount(); closeSidenavOnMobile()">
    <mat-icon>person_add</mat-icon>
    <span i18n="@@app.profile.create-account">Create account</span>
  </button>
  }
  <button mat-menu-item routerLink="/settings" (click)="closeSidenavOnMobile()">
    <mat-icon>settings</mat-icon>
    <span i18n="@@app.profile.settings">Settings</span>
  </button>
  <mat-divider></mat-divider>
  <button mat-menu-item (click)="themeService.toggleDarkMode()">
    @if (themeService.darkMode()) {
    <mat-icon>light_mode</mat-icon>
    <span i18n="@@app.theme.light-mode">Light mode</span>
    } @else {
    <mat-icon>dark_mode</mat-icon>
    <span i18n="@@app.theme.dark-mode">Dark mode</span>
    }
  </button>
</mat-menu>

<!-- Account switch submenu -->
<mat-menu #accountSwitchSubMenu="matMenu">
  @for (item of accountsWithProfiles(); track item.account.pubkey) {
  <button mat-menu-item (click)="switchAccount(item.account.pubkey)" class="account-switch-item">
    <div class="menu-account-avatar">
      @if (item.profile?.data?.picture) {
      @if (settings.settings().imageCacheEnabled) {
      <img [src]="getOptimizedImageUrl(item.profile!.data!.picture)" alt="Profile" class="avatar-image" />
      } @else {
      <img [src]="item.profile!.data!.picture" alt="Profile" class="avatar-image" />
      }
      } @else {
      <mat-icon>account_circle</mat-icon>
      }
    </div>
    <span>{{ item.profile?.data?.display_name || item.profile?.data?.name || item.account.name ||
      (item.account.pubkey | npub) }}</span>
  </button>
  }
  <mat-divider></mat-divider>
  <button mat-menu-item (click)="addAccount()">
    <mat-icon>person_add</mat-icon>
    <span i18n="@@app.profile.add-account">Add account</span>
  </button>
</mat-menu>