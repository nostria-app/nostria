<div class="app-container" [class.dark-theme]="themeService.darkMode()" [class.has-right-content]="hasRightContent()"
  [attr.data-fullscreen]="layout.fullscreenMediaPlayer()"
  [style.background-color]="themeService.darkMode() ? '#18111b' : '#FEF7FA'">
  <!-- Success overlay with checkmark -->
  @if (appState.showSuccess()) {
  <div class="success-overlay">
    <div class="success-checkmark">
      <span class="success-icon">âœ“</span>
    </div>
  </div>
  }

  <!-- Sleep mode overlay -->
  <app-sleep-mode-overlay></app-sleep-mode-overlay>

  @if (layout.showWelcomeScreen()) {
  <app-welcome></app-welcome>
  }
  @if (!app.initialized()) {
  <!-- Loading state while services initialize - inline styles ensure visibility before CSS loads -->
  <div class="app-initializing" [style.background-color]="themeService.darkMode() ? '#18111b' : '#FEF7FA'">
    <div class="initializing-content">
      <div class="initializing-spinner"
        [style.border-color]="themeService.darkMode() ? 'rgba(197, 192, 255, 0.2)' : 'rgba(89, 83, 169, 0.2)'"
        [style.border-top-color]="themeService.darkMode() ? '#c5c0ff' : '#5953a9'"></div>
      <div class="initializing-text" [style.color]="themeService.darkMode() ? '#ecdeed' : '#201923'"
        i18n="@@app.loading">Loading Nostria...</div>
    </div>
  </div>
  }
  @if (app.initialized()) {
  <!-- Top toolbar - now outside and above the sidenav container -->
  <mat-toolbar class="app-toolbar no-print no-select">
    <!-- Left section: hamburger menu, navigation, and title (only shows "Nostria" when no page title) -->
    @if (!layout.search()) {
    <div class="toolbar-section toolbar-left">
      <button mat-icon-button (click)="toggleSidenav()" aria-label="Toggle sidenav">
        <mat-icon>menu</mat-icon>
      </button>
      <app-navigation></app-navigation>
      <!-- Page title or app title -->
      @if (panelActions.pageTitle()) {
      <span class="page-title title-font">
        {{ panelActions.pageTitle() }}
      </span>
      } @else {
      <span class="app-title title-font hide-small">
        <button type="button" class="title-button" (click)="navigateToHome()">{{ title }}</button>
      </span>
      }
    </div>
    }

    <span class="toolbar-spacer">
      <!-- Search container is always rendered but hidden via CSS for iOS Safari focus compatibility -->
      <div class="search-container toolbar-section" [class.search-hidden]="!layout.search()">
        <input type="search" class="search-input" #searchInputElement [(ngModel)]="layout.searchInput"
          (input)="layout.onSearchInput($event)" (keydown)="onSearchInputKeyDown($event)"
          (paste)="onSearchInputPaste($event)" i18n-placeholder="@@app.search.placeholder"
          placeholder="Search for profiles or paste identifiers..." [attr.tabindex]="layout.search() ? 0 : -1" />
        <button mat-icon-button class="search-action-button voice-search-button" (click)="startSearchVoiceInput()"
          [disabled]="isSearchListening() || isSearchTranscribing()" matTooltip="Voice search"
          [attr.tabindex]="layout.search() ? 0 : -1">
          @if (isSearchListening()) {
          <mat-icon class="pulse-icon">mic</mat-icon>
          } @else if (isSearchTranscribing()) {
          <mat-icon class="spinning-icon">sync</mat-icon>
          } @else {
          <mat-icon>mic</mat-icon>
          }
        </button>
        <button mat-icon-button class="search-action-button qr-button" (click)="qrScan()"
          [attr.tabindex]="layout.search() ? 0 : -1">
          <mat-icon>qr_code_scanner</mat-icon>
        </button>
        <button mat-icon-button class="search-action-button close-button" (click)="layout.toggleSearch()"
          [attr.tabindex]="layout.search() ? 0 : -1">
          <mat-icon>close</mat-icon>
        </button>
        <app-search-results></app-search-results>
      </div>
    </span>

    <!-- Right section: action buttons and profile -->
    @if (!layout.search()) {
    <div class="toolbar-section toolbar-right">
      @if (pwaUpdateService.updateAvailable()) {
      <button mat-icon-button class="update-button" (click)="pwaUpdateService.updateApplication()"
        i18n-matTooltip="@@app.update.ready" matTooltip="Update ready!" i18n-aria-label="@@app.update.aria"
        aria-label="Update application">
        <mat-icon class="update-icon">system_update</mat-icon>
      </button>
      } @else {
      <button mat-icon-button (click)="openSearch()" class="hide-small">
        <mat-icon>search</mat-icon>
      </button>
      }

      @if (app.authenticated() && accountState.profileProcessingState().isProcessing) {
      <button mat-icon-button class="profile-cache-button" [matTooltip]="cachingTooltip()"
        i18n-aria-label="@@app.tooltip.caching-aria" aria-label="Profile caching progress">
        <mat-icon class="spinning-icon">cached</mat-icon>
        <span class="progress-badge">{{ accountState.processingProgress() }}%</span>
      </button>
      }
      @if (app.authenticated()) {
      @if (appState.isPublishing() || ai.processingState().isProcessing) {
      <button mat-icon-button class="profile-cache-button" routerLink="/notifications"
        [matTooltip]="ai.processingState().isProcessing ? ai.getTaskName(ai.processingState().task) : publishingEventLabel"
        i18n-aria-label="@@app.tooltip.processing-aria" aria-label="Processing in progress">
        <mat-icon class="spinning-icon">sync</mat-icon>
      </button>
      }
      @else {
      <button class="notification-toolbar hide-small" mat-icon-button routerLink="/notifications"
        i18n-matTooltip="@@app.notifications.tooltip" matTooltip="View notifications">
        <mat-icon
          [matBadge]="unreadNotificationsCount() > 0 ? unreadNotificationsCount() : null">notifications</mat-icon>
      </button>
      }
      }

      <button mat-icon-button [class.profile-button-picture]="accountState.profile()?.data?.picture"
        (click)="toggleProfileSidenav()" aria-label="Toggle profile" class="profile-button">
        @if (accountState.profile()?.data?.picture) {
        @if (settings.settings().imageCacheEnabled) {
        <img [src]="getOptimizedImageUrl(accountState.profile()?.data?.picture)" class="profile-button-avatar"
          alt="Profile picture" />
        } @else {
        <img [src]="accountState.profile()?.data?.picture" class="profile-button-avatar" alt="Profile picture" />
        }
        } @else {
        @if (app.authenticated()) {
        <mat-icon>account_circle</mat-icon>
        } @else {
        <mat-icon>account_circle_off</mat-icon>
        }
        }
      </button>
    </div>
    }
  </mat-toolbar>
  }

  <!-- Floating Offline Indicator -->
  @if (appState.showOfflineWarning()) {
  <div class="floating-offline-indicator">
    <div class="offline-content">
      <mat-icon class="offline-icon">wifi_off</mat-icon>
      <span i18n="@@app.offline.message">You are currently offline</span>
      <button mat-icon-button class="dismiss-button" (click)="app.reload()">
        <mat-icon>refresh</mat-icon>
      </button>
      <button mat-icon-button class="dismiss-button" (click)="appState.dismissOffline()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>
  }
  @if (app.initialized()) {
  <!-- Sidenav container now below the toolbar -->
  <mat-sidenav-container class="sidenav-container" [autosize]="true">
    <!-- Side navigation -->
    <mat-sidenav #sidenav class="sidenav no-print"
      [ngClass]="{ 'sidenav-labels': displayLabels(), 'sidenav-small': !displayLabels() }" [opened]="opened()"
      [mode]="layout.isHandset() ? 'over' : 'side'" [fixedInViewport]="false" (closed)="onSidenavClosed()"
      (opened)="onSidenavOpened()">
      <mat-nav-list>
        @for (item of navigationItems(); track $index) {
        <!-- Main navigation item -->
        <a mat-list-item [routerLink]="item.action ? undefined : [item.path]" routerLinkActive="active-link"
          [routerLinkActiveOptions]="{ exact: item.path === 'people' ? false : true }"
          (click)="onNavItemClick($event, item)" class="nav-item" [class.expandable-nav-item]="item.expandable">
          <mat-icon matListItemIcon [matBadge]="item.badge ? item.badge() : null" matBadgeSize="small">{{ item.icon
            }}</mat-icon>
          @if (displayLabels()) {
          <span class="nav-label">{{ item.label }}</span>
          @if (item.expandable) {
          <button mat-icon-button class="expand-button"
            (click)="$event.stopPropagation(); $event.preventDefault(); toggleMenuExpansion(item.label.toLowerCase())"
            [attr.aria-label]="item.expanded ? 'Collapse' : 'Expand'" tabindex="0">
            <mat-icon class="expand-icon">
              {{ item.expanded ? 'keyboard_arrow_down' : 'keyboard_arrow_right' }}
            </mat-icon>
          </button>
          }
          }
        </a>

        <!-- Child items for expandable menus -->
        @if (item.expandable && item.expanded && item.children && displayLabels()) {
        @for (child of item.children; track child.path) {
        <div class="child-nav-item-container">
          <button mat-list-item class="child-nav-item" (click)="navigateToChildItem(child)"
            (keyup.enter)="navigateToChildItem(child)">
            <mat-icon matListItemIcon>{{ child.icon }}</mat-icon>
            <span class="nav-label child-label">{{ child.label }}</span>
          </button>
          @if (child.feedId) {
          <button mat-icon-button class="feed-edit-button"
            (click)="$event.stopPropagation(); openFeedEditDialog(child.feedId)" i18n-matTooltip="@@app.feed.edit"
            matTooltip="Edit feed" tabindex="0">
            <mat-icon>settings</mat-icon>
          </button>
          }
          @if (child.followSetId && item.label === 'People') {
          <button mat-icon-button class="feed-edit-button"
            (click)="$event.stopPropagation(); openFollowSetEditDialog(child.followSetId)"
            i18n-matTooltip="@@app.followset.edit" matTooltip="Edit people" tabindex="0">
            <mat-icon>settings</mat-icon>
          </button>
          }
          @if (child.mediaSettings) {
          <button mat-icon-button class="feed-edit-button" (click)="$event.stopPropagation(); openMediaSettings()"
            i18n-matTooltip="@@app.media.settings" matTooltip="Media servers" tabindex="0">
            <mat-icon>settings</mat-icon>
          </button>
          }
        </div>
        }
        }
        }

        <!-- Create FAB at bottom of sidenav -->
        @if (app.authenticated()) {
        <div class="sidenav-fab-container-bottom">
          <button mat-mini-fab color="primary" class="sidenav-create-fab" (click)="openCreateMenu($event)"
            i18n-aria-label="@@app.create.aria" aria-label="Create new content"
            [matTooltip]="displayLabels() ? '' : createLabel">
            <mat-icon>add</mat-icon>
          </button>
        </div>
        }

        <a mat-list-item (click)="toggleMenuSize()">
          @if (displayLabels()) {
          <mat-icon matListItemIcon>chevron_left</mat-icon>
          } @else {
          <mat-icon matListItemIcon>chevron_right</mat-icon>
          }
        </a>
      </mat-nav-list>
    </mat-sidenav>

    <mat-sidenav #profileSidenav position="end" class="profile-sidenav" mode="over" [fixedInViewport]="true"
      [fixedTopGap]="0" [fixedBottomGap]="0" [disableClose]="false">
      <div class="profile-content">
        <button class="theme-button" mat-icon-button (click)="themeService.toggleDarkMode()">
          @if (themeService.darkMode()) {
          <mat-icon>dark_mode</mat-icon>
          } @else {
          <mat-icon>light_mode</mat-icon>
          }
        </button>
        <button class="close-button-right" mat-icon-button (click)="toggleProfileSidenav()">
          <mat-icon>close</mat-icon>
        </button>
        <div class="profile-header">
          @if (accountState.profile(); as metadata) {
          @if (metadata?.data?.picture) {
          <div class="profile-avatar">
            @if (settings.settings().imageCacheEnabled) {
            <img [src]="getOptimizedImageUrl(metadata.data.picture)" alt="Profile picture" class="avatar-image" />
            } @else {
            <img [src]="metadata.data.picture" alt="Profile picture" class="avatar-image" />
            }
          </div>
          } @else {
          <div class="profile-avatar">
            <mat-icon class="avatar-icon">account_circle</mat-icon>
          </div>
          }
          @if (metadata.data.display_name) {
          <h2>{{ metadata.data.display_name }}</h2>
          } @else if (metadata.data.name) {
          <h2>{{ metadata.data.name }}</h2>
          } @else {
          <h2>{{ metadata.event.pubkey | npub }}</h2>
          }
          } @else {
          <div class="profile-avatar">
            @if (app.authenticated()) {
            <mat-icon class="avatar-icon">account_circle</mat-icon>
            } @else {
            <mat-icon class="avatar-icon">account_circle_off</mat-icon>
            }
          </div>

          @if (app.authenticated()) {
          <h2>
            {{ accountState.account()?.name || (accountState.pubkey() | npub) }}
          </h2>
          } @else {
          <h2 i18n="@@app.profile.not-logged-in">Not logged in</h2>
          }
          }

          @if (accountState.hasActiveSubscription()) {
          <span class="premium-label" i18n="@@app.profile.premium">Premium</span>
          <div class="premium-expires">
            Expires {{ accountState.expiresWhen() | date: 'MMM d yyyy' }}
          </div>
          } @else {
          <span class="premium-label" i18n="@@app.profile.free">Free</span>
          }
        </div>

        <mat-nav-list>
          @if (app.authenticated()) {
          <div class="profile-nav-item-container">
            <a mat-list-item [routerLink]="accountState.profilePath()" (click)="toggleProfileSidenav()">
              <mat-icon matListItemIcon>person</mat-icon>
              <span i18n="@@app.profile.my-profile">My Profile</span>
            </a>
            <button mat-icon-button class="profile-edit-button"
              (click)="$event.stopPropagation(); toggleProfileSidenav()"
              [routerLink]="accountState.profilePath() + '/edit'" i18n-matTooltip="@@app.profile.edit"
              matTooltip="Edit profile" tabindex="0">
              <mat-icon>edit</mat-icon>
            </button>
          </div>
          <a mat-list-item routerLink="/credentials" (click)="navigateAndClearRightPanel('/credentials')">
            <mat-icon matListItemIcon>key</mat-icon>
            <span i18n="@@app.profile.credentials">Credentials</span>
          </a>
          }

          <a mat-list-item (click)="addAccount(); toggleProfileSidenav()">
            <mat-icon matListItemIcon>person_add</mat-icon>
            <span i18n="@@app.profile.add-account">Add account</span>
          </a>
          <a mat-list-item routerLink="/accounts" (click)="navigateAndClearRightPanel('/accounts')">
            <mat-icon matListItemIcon>manage_accounts</mat-icon>
            <span i18n="@@app.profile.manage-accounts">Manage accounts</span>
          </a>
          <a mat-list-item routerLink="/settings" (click)="navigateAndClearRightPanel('/settings')">
            <mat-icon matListItemIcon>settings</mat-icon>
            <span i18n="@@app.profile.settings">Settings</span>
          </a>
        </mat-nav-list>
        <mat-divider></mat-divider>
        <!-- Account selection menu -->
        @if (accountState.hasAccounts()) {
        <mat-nav-list class="accounts-list">
          @for (item of accountsWithProfiles(); track item.account.pubkey) {
          @if (item.profile; as metadata) {
          <a mat-list-item (click)="switchAccount(item.account.pubkey); toggleProfileSidenav()" class="account-item">
            @if (metadata.data?.picture) {
            <div class="account-avatar" matListItemIcon>
              @if (settings.settings().imageCacheEnabled) {
              <img [src]="getOptimizedImageUrl(metadata.data.picture)" alt="Profile picture" class="avatar-image" />
              } @else {
              <img [src]="metadata.data.picture" alt="Profile picture" class="avatar-image" />
              }
            </div>
            } @else {
            <div class="account-avatar" matListItemIcon>
              <mat-icon>account_circle</mat-icon>
            </div>
            }
            <span matListItemTitle>
              {{
              metadata.data?.display_name ||
              metadata.data?.name ||
              item.account.name ||
              (item.account.pubkey | npub)
              }}
            </span>
            <span matListItemLine class="account-source">
              {{ item.account.source }} - used {{ (item.account.lastUsed! / 1000) | ago }}
            </span>
          </a>
          } @else {
          <a mat-list-item (click)="switchAccount(item.account.pubkey); toggleProfileSidenav()" class="account-item">
            <div class="account-avatar" matListItemIcon>
              <mat-icon>account_circle</mat-icon>
            </div>
            <span matListItemTitle> {{ item.account.name || (item.account.pubkey | npub) }} </span>
            <span matListItemLine class="account-source">
              {{ item.account.source }} - used {{ (item.account.lastUsed! / 1000) | ago }}
            </span>
          </a>
          }
          }
        </mat-nav-list>
        }
      </div>
    </mat-sidenav>

    <mat-sidenav-content [class.following-sidebar-docked]="favoritesOverlay?.isDocked() ?? false"
      [class.media-player-shown]="layout.showMediaPlayer()">
      <!-- Two-Column Layout Container -->
      <div class="two-column-layout" [class.feeds-visible]="panelNav.showFeeds()"
        [class.wide-left]="twoColumnLayout.leftWidthMode() === 'wide'"
        [style.--left-column-width.px]="twoColumnLayout.leftColumnWidth()"
        [style.--right-column-width.px]="twoColumnLayout.rightColumnWidth()"
        [class.feeds-centered]="panelNav.feedsCentered()" [class.has-left-content]="panelNav.hasLeftContent()"
        [class.has-right-content]="hasRightContent()" [class.mobile-layout]="panelNav.isMobile()"
        [class.left-collapsed]="leftPanelCollapsed() && hasRightContent()">

        <!-- Floating panel toolbars - positioned at main toolbar level -->
        <div class="floating-toolbars-container show-on-wide">
          <!-- Left panel floating toolbar - shows when there's actions or back button (NOT for title - that's in main toolbar now) -->
          @if ((panelActions.leftPanelActions().length > 0 || panelNav.canGoBackLeft()) &&
          !panelNav.showFeeds()) {
          <div class="panel-floating-toolbar left-toolbar" [class.with-right]="hasRightContent()">
            <div class="floating-toolbar-content">
              @if (panelNav.canGoBackLeft()) {
              <button mat-icon-button (click)="goBackLeft()" class="nav-button back-button" matTooltip="Go back"
                i18n-matTooltip="@@app.nav.back">
                <mat-icon>arrow_back</mat-icon>
              </button>
              }
              @if (panelActions.leftPanelHeaderLeftContent()) {
              <ng-container *ngTemplateOutlet="panelActions.leftPanelHeaderLeftContent()!"></ng-container>
              }
              @for (action of panelActions.leftPanelActions(); track action.id) {
              @if (action.menu) {
              <button mat-icon-button [matMenuTriggerFor]="leftPanelActionsMenu"
                [matTooltip]="action.tooltip || action.label" [disabled]="action.disabled" class="action-button">
                <mat-icon>{{ action.icon }}</mat-icon>
              </button>
              } @else {
              <button mat-icon-button (click)="action.action()" [matTooltip]="action.tooltip || action.label"
                [disabled]="action.disabled" class="action-button">
                <mat-icon>{{ action.icon }}</mat-icon>
              </button>
              }
              }
            </div>
          </div>
          }

          <!-- Right panel floating toolbar -->
          @if (hasRightContent() && (canGoBackRight() || rightPanelTitle() ||
          panelActions.rightPanelHeaderLeftContent() || panelActions.rightPanelActions().length > 0)) {
          <div class="panel-floating-toolbar right-toolbar">
            <div class="floating-toolbar-content">
              @if (canGoBackRight()) {
              <button mat-icon-button (click)="goBackRight()" class="nav-button back-button" matTooltip="Go back"
                i18n-matTooltip="@@app.nav.back">
                <mat-icon>arrow_back</mat-icon>
              </button>
              }
              <span class="panel-title title-font">{{ rightPanelTitle() }}</span>
              @if (panelActions.rightPanelHeaderLeftContent()) {
              <ng-container *ngTemplateOutlet="panelActions.rightPanelHeaderLeftContent()!"></ng-container>
              }
              @for (action of panelActions.rightPanelActions(); track action.id) {
              @if (action.menu) {
              <button mat-icon-button [matMenuTriggerFor]="rightPanelActionsMenu"
                [matTooltip]="action.tooltip || action.label" [disabled]="action.disabled" class="action-button">
                <mat-icon>{{ action.icon }}</mat-icon>
              </button>
              } @else {
              <button mat-icon-button (click)="action.action()" [matTooltip]="action.tooltip || action.label"
                [disabled]="action.disabled" class="action-button">
                <mat-icon>{{ action.icon }}</mat-icon>
              </button>
              }
              }
            </div>
          </div>
          }
        </div>

        <!-- Left Panel Collapse Toggle (shown when right panel has content) -->
        @if (hasRightContent() && !panelNav.isMobile()) {
        <button mat-icon-button class="left-panel-toggle" (click)="toggleLeftPanelCollapse()"
          [matTooltip]="leftPanelCollapsed() ? 'Show left panel' : 'Hide left panel'">
          <mat-icon>{{ leftPanelCollapsed() ? 'chevron_right' : 'chevron_left' }}</mat-icon>
        </button>
        }

        <!-- Left Panel: Feeds or list/root views -->
        <div class="left-panel" [class.has-content]="panelNav.hasLeftContent()"
          [class.hidden-mobile]="hasRightContent() && panelNav.isMobile()">

          <!-- Feeds - Persistent (uses visibility for state preservation) -->
          @if (app.authenticated()) {
          <div class="feeds-container" [class.feeds-active]="panelNav.showFeeds()"
            [class.feeds-hidden]="!panelNav.showFeeds()">
            <app-feeds></app-feeds>
          </div>
          }

          <!-- Left panel content header (not shown for Feeds or Home - they have their own UI) -->
          <!-- Hidden when floating toolbar is active -->
          @if (panelNav.hasLeftContent() && !panelNav.showFeeds() && !panelNav.isHomeRoute()) {
          <div class="panel-header left-panel-header" [class.header-hidden]="leftPanelHeaderHidden()"
            [class.hide-on-wide]="panelActions.pageTitle() || panelActions.leftPanelActions().length > 0 || panelNav.canGoBackLeft()">
            <div class="header-left">
              @if (panelNav.canGoBackLeft()) {
              <button mat-icon-button (click)="goBackLeft()" class="nav-button back-button" matTooltip="Go back"
                i18n-matTooltip="@@app.nav.back">
                <mat-icon>arrow_back</mat-icon>
              </button>
              }
              @if (panelActions.leftPanelHeaderLeftContent()) {
              <ng-container *ngTemplateOutlet="panelActions.leftPanelHeaderLeftContent()!"></ng-container>
              }
            </div>
            @if (panelActions.leftPanelActions().length > 0) {
            <div class="header-right">
              @for (action of panelActions.leftPanelActions(); track action.id) {
              @if (action.menu) {
              <button mat-icon-button [matMenuTriggerFor]="leftPanelActionsMenu"
                [matTooltip]="action.tooltip || action.label" [disabled]="action.disabled" class="action-button">
                <mat-icon>{{ action.icon }}</mat-icon>
              </button>
              } @else {
              <button mat-icon-button (click)="action.action()" [matTooltip]="action.tooltip || action.label"
                [disabled]="action.disabled" class="action-button">
                <mat-icon>{{ action.icon }}</mat-icon>
              </button>
              }
              }
            </div>
            }
          </div>
          }

          <!-- Left panel actions menu (always present, template controls content) -->
          <mat-menu #leftPanelActionsMenu="matMenu">
            @if (panelActions.leftPanelMenuTemplate()) {
            <ng-container *ngTemplateOutlet="panelActions.leftPanelMenuTemplate()!"></ng-container>
            }
          </mat-menu>

          <!-- Left panel content - router outlet renders here for list routes -->
          <div class="panel-content left-panel-content" (scroll)="onLeftPanelScroll($event)">
            <router-outlet></router-outlet>
          </div>
        </div>

        <!-- Right Panel: Detail views (routed) -->
        <div class="right-panel" [class.active]="hasRightContent()"
          [class.overlay-mode]="panelNav.isMobile() && hasRightContent()"
          [class.expanded]="leftPanelCollapsed() && hasRightContent()">

          <!-- Right panel header - only show if there's a back button, title, left content, or actions -->
          <!-- Hidden when floating toolbar is active -->
          @if (hasRightContent() && (canGoBackRight() || rightPanelTitle() || panelActions.rightPanelHeaderLeftContent()
          || panelActions.rightPanelActions().length > 0)) {
          <div class="panel-header right-panel-header hide-on-wide" [class.header-hidden]="rightPanelHeaderHidden()">
            <div class="header-left">
              @if (canGoBackRight()) {
              <button mat-icon-button (click)="goBackRight()" class="nav-button back-button" matTooltip="Go back"
                i18n-matTooltip="@@app.nav.back">
                <mat-icon>arrow_back</mat-icon>
              </button>
              }
              <span class="panel-title">{{ rightPanelTitle() }}</span>
              @if (panelActions.rightPanelHeaderLeftContent()) {
              <ng-container *ngTemplateOutlet="panelActions.rightPanelHeaderLeftContent()!"></ng-container>
              }
            </div>
            @if (panelActions.rightPanelActions().length > 0) {
            <div class="header-right">
              @for (action of panelActions.rightPanelActions(); track action.id) {
              @if (action.menu) {
              <button mat-icon-button [matMenuTriggerFor]="rightPanelActionsMenu"
                [matTooltip]="action.tooltip || action.label" [disabled]="action.disabled" class="action-button">
                <mat-icon>{{ action.icon }}</mat-icon>
              </button>
              } @else {
              <button mat-icon-button (click)="action.action()" [matTooltip]="action.tooltip || action.label"
                [disabled]="action.disabled" class="action-button">
                <mat-icon>{{ action.icon }}</mat-icon>
              </button>
              }
              }
            </div>
            }
          </div>
          }

          <!-- Right panel actions menu (always present, template controls content) -->
          <mat-menu #rightPanelActionsMenu="matMenu">
            @if (panelActions.rightPanelMenuTemplate()) {
            <ng-container *ngTemplateOutlet="panelActions.rightPanelMenuTemplate()!"></ng-container>
            }
          </mat-menu>

          <!-- Right panel content - named router outlet for detail views -->
          <div class="panel-content right-panel-content" (scroll)="onRightPanelScroll($event)">
            <router-outlet name="right"></router-outlet>
          </div>
        </div>
      </div>
    </mat-sidenav-content>
  </mat-sidenav-container>

  <!-- Favorites sidebar - vertical on right side of screen -->
  @if (app.authenticated()) {
  <app-favorites-overlay class="favorites-sidebar"></app-favorites-overlay>
  }

  <!-- Media player - positioned in footer or fullscreen based on state -->
  @if (layout.showMediaPlayer()) {
  <app-media-player></app-media-player>
  }

  <!-- Mobile navigation footer - now outside of sidenav container -->
  @if (layout.isHandset() && !layout.showMediaPlayer() && app.authenticated() && !layout.hideMobileNav()) {
  <div class="mobile-nav no-print">
    <a mat-button class="mobile-nav-button" [routerLink]="['/f']"
      (click)="$event.preventDefault(); onMobileNavClick('/f')" routerLinkActive="active-link"
      [routerLinkActiveOptions]="{ exact: true }">
      <mat-icon>stacks</mat-icon>
      <div class="mobile-nav-label" i18n="@@app.mobile.feeds">Feeds</div>
    </a>

    <a mat-button class="mobile-nav-button" [routerLink]="['/messages']"
      (click)="$event.preventDefault(); onMobileNavClick('/messages')" routerLinkActive="active-link"
      [routerLinkActiveOptions]="{ exact: true }">
      <mat-icon [matBadge]="getUnreadMessagesCount()" matBadgeSize="small">mail</mat-icon>
      <div class="mobile-nav-label" i18n="@@app.mobile.messages">Messages</div>
    </a>

    <!-- FAB button in the middle with circular cut-out -->
    <div class="fab-container">
      <button mat-mini-fab color="primary" class="create-fab" i18n-aria-label="@@app.create.aria"
        aria-label="Create new content" (click)="openCreateOptions()">
        <mat-icon>add</mat-icon>
      </button>
    </div>

    <a mat-button class="mobile-nav-button" [routerLink]="['/notifications']"
      (click)="$event.preventDefault(); onMobileNavClick('/notifications')" routerLinkActive="active-link"
      [routerLinkActiveOptions]="{ exact: true }">
      <mat-icon [matBadge]="unreadNotificationsCount() > 0 ? unreadNotificationsCount() : null"
        matBadgeSize="small">notifications</mat-icon>
      <div class="mobile-nav-label" i18n="@@app.mobile.notifications">Notifications</div>
    </a>

    <button mat-button class="mobile-nav-button" (click)="openSearch()">
      <mat-icon>search</mat-icon>
      <div class="mobile-nav-label" i18n="@@app.mobile.search">Search</div>
    </button>
  </div>
  }
  }
</div>

<app-navigation-context-menu></app-navigation-context-menu>

<!-- Global fullscreen video container -->
<div id="global-fullscreen-container" class="global-fullscreen-video" style="display: none">
  <button class="fullscreen-minimize-button" (click)="exitFullscreen()" i18n-aria-label="@@app.fullscreen.exit"
    aria-label="Exit fullscreen">
    <mat-icon>close</mat-icon>
  </button>
</div>

<!-- Standalone login dialog -->
@if (layout.showStandaloneLogin()) {
<app-standalone-login-dialog (closed)="layout.handleLoginDialogClose()" />
}
<!-- Terms of Use Dialog -->
@if (layout.showTermsDialog()) {
<app-standalone-terms-dialog (closed)="layout.handleTermsDialogClose()" />
}
<!-- Feed Edit Dialog -->
@if (showFeedEditDialog()) {
<app-new-feed-dialog [icons]="feedIconOptions" [feed]="editingFeed()" (closed)="onFeedEditDialogClosed($event)" />
}