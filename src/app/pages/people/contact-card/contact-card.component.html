<div class="contact-card-container" #contactContainer>
  @if (isLoading()) {
  <div class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading contact...</p>
  </div>
  } @else {
  @if (userMetadata(); as metadata) {
  <!-- Simple Contact Header -->
  <div class="contact-header">
    <button mat-icon-button class="back-button" (click)="closeContact()">
      <mat-icon>arrow_back</mat-icon>
    </button>

    <div class="contact-header-content">
      <div class="contact-avatar-large">
        @if (metadata.data?.picture) {
        <img [src]="getOptimizedImageUrl(metadata.data.picture)" alt="Profile photo" />
        } @else {
        <mat-icon>account_circle</mat-icon>
        }
      </div>

      <div class="contact-name-section">
        <h1>{{ getFormattedName() }}</h1>
        @if (getVerifiedIdentifier()) {
        <p class="verified-badge">
          <mat-icon>verified</mat-icon>
          {{ getVerifiedIdentifier() }}
        </p>
        }
      </div>

      <div class="contact-actions-top">
        <button mat-icon-button matTooltip="Open full profile" (click)="openFullProfile()">
          <mat-icon>open_in_new</mat-icon>
        </button>
        <button mat-icon-button [matMenuTriggerFor]="moreMenu">
          <mat-icon>more_vert</mat-icon>
        </button>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="contact-quick-actions">
      <button mat-button class="action-button" (click)="openMessage()">
        <mat-icon>mail</mat-icon>
        <span>Message</span>
      </button>
    </div>
  </div>

  <mat-tab-group [(selectedIndex)]="selectedTabIndex" class="contact-tabs" [animationDuration]="'200ms'">
    <!-- Overview Tab (merged with Contact Info) -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon>person</mat-icon>
        <span>Profile</span>
      </ng-template>
      <app-contact-overview [pubkey]="pubkey()" [metadata]="metadata"></app-contact-overview>
    </mat-tab>

    <!-- Interactions Tab -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon>timeline</mat-icon>
        <span>Interactions</span>
      </ng-template>
      <app-contact-interactions [pubkey]="pubkey()"></app-contact-interactions>
    </mat-tab>

    <!-- Monetary Tab -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon>bolt</mat-icon>
        <span>Payments</span>
      </ng-template>
      <app-contact-monetary [pubkey]="pubkey()"></app-contact-monetary>
    </mat-tab>
  </mat-tab-group>
  } @else {
  <div class="error-container">
    <mat-icon>error_outline</mat-icon>
    <p>Contact not found</p>
  </div>
  }
  }
</div>

<mat-menu #moreMenu="matMenu">
  <button mat-menu-item (click)="openFullProfile()">
    <mat-icon>person</mat-icon>
    <span>View full profile</span>
  </button>
</mat-menu>