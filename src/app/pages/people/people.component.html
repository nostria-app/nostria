<!-- Panel Header -->
<div class="panel-header">
  <!-- Interactive List Selector -->
  @if (allFollowSets().length > 0) {
  <button 
    class="list-selector-button" 
    mat-button 
    [matMenuTriggerFor]="followSetsMenu"
    [class.has-selection]="selectedFollowSet()">
    <mat-icon class="selector-icon">{{ selectedFollowSet()?.isPrivate ? 'lock' : (selectedFollowSet() ? 'list' : 'people') }}</mat-icon>
    <span class="selector-label">{{ selectedFollowSet() ? selectedFollowSet()!.title : 'Following' }}</span>
    @if (selectedFollowSet()) {
    <span class="selector-count">{{ selectedFollowSet()!.pubkeys.length }}</span>
    }
    <mat-icon class="selector-arrow">expand_more</mat-icon>
  </button>

  <mat-menu #followSetsMenu="matMenu" class="list-selector-menu">
    <button mat-menu-item (click)="selectFollowSet(null)" [class.active]="!selectedFollowSet()">
      <mat-icon>people</mat-icon>
      <span>Following</span>
    </button>
    <mat-divider></mat-divider>
    @for (set of allFollowSets(); track set.id) {
    <button mat-menu-item (click)="selectFollowSet(set)" [class.active]="selectedFollowSet()?.dTag === set.dTag">
      <mat-icon>{{ set.isPrivate ? 'lock' : (set.dTag === 'nostria-favorites' ? 'star' : 'group') }}</mat-icon>
      <span>{{ set.title }}</span>
      <span class="menu-item-count">{{ set.pubkeys.length }}</span>
    </button>
    }
  </mat-menu>
  } @else {
  <h2 class="panel-title-static title-font">Following</h2>
  }

  <span class="panel-header-spacer"></span>

  <!-- Add button with dropdown menu -->
  <button mat-icon-button [matMenuTriggerFor]="addMenu" matTooltip="Add">
    <mat-icon>add</mat-icon>
  </button>

  <mat-menu #addMenu="matMenu">
    <button mat-menu-item (click)="createNewList()">
      <mat-icon>playlist_add</mat-icon>
      <span>New list</span>
    </button>
    <button mat-menu-item (click)="openAddPersonDialog()">
      <mat-icon>person_add</mat-icon>
      <span>Add person</span>
    </button>
  </mat-menu>

  <!-- Edit List button (only when a list is selected) -->
  @if (selectedFollowSet()) {
  <button mat-icon-button (click)="openEditListDialog()" matTooltip="Edit List">
    <mat-icon>edit</mat-icon>
  </button>
  }

  <!-- View toggle button - cycles through modes -->
  <button mat-icon-button (click)="cycleViewMode()" [matTooltip]="'View: ' + viewMode() + ' (click to change)'">
    <mat-icon>{{ getViewModeIcon() }}</mat-icon>
  </button>

  <!-- Filter button with overlay panel -->
  <button mat-icon-button #filterTrigger cdkOverlayOrigin #filterOrigin="cdkOverlayOrigin" (click)="toggleFilterPanel()"
    [matTooltip]="'Filter & Sort'" [class.active-filters]="hasActiveFilters()">
    <mat-icon>tune</mat-icon>
  </button>

  <!-- Filter Panel Overlay -->
  <ng-template cdkConnectedOverlay [cdkConnectedOverlayOrigin]="filterOrigin"
    [cdkConnectedOverlayOpen]="filterPanelOpen()" [cdkConnectedOverlayPositions]="filterPanelPositions"
    [cdkConnectedOverlayHasBackdrop]="true" cdkConnectedOverlayBackdropClass="filter-panel-backdrop"
    (backdropClick)="closeFilterPanel()">
    <app-people-filter-panel [filters]="filters()" [sortOption]="sortOption()"
      (filtersChanged)="onFiltersChanged($event)" (sortOptionChanged)="onSortOptionChanged($event)">
    </app-people-filter-panel>
  </ng-template>
</div>

<div class="people-page">
  <!-- People List -->
  <div class="people-sidebar">
    <!-- Search bar -->
    <div class="search-bar">
      <mat-icon>search</mat-icon>
      <input type="text" placeholder="Filter people..." [value]="searchTerm()"
        (input)="updateSearch($any($event.target).value)" />
      @if (searchTerm()) {
      <button mat-icon-button (click)="updateSearch('')">
        <mat-icon>close</mat-icon>
      </button>
      }
    </div>

    <!-- Content section -->
    <div class="people-content" #peopleContent>
      @if (isLoading()) {
      <div class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Loading...</p>
      </div>
      } @else if (error()) {
      <div class="error-container">
        <mat-icon color="warn">error</mat-icon>
        <p>{{ error() }}</p>
      </div>
      } @else if (sortedPeople().length === 0) {
      <div class="empty-container">
        @if (searchTerm()) {
        <mat-icon>search_off</mat-icon>
        <p>No results</p>
        <button mat-button (click)="updateSearch('')">Clear</button>
        } @else if (selectedFollowSet()) {
        <mat-icon>group_off</mat-icon>
        <p>It's pretty empty in here...</p>
        <p class="subtitle">Let's add some awesome people!</p>
        <button mat-flat-button (click)="openAddPersonDialog()">
          <mat-icon>person_add</mat-icon>
          Add Your First Person
        </button>
        } @else {
        <mat-icon>people_outline</mat-icon>
        <p>No people yet</p>
        <p class="subtitle">Start by adding people you want to follow</p>
        <button mat-flat-button (click)="openAddPersonDialog()">
          <mat-icon>person_add</mat-icon>
          Add Person
        </button>
        }
      </div>
      } @else {
      <!-- Apply different container classes based on viewMode() -->
      <div class="people-container" [ngClass]="{
              'comfortable-list': viewMode() === 'comfortable',
              'medium-grid': viewMode() === 'medium',
              'small-grid': viewMode() === 'small',
              'details-list': viewMode() === 'details'
            }">
        @for (pubkey of visiblePeople(); track pubkey) {
        <div class="person-item" [attr.data-pubkey]="pubkey" (click)="selectContact(pubkey)"
          (keydown.enter)="selectContact(pubkey)" (keydown.space)="selectContact(pubkey); $event.preventDefault()"
          tabindex="0" role="button"
          [attr.aria-label]="'View contact details for ' + (followingService.getProfile(pubkey)?.info?.['displayName'] || 'user')">
          <app-user-profile [info]="followingService.getProfile(pubkey)?.info ?? undefined"
            [trust]="followingService.getProfile(pubkey)?.trust ?? undefined" [pubkey]="pubkey"
            [view]="$any(viewMode())"
            [hostWidthAuto]="viewMode() === 'comfortable' || viewMode() === 'medium' || viewMode() === 'small'"
            [showRank]="filters().showRank" [disableLink]="true">
          </app-user-profile>
        </div>
        }

        <!-- Scroll sentinel for infinite loading -->
        @if (hasMorePeople()) {
        <div class="scroll-sentinel" #scrollSentinel></div>
        }
      </div>
      }
    </div>
  </div>

  <!-- Alphabet Navigation Sidebar - sticky within scroll context -->
  @if (showAlphabetNav() && sortedPeople().length > 0) {
  <div class="alphabet-nav-container">
    <div class="alphabet-nav" #alphabetNav
      (touchstart)="onAlphabetTouchStart($event)"
      (touchmove)="onAlphabetTouchMove($event)"
      (touchend)="onAlphabetTouchEnd()">
      @for (letter of availableLetters(); track letter) {
      <button class="letter-button" [class.active]="selectedLetter() === letter" (click)="scrollToLetter(letter)"
        (mouseenter)="scrollToLetter(letter)" [attr.aria-label]="'Jump to ' + letter">
        {{ letter }}
      </button>
      }
    </div>
  </div>
  }
</div>