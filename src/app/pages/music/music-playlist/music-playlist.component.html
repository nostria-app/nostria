<div class="panel-header">
  <button mat-icon-button (click)="goBack()" matTooltip="Back to Music">
    <mat-icon>arrow_back</mat-icon>
  </button>
  <h2 class="panel-title title-font">Playlist</h2>
  <span class="panel-header-spacer"></span>
  <button mat-icon-button [matMenuTriggerFor]="headerMenu" matTooltip="More options">
    <mat-icon>more_vert</mat-icon>
  </button>
  <mat-menu #headerMenu="matMenu">
    @if (isOwnPlaylist()) {
    <button mat-menu-item (click)="editPlaylist()">
      <mat-icon>edit</mat-icon>
      <span>Edit Playlist</span>
    </button>
    }
    <button mat-menu-item [matMenuTriggerFor]="copyMenu">
      <mat-icon>content_copy</mat-icon>
      <span>Copy</span>
    </button>
    <button mat-menu-item (click)="openShareDialog()">
      <mat-icon>share</mat-icon>
      <span>Share</span>
    </button>
    <button mat-menu-item (click)="downloadAsM3u8()" [disabled]="tracks().length === 0">
      <mat-icon>download</mat-icon>
      <span>Download (M3U8)</span>
    </button>
    <button mat-menu-item (click)="publishPlaylist()">
      <mat-icon>publish</mat-icon>
      <span>Publish Event</span>
    </button>
  </mat-menu>
</div>

<div class="playlist-container">
  <!-- Submenus (kept outside template for proper nesting) -->
  <mat-menu #copyMenu="matMenu">
    <button mat-menu-item (click)="copyEventLink()">
      <mat-icon>link</mat-icon>
      <span>Copy Link</span>
    </button>
    <button mat-menu-item (click)="copyEventId()">
      <mat-icon>fingerprint</mat-icon>
      <span>Copy Event ID</span>
    </button>
    <button mat-menu-item (click)="copyEventData()">
      <mat-icon>data_object</mat-icon>
      <span>Copy Data</span>
    </button>
  </mat-menu>

  @if (loading()) {
  <div class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading playlist...</p>
  </div>
  } @else if (!playlist()) {
  <div class="empty-state">
    <mat-icon>playlist_remove</mat-icon>
    <h2>Playlist not found</h2>
    <p>This playlist may have been removed or is unavailable.</p>
    <button mat-flat-button (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
      Back to Music
    </button>
  </div>
  } @else {
  <div class="playlist-content">
    <!-- Playlist Header (Spotify-style) -->
    <div class="playlist-header">
      <div class="cover-section">
        @if (coverImage()) {
        <img [src]="coverImage()" [alt]="title()" title="Playlist cover" class="cover-image" />
        } @else if (gradient()) {
        <div class="cover-gradient" [style.background]="gradient()">
          <mat-icon>queue_music</mat-icon>
        </div>
        } @else {
        <div class="cover-placeholder">
          <mat-icon>queue_music</mat-icon>
        </div>
        }
      </div>

      <div class="info-section">
        <span class="playlist-label">PLAYLIST</span>
        <h1 class="playlist-title">{{ title() }}</h1>

        @if (description()) {
        <p class="description">{{ description() }}</p>
        }

        <div class="meta-info">
          <div class="artist-row" (click)="goToArtist()" (keydown.enter)="goToArtist()" tabindex="0" role="button"
            aria-label="View artist">
            @if (artistAvatar()) {
            <img [src]="artistAvatar()" alt="" class="artist-avatar" />
            } @else {
            <mat-icon class="artist-avatar-placeholder">person</mat-icon>
            }
            <span class="artist-name">{{ artistName() }}</span>
          </div>
          <span class="separator">•</span>
          <span class="date">{{ publishedDate() }}</span>
          <span class="separator">•</span>
          <span class="track-count">{{ trackCount() }} tracks</span>
          @if (isPublic()) {
          <span class="separator">•</span>
          <mat-chip>
            <mat-icon>public</mat-icon>
            Public
          </mat-chip>
          }
        </div>
      </div>
    </div>

    <!-- Action Row -->
    <div class="action-row">
      <button mat-fab class="play-fab" (click)="playAll()" [disabled]="tracks().length === 0" aria-label="Play all">
        <mat-icon>play_arrow</mat-icon>
      </button>
      <button mat-icon-button class="like-btn" (click)="likePlaylist()" [disabled]="isLiked() || isLiking()"
        [class.liked]="isLiked()" aria-label="Like playlist">
        @if (isLiking()) {
        <mat-icon>hourglass_empty</mat-icon>
        } @else {
        <mat-icon>{{ isLiked() ? 'favorite' : 'favorite_border' }}</mat-icon>
        }
      </button>
      <button mat-icon-button (click)="zapPlaylist()" aria-label="Zap playlist">
        <mat-icon>bolt</mat-icon>
      </button>
      @if (isOwnPlaylist()) {
      <button mat-icon-button (click)="editPlaylist()" aria-label="Edit playlist">
        <mat-icon>edit</mat-icon>
      </button>
      }
    </div>

    <!-- Tracks Table -->
    <div class="tracks-section">
      @if (loadingTracks()) {
      <div class="loading-tracks">
        <mat-spinner diameter="32"></mat-spinner>
        <span>Loading tracks...</span>
      </div>
      } @else if (tracks().length === 0) {
      <div class="empty-tracks">
        <mat-icon>music_off</mat-icon>
        <p>No tracks in this playlist yet</p>
      </div>
      } @else {
      <!-- Table Header -->
      <div class="track-header">
        <span class="track-number">#</span>
        <span class="track-title-header">Title</span>
        <span class="track-date-header">Date added</span>
        <span class="track-duration-header">
          <mat-icon>schedule</mat-icon>
        </span>
      </div>

      <!-- Track List -->
      <!-- eslint-disable @angular-eslint/template/click-events-have-key-events, @angular-eslint/template/interactive-supports-focus -->
      <div class="track-list" role="list">
        @for (track of tracks(); track track.id; let i = $index) {
        <div class="track-row" role="listitem" tabindex="0" (click)="playTrack(i)" (keydown.enter)="playTrack(i)">
          <span class="track-number">
            <span class="number-text">{{ i + 1 }}</span>
            <mat-icon class="play-icon">play_arrow</mat-icon>
          </span>
          <div class="track-info">
            <div class="track-image">
              @if (getTrackImage(track); as img) {
              <img [src]="img" [alt]="getTrackTitle(track)" title="Track cover" />
              } @else if (getTrackGradient(track); as gradient) {
              <div class="track-gradient" [style.background]="gradient"></div>
              } @else {
              <div class="track-placeholder">
                <mat-icon>music_note</mat-icon>
              </div>
              }
            </div>
            <div class="track-text">
              <span class="track-title">{{ getTrackTitle(track) }}</span>
              <a class="track-artist" (click)="goToTrackArtist(track, $any($event))">{{ getTrackArtist(track) }}</a>
            </div>
          </div>
          <span class="track-date">{{ getTrackDate(track) }}</span>
          <span class="track-duration">{{ getTrackDuration(track) }}</span>
          <app-music-track-menu [track]="track" [artistName]="getTrackArtist(track)"
            [showEditOption]="isOwnTrack(track)" (editRequested)="editTrack($event)" #trackMenuRef="musicTrackMenu" />
          <button mat-icon-button class="track-menu-btn" [matMenuTriggerFor]="trackMenuRef.trackMenu" type="button"
            aria-label="Track options" (click)="$event.stopPropagation()">
            <mat-icon>more_horiz</mat-icon>
          </button>
        </div>
        }
      </div>
      }
    </div>
  </div>
  }
</div>

@if (showEditDialog() && editDialogData()) {
<app-edit-music-playlist-dialog [data]="editDialogData()!" (closed)="onEditDialogClosed($event)" />
}

@if (showTrackEditDialog() && trackEditDialogData()) {
<app-music-track-dialog [data]="trackEditDialogData()!" (closed)="onTrackEditDialogClosed($event)" />
}