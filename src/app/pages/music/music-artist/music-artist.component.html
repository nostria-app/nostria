<div class="panel-header">
  <button mat-icon-button (click)="goBack()" matTooltip="Back to Music">
    <mat-icon>arrow_back</mat-icon>
  </button>
  <h2 class="panel-title title-font">{{ panelTitle() }}</h2>
  <span class="panel-header-spacer"></span>
  <button mat-icon-button [matMenuTriggerFor]="artistMenu" aria-label="More options" matTooltip="More options">
    <mat-icon>more_vert</mat-icon>
  </button>
  <mat-menu #artistMenu="matMenu">
    <button mat-menu-item (click)="downloadTracksAsM3u8()" [disabled]="tracks().length === 0">
      <mat-icon>download</mat-icon>
      <span>Download Tracks (M3U8)</span>
    </button>
    <button mat-menu-item (click)="copyArtistLink()">
      <mat-icon>link</mat-icon>
      <span>Copy Artist Link</span>
    </button>
    <button mat-menu-item (click)="goToProfile()">
      <mat-icon>person</mat-icon>
      <span>View Profile</span>
    </button>
  </mat-menu>
</div>

<div class="artist-container">
  @if (loading()) {
  <div class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading artist...</p>
  </div>
  } @else {
  <div class="artist-content">
    <!-- Artist Header -->
    <div class="artist-header" [class.has-banner]="artistBanner()">
      @if (artistBanner()) {
      <div class="banner" [style.background-image]="'url(' + artistBanner() + ')'"></div>
      }
      <div class="artist-info">
        <div class="avatar-container">
          @if (artistAvatar()) {
          <img [src]="artistAvatar()" [alt]="artistName()" class="artist-avatar" />
          } @else {
          <div class="avatar-placeholder">
            <mat-icon>person</mat-icon>
          </div>
          }
        </div>
        <div class="name-section">
          <h1 class="artist-name">{{ panelTitle() }}</h1>
          <div class="artist-actions">
            @if (trackCount() > 0) {
            <button mat-flat-button (click)="playArtist()">
              <mat-icon>play_arrow</mat-icon>
              Play Artist
            </button>
            }
            <button mat-stroked-button (click)="zapArtist()" aria-label="Zap artist">
              <mat-icon>bolt</mat-icon>
              Zap
            </button>
            <button mat-stroked-button (click)="goToProfile()">
              <mat-icon>person</mat-icon>
              View Profile
            </button>
          </div>
        </div>
      </div>
      @if (artistBio()) {
      <p class="artist-bio">{{ artistBio() }}</p>
      }
      <div class="stats">
        <span class="stat">
          <span class="stat-value">{{ trackCount() }}</span>
          <span class="stat-label">Tracks</span>
        </span>
        <span class="stat">
          <span class="stat-value">{{ playlistCount() }}</span>
          <span class="stat-label">Playlists</span>
        </span>
      </div>
    </div>

    <!-- Content Tabs -->
    <mat-tab-group [selectedIndex]="selectedTabIndex()" (selectedIndexChange)="onTabChange($event)">
      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon class="tab-icon">music_note</mat-icon>
          Tracks
          @if (trackCount() > 0) {
          <span class="tab-count">{{ trackCount() }}</span>
          }
        </ng-template>
        <div class="tab-content">
          @if (tracks().length === 0) {
          <div class="empty-state">
            <mat-icon>music_off</mat-icon>
            <p>No tracks found from this artist</p>
          </div>
          } @else {
          <!-- Table Header -->
          <div class="track-header">
            <span class="track-number">#</span>
            <span class="track-title-header">Title</span>
            <span class="track-album-header">Album</span>
            <span class="track-date-header">Date added</span>
            <span class="track-duration-header">
              <mat-icon>schedule</mat-icon>
            </span>
            <span class="track-menu-header"></span>
          </div>

          <!-- Track List -->

          <div class="track-list" role="list">
            @for (track of tracks(); track track.id; let i = $index) {
            <div class="track-row" role="listitem" tabindex="0" (click)="playTrack(i)" (keydown.enter)="playTrack(i)">
              <span class="track-number">
                <span class="number-text">{{ i + 1 }}</span>
                <mat-icon class="play-icon">play_arrow</mat-icon>
              </span>
              <div class="track-info">
                <div class="track-image">
                  @if (getTrackImage(track); as img) {
                  <img [src]="img" [alt]="getTrackTitle(track)" title="Track cover" />
                  } @else if (getTrackGradient(track); as gradient) {
                  <div class="track-gradient" [style.background]="gradient"></div>
                  } @else {
                  <div class="track-placeholder">
                    <mat-icon>music_note</mat-icon>
                  </div>
                  }
                </div>
                <div class="track-text">
                  <span class="track-title">{{ getTrackTitle(track) }}</span>
                  <span class="track-artist">{{ getTrackArtist(track) }}</span>
                </div>
              </div>
              <span class="track-album">{{ getTrackAlbum(track) }}</span>
              <span class="track-date">{{ getTrackDate(track) }}</span>
              <span class="track-duration">{{ getTrackDuration(track) }}</span>
              <app-music-track-menu [track]="track" [artistName]="getTrackArtist(track)"
                [showEditOption]="isOwnProfile()" (editRequested)="editTrack($event)" #trackMenuRef="musicTrackMenu" />
              <button mat-icon-button class="track-menu-btn" [matMenuTriggerFor]="trackMenuRef.trackMenu" type="button"
                aria-label="Track options" (click)="$event.stopPropagation()">
                <mat-icon>more_horiz</mat-icon>
              </button>
            </div>
            }
          </div>
          }
        </div>
      </mat-tab>

      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon class="tab-icon">queue_music</mat-icon>
          Playlists
          @if (playlistCount() > 0) {
          <span class="tab-count">{{ playlistCount() }}</span>
          }
        </ng-template>
        <div class="tab-content">
          @if (playlists().length === 0) {
          <div class="empty-state">
            <mat-icon>playlist_remove</mat-icon>
            <p>No playlists found from this artist</p>
          </div>
          } @else {
          <div class="playlists-grid">
            @for (playlist of playlists(); track playlist.id) {
            <app-music-playlist-card [event]="playlist"></app-music-playlist-card>
            }
          </div>
          }
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>
  }
</div>

@if (showEditDialog() && editDialogData()) {
<app-music-track-dialog [data]="editDialogData()!" (closed)="onEditDialogClosed($event)" />
}