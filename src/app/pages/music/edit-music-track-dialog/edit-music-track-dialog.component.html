<app-custom-dialog [title]="'Edit Track'" [showCloseButton]="true" [disableClose]="isSaving()" [width]="'600px'"
  [maxWidth]="'95vw'" (closed)="onClose()">

  <div dialog-content>
    <form [formGroup]="trackForm">
      <!-- Track Title -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Track Title</mat-label>
        <input matInput formControlName="title" placeholder="Track name" required />
      </mat-form-field>

      <!-- Audio URL (read-only display) -->
      @if (audioUrl()) {
      <div class="audio-info">
        <mat-icon>audio_file</mat-icon>
        <span class="audio-url">{{ audioUrl() }}</span>
      </div>
      }

      <!-- Album Art -->
      <div class="album-art-section">
        <label class="field-label">Album Art</label>
        <div class="album-art-row">
          <div class="cover-preview"
            [style.background]="coverImage() ? 'url(' + coverImage() + ')' : 'linear-gradient(135deg, ' + currentGradient() + ')'">
            @if (!coverImage()) {
            <mat-icon>image</mat-icon>
            }
          </div>
          <div class="cover-actions">
            <button mat-stroked-button type="button" (click)="uploadImage()" [disabled]="isUploadingImage()">
              @if (isUploadingImage()) {
              <mat-spinner diameter="18"></mat-spinner>
              } @else {
              <mat-icon>photo_library</mat-icon>
              }
              Upload
            </button>
            <button mat-stroked-button type="button" (click)="randomizeGradient()">
              <mat-icon>auto_awesome</mat-icon>
              Random
            </button>
          </div>
        </div>
        <div class="image-url-row">
          <span class="or-text">OR</span>
          <mat-form-field appearance="outline" class="full-width">
            <input matInput formControlName="imageUrl" placeholder="Paste image URL" (blur)="onImageUrlChange()" />
          </mat-form-field>
        </div>
      </div>

      <!-- Genres -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Genres</mat-label>
        <mat-select formControlName="genres" multiple>
          @for (genre of availableGenres; track genre) {
          <mat-option [value]="genre">{{ genre }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <!-- Artist Account (npub) -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Artist Account (npub)</mat-label>
        <input matInput formControlName="artistNpub" placeholder="npub1... (optional)" />
      </mat-form-field>

      <!-- Artist Name -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Artist Name</mat-label>
        <input matInput formControlName="artistName" placeholder="Leave blank to use your profile name" />
      </mat-form-field>

      <!-- AI-Generated Toggle -->
      <div class="toggle-section">
        <mat-slide-toggle formControlName="aiGenerated">
          AI-Generated
        </mat-slide-toggle>
        <span class="toggle-hint">This track was assisted in part or generated in full by AI</span>
      </div>

      <!-- Zap Recipients Section -->
      <div class="zap-recipients-section">
        <div class="zap-header">
          <div class="zap-title">
            <mat-icon>bolt</mat-icon>
            <span>Zap Recipients</span>
          </div>
          <button mat-stroked-button type="button" (click)="addZapSplit()">
            <mat-icon>add</mat-icon>
            Add
          </button>
        </div>

        <div class="splits-list">
          @for (split of zapSplits(); track split.pubkey; let i = $index) {
          <div class="split-item">
            <div class="split-avatar">
              @if (split.avatar) {
              <img [src]="split.avatar" alt="" />
              } @else {
              <mat-icon>person</mat-icon>
              }
            </div>
            <div class="split-info">
              <span class="split-name">{{ split.name }}</span>
              @if (split.isUploader) {
              <span class="split-badge">Uploader</span>
              }
            </div>
            <mat-form-field appearance="outline" class="split-percentage">
              <input matInput type="number" [value]="split.percentage" min="0" max="100"
                (change)="updateSplitPercentage(i, $any($event.target).value)" />
              <span matSuffix>%</span>
            </mat-form-field>
            @if (!split.isUploader) {
            <button mat-icon-button (click)="removeSplit(i)" aria-label="Remove">
              <mat-icon>close</mat-icon>
            </button>
            }
          </div>
          }
        </div>

        @if (totalSplitPercentage() !== 100) {
        <div class="split-warning">
          <mat-icon>warning</mat-icon>
          <span>Total must equal 100% (currently {{ totalSplitPercentage() }}%)</span>
        </div>
        }
      </div>

      <!-- Advanced Settings -->
      <details class="advanced-settings">
        <summary>
          <mat-icon>tune</mat-icon>
          Advanced Settings
        </summary>
        <div class="advanced-content">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Album</mat-label>
            <input matInput formControlName="album" placeholder="Album name" />
          </mat-form-field>

          <div class="row-fields">
            <mat-form-field appearance="outline">
              <mat-label>Track Number</mat-label>
              <input matInput formControlName="trackNumber" placeholder="1" />
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Release Date</mat-label>
              <input matInput formControlName="releaseDate" type="date" />
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Language</mat-label>
            <mat-select formControlName="language">
              <mat-option value="en">English</mat-option>
              <mat-option value="es">Spanish</mat-option>
              <mat-option value="fr">French</mat-option>
              <mat-option value="de">German</mat-option>
              <mat-option value="pt">Portuguese</mat-option>
              <mat-option value="ja">Japanese</mat-option>
              <mat-option value="ko">Korean</mat-option>
              <mat-option value="zh">Chinese</mat-option>
              <mat-option value="other">Other</mat-option>
            </mat-select>
          </mat-form-field>

          <div class="toggle-section">
            <mat-slide-toggle formControlName="explicitContent">
              Explicit Content
            </mat-slide-toggle>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Lyrics</mat-label>
            <textarea matInput formControlName="lyrics" rows="4" placeholder="Enter lyrics..."></textarea>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Credits</mat-label>
            <textarea matInput formControlName="credits" rows="3"
              placeholder="Producer: ...\nMixing: ...\nMastering: ..."></textarea>
          </mat-form-field>
        </div>
      </details>
    </form>
  </div>

  <div dialog-actions>
    <button mat-button (click)="cancel()" [disabled]="isSaving()">Cancel</button>
    <button mat-flat-button (click)="saveTrack()"
      [disabled]="!trackForm.valid || isSaving() || totalSplitPercentage() !== 100">
      @if (isSaving()) {
      <mat-spinner diameter="20"></mat-spinner>
      } @else {
      Save Changes
      }
    </button>
  </div>
</app-custom-dialog>