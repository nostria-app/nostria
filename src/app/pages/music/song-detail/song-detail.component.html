<div class="panel-header">
  <button mat-icon-button (click)="goBack()" matTooltip="Back">
    <mat-icon>arrow_back</mat-icon>
  </button>
  <h2 class="panel-title title-font">Track</h2>
  <span class="panel-header-spacer"></span>
  <button mat-icon-button [matMenuTriggerFor]="headerMenu" matTooltip="More options">
    <mat-icon>more_vert</mat-icon>
  </button>
</div>

<!-- Header menu -->
<mat-menu #headerMenu="matMenu">
  @if (isOwnTrack()) {
  <button mat-menu-item (click)="editTrack()">
    <mat-icon>edit</mat-icon>
    <span>Edit Track</span>
  </button>
  }
  @if (isAuthenticated()) {
  <button mat-menu-item [matMenuTriggerFor]="playlistMenu" (click)="loadPlaylists()">
    <mat-icon>playlist_add</mat-icon>
    <span>Add to Playlist</span>
  </button>
  }
  <button mat-menu-item (click)="addToQueue()">
    <mat-icon>queue_music</mat-icon>
    <span>Add to Queue</span>
  </button>
  <button mat-menu-item (click)="shareTrack()">
    <mat-icon>share</mat-icon>
    <span>Share</span>
  </button>
  <button mat-menu-item (click)="copyEventLink()">
    <mat-icon>link</mat-icon>
    <span>Copy Link</span>
  </button>
  <button mat-menu-item (click)="copyEventData()">
    <mat-icon>data_object</mat-icon>
    <span>Copy Data</span>
  </button>
  <button mat-menu-item (click)="publishTrack()">
    <mat-icon>publish</mat-icon>
    <span>Publish Event</span>
  </button>
  @if (isOwnTrack()) {
  <button mat-menu-item (click)="deleteTrack()" [disabled]="isDeleting()">
    <mat-icon>delete</mat-icon>
    <span>Delete</span>
  </button>
  }
</mat-menu>

<!-- Playlist submenu -->
<mat-menu #playlistMenu="matMenu">
  <button mat-menu-item (click)="createNewPlaylist()">
    <mat-icon>add</mat-icon>
    <span>New Playlist</span>
  </button>
  @if (playlistsLoading()) {
  <div class="playlist-loading">
    <mat-spinner diameter="20"></mat-spinner>
    <span>Loading playlists...</span>
  </div>
  } @else {
  @for (playlist of userPlaylists(); track playlist.id) {
  <button mat-menu-item (click)="addToPlaylist(playlist.id)">
    <mat-icon>queue_music</mat-icon>
    <span>{{ playlist.title }}</span>
  </button>
  }
  @if (userPlaylists().length === 0) {
  <div class="no-playlists">
    <span>No playlists yet</span>
  </div>
  }
  }
</mat-menu>

<div class="song-detail-container">

  @if (loading()) {
  <div class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading track...</p>
  </div>
  } @else if (!song()) {
  <div class="empty-state">
    <mat-icon>music_off</mat-icon>
    <h2>Track not found</h2>
    <p>This track may have been removed or is unavailable.</p>
    <button mat-flat-button (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
      Back to Music
    </button>
  </div>
  } @else {
  <div class="song-content">
    <div class="song-header">
      <div class="cover-section">
        @if (image()) {
        <img [src]="image()" [alt]="title()" title="Track cover" class="cover-image" />
        } @else if (gradient()) {
        <div class="cover-gradient" [style.background]="gradient()">
          <mat-icon>music_note</mat-icon>
        </div>
        } @else {
        <div class="cover-placeholder">
          <mat-icon>music_note</mat-icon>
        </div>
        }
        <button mat-fab class="play-button" (click)="playTrack()" [disabled]="!audioUrl()" aria-label="Play track">
          <mat-icon>play_arrow</mat-icon>
        </button>
      </div>

      <div class="info-section">
        <h1 class="song-title">{{ title() }}</h1>

        <div class="artist-row" (click)="goToArtist()" (keydown.enter)="goToArtist()" tabindex="0" role="button"
          aria-label="View artist">
          @if (artistAvatar()) {
          <img [src]="artistAvatar()" alt="" class="artist-avatar" />
          } @else {
          <mat-icon class="artist-avatar-placeholder">person</mat-icon>
          }
          <span class="artist-name">{{ artistName() }}</span>
          <mat-icon class="navigate-icon">chevron_right</mat-icon>
        </div>

        <div class="meta-row">
          <span class="date">{{ publishedDate() }}</span>
          @if (isAiGenerated()) {
          <mat-chip class="ai-chip">
            <mat-icon>smart_toy</mat-icon>
            AI Generated
          </mat-chip>
          }
        </div>

        <!-- Engagement Metrics Row -->
        <div class="engagement-row">
          <span class="engagement-item">
            <mat-icon>thumb_up</mat-icon>
            <span class="count">{{ reactionCount() }}</span>
          </span>
          <span class="engagement-item">
            <mat-icon>chat_bubble</mat-icon>
            <span class="count">{{ commentCount() }}</span>
          </span>
          <span class="engagement-item">
            <mat-icon>bolt</mat-icon>
            <span class="count">{{ formatZapAmount(zapTotal()) }}</span>
          </span>
        </div>

        <!-- Top Zappers -->
        @if (topZappers().length > 0) {
        <div class="top-zappers">
          <app-zap-chips [zappers]="topZappers()" [maxDisplay]="4"></app-zap-chips>
        </div>
        }

        <div class="action-buttons">
          <button mat-flat-button (click)="likeTrack()" [disabled]="isLiked() || isLiking()" [class.liked]="isLiked()"
            aria-label="Like track">
            <mat-icon>{{ isLiked() ? 'favorite' : 'favorite_border' }}</mat-icon>
            {{ isLiked() ? 'Liked' : 'Like' }}
          </button>
          <button mat-stroked-button (click)="zapArtist()" aria-label="Zap artist">
            <mat-icon>bolt</mat-icon>
            Zap
          </button>
          <button mat-stroked-button (click)="downloadTrack()" [disabled]="!audioUrl() || isDownloading()"
            aria-label="Download track">
            @if (isDownloading()) {
            <mat-spinner diameter="18"></mat-spinner>
            } @else {
            <mat-icon>download</mat-icon>
            }
            Download
          </button>
        </div>

        <!-- Offline availability toggle -->
        <div class="offline-toggle-container">
          <mat-slide-toggle [checked]="isOffline()" [disabled]="!audioUrl() || isSavingOffline()"
            (change)="toggleOffline()" aria-label="Make available offline">
            <div class="offline-toggle-label">
              @if (isSavingOffline()) {
              <mat-spinner diameter="16"></mat-spinner>
              @if (offlineDownloadProgress() !== null) {
              <span>Downloading... {{ offlineDownloadProgress() }}%</span>
              } @else {
              <span>Saving...</span>
              }
              } @else {
              <mat-icon>{{ isOffline() ? 'offline_pin' : 'cloud_download' }}</mat-icon>
              <span>{{ isOffline() ? 'Available offline' : 'Make available offline' }}</span>
              }
            </div>
          </mat-slide-toggle>
        </div>

        @if (genres().length > 0) {
        <div class="genres">
          @for (genre of genres(); track genre) {
          <mat-chip>{{ genre }}</mat-chip>
          }
        </div>
        }

        @if (description()) {
        <p class="description">{{ description() }}</p>
        }
      </div>
    </div>

    @for (section of contentSections(); track section.title) {
    <mat-card class="content-section-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>{{ section.icon }}</mat-icon>
          {{ section.title }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        @if (section.title === 'License') {
        <div class="license-content">
          <span class="license-name">{{ section.content }}</span>
          @if (section.url) {
          <a [href]="section.url" target="_blank" rel="noopener noreferrer" class="license-link">
            <mat-icon>open_in_new</mat-icon>
            View License
          </a>
          }
        </div>
        } @else {
        <pre class="section-text">{{ section.content }}</pre>
        }
      </mat-card-content>
    </mat-card>
    }

    <!-- Comments Section -->
    @if (song(); as songEvent) {
    <div class="comments-section">
      <app-comments-list [event]="songEvent" [autoExpand]="false" label="Comments" singularLabel="Comment"
        [allowedKinds]="[1111]">
      </app-comments-list>
    </div>
    }
  </div>
  }
</div>

@if (showEditDialog() && editDialogData()) {
<app-music-track-dialog [data]="editDialogData()!" (closed)="onEditDialogClosed($event)" />
}

@if (showCreatePlaylistDialog() && createPlaylistDialogData()) {
<app-create-music-playlist-dialog [data]="createPlaylistDialogData()!" (closed)="onCreatePlaylistDialogClosed($event)" />
}