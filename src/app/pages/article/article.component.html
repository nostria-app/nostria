<!-- Panel Header - Fixed at top -->
<div class="panel-header">
  <button mat-icon-button class="back-button" (click)="goBack()" matTooltip="Go back">
    <mat-icon>arrow_back</mat-icon>
  </button>
  <h2 class="panel-title title-font">{{ title() || 'Article' }}</h2>
  <span class="panel-header-spacer"></span>

  @if (event()) {
  @if (accountState.isCurrentUser(authorPubkey())) {
  <button mat-icon-button (click)="layout.createArticle(link)" matTooltip="Edit Article">
    <mat-icon>edit</mat-icon>
  </button>
  }
  <button mat-icon-button (click)="bookmarkArticle()"
    [matTooltip]="bookmark.isBookmarkedInAnyList(id(), 'a') ? 'Manage bookmarks' : 'Add to bookmark list'">
    <mat-icon>{{ bookmark.getBookmarkIcon(id(), 'a') }}</mat-icon>
  </button>
  <button mat-icon-button (click)="shareArticle()" matTooltip="Share Article">
    <mat-icon>share</mat-icon>
  </button>
  <app-zap-button [event]="event()!"></app-zap-button>
  <app-event-menu [event]="event()!" [view]="'icon'"></app-event-menu>
  }
</div>

@let article = event();

@if (isLoading()) {
<!-- Loading State -->
<div class="article-loading">
  <mat-card>
    <mat-card-content>
      <div class="loading-content">
        <mat-progress-spinner diameter="40" mode="indeterminate"></mat-progress-spinner>
        <h2>Loading Article...</h2>
        <p>Please wait while we fetch the content.</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>
} @else if (error()) {
<!-- Error State -->
<div class="article-error">
  <mat-card>
    <mat-card-content>
      <div class="error-content">
        <mat-icon>error_outline</mat-icon>
        <h2>Unable to Load Article</h2>
        <p>{{ error() }}</p>
        <button mat-raised-button color="primary" (click)="retryLoad()">
          <mat-icon>refresh</mat-icon>
          Try Again
        </button>
      </div>
    </mat-card-content>
  </mat-card>
</div>
} @else if (article) {
<div class="article-container">
  <!-- Use ArticleDisplayComponent for rendering -->
  <app-article-display [article]="articleData()" mode="full" [showTopActions]="false" [isSpeaking]="isSpeaking()"
    [isPaused]="isPaused()" [useAiVoice]="useAiVoice()" [isSynthesizing]="isSynthesizing()"
    [isTranslating]="isTranslating()" [availableVoices]="availableVoices()" [selectedVoice]="selectedVoice()"
    [playbackRate]="playbackRate()" (startSpeech)="startSpeech()" (pauseSpeech)="pauseSpeech()"
    (resumeSpeech)="resumeSpeech()" (stopSpeech)="stopSpeech()" (toggleAiVoice)="useAiVoice.set($event)"
    (voiceChange)="onVoiceChange($event)" (playbackRateChange)="onPlaybackRateChange($event)" (share)="shareArticle()"
    (translate)="onTranslate($event)"></app-article-display>

  <!-- Article Footer with reactions -->
  <div class="article-footer">
    <div class="actions-row">
      <!-- Like with count -->
      <div class="action-button like-action like-hover-container"
        (click)="reactionBtn.sendDefaultReaction(); $event.stopPropagation()">
        <app-reaction-button class="action-icon" #reactionBtn [event]="article"
          [reactionsFromParent]="reactions()" (reactionChanged)="loadReactions(true)" view="icon"></app-reaction-button>
        @if (likes().length > 0) {
        <span class="action-count">{{ likes().length }}</span>
        }
        <span class="action-text">Like</span>
      </div>

      <!-- Reply -->
      <div class="action-button comment-action" role="button" tabindex="0" (click)="openReplyEditor($event)">
        <mat-icon class="action-icon">mode_comment</mat-icon>
        @if (replyCount() > 0) {
        <span class="action-count">{{ replyCount() }}</span>
        }
        <span class="action-text">Reply</span>
      </div>

      <!-- Share with count (reposts + quotes) -->
      <div class="action-button share-action" role="button" tabindex="0"
        (click)="shareArticle(); $event.stopPropagation()">
        <mat-icon class="action-icon">share</mat-icon>
        @if (shareCount() > 0) {
        <span class="action-count">{{ shareCount() }}</span>
        }
        <span class="action-text">Share</span>
      </div>

      <!-- Zap with sats -->
      <div class="action-button zap-action" (click)="zapBtn.onClick($event); $event.stopPropagation()">
        <app-zap-button class="action-icon" #zapBtn [event]="article"
          [recipientPubkey]="article.pubkey" (zapSent)="onZapSent($event)">
        </app-zap-button>
        @if (totalZapAmount() > 0) {
        <span class="action-count">{{ formatZapAmount(totalZapAmount()) }}</span>
        }
        <span class="action-text">Zap</span>
      </div>

      <!-- Bookmark -->
      <div class="action-button bookmark-action" role="button" tabindex="0" (click)="onBookmarkClick($event)">
        <mat-icon class="action-icon">{{ bookmark.getBookmarkIcon(id(), 'a') }}</mat-icon>
        <span class="action-text">Bookmark</span>
      </div>

      <!-- Top emojis indicator (right-aligned) -->
      @if (likes().length > 0 || zapCount() > 0 || repostCount() > 0 || quoteCount() > 0) {
      <div class="emoji-indicators" (click)="toggleReactionsSummary(); $event.stopPropagation()">
        @if (topEmojis().length > 0) {
        <span class="aggregated-emojis">
          @for (emoji of topEmojis(); track emoji.emoji) {
          @if (emoji.url) {
          <img [src]="emoji.url" [alt]="emoji.emoji" class="emoji-item custom-emoji" />
          } @else {
          <span class="emoji-item">{{ emoji.emoji }}</span>
          }
          }
        </span>
        }
        <span class="emoji-more">...</span>
      </div>
      }
    </div>

    <!-- Expandable reactions summary panel -->
    @if (showReactionsSummary()) {
    <div class="reactions-summary-container" [@expandCollapse]>
      <app-reaction-summary [reactions]="likes()" [replyCount]="replyCount()" [repostCount]="repostCount()"
        [quoteCount]="quoteCount()" [reposts]="reposts()" [quotes]="quotes()" [zaps]="zaps()"
        [totalZapAmount]="totalZapAmount()" [zapCount]="zapCount()" [initialTab]="reactionsSummaryTab()"
        [hideTabs]="false">
      </app-reaction-summary>
    </div>
    }
  </div>
</div>
} @else {
<!-- Loading or Empty State -->
<div class="article-empty-state">
  <mat-card>
    <mat-card-content>
      <div class="empty-state-content">
        <mat-icon>article</mat-icon>
        <h2>No Article Selected</h2>
        <p>Please select an article to view its content.</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>
}