<div class="content-medium">
   <ng-template #discoveryRelaysInfoContent>
    <mat-card-header>
      <mat-card-title>
        <div class="info-title">
          <mat-icon class="info-icon">info</mat-icon>
          How Backup Work
        </div>
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <p>
        Nostria keeps all your data in your browser's local storage. While this provides privacy, it
        means your data could be lost if you clear your browser data or switch devices.
      </p>
      <p>
        Regular backups ensure that you can restore your data when needed. Backups contain all of
        your events, relay information, and profile data.
      </p>
      <p>You should normally not need more than one or two discovery relays.</p>
      <h3>Important Notes:</h3>
      <ul>
        <li>Backups <strong>do not</strong> include your private keys for security reasons</li>
        <li>You should store backup files securely as they contain your public data</li>
        <li>Importing a backup will not overwrite existing data, only add missing events</li>
      </ul>
    </mat-card-content>
  </ng-template>

  <h2>
    Backup & Restore <mat-icon class="premium-icon">diamond</mat-icon>
    <app-info-tooltip
      [content]="discoveryRelaysInfoContent"
      ariaLabel="Learn how backup work"
    ></app-info-tooltip>
  </h2>

  <p class="subtitle">Manage your Nostr data backups</p>

  <mat-card>
    <mat-card-header>
      <mat-card-title>Data Statistics</mat-card-title>
      <mat-card-subtitle>Overview of your stored data</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div class="stats-container">
        <div class="stat-item">
          <div class="stat-value">{{ stats().eventsCount }}</div>
          <div class="stat-label">Events</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ stats().relaysCount }}</div>
          <div class="stat-label">Relays</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ stats().formattedSize }}</div>
          <div class="stat-label">Total Size</div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <div class="card-container">
    <!-- Backup Card -->
    <mat-card class="action-card">
      <mat-card-header>
        <mat-icon mat-card-avatar class="card-icon">cloud_download</mat-icon>
        <mat-card-title>Save Backup</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <p>
          Create a backup of all your events and data stored in Nostria. The backup will be saved as
          a zip file on your device.
        </p>

        @if (isSaving()) {
          <div class="progress-container">
            <mat-progress-bar mode="determinate" [value]="progress()"></mat-progress-bar>
            <span class="progress-text">{{ progress().toFixed(0) }}%</span>
          </div>
        }
      </mat-card-content>

      <mat-card-actions>
        <button mat-flat-button color="primary" [disabled]="isSaving()" (click)="saveBackup()">
          <mat-icon>save</mat-icon>
          @if (isSaving()) {
            <mat-spinner diameter="20" class="button-spinner"></mat-spinner>
            CREATING BACKUP...
          } @else {
            SAVE BACKUP
          }
        </button>
      </mat-card-actions>
    </mat-card>

    <!-- Restore Card -->
    <mat-card class="action-card">
      <mat-card-header>
        <mat-icon mat-card-avatar class="card-icon">restore</mat-icon>
        <mat-card-title>Import Backup</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <p>
          Import events from a previously created Nostria backup file. This will add any missing
          events to your local database.
        </p>

        @if (isImporting()) {
          <div class="progress-container">
            <mat-progress-bar mode="determinate" [value]="importProgress()"></mat-progress-bar>
            <span class="progress-text">{{ importProgress().toFixed(0) }}%</span>
          </div>
        }
      </mat-card-content>

      <mat-card-actions>
        <button
          mat-flat-button
          color="accent"
          [disabled]="isImporting()"
          (click)="initiateImport()"
        >
          <mat-icon>upload_file</mat-icon>
          @if (isImporting()) {
            <mat-spinner diameter="20" class="button-spinner"></mat-spinner>
            IMPORTING...
          } @else {
            IMPORT BACKUP
          }
        </button>
      </mat-card-actions>
    </mat-card>
  </div>

  <mat-divider style="margin: 32px 0;"></mat-divider>

  <h3>Following List History</h3>
  <p class="subtitle">Automatic backups of your following list (kind 3 events)</p>

  <mat-card>
    <mat-card-header>
      <mat-icon mat-card-avatar class="card-icon">people</mat-icon>
      <mat-card-title>Following List Backups</mat-card-title>
      <mat-card-subtitle>Last 10 versions are kept automatically</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <p>
        Your following list is automatically backed up every time you follow or unfollow someone. 
        You can restore a previous version or merge it with your current list.
      </p>
      
      <div class="backup-stats">
        <div class="stat">
          <mat-icon>backup</mat-icon>
          <span class="stat-value">{{ followingBackupsCount() }}</span>
          <span class="stat-label">Backups Available</span>
        </div>
        <div class="stat">
          <mat-icon>person_add</mat-icon>
          <span class="stat-value">{{ currentFollowingCount() }}</span>
          <span class="stat-label">Currently Following</span>
        </div>
      </div>
    </mat-card-content>

    <mat-card-actions>
      <button 
        mat-flat-button 
        (click)="openFollowingHistory()"
        [disabled]="followingBackupsCount() === 0"
      >
        <mat-icon>history</mat-icon>
        VIEW HISTORY
      </button>
    </mat-card-actions>
  </mat-card>
</div>
