// Host element styles - fill the full height of the container
:host {
  display: flex;
  flex-direction: column;
  width: 100%;
  // Fill the parent panel height so virtual scroll can work properly
  height: 100%;
  // Prevent any overflow from this element - virtual scroll handles scrolling
  overflow: hidden;
  // Remove any generic padding added by parent
  padding-top: 0 !important;
}

// Filter panel backdrop
::ng-deep .filter-panel-backdrop {
  background-color: transparent;
}

// Active filters indicator on button
.active-filters {
  color: var(--mat-sys-primary) !important;
}

// Panel header styles - fixed at top
.panel-header {
  position: sticky;
  top: 0;
  z-index: 50;
  display: flex;
  align-items: center;
  gap: 8px;
  min-height: 56px;
  padding: 0 16px;
  flex-shrink: 0;
  background-color: rgba(255, 255, 255, 0.92);
  -webkit-backdrop-filter: blur(20px) saturate(1.8);
  backdrop-filter: blur(20px) saturate(1.8);
  border-bottom: 1px solid rgba(0, 0, 0, 0.06);

  .panel-title {
    margin: 0;
    font-size: 1.25rem;
  }

  .panel-header-spacer {
    flex: 1;
  }
}

:host-context(.dark) .panel-header {
  background-color: rgba(18, 18, 18, 0.92);
  border-bottom: 1px solid rgba(255, 255, 255, 0.06);
}

// Main container styles
.notifications-page {
  display: flex;
  flex-direction: column;
  // Fill parent height for virtual scroll to work
  height: 100%;
  max-width: 700px;
  margin: 0 auto;
  width: 100%;
  // Prevent overflow - virtual scroll handles scrolling
  overflow: hidden;
  // Remove any inherited padding
  padding-top: 0;
}

// Notifications container
.notifications-container {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-height: 0; // Allow flex child to shrink for virtual scroll
  position: relative;
  border-radius: 12px;
  overflow: hidden; // Clip to container, virtual scroll handles scrolling
}

// Notification badge in panel header
.notification-badge {
  background: var(--mat-sys-primary);
  color: var(--mat-sys-on-primary);
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
  min-width: 20px;
  text-align: center;
  margin-left: 8px;
}

// Filter menu item with type icon
.filter-menu-item {
  .type-icon {
    margin-left: 8px;
    font-size: 18px;
    width: 18px;
    height: 18px;
  }
}

// Search container
.search-container {
  padding: 16px 16px 0 16px;

  .search-field {
    width: 100%;

    ::ng-deep {
      .mat-mdc-form-field-subscript-wrapper {
        display: none;
      }

      .mat-mdc-text-field-wrapper {
        background: var(--mat-sys-surface-container);
      }
    }

    mat-icon[matPrefix] {
      margin-right: 8px;
      color: var(--mat-sys-on-surface-variant);
    }
  }
}

// Empty state
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 80px 24px;
  text-align: center;

  .empty-icon {
    font-size: 120px;
    width: 120px;
    height: 120px;
    color: var(--mat-sys-primary);
    margin-bottom: 24px;
    opacity: 0.6;
  }

  h2 {
    margin: 0 0 8px 0;
    font-size: 24px;
  }

  p {
    margin: 0 0 16px 0;
    opacity: 0.7;
    font-size: 16px;
  }

  button {
    margin-top: 8px;
  }
}

// Notification list - CDK virtual scroll requires explicit height
.notification-viewport {
  // Fill remaining space in flex container
  flex: 1;
  min-height: 0; // Required for flex child to shrink properly
  width: 100%;
  padding-bottom: 80px; // Space for mobile navigation menu

  ::ng-deep .cdk-virtual-scroll-content-wrapper {
    width: 100%;
    max-width: 700px;
    margin: 0 auto;
    // Add padding at top for spacing
    padding-top: 16px;
  }

  // Fixed height for virtual scrolling items only (94px content + 8px margin-bottom)
  .notification-item {
    height: 94px;
    min-height: 94px;
    max-height: 94px;
    overflow: hidden; // Clip content vertically and horizontally to fixed height

    // Constrain content to fit fixed height
    .notification-content {
      .notification-author {
        max-height: 40px;
        overflow: hidden;
      }

      .notification-message {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
    }
  }

  // Load more indicator at bottom of virtual scroll
  .load-more-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 24px;
    color: var(--mat-sys-on-surface-variant);
    font-size: 14px;

    mat-icon {
      font-size: 20px;
      width: 20px;
      height: 20px;
    }

    &.clickable {
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s;
      border-radius: 8px;
      margin: 8px 16px;
      background: var(--mat-sys-surface-container);

      &:hover {
        background: var(--mat-sys-surface-container-high);
        color: var(--mat-sys-primary);
      }
    }

    &.end {
      opacity: 0.6;

      mat-icon {
        color: var(--mat-success-color);
      }
    }
  }
}

.notification-list {
  display: flex;
  flex-direction: column;
  width: 100%;
  flex: 1;
  min-height: 0; // Required for flex child to enable scrolling
  overflow-y: auto; // Enable vertical scrolling
  padding-bottom: 80px; // Space for mobile navigation menu
}

// System notification items - completely separate from activity items
.notification-system-item {
  display: flex;
  align-items: flex-start;
  padding: 16px 12px;
  gap: 16px;
  border-bottom: 1px solid var(--mat-sys-outline-variant);
  transition: background-color 0.2s;
  min-width: 0;
  position: relative;
  width: 100%;

  &:hover {
    background: var(--mat-sys-surface-container-high);
  }

  &.unread {
    background: var(--mat-sys-surface-container-low);
  }

  &:last-child {
    border-bottom: none;
  }

  // Icon wrapper styling (same as activity items)
  .notification-icon-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 48px;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    flex-shrink: 0;
    background: var(--mat-sys-primary-container);

    .notification-bell {
      font-size: 24px;
      width: 24px;
      height: 24px;
      color: var(--mat-sys-on-primary-container);
    }
  }

  // Allow full vertical expansion for relay publish status cards
  .notification-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-width: 0;
    overflow: visible; // Allow content to expand

    .notification-header {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;

      .notification-title {
        font-size: 16px;
        flex: 1;
        min-width: 0;
      }

      .new-indicator {
        background: var(--mat-sys-primary);
        color: var(--mat-sys-on-primary);
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        letter-spacing: 1px;
        text-transform: uppercase;
        flex-shrink: 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        animation: pulse-glow 2s ease-in-out infinite;
      }
    }

    .notification-message {
      font-size: 14px;
      opacity: 0.8;
      line-height: 1.4;
    }

    .notification-meta {
      display: flex;
      align-items: center;
      gap: 4px;
      opacity: 0.6;
      font-size: 14px;
      flex-wrap: wrap;

      .time-icon {
        font-size: 16px;
        width: 16px;
        height: 16px;
      }
    }
  }

  // Extra content area (relay publish status) should expand freely
  .notification-extra {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--mat-sys-outline-variant);
    width: 100%;

    // Ensure relay status renders at full size
    ::ng-deep app-relay-publish-status {
      display: block;
      width: 100%;
      max-height: none !important;
      height: auto !important;
      overflow: visible !important;

      .relay-status-card {
        width: 100%;
        margin-bottom: 0;
        box-shadow: none;
        border: 1px solid var(--mat-sys-outline-variant);
        max-height: none !important;
        height: auto !important;
        overflow: visible !important;
      }

      .mat-mdc-card-content,
      mat-card-content {
        max-height: none !important;
        height: auto !important;
        overflow: visible !important;
      }

      .relays-container {
        max-height: none !important;
        height: auto !important;
        overflow: visible !important;
      }
    }
  }

  // Action buttons styling (same as activity items)
  .notification-actions {
    display: flex;
    align-items: flex-start;
    gap: 4px;

    .action-icon-button {
      width: 36px;
      height: 36px;

      mat-icon {
        font-size: 20px;
        width: 20px;
        height: 20px;
      }
    }
  }
}

.notification-item {
  display: flex;
  align-items: flex-start;
  padding: 10px 10px;
  gap: 16px;
  border-bottom: 1px solid var(--mat-sys-outline-variant);
  transition: background-color 0.2s, opacity 0.2s;
  min-width: 0; // Enable proper flex shrinking
  overflow-x: hidden; // Prevent horizontal overflow only
  position: relative;
  padding-left: 16px; // Space for left accent border
  margin: 0 12px 8px 12px; // Add margin between items
  border-radius: 12px; // Rounded corners for card-like appearance
  border: 1px solid var(--mat-sys-outline-variant);

  // Left accent bar for visual type identification
  &::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    border-radius: 12px 0 0 12px; // Match container border radius
    transition: opacity 0.3s ease;
  }

  // Type-specific accent colors for the left bar
  &[data-notification-type="zap"]::before {
    background: linear-gradient(180deg, #f7931a 0%, #ffb347 100%);
  }

  &[data-notification-type="newfollower"]::before {
    background: linear-gradient(180deg, #10b981 0%, #34d399 100%);
  }

  &[data-notification-type="mention"]::before {
    background: linear-gradient(180deg, #8b5cf6 0%, #a78bfa 100%);
  }

  &[data-notification-type="repost"]::before {
    background: linear-gradient(180deg, #3b82f6 0%, #60a5fa 100%);
  }

  &[data-notification-type="reply"]::before {
    background: linear-gradient(180deg, #0ea5e9 0%, #38bdf8 100%);
  }

  &[data-notification-type="reaction"]::before {
    background: linear-gradient(180deg, #ec4899 0%, #f472b6 100%);
  }

  // Unread notifications - show the accent bar, white/bright background
  &:not(.read) {
    background: var(--mat-sys-surface);
    border-color: var(--mat-sys-outline-variant);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);

    &::before {
      opacity: 1;
    }
  }

  // Read notifications - hide the accent bar, significantly muted
  &.read {
    background: var(--mat-sys-surface-container);
    opacity: 0.6;
    border-color: transparent;

    &::before {
      opacity: 0;
    }

    .notification-content {
      .notification-header .notification-author-name {
        color: var(--mat-sys-on-surface-variant);
      }

      .notification-message {
        opacity: 0.7;
      }
    }

    .notification-avatar-wrapper {
      opacity: 0.7;
    }
  }

  &:hover {
    background: var(--mat-sys-surface-container-high);
    opacity: 1;

    // Show accent bar on hover even for read notifications
    &::before {
      opacity: 1;
    }
  }

  &.clickable .notification-content {
    cursor: pointer;
    transition: opacity 0.2s;

    &:hover {
      opacity: 0.8;
    }

    &:focus {
      outline: 2px solid var(--mat-app-primary);
      outline-offset: 2px;
      border-radius: 4px;
    }
  }

  // Avatar wrapper with notification type badge overlay
  .notification-avatar-wrapper {
    position: relative;
    flex-shrink: 0;
    width: 56px;
    height: 56px;

    // Style the user-profile component to show larger avatar
    ::ng-deep app-user-profile {
      .user-profile.small {
        .user-profile-container {
          padding: 0;
        }

        .user-profile-avatar-container {
          .user-profile-avatar {
            width: 56px;
            height: 56px;
            border-width: 2px;

            .user-avatar {
              width: 56px;
              height: 56px;
            }

            .default-user-avatar {
              font-size: 56px;
              width: 56px;
              height: 56px;
            }
          }
        }
      }
    }

    // Default avatar when no author pubkey
    .notification-default-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--mat-sys-surface-container);
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--mat-sys-outline-variant);

      mat-icon {
        font-size: 40px;
        width: 40px;
        height: 40px;
        color: var(--mat-sys-on-surface-variant);
      }
    }

    // Notification type badge positioned at bottom-right of avatar
    .notification-type-badge {
      position: absolute;
      bottom: -4px;
      right: -4px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--mat-sys-surface);
      z-index: 1;

      mat-icon {
        font-size: 14px;
        width: 14px;
        height: 14px;
        color: #ffffff;
      }

      // Zap notifications - Bitcoin orange/gold
      &[data-badge-type="zap"] {
        background: linear-gradient(135deg, #f7931a 0%, #ffb347 100%);
        box-shadow: 0 2px 4px rgba(247, 147, 26, 0.4);
      }

      // New follower - Cheerful green/teal
      &[data-badge-type="newfollower"] {
        background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.4);
      }

      // Mentions - Purple/violet
      &[data-badge-type="mention"] {
        background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        box-shadow: 0 2px 4px rgba(139, 92, 246, 0.4);
      }

      // Reposts - Blue
      &[data-badge-type="repost"] {
        background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.4);
      }

      // Replies - Sky blue
      &[data-badge-type="reply"] {
        background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%);
        box-shadow: 0 2px 4px rgba(14, 165, 233, 0.4);
      }

      // Reactions (likes) - Pink/rose
      &[data-badge-type="reaction"] {
        background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
        box-shadow: 0 2px 4px rgba(236, 72, 153, 0.4);
      }
    }
  }

  .notification-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-width: 0; // Allow container to shrink and enable text wrapping
    overflow: hidden; // Prevent overflow

    .notification-header {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0; // Allow flex items to shrink
      flex-wrap: wrap;

      .notification-author-name {
        color: var(--mat-sys-primary);
        text-decoration: none;
        font-size: 15px;
        cursor: pointer;
        flex-shrink: 0;
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;

        &:hover {
          text-decoration: underline;
        }

        ::ng-deep app-profile-display-name {
          display: inline;
        }
      }

      .notification-title {
        font-size: 15px;
        flex: 1;
        min-width: 0; // Allow text to shrink
        white-space: nowrap; // Prevent wrapping
        overflow: hidden; // Hide overflow
        text-overflow: ellipsis; // Show ellipsis for overflow
        opacity: 0.8;
      }

      // Custom emoji image for NIP-30 reactions
      .notification-custom-emoji {
        width: 20px;
        height: 20px;
        object-fit: contain;
        vertical-align: middle;
        flex-shrink: 0;
      }

      .new-indicator {
        background: var(--mat-sys-primary);
        color: var(--mat-sys-on-primary);
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        letter-spacing: 1px;
        text-transform: uppercase;
        flex-shrink: 0; // Don't shrink the badge
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        animation: pulse-glow 2s ease-in-out infinite;
      }

      @keyframes pulse-glow {

        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }

        50% {
          opacity: 0.9;
          transform: scale(1.05);
        }
      }
    }

    // Keep old notification-author styles for backward compatibility if needed
    .notification-author {
      margin-top: 4px;
      margin-bottom: 4px;
      // No max-height constraint for regular list items
      // (constraint is applied in .notification-viewport scope)
    }

    .notification-message {
      font-size: 14px;
      opacity: 0.8;
      line-height: 1.4;
      // No text truncation for regular list items
      // (constraint is applied in .notification-viewport scope)

      &.zap-content {
        font-style: italic;
        opacity: 0.9;
        padding: 8px 12px;
        margin-top: 4px;
        border-left: 3px solid #f7931a;
        background: var(--mat-sys-surface-container-low);
        border-radius: 4px;
      }
    }

    .notification-meta {
      display: flex;
      align-items: center;
      gap: 4px;
      opacity: 0.6;
      font-size: 14px;
      flex-wrap: wrap;

      .time-icon {
        font-size: 16px;
        width: 16px;
        height: 16px;
      }

      .divider {
        margin: 0 4px;
      }

      .author-link {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        min-height: 0;
        height: auto;
        font-size: 13px;
        opacity: 1;
        color: var(--mat-sys-primary);
        text-transform: none;
        letter-spacing: normal;

        mat-icon {
          font-size: 16px;
          width: 16px;
          height: 16px;
        }

        &:hover {
          background: var(--mat-sys-primary-container);
        }
      }
    }

    .notification-extra {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--mat-sys-outline-variant);

      // Ensure relay status card has proper spacing
      ::ng-deep app-relay-publish-status {
        display: block;

        .relay-status-card {
          margin-bottom: 0; // Remove bottom margin in notification context
          box-shadow: none; // Remove shadow, use border instead
          border: 1px solid var(--mat-sys-outline-variant);
        }
      }
    }
  }

  .notification-actions {
    display: flex;
    align-items: flex-start;
    gap: 4px;

    .action-icon-button {
      width: 36px;
      height: 36px;

      mat-icon {
        font-size: 20px;
        width: 20px;
        height: 20px;
      }
    }
  }
}

// Hide the menu mark-read button on larger screens (shown via ::ng-deep for mat-menu)
::ng-deep .menu-mark-read-btn {
  display: none !important;
}

// Responsive
@media (max-width: 768px) {

  .page-header {
    flex-direction: row;
    align-items: center;
    gap: 8px;
  }

  // Hide "NEW" indicator on notification items
  .notification-item .notification-content .notification-header .new-indicator,
  .notification-system-item .notification-content .notification-header .new-indicator {
    display: none;
  }

  // Hide notification badge in header on small screens
  .notification-badge {
    display: none;
  }
}

@media (max-width: 600px) {

  // Show the menu mark-read button on small screens
  ::ng-deep .menu-mark-read-btn {
    display: flex !important;
  }

  // Hide the standalone mark-read button on small screens (it's in the menu)
  .notification-item .notification-actions .mark-read-btn,
  .notification-system-item .notification-actions .mark-read-btn {
    display: none;
  }

  // Adjust viewport for mobile - use flex sizing, add extra bottom padding
  .notification-viewport {
    padding-bottom: 120px; // Extra space for mobile navigation menu
  }

  .notification-list {
    padding-bottom: 120px; // Extra space for mobile navigation menu
  }

  .page-header .header-left .header-icon {
    font-size: 28px;
    width: 28px;
    height: 28px;
  }

  .page-header .header-left .header-text h1 {
    font-size: 24px;
  }

  .notification-item {
    gap: 8px;

    // Shrink the avatar wrapper on small screens
    .notification-avatar-wrapper {
      width: 48px;
      height: 48px;

      ::ng-deep app-user-profile {
        .user-profile.small {
          .user-profile-avatar-container {
            .user-profile-avatar {
              width: 48px;
              height: 48px;

              .user-avatar {
                width: 48px;
                height: 48px;
              }

              .default-user-avatar {
                font-size: 48px;
                width: 48px;
                height: 48px;
              }
            }
          }
        }
      }

      .notification-default-avatar {
        width: 48px;
        height: 48px;

        mat-icon {
          font-size: 32px;
          width: 32px;
          height: 32px;
        }
      }

      .notification-type-badge {
        width: 20px;
        height: 20px;
        bottom: -2px;
        right: -2px;

        mat-icon {
          font-size: 12px;
          width: 12px;
          height: 12px;
        }
      }
    }
  }

  .empty-state {
    padding: 60px 16px;

    .empty-icon {
      font-size: 80px;
      width: 80px;
      height: 80px;
    }
  }
}

// Very small screens - shrink avatar further
@media (max-width: 400px) {
  .notification-item {
    .notification-avatar-wrapper {
      width: 40px;
      height: 40px;

      ::ng-deep app-user-profile {
        .user-profile.small {
          .user-profile-avatar-container {
            .user-profile-avatar {
              width: 40px;
              height: 40px;

              .user-avatar {
                width: 40px;
                height: 40px;
              }

              .default-user-avatar {
                font-size: 40px;
                width: 40px;
                height: 40px;
              }
            }
          }
        }
      }

      .notification-default-avatar {
        width: 40px;
        height: 40px;

        mat-icon {
          font-size: 28px;
          width: 28px;
          height: 28px;
        }
      }

      .notification-type-badge {
        width: 18px;
        height: 18px;

        mat-icon {
          font-size: 10px;
          width: 10px;
          height: 10px;
        }
      }
    }
  }
}

// Filter button in tab label
// Filter menu styles
.filter-menu-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  font-weight: 500;
  color: var(--mat-sys-primary);
  pointer-events: none;

  mat-icon {
    font-size: 20px;
    width: 20px;
    height: 20px;
  }
}

// Type icon in menu items
.type-icon {
  margin-left: 8px;
  font-size: 18px;
  width: 18px;
  height: 18px;
  opacity: 0.7;
}

// Filter menu item styling
.filter-menu-item {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;

  &:hover {
    background-color: rgba(var(--mat-sys-primary-rgb), 0.08);
  }
}

// Dark mode adjustments
:host-context(.dark) {
  .notification-item {

    // Unread notifications in dark mode - brighter surface with emphasis
    &:not(.read) {
      background: var(--mat-sys-surface-container-high);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    // Read notifications in dark mode - much darker/more muted
    &.read {
      background: var(--mat-sys-surface-container-lowest);
      opacity: 0.5;
      border-color: transparent;
    }
  }

  .notification-type-badge {

    // Adjust gradients for better contrast in dark mode
    &[data-badge-type="zap"] {
      background: linear-gradient(135deg, #f7931a 0%, #d97706 100%);
      box-shadow: 0 2px 8px rgba(247, 147, 26, 0.5);
    }

    &[data-badge-type="newfollower"] {
      background: linear-gradient(135deg, #059669 0%, #10b981 100%);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.5);
    }

    &[data-badge-type="mention"] {
      background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);
      box-shadow: 0 2px 8px rgba(124, 58, 237, 0.5);
    }

    &[data-badge-type="repost"] {
      background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.5);
    }

    &[data-badge-type="reply"] {
      background: linear-gradient(135deg, #0284c7 0%, #0ea5e9 100%);
      box-shadow: 0 2px 8px rgba(2, 132, 199, 0.5);
    }

    &[data-badge-type="reaction"] {
      background: linear-gradient(135deg, #db2777 0%, #ec4899 100%);
      box-shadow: 0 2px 8px rgba(219, 39, 119, 0.5);
    }
  }
}