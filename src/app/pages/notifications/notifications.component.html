<div class="notifications-page">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-left">
      <mat-icon class="header-icon">notifications</mat-icon>
      <div class="header-text">
        <h1>Notifications</h1>
        @if (newNotificationCount() > 0) {
        <span class="new-badge">{{ newNotificationCount() }} new</span>
        }
      </div>
    </div>
    <div class="header-actions">
      @if (notifications().length > 0) {
      <button mat-button (click)="markAllAsRead()" class="action-button">
        <mat-icon>done_all</mat-icon>
        Mark All Read
      </button>
      <button mat-button (click)="clearNotifications()" class="action-button">
        <mat-icon>close</mat-icon>
        Clear All
      </button>
      }
      <button mat-icon-button routerLink="/notifications/settings" matTooltip="Notification settings"
        i18n-matTooltip="@@notifications.settings.tooltip">
        <mat-icon>settings</mat-icon>
      </button>
    </div>
  </div>

  <!-- Notifications Content -->
  <div class="notifications-container">
    <mat-tab-group class="notifications-tabs">
      <!-- Content Notifications Tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <span class="tab-label">
            <mat-icon>people</mat-icon>
            Activity
            @if (contentNotifications().length > 0) {
            <span class="tab-badge">{{ contentNotifications().length }}</span>
            }
            <button mat-icon-button class="filter-button" [matMenuTriggerFor]="filterMenu"
              (click)="$event.stopPropagation()" matTooltip="Filter notifications">
              <mat-icon>settings</mat-icon>
            </button>
            <button mat-icon-button class="filter-button" [class.active]="showSearch()"
              (click)="toggleSearch(); $event.stopPropagation()" matTooltip="Search notifications">
              <mat-icon>search</mat-icon>
            </button>
          </span>
        </ng-template>

        <mat-menu #filterMenu="matMenu">
          <div class="filter-menu-header">
            <mat-icon>filter_list</mat-icon>
            <span>Filter Activity</span>
          </div>
          <mat-divider></mat-divider>
          @for (type of getFilterableNotificationTypes(); track type) {
          <button mat-menu-item (click)="toggleNotificationFilter(type); $event.stopPropagation()"
            (mousedown)="$event.stopPropagation()" class="filter-menu-item">
            <mat-icon>{{ notificationFilters()[type] ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
            <mat-icon class="type-icon">{{ getNotificationTypeIcon(type) }}</mat-icon>
            <span>{{ getNotificationTypeLabel(type) }}</span>
          </button>
          }
        </mat-menu>

        <!-- Search Input (toggled by search button) -->
        @if (showSearch()) {
        <div class="search-container">
          <mat-form-field appearance="outline" class="search-field">
            <mat-icon matPrefix>search</mat-icon>
            <input matInput placeholder="Search by name or content..." [ngModel]="searchQuery()"
              (ngModelChange)="searchQuery.set($event)">
            <button matSuffix mat-icon-button (click)="toggleSearch()" matTooltip="Close search">
              <mat-icon>close</mat-icon>
            </button>
          </mat-form-field>
        </div>
        }

        @if (contentNotifications().length === 0 && !searchQuery()) {
        <div class="empty-state">
          <mat-icon class="empty-icon">people</mat-icon>
          <h2>No activity yet</h2>
          <p>You'll see mentions, follows, reposts, and other interactions here.</p>
        </div>
        } @else if (contentNotifications().length === 0 && searchQuery()) {
        <div class="empty-state">
          <mat-icon class="empty-icon">search_off</mat-icon>
          <h2>No matching notifications</h2>
          <p>No notifications found matching "{{ searchQuery() }}"</p>
          <button mat-flat-button (click)="clearSearch()">
            <mat-icon>close</mat-icon>
            Clear search
          </button>
        </div>
        } @else {
        <cdk-virtual-scroll-viewport [itemSize]="110" class="notification-viewport"
          (scrolledIndexChange)="onScrolledIndexChange($event)">
          <div *cdkVirtualFor="let notification of contentNotifications(); trackBy: trackByNotificationId"
            class="notification-item" [class.unread]="!notification.read" [class.clickable]="getEventId(notification)"
            [attr.data-notification-type]="notification.type">
            <div class="notification-avatar-wrapper">
              @if (getAuthorPubkey(notification)) {
              <app-user-profile [pubkey]="getAuthorPubkey(notification)!" [view]="'small'"
                [disableLink]="true"></app-user-profile>
              } @else {
              <div class="notification-default-avatar">
                <mat-icon>account_circle</mat-icon>
              </div>
              }
              <div class="notification-type-badge" [attr.data-badge-type]="notification.type">
                <mat-icon>{{ getNotificationTypeIcon(notification.type) }}</mat-icon>
              </div>
            </div>

            <div class="notification-content" (click)="getEventId(notification) ? viewEvent(notification) : null"
              (keydown.enter)="getEventId(notification) ? viewEvent(notification) : null"
              [attr.tabindex]="getEventId(notification) ? 0 : null"
              [attr.role]="getEventId(notification) ? 'button' : null">
              <div class="notification-header">
                @if (getAuthorPubkey(notification)) {
                <a class="notification-author-name" [routerLink]="['/p', getAuthorNpub(notification)]">
                  <app-profile-display-name [pubkey]="getAuthorPubkey(notification)!"></app-profile-display-name>
                </a>
                }
                <span class="notification-title">{{ getFormattedNotificationTitle(notification) }}</span>
                @if (!notification.read) {
                <span class="new-indicator">NEW</span>
                }
              </div>

              @if (notification.message && notification.type !== 'zap') {
              <div class="notification-message">{{ notification.message }}</div>
              }

              @if (notification.message && notification.type === 'zap') {
              <div class="notification-message">
                {{ notification.message }}@if (getZapContent(notification)) {<span> Â· {{ getZapContent(notification)
                  }}</span>}
              </div>
              } @else if (getZapContent(notification)) {
              <div class="notification-message">{{ getZapContent(notification) }}</div>
              }

              <div class="notification-meta">
                <mat-icon class="time-icon">schedule</mat-icon>
                <span class="notification-time">{{ (notification.timestamp / 1000) | ago }}</span>
              </div>
            </div>

            <div class="notification-actions">
              @if (!notification.read) {
              <button mat-icon-button (click)="markAsRead(notification.id); $event.stopPropagation()"
                matTooltip="Mark as read" class="action-icon-button">
                <mat-icon>check</mat-icon>
              </button>
              }
              <button mat-icon-button (click)="removeNotification(notification.id); $event.stopPropagation()"
                matTooltip="Remove" class="action-icon-button remove-btn">
                <mat-icon>close</mat-icon>
              </button>
              <button mat-icon-button [matMenuTriggerFor]="notificationMenu" (click)="$event.stopPropagation()"
                matTooltip="More options" class="action-icon-button">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #notificationMenu="matMenu">
                <button mat-menu-item class="menu-remove-btn" (click)="removeNotification(notification.id)">
                  <mat-icon>close</mat-icon>
                  <span>Remove</span>
                </button>
                <button mat-menu-item (click)="copyNotificationData(notification)">
                  <mat-icon>content_copy</mat-icon>
                  <span>Copy event data</span>
                </button>
              </mat-menu>
            </div>
          </div>

          <!-- Load More Indicator -->
          @if (isLoadingMore()) {
          <div class="load-more-indicator">
            <mat-spinner diameter="24"></mat-spinner>
            <span>Loading older notifications...</span>
          </div>
          } @else if (hasMoreNotifications() && contentNotifications().length >= 10) {
          <div class="load-more-indicator clickable" (click)="loadMoreNotifications()">
            <mat-icon>expand_more</mat-icon>
            <span>Load more notifications</span>
          </div>
          } @else if (!hasMoreNotifications()) {
          <div class="load-more-indicator end">
            <mat-icon>check_circle</mat-icon>
            <span>You've reached the end</span>
          </div>
          }
        </cdk-virtual-scroll-viewport>
        }
      </mat-tab>

      <!-- System Notifications Tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <span class="tab-label">
            <mat-icon>priority</mat-icon>
            System
          </span>
        </ng-template>

        @if (systemNotifications().length === 0) {
        <div class="empty-state">
          <mat-icon class="empty-icon">settings</mat-icon>
          <h2>No system notifications</h2>
          <p>Technical notifications and system messages will appear here.</p>
        </div>
        } @else {
        <div class="notification-list">
          @for (notification of systemNotifications(); track trackByNotificationId($index, notification)) {
          <div class="notification-system-item" [class.unread]="!notification.read">
            <div class="notification-icon-wrapper">
              <mat-icon class="notification-bell">notifications</mat-icon>
            </div>

            <div class="notification-content">
              <div class="notification-header">
                <span class="notification-title">{{ getFormattedNotificationTitle(notification) }}</span>
                @if (!notification.read) {
                <span class="new-indicator">NEW</span>
                }
              </div>

              @if (notification.message) {
              <div class="notification-message">{{ notification.message }}</div>
              }

              <div class="notification-meta">
                <mat-icon class="time-icon">schedule</mat-icon>
                <span class="notification-time">{{ (notification.timestamp / 1000) | ago }}</span>
              </div>

              @if (isRelayPublishingNotification(notification)) {
              <div class="notification-extra">
                <app-relay-publish-status [notification]="notification" (retry)="onRetryPublish($event)"
                  (republish)="onRepublish($event)">
                </app-relay-publish-status>
              </div>
              }
            </div>

            <div class="notification-actions">
              @if (!notification.read) {
              <button mat-icon-button (click)="markAsRead(notification.id)" matTooltip="Mark as read"
                class="action-icon-button">
                <mat-icon>check</mat-icon>
              </button>
              }
              <button mat-icon-button (click)="removeNotification(notification.id)" matTooltip="Remove"
                class="action-icon-button">
                <mat-icon>close</mat-icon>
              </button>
              <button mat-icon-button [matMenuTriggerFor]="systemNotificationMenu" matTooltip="More options"
                class="action-icon-button">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #systemNotificationMenu="matMenu">
                <button mat-menu-item (click)="copyNotificationData(notification)">
                  <mat-icon>content_copy</mat-icon>
                  <span>Copy event data</span>
                </button>
              </mat-menu>
            </div>
          </div>
          }
        </div>
        }
      </mat-tab>
    </mat-tab-group>
  </div>
</div>