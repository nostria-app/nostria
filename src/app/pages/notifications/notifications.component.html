<div class="notifications-page">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-left">
      <mat-icon class="header-icon">notifications</mat-icon>
      <div class="header-text">
        <h1>Notifications</h1>
        @if (newNotificationCount() > 0) {
        <span class="new-badge">{{ newNotificationCount() }} new</span>
        }
      </div>
    </div>
    <div class="header-actions">
      @if (notifications().length > 0) {
      <button mat-button (click)="markAllAsRead()" class="action-button">
        <mat-icon>done_all</mat-icon>
        Mark All Read
      </button>
      <button mat-button (click)="clearNotifications()" class="action-button">
        <mat-icon>close</mat-icon>
        Clear All
      </button>
      }
    </div>
  </div>

  <p class="page-subtitle">Stay updated with your latest activities</p>

  <!-- Notifications Content -->
  <div class="notifications-container">
    <mat-tab-group class="notifications-tabs">
      <!-- Content Notifications Tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <span class="tab-label">
            <mat-icon>people</mat-icon>
            Activity
            @if (contentNotifications().length > 0) {
            <span class="tab-badge">{{ contentNotifications().length }}</span>
            }
            <button mat-icon-button class="filter-button" [matMenuTriggerFor]="filterMenu"
              (click)="$event.stopPropagation()" matTooltip="Filter notifications">
              <mat-icon>settings</mat-icon>
            </button>
          </span>
        </ng-template>

        <mat-menu #filterMenu="matMenu">
          <div class="filter-menu-header">
            <mat-icon>filter_list</mat-icon>
            <span>Filter Activity</span>
          </div>
          <mat-divider></mat-divider>
          @for (type of getFilterableNotificationTypes(); track type) {
          <button mat-menu-item (click)="toggleNotificationFilter(type); $event.stopPropagation()"
            (mousedown)="$event.stopPropagation()" class="filter-menu-item">
            <mat-icon>{{ notificationFilters()[type] ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
            <mat-icon class="type-icon">{{ getNotificationTypeIcon(type) }}</mat-icon>
            <span>{{ getNotificationTypeLabel(type) }}</span>
          </button>
          }
        </mat-menu>

        @if (contentNotifications().length === 0) {
        <div class="empty-state">
          <mat-icon class="empty-icon">people</mat-icon>
          <h2>No activity yet</h2>
          <p>You'll see mentions, follows, reposts, and other interactions here.</p>
        </div>
        } @else {
        <cdk-virtual-scroll-viewport [itemSize]="100" class="notification-viewport">
          <div *cdkVirtualFor="let notification of contentNotifications(); trackBy: trackByNotificationId"
            class="notification-item" [class.unread]="!notification.read" [class.clickable]="getEventId(notification)"
            [attr.data-notification-type]="notification.type">
            <div class="notification-icon-wrapper" [attr.data-icon-type]="notification.type">
              <mat-icon class="notification-icon">{{ getNotificationTypeIcon(notification.type) }}</mat-icon>
            </div>

            <div class="notification-content" (click)="getEventId(notification) ? viewEvent(notification) : null"
              (keydown.enter)="getEventId(notification) ? viewEvent(notification) : null"
              [attr.tabindex]="getEventId(notification) ? 0 : null"
              [attr.role]="getEventId(notification) ? 'button' : null">
              <div class="notification-header">
                <span class="notification-title">{{ notification.title }}</span>
                @if (!notification.read) {
                <span class="new-indicator">NEW</span>
                }
              </div>

              @if (notification.message) {
              <div class="notification-message">{{ notification.message }}</div>
              }

              <div class="notification-meta">
                <mat-icon class="time-icon">schedule</mat-icon>
                <span class="notification-time">{{ (notification.timestamp / 1000) | ago }}</span>
                @if (getAuthorPubkey(notification)) {
                <span class="divider">â€¢</span>
                <button mat-button class="author-link"
                  (click)="viewAuthorProfile(notification); $event.stopPropagation()" matTooltip="View profile">
                  <mat-icon>person</mat-icon>
                  View Profile
                </button>
                }
              </div>
            </div>

            <div class="notification-actions">
              @if (!notification.read) {
              <button mat-icon-button (click)="markAsRead(notification.id); $event.stopPropagation()"
                matTooltip="Mark as read" class="action-icon-button">
                <mat-icon>check</mat-icon>
              </button>
              }
              <button mat-icon-button (click)="removeNotification(notification.id); $event.stopPropagation()"
                matTooltip="Remove" class="action-icon-button">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>
        </cdk-virtual-scroll-viewport>
        }
      </mat-tab>

      <!-- System Notifications Tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <span class="tab-label">
            <mat-icon>settings</mat-icon>
            System
          </span>
        </ng-template>

        @if (systemNotifications().length === 0) {
        <div class="empty-state">
          <mat-icon class="empty-icon">settings</mat-icon>
          <h2>No system notifications</h2>
          <p>Technical notifications and system messages will appear here.</p>
        </div>
        } @else {
        <cdk-virtual-scroll-viewport [itemSize]="100" class="notification-viewport">
          <div *cdkVirtualFor="let notification of systemNotifications(); trackBy: trackByNotificationId"
            class="notification-item" [class.unread]="!notification.read">
            <div class="notification-icon-wrapper">
              <mat-icon class="notification-bell">notifications</mat-icon>
            </div>

            <div class="notification-content">
              <div class="notification-header">
                <span class="notification-title">{{ notification.title }}</span>
                @if (!notification.read) {
                <span class="new-indicator">NEW</span>
                }
              </div>

              @if (notification.message) {
              <div class="notification-message">{{ notification.message }}</div>
              }

              <div class="notification-meta">
                <mat-icon class="time-icon">schedule</mat-icon>
                <span class="notification-time">{{ (notification.timestamp / 1000) | ago }}</span>
              </div>

              @if (isRelayPublishingNotification(notification)) {
              <div class="notification-extra">
                <app-relay-publish-status [notification]="notification" (retry)="onRetryPublish($event)">
                </app-relay-publish-status>
              </div>
              }
            </div>

            <div class="notification-actions">
              @if (!notification.read) {
              <button mat-icon-button (click)="markAsRead(notification.id)" matTooltip="Mark as read"
                class="action-icon-button">
                <mat-icon>check</mat-icon>
              </button>
              }
              <button mat-icon-button (click)="removeNotification(notification.id)" matTooltip="Remove"
                class="action-icon-button">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>
        </cdk-virtual-scroll-viewport>
        }
      </mat-tab>
    </mat-tab-group>
  </div>
</div>