<div class="notifications-page">
  <!-- Panel Header -->
  <div class="panel-header">
    <h2 class="panel-title title-font">Notifications</h2>
    @if (newNotificationCount() > 0) {
    <span class="notification-badge">{{ newNotificationCount() }}</span>
    }
    <span class="panel-header-spacer"></span>
    <button mat-icon-button (click)="toggleSearch()" matTooltip="Search notifications" class="hide-small">
      <mat-icon>search</mat-icon>
    </button>
    <!-- Filter button with overlay panel -->
    <button mat-icon-button cdkOverlayOrigin #filterOrigin="cdkOverlayOrigin" (click)="toggleFilterPanel()"
      [matTooltip]="'Filter'" [class.active-filters]="hasActiveFilters()">
      <mat-icon>tune</mat-icon>
    </button>
    @if (notifications().length > 0) {
    <button mat-icon-button (click)="markAllAsRead()" matTooltip="Mark all as read">
      <mat-icon>done_all</mat-icon>
    </button>
    }
    <button mat-icon-button [matMenuTriggerFor]="notificationsMenu" matTooltip="More options">
      <mat-icon>more_vert</mat-icon>
    </button>
    <mat-menu #notificationsMenu="matMenu">
      <!-- Search - shown only on small screens -->
      <button mat-menu-item (click)="toggleSearch()" class="show-small">
        <mat-icon>search</mat-icon>
        <span>Search</span>
      </button>
      <mat-divider class="show-small"></mat-divider>

      <button mat-menu-item (click)="refreshNotifications()" [disabled]="isRefreshing()">
        @if (isRefreshing()) {
        <mat-spinner diameter="18"></mat-spinner>
        } @else {
        <mat-icon>refresh</mat-icon>
        }
        <span>Refresh</span>
      </button>
      @if (notifications().length > 0) {
      <button mat-menu-item (click)="clearNotifications()">
        <mat-icon>close</mat-icon>
        <span>Clear All</span>
      </button>
      }
      <mat-divider></mat-divider>
      <button mat-menu-item routerLink="/notifications/settings">
        <mat-icon>settings</mat-icon>
        <span i18n="@@notifications.settings.label">Settings</span>
      </button>
    </mat-menu>
  </div>

  <!-- Filter Panel Overlay -->
  <ng-template cdkConnectedOverlay [cdkConnectedOverlayOrigin]="filterOrigin"
    [cdkConnectedOverlayOpen]="filterPanelOpen()" [cdkConnectedOverlayPositions]="filterPanelPositions"
    [cdkConnectedOverlayHasBackdrop]="true" cdkConnectedOverlayBackdropClass="filter-panel-backdrop"
    (backdropClick)="closeFilterPanel()">
    <app-notifications-filter-panel [filters]="notificationFilters()"
      [showSystemNotifications]="showSystemNotifications()" [showUnreadOnly]="showUnreadOnly()"
      (filtersChanged)="onFiltersChanged($event)"
      (showSystemNotificationsChanged)="onSystemNotificationsChanged($event)"
      (showUnreadOnlyChanged)="onUnreadOnlyChanged($event)">
    </app-notifications-filter-panel>
  </ng-template>

  <!-- Search Input (toggled by global search button) -->
  @if (showSearch()) {
  <div class="search-container">
    <mat-form-field appearance="outline" class="search-field">
      <mat-icon matPrefix>search</mat-icon>
      <input #searchInputElement matInput placeholder="Search by name or content..." [ngModel]="searchQuery()"
        (ngModelChange)="searchQuery.set($event)">
      <button matSuffix mat-icon-button (click)="toggleSearch()" matTooltip="Close search">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
  </div>
  }

  <!-- Notifications Content -->
  <div class="notifications-container">
    @if (showSystemNotifications()) {
    <!-- System Notifications View -->
    @if (systemNotifications().length === 0) {
    <div class="empty-state">
      <mat-icon class="empty-icon">settings</mat-icon>
      <h2>No system notifications</h2>
      <p>Technical notifications and system messages will appear here.</p>
    </div>
    } @else {
    <div class="notification-list">
      @for (notification of systemNotifications(); track trackByNotificationId($index, notification)) {
      <div class="notification-system-item" [class.unread]="!notification.read">
        <div class="notification-icon-wrapper">
          <mat-icon class="notification-bell">notifications</mat-icon>
        </div>

        <div class="notification-content">
          <div class="notification-header">
            <span class="notification-title">{{ getFormattedNotificationTitle(notification) }}</span>
            @if (!notification.read) {
            <span class="new-indicator">NEW</span>
            }
          </div>

          @if (notification.message) {
          <div class="notification-message">{{ notification.message | resolveNostr }}</div>
          }

          <div class="notification-meta">
            <mat-icon class="time-icon">schedule</mat-icon>
            <span class="notification-time">{{ (notification.timestamp / 1000) | ago }}</span>
          </div>

          @if (isRelayPublishingNotification(notification)) {
          <div class="notification-extra">
            <app-relay-publish-status [notification]="notification" (retry)="onRetryPublish($event)"
              (republish)="onRepublish($event)">
            </app-relay-publish-status>
          </div>
          }
        </div>

        <div class="notification-actions">
          @if (!notification.read) {
          <button mat-icon-button (click)="markAsRead(notification.id)" matTooltip="Mark as read"
            class="action-icon-button mark-read-btn">
            <mat-icon>check</mat-icon>
          </button>
          }
          <button mat-icon-button [matMenuTriggerFor]="systemNotificationMenu" matTooltip="More options"
            class="action-icon-button">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #systemNotificationMenu="matMenu">
            @if (!notification.read) {
            <button mat-menu-item class="menu-mark-read-btn" (click)="markAsRead(notification.id)">
              <mat-icon>check</mat-icon>
              <span>Mark as Read</span>
            </button>
            }
            <button mat-menu-item (click)="removeNotification(notification.id)">
              <mat-icon>close</mat-icon>
              <span>Remove</span>
            </button>
            <button mat-menu-item (click)="copyNotificationData(notification)">
              <mat-icon>content_copy</mat-icon>
              <span>Copy event data</span>
            </button>
          </mat-menu>
        </div>
      </div>
      }
    </div>
    }
    } @else {
    <!-- Activity Notifications View -->
    @if (contentNotifications().length === 0 && !searchQuery()) {
    <div class="empty-state">
      <mat-icon class="empty-icon">people</mat-icon>
      <h2>No activity yet</h2>
      <p>You'll see mentions, follows, reposts, and other interactions here.</p>
    </div>
    } @else if (contentNotifications().length === 0 && searchQuery()) {
    <div class="empty-state">
      <mat-icon class="empty-icon">search_off</mat-icon>
      <h2>No matching notifications</h2>
      <p>No notifications found matching "{{ searchQuery() }}"</p>
      <button mat-flat-button (click)="clearSearch()">
        <mat-icon>close</mat-icon>
        Clear search
      </button>
    </div>
    } @else {
    <cdk-virtual-scroll-viewport [itemSize]="102" [minBufferPx]="800" [maxBufferPx]="1400" class="notification-viewport"
      (scrolledIndexChange)="onScrolledIndexChange($event)">
      <div *cdkVirtualFor="let notification of contentNotifications(); trackBy: trackByNotificationId"
        class="notification-item" [class.read]="notification.read" [class.clickable]="getEventId(notification)"
        [attr.data-notification-type]="notification.type">
        <div class="notification-avatar-wrapper" (click)="viewAuthorProfile(notification); $event.stopPropagation()">
          @if (getAuthorPubkey(notification)) {
          <app-user-profile [pubkey]="getAuthorPubkey(notification)!" [view]="'small'" [disableLink]="true"
            [prefetchedProfile]="getPrefetchedProfile(notification)"></app-user-profile>
          } @else {
          <div class="notification-default-avatar">
            <mat-icon>account_circle</mat-icon>
          </div>
          }
          <div class="notification-type-badge" [attr.data-badge-type]="notification.type">
            <mat-icon>{{ getNotificationTypeIcon(notification.type) }}</mat-icon>
          </div>
        </div>

        <div class="notification-content" (click)="getEventId(notification) ? viewEvent(notification) : null"
          (keydown.enter)="getEventId(notification) ? viewEvent(notification) : null"
          [attr.tabindex]="getEventId(notification) ? 0 : null"
          [attr.role]="getEventId(notification) ? 'button' : null">
          <div class="notification-header">
            @if (getAuthorPubkey(notification)) {
            <span class="notification-author-name" (click)="viewAuthorProfile(notification); $event.stopPropagation()">
              {{ getNotificationAuthorDisplayName(notification) }}
            </span>
            }
            <span class="notification-title">
              @if (getCustomEmojiTitleSegments(notification); as customEmojiTitle) {
              <span>{{ customEmojiTitle.prefix }}</span>
              <img [src]="getCustomEmojiUrl(notification)!" alt="custom emoji" title="custom emoji"
                [attr.title]="getCustomEmojiAlt(notification)" class="notification-custom-emoji">
              @if (customEmojiTitle.suffix) {
              <span>{{ customEmojiTitle.suffix }}</span>
              }
              } @else {
              {{ getFormattedNotificationTitle(notification) }}
              }
            </span>
          </div>

          @if (notification.message && notification.type !== 'zap') {
          <div class="notification-message">{{ notification.message | resolveNostr }}</div>
          }

          @if (notification.message && notification.type === 'zap') {
          <div class="notification-message">
            {{ notification.message }}@if (getZapContent(notification)) {<span> Â· {{ getZapContent(notification)! |
              resolveNostr
              }}</span>}
          </div>
          } @else if (getZapContent(notification)) {
          <div class="notification-message">{{ getZapContent(notification)! | resolveNostr }}</div>
          }

          <div class="notification-meta">
            <mat-icon class="time-icon">schedule</mat-icon>
            <span class="notification-time">{{ (notification.timestamp / 1000) | ago }}</span>
          </div>
        </div>

        <div class="notification-actions">
          @if (!notification.read) {
          <button mat-icon-button (click)="markAsRead(notification.id); $event.stopPropagation()"
            matTooltip="Mark as read" class="action-icon-button mark-read-btn">
            <mat-icon>check</mat-icon>
          </button>
          }
          <button mat-icon-button [matMenuTriggerFor]="notificationMenu" (click)="$event.stopPropagation()"
            matTooltip="More options" class="action-icon-button">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #notificationMenu="matMenu">
            @if (!notification.read) {
            <button mat-menu-item class="menu-mark-read-btn" (click)="markAsRead(notification.id)">
              <mat-icon>check</mat-icon>
              <span>Mark as Read</span>
            </button>
            }
            <button mat-menu-item (click)="removeNotification(notification.id)">
              <mat-icon>close</mat-icon>
              <span>Remove</span>
            </button>
            <button mat-menu-item (click)="copyNotificationData(notification)">
              <mat-icon>content_copy</mat-icon>
              <span>Copy event data</span>
            </button>
          </mat-menu>
        </div>
      </div>

      <!-- Load More Indicator -->
      @if (isLoadingMore()) {
      <div class="load-more-indicator">
        <mat-spinner diameter="24"></mat-spinner>
        <span>Loading older notifications...</span>
      </div>
      } @else if (hasMoreNotifications() && contentNotifications().length >= 10) {
      <div class="load-more-indicator clickable" (click)="loadMoreNotifications()">
        <mat-icon>expand_more</mat-icon>
        <span>Load more notifications</span>
      </div>
      } @else if (!hasMoreNotifications()) {
      <div class="load-more-indicator end">
        <mat-icon>check_circle</mat-icon>
        <span>You've reached the end</span>
      </div>
      }
    </cdk-virtual-scroll-viewport>
    }
    }
  </div>
</div>