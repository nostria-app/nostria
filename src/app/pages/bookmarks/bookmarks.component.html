<div class="bookmarks-container">
  <div class="bookmarks-header">
    <h1>Bookmarks</h1>
    <div class="header-actions">
      <button mat-icon-button [matMenuTriggerFor]="viewMenu" matTooltip="Change View">
        <mat-icon>{{ getViewIcon() }}</mat-icon>
      </button>
      <mat-menu #viewMenu="matMenu">
        <button mat-menu-item (click)="setViewMode('content')">
          <mat-icon>view_agenda</mat-icon>
          <span>Content View</span>
        </button>
        <button mat-menu-item (click)="setViewMode('tiles')">
          <mat-icon>grid_view</mat-icon>
          <span>Tiles View</span>
        </button>
      </mat-menu>
      <button mat-icon-button [matMenuTriggerFor]="listMenu" matTooltip="Manage Lists">
        <mat-icon>more_vert</mat-icon>
      </button>
      <mat-menu #listMenu="matMenu">
        <button mat-menu-item (click)="createNewList()">
          <mat-icon>add</mat-icon>
          <span>Create New List</span>
        </button>
        @if (bookmarkService.selectedListId() !== 'default') {
        <button mat-menu-item (click)="renameCurrentList()">
          <mat-icon>edit</mat-icon>
          <span>Rename List</span>
        </button>
        <button mat-menu-item (click)="deleteCurrentList()">
          <mat-icon>delete</mat-icon>
          <span>Delete List</span>
        </button>
        }
      </mat-menu>
      <button mat-flat-button (click)="addBookmark()" [disabled]="loading()">
        <mat-icon>add</mat-icon>
        Add Bookmark
      </button>
    </div>
  </div>

  @if (loading()) {
  <div class="loading-container">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Loading bookmarks...</p>
  </div>
  } @else {
  <div class="filters-container">
    <!-- Bookmark List Selector -->
    <div class="list-selector">
      <mat-form-field appearance="outline" class="list-select-field">
        <mat-label>Bookmark List</mat-label>
        <mat-select [value]="bookmarkService.selectedListId()" (valueChange)="onListChange($event)">
          <mat-select-trigger>
            @for (list of bookmarkService.allBookmarkLists(); track list.id) {
              @if (list.id === bookmarkService.selectedListId()) {
                <div class="list-option-content">
                  <mat-icon class="list-icon">{{ list.isDefault ? 'bookmark' : 'label' }}</mat-icon>
                  <span class="list-name">{{ list.name }}</span>
                  @if (list.isPrivate) {
                  <mat-icon class="private-icon" matTooltip="Private (Encrypted)">lock</mat-icon>
                  }
                </div>
              }
            }
          </mat-select-trigger>
          @for (list of bookmarkService.allBookmarkLists(); track list.id) {
          <mat-option [value]="list.id">
            <div class="list-option-content">
              <mat-icon class="list-icon">{{ list.isDefault ? 'bookmark' : 'label' }}</mat-icon>
              <span class="list-name">{{ list.name }}</span>
              @if (list.isPrivate) {
              <mat-icon class="private-icon" matTooltip="Private (Encrypted)">lock</mat-icon>
              }
            </div>
          </mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>

    <div class="categories-container">
      <div class="categories-list">
        @for (category of categories(); track category.id) {
        <div class="category-chip" [class.selected]="selectedCategory() === category.id" [style.background-color]="
                selectedCategory() === category.id ? category.color : 'transparent'
              " [style.color]="selectedCategory() === category.id ? '#fff' : category.color"
          [style.border-color]="category.color" (click)="selectCategory(category.id)">
          {{ category.name }}
        </div>
        }
      </div>
    </div>
  </div>

  <div class="bookmarks-list" [attr.data-view]="viewMode()">
    @if (selectedCategory() === 'events') {
    @for (bookmark of bookmarkService.bookmarkEvents(); track bookmark.id) {
    <app-event [id]="bookmark.id" [compact]="viewMode() === 'tiles'"></app-event>
    }
    } @else if (selectedCategory() === 'articles') {
    @for (bookmark of bookmarkService.bookmarkArticles(); track bookmark.id) {
    @let bm = bookmarkService.parseArticleId(bookmark.id);
    <div class="bookmark-article-wrapper">
      <app-article [pubkey]="bm.id" [kind]="bm.kind" [slug]="bm.slug" mode="card" [showAuthor]="true"
        [showMetadata]="true" [showActions]="false" [clickable]="true"></app-article>
      <button mat-icon-button class="remove-bookmark-btn" (click)="removeArticleBookmark(bookmark.id, $event)"
        matTooltip="Remove from this list">
        <mat-icon>delete</mat-icon>
      </button>
    </div>
    }
    } @else if (selectedCategory() === 'websites') {
    @for (bookmark of bookmarkService.bookmarkUrls(); track bookmark.id) {
    @if (viewMode() === 'content') {
    <div class="bookmark-url-card">
      <mat-icon>link</mat-icon>
      <a [href]="bookmark.id" target="_blank" rel="noopener noreferrer">{{ bookmark.id }}</a>
      <button mat-icon-button
        (click)="deleteBookmark({id: bookmark.id, title: 'Website', url: bookmark.id, categories: ['websites'], type: 'r', createdAt: bookmark.timestamp, updatedAt: bookmark.timestamp}, $event)"
        matTooltip="Remove">
        <mat-icon>delete</mat-icon>
      </button>
    </div>
    } @else if (viewMode() === 'tiles') {
    <div class="bookmark-tile">
      <div class="tile-header">
        <mat-icon>link</mat-icon>
        <span class="tile-type">Website</span>
      </div>
      <div class="tile-content">
        <a [href]="bookmark.id" target="_blank" rel="noopener noreferrer">
          <h3>{{ bookmark.id.length > 30 ? bookmark.id.substring(0, 30) + '...' : bookmark.id }}</h3>
        </a>
      </div>
      <div class="tile-actions">
        <button mat-icon-button
          (click)="deleteBookmark({id: bookmark.id, title: 'Website', url: bookmark.id, categories: ['websites'], type: 'r', createdAt: bookmark.timestamp, updatedAt: bookmark.timestamp}, $event)"
          matTooltip="Remove">
          <mat-icon>delete</mat-icon>
        </button>
      </div>
    </div>
    } @else {
    <div class="bookmark-detail">
      <mat-icon class="detail-icon">link</mat-icon>
      <div class="detail-content">
        <a [href]="bookmark.id" target="_blank" rel="noopener noreferrer">
          <h3>{{ bookmark.id }}</h3>
        </a>
        <p class="detail-meta">Website â€¢ Added {{ getFormattedDate(bookmark.timestamp) }}</p>
      </div>
      <button mat-icon-button
        (click)="deleteBookmark({id: bookmark.id, title: 'Website', url: bookmark.id, categories: ['websites'], type: 'r', createdAt: bookmark.timestamp, updatedAt: bookmark.timestamp}, $event)"
        matTooltip="Remove">
        <mat-icon>delete</mat-icon>
      </button>
    </div>
    }
    }
    }
  </div>
  }
</div>