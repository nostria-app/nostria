<!-- Panel Header -->
<div class="panel-header">
  <h2 class="panel-title title-font">Bookmarks</h2>

  <!-- Bookmark List Selector -->
  <mat-form-field appearance="outline" class="toolbar-list-select">
    <mat-select [value]="bookmarkService.selectedListId()" (valueChange)="onListChange($event)">
      <mat-select-trigger>
        @for (list of bookmarkService.allBookmarkLists(); track list.id) {
        @if (list.id === bookmarkService.selectedListId()) {
        <div class="list-option-content">
          <mat-icon class="list-icon">{{ list.isDefault ? 'bookmark' : 'label' }}</mat-icon>
          <span class="list-name">{{ list.name }}</span>
          @if (list.isPrivate) {
          <mat-icon class="private-icon" matTooltip="Private (Encrypted)">lock</mat-icon>
          }
        </div>
        }
        }
      </mat-select-trigger>
      @for (list of bookmarkService.allBookmarkLists(); track list.id) {
      <mat-option [value]="list.id">
        <div class="list-option-content">
          <mat-icon class="list-icon">{{ list.isDefault ? 'bookmark' : 'label' }}</mat-icon>
          <span class="list-name">{{ list.name }}</span>
          @if (list.isPrivate) {
          <mat-icon class="private-icon" matTooltip="Private (Encrypted)">lock</mat-icon>
          }
        </div>
      </mat-option>
      }
    </mat-select>
  </mat-form-field>

  <span class="panel-header-spacer"></span>

  <!-- Add menu button - hidden on small screens -->
  <button mat-icon-button [matMenuTriggerFor]="addMenu" [disabled]="loading()" matTooltip="Add New" class="hide-small">
    <mat-icon>add</mat-icon>
  </button>
  <mat-menu #addMenu="matMenu">
    <button mat-menu-item (click)="addBookmark()">
      <mat-icon>bookmark_add</mat-icon>
      <span>Add Bookmark</span>
    </button>
    <button mat-menu-item (click)="createNewList()">
      <mat-icon>playlist_add</mat-icon>
      <span>Create List</span>
    </button>
  </mat-menu>

  <!-- View mode toggle button - hidden on small screens -->
  <button mat-icon-button (click)="toggleViewMode()" [matTooltip]="viewMode() === 'content' ? 'Switch to Tiles View' : 'Switch to Content View'" class="hide-small">
    <mat-icon>{{ getViewIcon() }}</mat-icon>
  </button>

  <!-- Manage lists menu -->
  <button mat-icon-button [matMenuTriggerFor]="listMenu" matTooltip="Manage Lists">
    <mat-icon>more_vert</mat-icon>
  </button>
  <mat-menu #listMenu="matMenu">
    <!-- Add options - shown only on small screens -->
    <button mat-menu-item (click)="addBookmark()" class="show-small">
      <mat-icon>bookmark_add</mat-icon>
      <span>Add Bookmark</span>
    </button>
    <button mat-menu-item (click)="createNewList()" class="show-small">
      <mat-icon>playlist_add</mat-icon>
      <span>Create List</span>
    </button>
    <mat-divider class="show-small"></mat-divider>

    <!-- View mode options - shown only on small screens -->
    <button mat-menu-item (click)="setViewMode('content')" class="show-small" [class.active]="viewMode() === 'content'">
      <mat-icon>view_stream</mat-icon>
      <span>Content View</span>
    </button>
    <button mat-menu-item (click)="setViewMode('tiles')" class="show-small" [class.active]="viewMode() === 'tiles'">
      <mat-icon>grid_view</mat-icon>
      <span>Tiles View</span>
    </button>
    <mat-divider class="show-small"></mat-divider>

    @if (bookmarkService.selectedListId() !== 'default') {
    <button mat-menu-item (click)="renameCurrentList()">
      <mat-icon>edit</mat-icon>
      <span>Rename List</span>
    </button>
    }
    <button mat-menu-item (click)="toggleListPrivacy()">
      <mat-icon>{{ currentList()?.isPrivate ? 'lock_open' : 'lock' }}</mat-icon>
      <span>{{ currentList()?.isPrivate ? 'Make Public' : 'Make Private' }}</span>
    </button>
    <button mat-menu-item (click)="deleteCurrentList()">
      <mat-icon>delete</mat-icon>
      <span>Delete List</span>
    </button>
  </mat-menu>
</div>

<div class="bookmarks-container">
  @if (loading()) {
  <div class="loading-container">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Loading bookmarks...</p>
  </div>
  } @else {
  <div class="filters-container">
    <div class="categories-container">
      <div class="categories-list">
        @for (category of categories(); track category.id) {
        <div class="category-chip" [class.selected]="selectedCategory() === category.id" [style.background-color]="
                selectedCategory() === category.id ? category.color : 'transparent'
              " [style.color]="selectedCategory() === category.id ? '#fff' : category.color"
          [style.border-color]="category.color" (click)="selectCategory(category.id)">
          {{ category.name }}
        </div>
        }
      </div>
    </div>
  </div>

  <div class="bookmarks-list" [attr.data-view]="viewMode()" (scroll)="onScroll($event)">
    @if (selectedCategory() === 'events') {
    @for (bookmark of displayedEvents(); track bookmark.id) {
    <app-event [id]="bookmark.id" [compact]="viewMode() === 'tiles'"></app-event>
    }
    } @else if (selectedCategory() === 'articles') {
    @for (bookmark of displayedArticles(); track bookmark.id) {
    @let bm = bookmarkService.parseArticleId(bookmark.id);
    <div class="bookmark-article-wrapper">
      <app-article [pubkey]="bm.id" [kind]="bm.kind" [slug]="bm.slug" mode="card" [showAuthor]="true"
        [showMetadata]="true" [showActions]="false" [clickable]="true"></app-article>
      <button mat-icon-button class="remove-bookmark-btn" (click)="removeArticleBookmark(bookmark.id, $event)"
        matTooltip="Remove from this list">
        <mat-icon>delete</mat-icon>
      </button>
    </div>
    }
    } @else if (selectedCategory() === 'websites') {
    @for (bookmark of displayedUrls(); track bookmark.id) {
    @if (viewMode() === 'content') {
    <div class="bookmark-url-preview">
      <app-social-preview [url]="bookmark.id"></app-social-preview>
      <button mat-icon-button class="remove-bookmark-btn"
        (click)="deleteBookmark({id: bookmark.id, title: 'Website', url: bookmark.id, categories: ['websites'], type: 'r', createdAt: bookmark.timestamp, updatedAt: bookmark.timestamp}, $event)"
        matTooltip="Remove from this list">
        <mat-icon>delete</mat-icon>
      </button>
    </div>
    } @else if (viewMode() === 'tiles') {
    <div class="bookmark-url-preview">
      <app-social-preview [url]="bookmark.id"></app-social-preview>
      <button mat-icon-button class="remove-bookmark-btn"
        (click)="deleteBookmark({id: bookmark.id, title: 'Website', url: bookmark.id, categories: ['websites'], type: 'r', createdAt: bookmark.timestamp, updatedAt: bookmark.timestamp}, $event)"
        matTooltip="Remove from this list">
        <mat-icon>delete</mat-icon>
      </button>
    </div>
    } @else {
    <div class="bookmark-detail">
      <mat-icon class="detail-icon">link</mat-icon>
      <div class="detail-content">
        <a [href]="bookmark.id" target="_blank" rel="noopener noreferrer">
          <h3>{{ bookmark.id }}</h3>
        </a>
        <p class="detail-meta">Website â€¢ Added {{ getFormattedDate(bookmark.timestamp) }}</p>
      </div>
      <button mat-icon-button
        (click)="deleteBookmark({id: bookmark.id, title: 'Website', url: bookmark.id, categories: ['websites'], type: 'r', createdAt: bookmark.timestamp, updatedAt: bookmark.timestamp}, $event)"
        matTooltip="Remove">
        <mat-icon>delete</mat-icon>
      </button>
    </div>
    }
    }
    }

    <!-- Load more indicator -->
    @if (hasMoreToLoad()) {
    <div class="load-more-indicator">
      <p>Scroll for more...</p>
    </div>
    }
  </div>
  }
</div>