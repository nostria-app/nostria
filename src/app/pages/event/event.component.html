@if (isLoading() && !event()) {
<div class="thread-loading">
  <mat-spinner diameter="32"></mat-spinner>
  <p class="loading-text">Loading thread...</p>
</div>
} @else {
<!-- Loading indicator for parent events when they're still loading -->
@if (isLoadingParents()) {
<div class="parent-events">
  <div class="section-loading">
    <mat-spinner diameter="16"></mat-spinner>
    <p class="loading-text">Loading thread context...</p>
  </div>
</div>
}

<!-- Display parent events in thread (if any) -->
@if (parentEvents().length > 0) {
<div class="parent-events">
  <!-- <h3>Thread Context</h3> -->
  @for (parentEvent of parentEvents(); track parentEvent.id) {
  <div class="parent-event">
    <app-event [event]="parentEvent" appearance="plain" mode="thread"></app-event>
  </div>
  }
  <!-- <div class="thread-indicator">
        <hr />
        <span>Reply below</span>
        <hr />
      </div> -->
</div>
}

<!-- Main event -->
@if (event()) {
<div id="main-event">
  <app-event [event]="event()" appearance="plain" [navigationDisabled]="true" mode="thread"></app-event>
</div>
}

<!-- Loading status indicator - shows what's still loading -->
@if (isLoadingParents() || isLoadingReplies()) {
<div class="loading-status">
  @if (isLoadingParents()) {
  <div class="status-item">
    <mat-spinner diameter="14"></mat-spinner>
    <span>Loading thread...</span>
  </div>
  }
  @if (isLoadingReplies()) {
  <div class="status-item">
    <mat-spinner diameter="14"></mat-spinner>
    <span>Loading replies...</span>
  </div>
  }
</div>
}

<!-- <div class="reactions">
    @for (reaction of reactions(); track reaction.emoji) {
      <div class="reaction">
        <span class="emoji">{{ reaction.emoji }}</span>
        <span class="count">{{ reaction.count }}</span>
      </div>
    }
  </div> -->

@if (error()) {
<div class="error-container">
  <mat-icon class="error-icon">error_outline</mat-icon>
  <h3 class="error-title">{{ error() }}</h3>

  @if (error() === 'Event not found') {
  <div class="deep-resolution-section">
    <p class="deep-resolution-description">
      Deep Resolution attempts to find this event by querying multiple relays and checking for reposts or quotes that
      might contain the original content.
    </p>
    <div class="deep-resolution-actions">
      <button mat-flat-button color="primary" (click)="startDeepResolution()" [disabled]="isLoading()">
        <mat-icon>search</mat-icon>
        Try Deep Resolution
      </button>
    </div>
  </div>
  }
</div>
}

@if (deepResolutionProgress()) {
<div class="deep-resolution-progress">
  <mat-spinner diameter="20"></mat-spinner>
  <span>{{ deepResolutionProgress() }}</span>
</div>
}

<div class="replies-section">
  @if (threadedReplies().length === 0 && isLoadingReplies()) {
  <div class="replies-loading">
    <mat-spinner diameter="20"></mat-spinner>
    <p class="loading-text">Loading replies...</p>
  </div>
  } @else {
  @for (threadedEvent of threadedReplies(); track threadedEvent.event.id) {
  <ng-container [ngTemplateOutlet]="replyTemplate"
    [ngTemplateOutletContext]="{ threadedEvent: threadedEvent }"></ng-container>
  }
  }
</div>
}

<ng-template #replyTemplate let-threadedEvent="threadedEvent">
  <div class="threaded-reply"
    [class.has-replies]="threadedEvent.replies.length > 0"
    [class.lines-hidden]="!localSettings.showThreadLines()">
    <div class="thread-line-clickable" 
      [class.no-replies]="threadedEvent.replies.length === 0"
      [class.collapsed]="isThreadCollapsed(threadedEvent.event.id)"
      [class.interactive]="threadedEvent.replies.length > 0"
      (click)="threadedEvent.replies.length > 0 ? toggleThreadCollapse(threadedEvent.event.id) : null"
      (keydown.enter)="threadedEvent.replies.length > 0 ? toggleThreadCollapse(threadedEvent.event.id) : null"
      (keydown.space)="threadedEvent.replies.length > 0 ? toggleThreadCollapse(threadedEvent.event.id) : null"
      [attr.role]="threadedEvent.replies.length > 0 ? 'button' : null"
      [attr.tabindex]="threadedEvent.replies.length > 0 ? 0 : null"
      [attr.title]="threadedEvent.replies.length > 0 ? 'Click to collapse or expand replies' : null"
      [attr.aria-label]="threadedEvent.replies.length > 0 ? 'Toggle replies visibility' : null">
    </div>
    <div class="thread-content">
      <app-event [event]="threadedEvent.event" mode="thread"></app-event>

      @if (isThreadCollapsed(threadedEvent.event.id) && threadedEvent.replies.length > 0) {
      <button class="expand-collapsed-btn" mat-button (click)="toggleThreadCollapse(threadedEvent.event.id)">
        <mat-icon>unfold_more</mat-icon>
        <span>Show {{ countReplies(threadedEvent) }} {{ countReplies(threadedEvent) === 1 ? 'reply' : 'replies'
          }}</span>
      </button>
      } @else {
      @for (childReply of threadedEvent.replies; track childReply.event.id) {
      <ng-container [ngTemplateOutlet]="replyTemplate"
        [ngTemplateOutletContext]="{ threadedEvent: childReply }"></ng-container>
      }
      }
    </div>
  </div>
</ng-template>