<div class="media-container">
  <div class="media-header">
    <h1>Media Library</h1>
    <div class="media-actions">
      <button mat-raised-button color="primary" (click)="openUploadDialog()">
        <mat-icon>upload</mat-icon>
        Upload Media
      </button>
      <button mat-icon-button (click)="refreshMedia()" [disabled]="mediaService.loading()">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>
  </div>

  @if (mediaService.loading()) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <span>Loading media...</span>
    </div>
  }

  @if (mediaService.error()) {
    <div class="error-container">
      <mat-icon color="warn">error</mat-icon>
      <p>{{ mediaService.error() }}</p>
      <button mat-button color="primary" (click)="refreshMedia()">Try Again</button>
    </div>
  }

  <mat-tab-group (selectedIndexChange)="setActiveTab($event === 0 ? 'images' : ($event === 1 ? 'videos' : 'servers'))">
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">image</mat-icon>
        <span>Images ({{ images().length }})</span>
      </ng-template>
      <div class="tab-content">
        @if (selectedItems().length > 0) {
          <div class="selection-actions">
            <span>{{ selectedItems().length }} item(s) selected</span>
            <button mat-button color="primary" (click)="clearSelection()">Clear Selection</button>
            <button mat-button color="warn" (click)="deleteSelected()">Delete Selected</button>
          </div>
        } @else {
          <div class="selection-actions">
            <button mat-button color="primary" (click)="selectAll()" [disabled]="images().length === 0">Select All</button>
          </div>
        }

        @if (images().length === 0) {
          <div class="empty-state">
            <mat-icon>image</mat-icon>
            <p>No images found in your library</p>
            <button mat-raised-button color="primary" (click)="openUploadDialog()">Upload Now</button>
          </div>
        } @else {
          <div class="media-grid">
            @for (item of images(); track item.id) {
              <div class="media-card" [class.selected]="isSelected(item.id)" (click)="toggleItemSelection(item.id)">
                <div class="media-thumbnail">
                  <img [src]="item.thumbnailUrl || item.url" [alt]="item.title || 'Image'">
                  <div class="selection-indicator">
                    <mat-icon>check_circle</mat-icon>
                  </div>
                </div>
                <div class="media-info">
                  <h3>{{ item.title || 'Untitled' }}</h3>
                  <p>{{ formatFileSize(item.size) }}</p>
                </div>
                <div class="media-actions">
                  <button mat-icon-button [matMenuTriggerFor]="menu" (click)="$event.stopPropagation()">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #menu="matMenu">
                    <button mat-menu-item (click)="openDetailsDialog(item); $event.stopPropagation()">
                      <mat-icon>info</mat-icon>
                      <span>View Details</span>
                    </button>
                    <button mat-menu-item (click)="mirrorItem(item.id); $event.stopPropagation()">
                      <mat-icon>cloud_upload</mat-icon>
                      <span>Mirror</span>
                    </button>
                    <button mat-menu-item color="warn" (click)="reportItem(item.id); $event.stopPropagation()">
                      <mat-icon>flag</mat-icon>
                      <span>Report</span>
                    </button>
                  </mat-menu>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </mat-tab>
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">videocam</mat-icon>
        <span>Videos ({{ videos().length }})</span>
      </ng-template>
      <div class="tab-content">
        @if (selectedItems().length > 0) {
          <div class="selection-actions">
            <span>{{ selectedItems().length }} item(s) selected</span>
            <button mat-button color="primary" (click)="clearSelection()">Clear Selection</button>
            <button mat-button color="warn" (click)="deleteSelected()">Delete Selected</button>
          </div>
        } @else {
          <div class="selection-actions">
            <button mat-button color="primary" (click)="selectAll()" [disabled]="videos().length === 0">Select All</button>
          </div>
        }

        @if (videos().length === 0) {
          <div class="empty-state">
            <mat-icon>videocam</mat-icon>
            <p>No videos found in your library</p>
            <button mat-raised-button color="primary" (click)="openUploadDialog()">Upload Now</button>
          </div>
        } @else {
          <div class="media-grid">
            @for (item of videos(); track item.id) {
              <div class="media-card" [class.selected]="isSelected(item.id)" (click)="toggleItemSelection(item.id)">
                <div class="media-thumbnail">
                  <img [src]="item.thumbnailUrl || 'assets/video-placeholder.jpg'" [alt]="item.title || 'Video'">
                  <mat-icon class="video-badge">play_circle_filled</mat-icon>
                  <div class="selection-indicator">
                    <mat-icon>check_circle</mat-icon>
                  </div>
                </div>
                <div class="media-info">
                  <h3>{{ item.title || 'Untitled' }}</h3>
                  <p>{{ formatFileSize(item.size) }}</p>
                  @if (item.duration) {
                    <p class="duration">{{ formatDuration(item.duration) }}</p>
                  }
                </div>
                <div class="media-actions">
                  <button mat-icon-button [matMenuTriggerFor]="menu" (click)="$event.stopPropagation()">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #menu="matMenu">
                    <button mat-menu-item (click)="openDetailsDialog(item); $event.stopPropagation()">
                      <mat-icon>info</mat-icon>
                      <span>View Details</span>
                    </button>
                    <button mat-menu-item (click)="mirrorItem(item.id); $event.stopPropagation()">
                      <mat-icon>cloud_upload</mat-icon>
                      <span>Mirror</span>
                    </button>
                    <button mat-menu-item color="warn" (click)="reportItem(item.id); $event.stopPropagation()">
                      <mat-icon>flag</mat-icon>
                      <span>Report</span>
                    </button>
                  </mat-menu>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </mat-tab>
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">folder</mat-icon>
        <span>Files ({{ images().length }})</span>
      </ng-template>
      <div class="tab-content">
        @if (selectedItems().length > 0) {
          <div class="selection-actions">
            <span>{{ selectedItems().length }} item(s) selected</span>
            <button mat-button color="primary" (click)="clearSelection()">Clear Selection</button>
            <button mat-button color="warn" (click)="deleteSelected()">Delete Selected</button>
          </div>
        } @else {
          <div class="selection-actions">
            <button mat-button color="primary" (click)="selectAll()" [disabled]="images().length === 0">Select All</button>
          </div>
        }

        @if (images().length === 0) {
          <div class="empty-state">
            <mat-icon>insert_drive_file</mat-icon>
            <p>No files found in your library</p>
            <button mat-raised-button color="primary" (click)="openUploadDialog()">Upload Now</button>
          </div>
        } @else {
          <div class="media-grid">
            @for (item of images(); track item.id) {
              <div class="media-card" [class.selected]="isSelected(item.id)" (click)="toggleItemSelection(item.id)">
                <div class="media-thumbnail">
                  <img [src]="item.thumbnailUrl || item.url" [alt]="item.title || 'Image'">
                  <div class="selection-indicator">
                    <mat-icon>check_circle</mat-icon>
                  </div>
                </div>
                <div class="media-info">
                  <h3>{{ item.title || 'Untitled' }}</h3>
                  <p>{{ formatFileSize(item.size) }}</p>
                </div>
                <div class="media-actions">
                  <button mat-icon-button [matMenuTriggerFor]="menu" (click)="$event.stopPropagation()">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #menu="matMenu">
                    <button mat-menu-item (click)="openDetailsDialog(item); $event.stopPropagation()">
                      <mat-icon>info</mat-icon>
                      <span>View Details</span>
                    </button>
                    <button mat-menu-item (click)="mirrorItem(item.id); $event.stopPropagation()">
                      <mat-icon>cloud_upload</mat-icon>
                      <span>Mirror</span>
                    </button>
                    <button mat-menu-item color="warn" (click)="reportItem(item.id); $event.stopPropagation()">
                      <mat-icon>flag</mat-icon>
                      <span>Report</span>
                    </button>
                  </mat-menu>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </mat-tab>
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">storage</mat-icon>
        <span>Media Servers</span>
      </ng-template>
      <div class="tab-content">
        <div class="server-header">
          <h2>Your Nostr Media Servers</h2>
          <button mat-raised-button color="primary" (click)="openServerDialog()">
            <mat-icon>add</mat-icon>
            Add Server
          </button>
        </div>
        
        <div class="server-description">
          <p>Media servers are endpoints that can host your content following the Nostr BUD (Blossom - Blobs stored simply on mediaservers) protocol.</p>
        </div>
        
        @if (mediaService.mediaServers().length === 0) {
          <div class="empty-state">
            <mat-icon>cloud_off</mat-icon>
            <p>No media servers configured</p>
            <p class="subtitle">Add servers to store and distribute your media</p>
            <button mat-raised-button color="primary" (click)="openServerDialog()">Add Your First Server</button>
          </div>
        } @else {
          <div class="server-list">
            @for (server of mediaService.mediaServers(); track server) {
              <mat-card class="server-card">
                <mat-card-header>
                  <mat-icon mat-card-avatar>storage</mat-icon>
                  <mat-card-title>{{ server || server }}</mat-card-title>
                  <mat-card-subtitle>{{ server }}</mat-card-subtitle>
                  
                  <div class="server-status">
                    <!-- @if (server.status === 'active') { -->
                      <span class="status-badge active">Active</span>
                    <!-- } @else if (server.status === 'error') { -->
                      <!-- <span class="status-badge error">Error</span> -->
                    <!-- } @else { -->
                      <!-- <span class="status-badge unknown">Unknown</span> -->
                    <!-- } -->
                  </div>
                </mat-card-header>
                
                <mat-card-content>
                  <!-- @if (server.description) {
                    <p>{{ server.description }}</p>
                  } -->
                  
                  <!-- @if (server.error) {
                    <div class="server-error">
                      <mat-icon color="warn">error</mat-icon>
                      <span>{{ server.error }}</span>
                    </div>
                  } -->
                  
                  <!-- @if (server.capabilities && server.capabilities.length > 0) {
                    <div class="server-capabilities">
                      <h4>Capabilities:</h4>
                      <div class="capability-tags">
                        @for (capability of server.capabilities; track capability) {
                          <span class="capability-tag">{{ capability }}</span>
                        }
                      </div>
                    </div>
                  } -->
                </mat-card-content>
                
                <mat-card-actions>
                  <button mat-button color="primary" (click)="testServer(server)">
                    <mat-icon>sync</mat-icon> Test Connection
                  </button>
                  <button mat-button color="primary" (click)="editServer(server)">
                    <mat-icon>edit</mat-icon> Edit
                  </button>
                  <button mat-button color="warn" (click)="removeServer(server)">
                    <mat-icon>delete</mat-icon> Remove
                  </button>
                </mat-card-actions>
              </mat-card>
            }
          </div>
        }
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
