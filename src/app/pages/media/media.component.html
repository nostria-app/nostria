<div class="media-container">
  @if (mediaService.error()) {
  <div class="error-container">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ mediaService.error() }}</p>
    <div class="error-actions">
      <button mat-button (click)="refreshMedia()">Try Again</button>
      <button mat-button (click)="dismissError()">Dismiss</button>
    </div>
  </div>
  }

  <!-- Toolbar -->
  <div class="media-toolbar" [class.selection-active]="selectionMode()">
    @if (selectionMode()) {
    <!-- Selection mode toolbar -->
    <div class="selection-info">
      <button mat-icon-button (click)="clearSelection()">
        <mat-icon>close</mat-icon>
      </button>
      <span class="selection-count">{{ selectedItems().length }} selected</span>
    </div>
    <div class="selection-actions">
      <button mat-button (click)="publishSelected()" [disabled]="selectedItems().length === 0">
        <mat-icon>send</mat-icon>
        <span class="hide-small">Publish</span>
      </button>
      <button mat-button (click)="downloadSelected()" [disabled]="selectedItems().length === 0">
        <mat-icon>download</mat-icon>
        <span class="hide-small">Download</span>
      </button>
      <button mat-button (click)="mirrorSelected()" [disabled]="selectedItems().length === 0">
        <mat-icon>cloud_upload</mat-icon>
        <span class="hide-small">Mirror</span>
      </button>
      <button mat-button (click)="deleteSelected()" [disabled]="selectedItems().length === 0">
        <mat-icon color="warn">delete</mat-icon>
        <span class="hide-small delete-text">Delete</span>
      </button>
    </div>
    } @else {
    <!-- Normal toolbar -->
    <div class="toolbar-left">
      <!-- Filter button -->
      <button mat-button [matMenuTriggerFor]="filterMenu" class="filter-button">
        <mat-icon>{{ getFilterIcon() }}</mat-icon>
        <span>{{ getFilterLabel() }}</span>
        <mat-icon>arrow_drop_down</mat-icon>
      </button>
      <mat-menu #filterMenu="matMenu">
        <button mat-menu-item (click)="setMediaFilter('all')" [class.selected-option]="mediaFilter() === 'all'">
          <mat-icon>filter_list</mat-icon>
          <span>All Files</span>
        </button>
        <button mat-menu-item (click)="setMediaFilter('images')" [class.selected-option]="mediaFilter() === 'images'">
          <mat-icon>image</mat-icon>
          <span>Images</span>
        </button>
        <button mat-menu-item (click)="setMediaFilter('videos')" [class.selected-option]="mediaFilter() === 'videos'">
          <mat-icon>videocam</mat-icon>
          <span>Videos</span>
        </button>
        <button mat-menu-item (click)="setMediaFilter('audio')" [class.selected-option]="mediaFilter() === 'audio'">
          <mat-icon>audiotrack</mat-icon>
          <span>Audio</span>
        </button>
        <button mat-menu-item (click)="setMediaFilter('files')" [class.selected-option]="mediaFilter() === 'files'">
          <mat-icon>insert_drive_file</mat-icon>
          <span>Other Files</span>
        </button>
      </mat-menu>

      <!-- Sort button -->
      <button mat-button [matMenuTriggerFor]="sortMenu" class="sort-button">
        <mat-icon>sort</mat-icon>
        <span class="hide-small">{{ getSortLabel() }}</span>
      </button>
      <mat-menu #sortMenu="matMenu">
        <button mat-menu-item (click)="setSortOption('newest')" [class.selected-option]="sortOption() === 'newest'">
          <mat-icon>arrow_downward</mat-icon>
          <span>Newest First</span>
        </button>
        <button mat-menu-item (click)="setSortOption('oldest')" [class.selected-option]="sortOption() === 'oldest'">
          <mat-icon>arrow_upward</mat-icon>
          <span>Oldest First</span>
        </button>
        <button mat-menu-item (click)="setSortOption('name-asc')" [class.selected-option]="sortOption() === 'name-asc'">
          <mat-icon>sort_by_alpha</mat-icon>
          <span>Name (A-Z)</span>
        </button>
        <button mat-menu-item (click)="setSortOption('name-desc')" [class.selected-option]="sortOption() === 'name-desc'">
          <mat-icon>sort_by_alpha</mat-icon>
          <span>Name (Z-A)</span>
        </button>
        <button mat-menu-item (click)="setSortOption('size-desc')" [class.selected-option]="sortOption() === 'size-desc'">
          <mat-icon>expand_more</mat-icon>
          <span>Size (Large-Small)</span>
        </button>
        <button mat-menu-item (click)="setSortOption('size-asc')" [class.selected-option]="sortOption() === 'size-asc'">
          <mat-icon>expand_less</mat-icon>
          <span>Size (Small-Large)</span>
        </button>
      </mat-menu>

      <span class="item-count">{{ filteredMedia().length }} items</span>
      
      <div class="storage-info">
        <mat-icon>storage</mat-icon>
        <span>{{ formatFileSize(totalStorageBytes()) }}</span>
      </div>
    </div>

    <div class="toolbar-right">
      <!-- Upload button -->
      @if (mediaService.uploading()) {
      <div class="spinner-wrapper uploading">
        <mat-spinner diameter="20"></mat-spinner>
        <span class="hide-small">Uploading...</span>
      </div>
      } @else {
      <button mat-flat-button (click)="openUploadDialog()" class="upload-button">
        <mat-icon>upload</mat-icon>
        <span class="hide-small">Upload</span>
      </button>
      }

      <!-- Select all button -->
      <button mat-icon-button (click)="selectAll()" [disabled]="filteredMedia().length === 0" matTooltip="Select All">
        <mat-icon>checklist</mat-icon>
      </button>

      <!-- View mode button (toggle) -->
      <button mat-icon-button (click)="cycleViewMode()" [matTooltip]="'View: ' + getViewModeLabel()">
        <mat-icon>{{ getViewModeIcon() }}</mat-icon>
      </button>

      <!-- Refresh button -->
      @if (mediaService.loading()) {
      <div class="spinner-wrapper loading">
        <mat-spinner diameter="20"></mat-spinner>
      </div>
      } @else {
      <button mat-icon-button (click)="refreshMedia()" matTooltip="Refresh">
        <mat-icon>refresh</mat-icon>
      </button>
      }

      <!-- Settings button -->
      <button mat-icon-button (click)="openServersDialog()" matTooltip="Media Servers">
        <mat-icon>settings</mat-icon>
      </button>
    </div>
    }
  </div>

  <!-- Content area -->
  <div class="media-content">
    @if (filteredMedia().length === 0 && !mediaService.loading()) {
    <div class="empty-state">
      <mat-icon>{{ getFilterIcon() }}</mat-icon>
      @if (mediaFilter() === 'all') {
      <p>No media found in your library</p>
      } @else {
      <p>No {{ getFilterLabel().toLowerCase() }} found</p>
      }
      <button mat-flat-button (click)="openUploadDialog()">
        <mat-icon>upload</mat-icon>
        Upload Now
      </button>
    </div>
    } @else if (viewMode() === 'details') {
    <!-- Details/Table View -->
    <div class="files-table-container">
      <table mat-table [dataSource]="filteredMedia()" class="files-table">
        <!-- Selection Column -->
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef width="48px">
            <mat-icon class="select-all-icon" (click)="selectAll()">
              {{ selectedItems().length === filteredMedia().length && filteredMedia().length > 0 ? 'check_box' : 'check_box_outline_blank' }}
            </mat-icon>
          </th>
          <td mat-cell *matCellDef="let item">
            <mat-icon [class.selected]="isSelected(item.sha256)"
              (click)="$event.stopPropagation(); onCheckboxClick($event, item.sha256)">
              {{ isSelected(item.sha256) ? 'check_box' : 'check_box_outline_blank' }}
            </mat-icon>
          </td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Name</th>
          <td mat-cell *matCellDef="let item" class="clickable-cell file-name-column"
            (click)="navigateToDetails($event, item)">
            <div class="file-name-cell">
              <mat-icon>{{ getMediaTypeIcon(item.type) }}</mat-icon>
              <span class="file-name-text">{{ getFileName(item.url) }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Mirrors Column -->
        <ng-container matColumnDef="mirrors">
          <th mat-header-cell *matHeaderCellDef class="mirrors-column">Mirrors</th>
          <td mat-cell *matCellDef="let item" class="mirrors-column">
            @if (item.mirrors && item.mirrors.length > 0) {
            <div class="mirror-indicator" [matTooltip]="'Mirrored on ' + item.mirrors.length + ' server(s)'">
              <mat-icon>cloud_done</mat-icon>
              <span>{{ item.mirrors.length }}</span>
            </div>
            } @else {
            <span>-</span>
            }
          </td>
        </ng-container>

        <!-- Type Column -->
        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef class="responsive-column">Type</th>
          <td mat-cell *matCellDef="let item" class="responsive-column">
            {{ item.type || 'Unknown' }}
          </td>
        </ng-container>

        <!-- Size Column -->
        <ng-container matColumnDef="size">
          <th mat-header-cell *matHeaderCellDef class="responsive-column">Size</th>
          <td mat-cell *matCellDef="let item" class="responsive-column">
            {{ formatFileSize(item.size || 0) }}
          </td>
        </ng-container>

        <!-- Uploaded Column -->
        <ng-container matColumnDef="uploaded">
          <th mat-header-cell *matHeaderCellDef class="responsive-column">Uploaded</th>
          <td mat-cell *matCellDef="let item" class="responsive-column">
            {{ item.uploaded | timestamp: 'medium' }}
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef width="48px">Actions</th>
          <td mat-cell *matCellDef="let item">
            <button mat-icon-button [matMenuTriggerFor]="menu" (click)="$event.stopPropagation()">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="navigateToDetails($event, item)">
                <mat-icon>info</mat-icon>
                <span>Details</span>
              </button>
              <button mat-menu-item (click)="publishSingleItemFromCard(item)">
                <mat-icon>send</mat-icon>
                <span>Publish</span>
              </button>
              <button mat-menu-item (click)="downloadSelected(item.sha256)">
                <mat-icon>download</mat-icon>
                <span>Download</span>
              </button>
              <button mat-menu-item (click)="mirrorItem(item.sha256, item.url)" [disabled]="isFullyMirrored(item)">
                <mat-icon>cloud_upload</mat-icon>
                <span>Mirror</span>
              </button>
              <button mat-menu-item (click)="deleteSelected(item.sha256)">
                <mat-icon color="warn">delete</mat-icon>
                <span class="delete-text">Delete</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns" [class.selected]="isSelected(row.sha256)"
          (click)="navigateToDetails($event, row)"></tr>
      </table>
    </div>
    } @else {
    <!-- Grid View (Large or Medium) -->
    <div class="media-grid" [class.large]="viewMode() === 'large'" [class.medium]="viewMode() === 'medium'">
      @for (item of filteredMedia(); track item.sha256) {
      <div class="media-card" [class.selected]="isSelected(item.sha256)"
        (pointerdown)="onItemPointerDown($event, item.sha256)"
        (pointerup)="onItemPointerUp($event)"
        (pointerleave)="onItemPointerLeave()"
        (click)="onCardClick($event, item)">
        <div class="media-thumbnail">
          <!-- Checkbox (shown on hover or in selection mode) -->
          <button type="button" class="checkbox-container" [class.visible]="selectionMode()"
            (click)="onCheckboxClick($event, item.sha256)"
            [attr.aria-label]="isSelected(item.sha256) ? 'Deselect item' : 'Select item'">
            <mat-icon>
              {{ isSelected(item.sha256) ? 'check_circle' : 'radio_button_unchecked' }}
            </mat-icon>
          </button>

          <!-- Mirror badge -->
          @if (item.mirrors && item.mirrors.length > 0) {
          <div class="mirror-badge" [matTooltip]="'Mirrored on ' + item.mirrors.length + ' server(s)'">
            <mat-icon>cloud_done</mat-icon>
            <span class="mirror-count">{{ item.mirrors.length }}</span>
          </div>
          }

          <!-- Media preview -->
          @if (item.type?.startsWith('video')) {
          <div class="video-preview">
            <video [src]="item.url" preload="metadata"></video>
            <div class="play-button">
              <mat-icon>play_circle_filled</mat-icon>
            </div>
          </div>
          } @else if (item.type?.startsWith('image')) {
          <img [src]="item.url" [alt]="getFileName(item.url)" loading="lazy" />
          } @else if (item.type?.startsWith('audio')) {
          <div class="audio-preview">
            <mat-icon>audiotrack</mat-icon>
          </div>
          } @else {
          <div class="file-preview">
            <mat-icon>insert_drive_file</mat-icon>
          </div>
          }

          <!-- Actions menu -->
          <div class="media-actions">
            <button mat-icon-button [matMenuTriggerFor]="itemMenu" (click)="$event.stopPropagation()">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #itemMenu="matMenu">
              <button mat-menu-item (click)="openDetailsDialog(item)">
                <mat-icon>info</mat-icon>
                <span>Details</span>
              </button>
              <button mat-menu-item (click)="publishSingleItemFromCard(item)">
                <mat-icon>send</mat-icon>
                <span>Publish</span>
              </button>
              <button mat-menu-item (click)="downloadSelected(item.sha256)">
                <mat-icon>download</mat-icon>
                <span>Download</span>
              </button>
              <button mat-menu-item (click)="mirrorItem(item.sha256, item.url)" [disabled]="isFullyMirrored(item)">
                <mat-icon>cloud_upload</mat-icon>
                <span>Mirror</span>
              </button>
              <button mat-menu-item (click)="deleteSelected(item.sha256)">
                <mat-icon color="warn">delete</mat-icon>
                <span class="delete-text">Delete</span>
              </button>
            </mat-menu>
          </div>
        </div>
      </div>
      }
    </div>
    }
  </div>
</div>
