<div dialog-content class="media-creator-dialog" [class.step-1]="currentStep() === 1"
  [class.step-2]="currentStep() === 2" [class.step-3]="currentStep() === 3" (dragenter)="onDragEnter($event)"
  (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event)"
  [class.drag-over]="isDragOver()">

  <!-- Step indicators -->
  <div class="step-indicators">
    <button class="step-indicator" [class.active]="currentStep() === 1" [class.completed]="currentStep() > 1"
      (click)="goToStep(1)">
      <span class="step-number">1</span>
      <span class="step-label" i18n="@@media.creator.step.select">Select</span>
    </button>
    <div class="step-connector" [class.active]="currentStep() > 1"></div>
    <button class="step-indicator" [class.active]="currentStep() === 2" [class.completed]="currentStep() > 2"
      [disabled]="!hasMedia()" (click)="goToStep(2)">
      <span class="step-number">2</span>
      <span class="step-label" i18n="@@media.creator.step.edit">Edit</span>
    </button>
    <div class="step-connector" [class.active]="currentStep() > 2"></div>
    <button class="step-indicator" [class.active]="currentStep() === 3" [disabled]="!hasMedia()" (click)="goToStep(3)">
      <span class="step-number">3</span>
      <span class="step-label" i18n="@@media.creator.step.details">Details</span>
    </button>
  </div>

  <!-- STEP 1: Select Media -->
  @if (currentStep() === 1) {
  <div class="step-content step-select">
    @if (isCameraMode()) {
    <!-- Camera capture mode - fullscreen -->
    <div class="camera-capture-fullscreen">
      <video #cameraVideo autoplay playsinline muted [class.mirror]="facingMode() === 'user'"></video>
      <canvas #cameraCanvas hidden></canvas>

      @if (!isCameraReady() && !cameraError()) {
      <div class="camera-loading">
        <mat-spinner diameter="40"></mat-spinner>
        <span i18n="@@media.creator.camera.loading">Starting camera...</span>
      </div>
      }

      @if (cameraError()) {
      <div class="camera-error">
        <mat-icon>error_outline</mat-icon>
        <span>{{ cameraError() }}</span>
      </div>
      }

      <!-- Glass effect controls overlay -->
      <div class="camera-controls-overlay">
        <button class="glass-btn close-btn" (click)="stopCamera()" matTooltip="Close camera"
          i18n-matTooltip="@@media.creator.camera.close">
          <mat-icon>close</mat-icon>
        </button>

        <button class="glass-btn switch-btn" (click)="switchCamera()" matTooltip="Switch camera"
          i18n-matTooltip="@@media.creator.camera.switch">
          <mat-icon>flip_camera_ios</mat-icon>
        </button>
      </div>

      <!-- Capture button at bottom -->
      <div class="camera-capture-controls">
        <button class="capture-btn-glass" (click)="capturePhoto()" [disabled]="!isCameraReady()"
          matTooltip="Take photo" i18n-matTooltip="@@media.creator.camera.capture" aria-label="Take photo">
          <div class="capture-btn-inner"></div>
        </button>
      </div>
    </div>
    } @else {
    <!-- File picker mode -->
    <div class="empty-state">
      <div class="drop-zone" (click)="openFilePicker()" (keydown.enter)="openFilePicker()"
        (keydown.space)="openFilePicker(); $event.preventDefault()" tabindex="0" role="button"
        aria-label="Select media file">
        <mat-icon class="upload-icon">add_photo_alternate</mat-icon>
        <h3 i18n="@@media.creator.drop.title">Drop media here or click to browse</h3>
        <p i18n="@@media.creator.drop.hint">Supports images and videos (select multiple)</p>
      </div>

      <!-- Camera button -->
      @if (mediaType() !== 'video') {
      <button mat-stroked-button class="camera-btn" (click)="openCamera()">
        <mat-icon>photo_camera</mat-icon>
        <span i18n="@@media.creator.camera.open">Take a Photo</span>
      </button>
      }

      <input #fileInput type="file" [accept]="acceptedFileTypes()" (change)="onFileSelected($event)" multiple hidden />
    </div>
    }
  </div>
  }

  <!-- STEP 2: Edit with Filters -->
  @if (currentStep() === 2 && hasMedia()) {
  <div class="step-content step-edit">
    <div class="edit-layout">
      <!-- Large preview area -->
      <div class="preview-area"
        [class.vertical]="currentMedia()?.dimensions && currentMedia()!.dimensions!.height > currentMedia()!.dimensions!.width"
        (touchstart)="onTouchStart($event)" (touchmove)="onTouchMove($event)" (touchend)="onTouchEnd($event)">

        @if (isImage()) {
        <canvas #filterCanvas class="filter-canvas"></canvas>
        } @else if (currentMedia()) {
        <video [src]="currentMedia()!.preview" controls class="video-preview"></video>
        }

        <!-- Media info overlay -->
        <div class="media-info-overlay">
          <div class="media-kind-badge">
            <mat-icon>{{ isImage() ? 'image' : 'videocam' }}</mat-icon>
            <span>{{ mediaKindLabel() }}</span>
            @if (mediaFiles().length > 1) {
            <span class="media-count">({{ selectedMediaIndex() + 1 }}/{{ mediaFiles().length }})</span>
            }
          </div>

          @if (currentMedia()?.dimensions) {
          <div class="dimensions-badge">
            {{ currentMedia()!.dimensions!.width }} Ã— {{ currentMedia()!.dimensions!.height }}
          </div>
          }
        </div>

        <!-- Video thumbnail indicator -->
        @if (isVideo() && currentMedia()?.thumbnailUrl) {
        <div class="thumbnail-badge">
          <mat-icon>image</mat-icon>
          <span i18n="@@media.creator.thumbnail.label">Thumbnail ready</span>
        </div>
        }

        <!-- Remove current media button -->
        <button mat-icon-button class="remove-media-btn" (click)="removeMedia(selectedMediaIndex())"
          matTooltip="Remove this item" i18n-matTooltip="@@media.creator.remove.tooltip">
          <mat-icon>close</mat-icon>
        </button>

        <!-- Inline Filter/Adjustment Panel for images -->
        @if (isImage()) {
        <div class="inline-edit-panel" [class.expanded]="showEditPanel()">
          <!-- Toggle button -->
          <button class="edit-panel-toggle" (click)="toggleEditPanel()">
            <mat-icon>{{ showEditPanel() ? 'expand_more' : 'tune' }}</mat-icon>
            <span>{{ showEditPanel() ? '' : (selectedFilter() !== 'none' ? getCurrentFilterName() : 'Edit') }}</span>
          </button>

          @if (showEditPanel()) {
          <div class="edit-panel-content">
            <!-- Tabs for Filters / Adjustments -->
            <div class="edit-tabs">
              <button class="tab-btn" [class.active]="editPanelTab() === 'filters'" (click)="editPanelTab.set('filters')">
                <mat-icon>photo_filter</mat-icon>
                <span i18n="@@media.creator.tab.filters">Filters</span>
              </button>
              <button class="tab-btn" [class.active]="editPanelTab() === 'adjustments'"
                (click)="editPanelTab.set('adjustments')">
                <mat-icon>tune</mat-icon>
                <span i18n="@@media.creator.tab.adjustments">Adjust</span>
              </button>
            </div>

            <!-- Filters Tab -->
            @if (editPanelTab() === 'filters') {
            <div class="filter-chips">
              @for (filter of filterService.availableFilters; track filter.id) {
              <button class="filter-chip" [class.selected]="selectedFilter() === filter.id"
                (click)="selectFilter(filter.id)">
                <mat-icon>{{ filter.icon }}</mat-icon>
                <span>{{ filter.name }}</span>
              </button>
              }
            </div>

            <!-- Filter Intensity Slider -->
            @if (selectedFilter() !== 'none') {
            <div class="inline-slider">
              <span class="slider-label" i18n="@@media.creator.filter.intensity">Intensity</span>
              <mat-slider min="0" max="100" step="1" class="inline-mat-slider">
                <input matSliderThumb [value]="filterIntensity()" (valueChange)="updateFilterIntensity($any($event))" aria-label="Filter intensity" />
              </mat-slider>
              <span class="slider-value">{{ filterIntensity() }}%</span>
            </div>
            }
            }

            <!-- Adjustments Tab -->
            @if (editPanelTab() === 'adjustments') {
            <div class="adjustments-inline">
              <div class="inline-slider">
                <mat-icon>brightness_6</mat-icon>
                <mat-slider min="-100" max="100" step="1" class="inline-mat-slider">
                  <input matSliderThumb [value]="adjustments().brightness"
                    (valueChange)="updateAdjustment('brightness', $any($event))" aria-label="Brightness" />
                </mat-slider>
                <span class="slider-value">{{ adjustments().brightness }}</span>
              </div>
              <div class="inline-slider">
                <mat-icon>contrast</mat-icon>
                <mat-slider min="-100" max="100" step="1" class="inline-mat-slider">
                  <input matSliderThumb [value]="adjustments().contrast"
                    (valueChange)="updateAdjustment('contrast', $any($event))" aria-label="Contrast" />
                </mat-slider>
                <span class="slider-value">{{ adjustments().contrast }}</span>
              </div>
              <div class="inline-slider">
                <mat-icon>palette</mat-icon>
                <mat-slider min="-100" max="100" step="1" class="inline-mat-slider">
                  <input matSliderThumb [value]="adjustments().saturation"
                    (valueChange)="updateAdjustment('saturation', $any($event))" aria-label="Saturation" />
                </mat-slider>
                <span class="slider-value">{{ adjustments().saturation }}</span>
              </div>
              <div class="inline-slider">
                <mat-icon>thermostat</mat-icon>
                <mat-slider min="-100" max="100" step="1" class="inline-mat-slider">
                  <input matSliderThumb [value]="adjustments().temperature"
                    (valueChange)="updateAdjustment('temperature', $any($event))" aria-label="Temperature" />
                </mat-slider>
                <span class="slider-value">{{ adjustments().temperature }}</span>
              </div>
              <button class="reset-btn" (click)="resetAdjustments()" [disabled]="!hasAdjustments()">
                <mat-icon>refresh</mat-icon>
                <span i18n="@@media.creator.adjust.reset">Reset</span>
              </button>
            </div>
            }
          </div>
          }
        </div>
        }
      </div>

      <!-- Right panel (media thumbnails only) -->
      <div class="right-panel">

        <!-- Media thumbnails for multi-select -->
        @if (mediaFiles().length > 0) {
        <div class="media-thumbnails">
          <h4 i18n="@@media.creator.media.title">Media ({{ mediaFiles().length }})</h4>
          <div class="thumbnail-grid" cdkDropList cdkDropListOrientation="horizontal"
            (cdkDropListDropped)="onThumbnailDrop($event)">
            @for (media of mediaFiles(); track media.id; let i = $index) {
            <button class="thumbnail-item" [class.selected]="selectedMediaIndex() === i" (click)="selectMedia(i)"
              cdkDrag [cdkDragDisabled]="mediaFiles().length < 2">
              @if (media.type === 'image') {
              <img [src]="media.preview" alt="Media thumbnail" />
              } @else {
              <video [src]="media.preview" muted></video>
              <mat-icon class="video-indicator">play_circle</mat-icon>
              }
              <button mat-icon-button class="remove-thumb-btn" (click)="removeMedia(i); $event.stopPropagation()">
                <mat-icon>close</mat-icon>
              </button>
              @if (mediaFiles().length > 1) {
              <mat-icon class="drag-handle">drag_indicator</mat-icon>
              }
            </button>
            }
            <!-- Add more button -->
            <button class="thumbnail-item add-more" (click)="openFilePicker()"
              matTooltip="Add more {{ mediaType() === 'image' ? 'images' : 'videos' }}"
              i18n-matTooltip="@@media.creator.add.more.tooltip">
              <mat-icon>add</mat-icon>
            </button>
          </div>
        </div>
        }
      </div>
    </div>
  </div>
  }

  <!-- STEP 3: Add Details -->
  @if (currentStep() === 3 && hasMedia()) {
  <div class="step-content step-details">
    <div class="details-layout">
      <!-- Compact preview of all media -->
      <div class="media-preview-strip">
        @for (media of mediaFiles(); track media.id; let i = $index) {
        <div class="preview-thumb" [class.selected]="selectedMediaIndex() === i" (click)="selectMedia(i)">
          @if (media.type === 'image') {
          <img [src]="media.preview" alt="Media preview" />
          } @else {
          <video [src]="media.preview" muted></video>
          <mat-icon class="video-indicator">play_circle</mat-icon>
          }
        </div>
        }
        <div class="preview-info">
          <mat-icon>{{ isImage() ? 'image' : 'videocam' }}</mat-icon>
          <span>{{ mediaFiles().length }} {{ mediaType() === 'image' ? 'Photo' : 'Video' }}{{ mediaFiles().length > 1 ?
            's' : '' }} (kind {{ mediaKind() }})</span>
        </div>
      </div>

      <!-- Form fields -->
      <div class="form-section">
        <!-- Title -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label i18n="@@media.creator.title.label">Title</mat-label>
          <input matInput [value]="title()" (input)="title.set($any($event.target).value)"
            placeholder="Give your media a title" i18n-placeholder="@@media.creator.title.placeholder" />
          <mat-hint i18n="@@media.creator.title.hint">Optional but recommended</mat-hint>
        </mat-form-field>

        <!-- Description -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label i18n="@@media.creator.description.label">Description</mat-label>
          <textarea matInput [value]="content()" (input)="content.set($any($event.target).value)"
            placeholder="Add a description or caption" i18n-placeholder="@@media.creator.description.placeholder"
            rows="3" class="auto-grow-textarea"></textarea>
        </mat-form-field>

        <!-- Alt Text (per-image) -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>
            <ng-container i18n="@@media.creator.alt.label">Alt Text</ng-container>
            @if (mediaFiles().length > 1) {
            <span class="alt-for-image"> ({{ selectedMediaIndex() + 1 }}/{{ mediaFiles().length }})</span>
            }
          </mat-label>
          <input matInput [value]="currentAlt()" (input)="updateCurrentAlt($any($event.target).value)"
            placeholder="Describe for accessibility" i18n-placeholder="@@media.creator.alt.placeholder" />
          <mat-hint i18n="@@media.creator.alt.hint">Helps screen readers describe your media</mat-hint>
        </mat-form-field>

        @if (mediaFiles().length > 1) {
        <div class="alt-navigation">
          <button mat-button [disabled]="selectedMediaIndex() === 0" (click)="selectMedia(selectedMediaIndex() - 1)">
            <mat-icon>chevron_left</mat-icon>
            <span i18n="@@media.creator.alt.previous">Previous</span>
          </button>
          <span class="alt-nav-label" i18n="@@media.creator.alt.set.for">Set alt text for each image</span>
          <button mat-button [disabled]="selectedMediaIndex() === mediaFiles().length - 1"
            (click)="selectMedia(selectedMediaIndex() + 1)">
            <span i18n="@@media.creator.alt.next">Next</span>
            <mat-icon>chevron_right</mat-icon>
          </button>
        </div>
        }

        <!-- Hashtags -->
        <div class="hashtag-section">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label i18n="@@media.creator.hashtags.label">Hashtags</mat-label>
            <input matInput [value]="hashtagInput()" (input)="hashtagInput.set($any($event.target).value)"
              (keydown)="onHashtagKeydown($event)" placeholder="Type and press Enter"
              i18n-placeholder="@@media.creator.hashtags.placeholder" />
            <button mat-icon-button matSuffix (click)="addHashtag()" [disabled]="!hashtagInput().trim()">
              <mat-icon>add</mat-icon>
            </button>
          </mat-form-field>

          @if (hashtags().length > 0) {
          <div class="hashtag-chips">
            @for (tag of hashtags(); track tag) {
            <span class="hashtag-chip">
              #{{ tag }}
              <button mat-icon-button (click)="removeHashtag(tag)">
                <mat-icon>close</mat-icon>
              </button>
            </span>
            }
          </div>
          }
        </div>

        <!-- Content Warning -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label i18n="@@media.creator.cw.label">Content Warning</mat-label>
          <input matInput [value]="contentWarning()" (input)="contentWarning.set($any($event.target).value)"
            placeholder="e.g., NSFW, violence" i18n-placeholder="@@media.creator.cw.placeholder" />
          <mat-hint i18n="@@media.creator.cw.hint">Optional warning about sensitive content</mat-hint>
        </mat-form-field>

        <!-- Options -->
        <div class="options-section">
          <mat-slide-toggle [checked]="alsoPostAsNote()" (change)="alsoPostAsNote.set($event.checked)"
            matTooltip="Also create a regular note (kind 1) that references this media"
            i18n-matTooltip="@@media.creator.note.tooltip">
            <span i18n="@@media.creator.note.label">Also post as Note</span>
          </mat-slide-toggle>

          <mat-slide-toggle [checked]="uploadOriginal()" (change)="uploadOriginal.set($event.checked)"
            matTooltip="Skip server-side transcoding and upload the original file"
            i18n-matTooltip="@@media.creator.original.tooltip">
            <span i18n="@@media.creator.original.label">Upload original</span>
          </mat-slide-toggle>
        </div>
      </div>
    </div>
  </div>
  }

  <!-- Drag overlay -->
  @if (isDragOver()) {
  <div class="drag-overlay">
    <div class="drag-message">
      <mat-icon>cloud_upload</mat-icon>
      <span i18n="@@media.creator.drag.message">Drop your media here</span>
    </div>
  </div>
  }

  <!-- Upload progress -->
  @if (isUploading()) {
  <div class="upload-progress">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
    <span class="upload-text">{{ uploadStatus() }}</span>
  </div>
  }
</div>

<div dialog-actions class="action-container">
  <div class="left-actions">
    @if (currentStep() > 1) {
    <button mat-button (click)="startOver()">
      <mat-icon>restart_alt</mat-icon>
      <span i18n="@@media.creator.startover">Start Over</span>
    </button>
    }
    <input #fileInput type="file" [accept]="acceptedFileTypes()" (change)="onFileSelected($event)" multiple hidden />
  </div>

  <div class="right-actions">
    <button mat-button (click)="cancel()" i18n="@@media.creator.cancel">Cancel</button>

    @if (currentStep() < 3 && hasMedia()) { <button mat-flat-button (click)="goToNextStep()">
      <span i18n="@@media.creator.next">Next</span>
      <mat-icon>arrow_forward</mat-icon>
      </button>
      }

      @if (currentStep() === 3) {
      <button mat-flat-button (click)="publish()" [disabled]="!canPublish()">
        @if (isPublishing()) {
        <mat-spinner diameter="18"></mat-spinner>
        } @else {
        <mat-icon>send</mat-icon>
        }
        <span i18n="@@media.creator.publish">Publish</span>
      </button>
      }
  </div>
</div>