<div class="relay-column">
  <!-- Relay Info Header - Clickable to expand -->
  <div class="relay-info-header" [class.expanded]="isExpanded()" (click)="toggleExpanded()">
    <div class="relay-identity">
      @if (iconUrl()) {
      <img [src]="iconUrl()" alt="Relay icon" class="relay-icon" (error)="handleIconError($event)" />
      } @else {
      <mat-icon class="relay-icon-fallback">dns</mat-icon>
      }
      <div class="relay-details">
        <span class="relay-name">{{ displayName() }}</span>
        @if (relayInfo()?.description && !isExpanded()) {
        <span class="relay-description">{{ relayInfo()?.description }}</span>
        }
      </div>
    </div>

    <div class="relay-actions" (click)="$event.stopPropagation()">
      @if (isRefreshing()) {
      <div class="spinner-container">
        <mat-spinner diameter="20" strokeWidth="3"></mat-spinner>
      </div>
      } @else {
      <button mat-icon-button (click)="refresh()" matTooltip="Refresh">
        <mat-icon>refresh</mat-icon>
      </button>
      }

      @if (!isRelayInList(relayDomain())) {
      <button mat-icon-button (click)="addRelay(relayDomain())" matTooltip="Add to favorites">
        <mat-icon>bookmark_border</mat-icon>
      </button>
      }

      <button mat-icon-button (click)="toggleExpanded()" [matTooltip]="isExpanded() ? 'Collapse' : 'Show relay info'">
        <mat-icon>{{ isExpanded() ? 'expand_less' : 'expand_more' }}</mat-icon>
      </button>
    </div>
  </div>

  <!-- Expanded NIP-11 Metadata Section -->
  @if (isExpanded() && relayInfo()) {
  <div class="relay-metadata-expanded">
    @if (relayInfo()?.description) {
    <div class="metadata-section">
      <span class="metadata-label">Description</span>
      <p class="metadata-value description">{{ relayInfo()?.description }}</p>
    </div>
    }

    @if (relayInfo()?.pubkey) {
    <div class="metadata-section">
      <span class="metadata-label">Operator Pubkey</span>
      <div class="metadata-value operator-pubkey">
        <app-user-profile [pubkey]="relayInfo()!.pubkey!" view="compact"></app-user-profile>
      </div>
    </div>
    }

    @if (relayInfo()?.contact) {
    <div class="metadata-section">
      <span class="metadata-label">Contact</span>
      @if (contactUrl()) {
      <a [href]="contactUrl()" target="_blank" rel="noopener noreferrer" class="metadata-value link">
        {{ relayInfo()?.contact }}
      </a>
      } @else {
      <span class="metadata-value">{{ relayInfo()?.contact }}</span>
      }
    </div>
    }

    @if (relayInfo()?.software) {
    <div class="metadata-section">
      <span class="metadata-label">Software</span>
      @if (softwareUrl()) {
      <a [href]="softwareUrl()" target="_blank" rel="noopener noreferrer" class="metadata-value link">
        {{ softwareDisplay() }}@if (relayInfo()?.version) { v{{ relayInfo()?.version }}}
      </a>
      } @else {
      <span class="metadata-value">{{ relayInfo()?.software }}@if (relayInfo()?.version) { v{{ relayInfo()?.version
        }}}</span>
      }
    </div>
    }

    @if (relayInfo()?.supported_nips && relayInfo()!.supported_nips!.length > 0) {
    <div class="metadata-section">
      <span class="metadata-label">Supported NIPs</span>
      <div class="nips-list">
        @for (nip of relayInfo()?.supported_nips; track nip) {
        <span class="nip-chip">NIP-{{ nip }}</span>
        }
      </div>
    </div>
    }

    @if (relayInfo()?.limitation) {
    <div class="metadata-section">
      <span class="metadata-label">Limitations</span>
      <div class="limitations-grid">
        @if (relayInfo()?.limitation?.max_message_length) {
        <span class="limitation-item">Max message: {{ relayInfo()?.limitation?.max_message_length | number }}</span>
        }
        @if (relayInfo()?.limitation?.max_content_length) {
        <span class="limitation-item">Max content: {{ relayInfo()?.limitation?.max_content_length | number }}</span>
        }
        @if (relayInfo()?.limitation?.max_subscriptions) {
        <span class="limitation-item">Max subscriptions: {{ relayInfo()?.limitation?.max_subscriptions }}</span>
        }
        @if (relayInfo()?.limitation?.auth_required) {
        <span class="limitation-item warning">Auth required</span>
        }
        @if (relayInfo()?.limitation?.payment_required) {
        <span class="limitation-item warning">Payment required</span>
        }
      </div>
    </div>
    }

    @if (relayInfo()?.relay_countries && relayInfo()!.relay_countries!.length > 0) {
    <div class="metadata-section">
      <span class="metadata-label">Countries</span>
      <span class="metadata-value">{{ relayInfo()?.relay_countries?.join(', ') }}</span>
    </div>
    }

    @if (relayInfo()?.language_tags && relayInfo()!.language_tags!.length > 0) {
    <div class="metadata-section">
      <span class="metadata-label">Languages</span>
      <span class="metadata-value">{{ relayInfo()?.language_tags?.join(', ') }}</span>
    </div>
    }

    <div class="metadata-section">
      <span class="metadata-label">Relay URL</span>
      <div class="relay-url-row">
        <span class="metadata-value monospace">{{ relayUrl() }}</span>
        <button mat-icon-button class="copy-btn" (click)="copyRelayUrl()"
          [matTooltip]="copiedUrl() ? 'Copied!' : 'Copy URL'">
          <mat-icon>{{ copiedUrl() ? 'check' : 'content_copy' }}</mat-icon>
        </button>
      </div>
    </div>
  </div>
  } @else if (isExpanded() && isLoadingInfo()) {
  <div class="relay-metadata-expanded loading">
    <mat-spinner diameter="24"></mat-spinner>
    <span>Loading relay information...</span>
  </div>
  }

  <!-- Content Area -->
  <div class="column-items">
    @if (isLoading() && !isRefreshing()) {
    <!-- Loading skeleton -->
    <div class="column-skeleton-items">
      @for (item of [1, 2, 3, 4, 5]; track $index) {
      <div class="feed-item-skeleton">
        <div class="item-header-skeleton">
          <div class="avatar-skeleton"></div>
          <div class="user-info-skeleton">
            <div class="username-skeleton"></div>
            <div class="timestamp-skeleton"></div>
          </div>
        </div>
        <div class="item-content-skeleton">
          <div class="content-line-skeleton"></div>
          <div class="content-line-skeleton"></div>
          <div class="content-line-skeleton short"></div>
        </div>
        <div class="item-actions-skeleton">
          <div class="action-skeleton"></div>
          <div class="action-skeleton"></div>
          <div class="action-skeleton"></div>
          <div class="action-skeleton"></div>
        </div>
      </div>
      }
    </div>
    } @else if (error()) {
    <!-- Error state -->
    <div class="error-state">
      <mat-icon>error_outline</mat-icon>
      <p>{{ error() }}</p>
      <button mat-stroked-button (click)="refresh()">
        <mat-icon>refresh</mat-icon>
        Try Again
      </button>
    </div>
    } @else if (hasEvents()) {
    <!-- Events list -->
    @for (event of displayedEvents(); track event.id) {
    <app-event [event]="event"></app-event>
    }

    <!-- Load more trigger -->
    @if (hasMore()) {
    <div #loadMoreTrigger class="load-more-trigger"></div>
    } @else if (displayedEvents().length > 0) {
    <div class="end-of-feed">
      <mat-icon>celebration</mat-icon>
      <p>ðŸŽ‰ You've reached the end!</p>
      <span class="end-subtitle">No more posts from this relay.</span>
    </div>
    }
    } @else {
    <!-- Empty state -->
    <div class="empty-state">
      <mat-icon>dns</mat-icon>
      <p>No posts found from this relay</p>
      <span class="empty-subtitle">Try refreshing or select a different relay</span>
    </div>
    }
  </div>
</div>