<div class="page-container">
  <div class="header-actions">
    <div>
      <h1>Local AI Models</h1>
      <p>Run Small Language Models locally in your browser using WebGPU/WASM.</p>
    </div>
    <div class="header-buttons">
      <button mat-stroked-button (click)="downloadAll()">
        <mat-icon>download</mat-icon>
        Download All
      </button>
      <button mat-stroked-button color="warn" (click)="clearAllCache()">
        <mat-icon>delete_forever</mat-icon>
        Wipe All Cache
      </button>
    </div>
  </div>

  <mat-tab-group>
    <mat-tab label="Models">
      <div class="models-table-container">
        <ng-container *ngTemplateOutlet="modelsTable; context: { $implicit: models() }"></ng-container>
      </div>
    </mat-tab>
    <mat-tab label="Languages">
      <div class="models-table-container">
        <ng-container *ngTemplateOutlet="modelsTable; context: { $implicit: languageModels() }"></ng-container>
      </div>
    </mat-tab>
  </mat-tab-group>

  <ng-template #modelsTable let-dataSource>
    <div class="models-table-container">
      <table mat-table [dataSource]="dataSource" class="mat-elevation-z8">

        <!-- Info Column (Name, ID, Description) -->
        <ng-container matColumnDef="info">
          <th mat-header-cell *matHeaderCellDef> Model </th>
          <td mat-cell *matCellDef="let model">
            <div class="model-info-cell">
              <div class="model-name">{{model.name}}</div>
              <div class="model-subtext">
                <a [href]="'https://huggingface.co/' + model.id" target="_blank" class="model-link">
                  {{model.id}} <mat-icon class="link-icon">open_in_new</mat-icon>
                </a>
                <span class="separator">â€¢</span>
                <span>{{model.description}}</span>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Size Column -->
        <ng-container matColumnDef="size">
          <th mat-header-cell *matHeaderCellDef> Size </th>
          <td mat-cell *matCellDef="let model"> {{model.size}} </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef> Status </th>
          <td mat-cell *matCellDef="let model">
            @if (model.loading) {
            <div class="status-loading">
              <mat-progress-bar mode="determinate" [value]="model.progress"></mat-progress-bar>
              <span>{{ model.progress | number:'1.0-0' }}%</span>
            </div>
            } @else if (model.loaded) {
            <span class="status-loaded"><mat-icon>check_circle</mat-icon> Loaded</span>
            } @else if (model.cached) {
            <span class="status-cached"><mat-icon>save</mat-icon> Cached</span>
            } @else {
            <span class="status-not-loaded">Not Loaded</span>
            }
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef> Actions </th>
          <td mat-cell *matCellDef="let model">
            <div class="action-buttons">
              <button mat-stroked-button (click)="loadModel(model)" [disabled]="model.loaded || model.loading">
                @if (model.loaded) {
                Loaded
                } @else if (model.cached) {
                Load
                } @else {
                Download
                }
              </button>
              @if (model.cached || model.loaded) {
              <button mat-icon-button color="warn" (click)="deleteModel(model)" matTooltip="Delete from cache">
                <mat-icon>delete</mat-icon>
              </button>
              }
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>
  </ng-template>
  <div class="playground-section">
    <h2>Playground</h2>
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Input Text</mat-label>
      <textarea matInput [ngModel]="inputText()" (ngModelChange)="inputText.set($event)" rows="4"
        placeholder="Enter text here..."></textarea>
    </mat-form-field>

    <div class="actions">
      <mat-form-field appearance="outline" subscriptSizing="dynamic">
        <mat-label>Speaker</mat-label>
        <mat-select [ngModel]="selectedSpeaker()" (ngModelChange)="selectedSpeaker.set($event)">
          @for (speaker of speakers; track speaker.id) {
          <mat-option [value]="speaker">{{ speaker.name }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <button mat-stroked-button (click)="generate()"
        [disabled]="!isModelLoaded('Xenova/distilgpt2') || isGenerating()">
        Generate Text
      </button>
      <button mat-stroked-button (click)="speak()" [disabled]="isSpeaking()">
        @if (isSpeaking()) {
        <mat-progress-spinner mode="indeterminate" diameter="20"></mat-progress-spinner>
        } @else {
        <span><mat-icon>volume_up</mat-icon> Speak</span>
        }
      </button>
      <button mat-stroked-button (click)="summarize()"
        [disabled]="!isModelLoaded('Xenova/distilbart-cnn-6-6') || isGenerating()">
        Summarize
      </button>
      <button mat-stroked-button (click)="analyzeSentiment()"
        [disabled]="!isModelLoaded('Xenova/distilbert-base-uncased-finetuned-sst-2-english') || isGenerating()">
        Sentiment
      </button>

      <div class="translation-group">
        <mat-form-field appearance="outline" class="compact-select" subscriptSizing="dynamic">
          <mat-label>Translation Model</mat-label>
          <mat-select [ngModel]="selectedTranslationModel()" (ngModelChange)="selectedTranslationModel.set($event)">
            @for (model of languageModels(); track model.id) {
            <mat-option [value]="model.id">{{ model.name }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
        <button mat-stroked-button (click)="translate()"
          [disabled]="!isModelLoaded(selectedTranslationModel()) || isGenerating()">
          Translate
        </button>
      </div>
    </div>

    @if (isGenerating()) {
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
    }

    @if (outputText()) {
    <div class="output-section">
      <h3>Output</h3>
      <div class="output-box">
        {{ outputText() }}
      </div>
    </div>
    }

    @if (audioUrl()) {
    <div class="output-section">
      <h3>Audio Output</h3>
      <audio controls [src]="audioUrl()" class="full-width"></audio>
    </div>
    }
  </div>
</div>