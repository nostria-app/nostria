<div class="clips-container">
  <mat-menu #clipsTopMenu="matMenu">
    @if (isHandset()) {
    <button mat-menu-item (click)="goHome()">
      <mat-icon>home</mat-icon>
      <span>Home</span>
    </button>
    }
    <button mat-menu-item (click)="refresh()" [disabled]="loading()">
      <mat-icon>refresh</mat-icon>
      <span>Refresh</span>
    </button>
    <button mat-menu-item (click)="openSettings()">
      <mat-icon>settings</mat-icon>
      <span>Relay settings</span>
    </button>
    <button mat-menu-item (click)="toggleIncludeArchive()">
      <mat-icon>{{ includeArchive() ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
      <span>Include archive</span>
    </button>
    <button mat-menu-item (click)="toggleArchiveOnly()">
      <mat-icon>{{ archiveOnly() ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
      <span>Archive only</span>
    </button>
  </mat-menu>

  <div class="panel-header">
    <h2 class="panel-title title-font">Clips</h2>
    <div class="desktop-pane-tabs" aria-label="Clips tabs">
      <button mat-icon-button class="desktop-pane-create-button" (click)="createClip()" aria-label="Create clip"
        matTooltip="Create clip">
        <mat-icon>add</mat-icon>
      </button>
      <button class="clips-tab" [class.active]="selectedTabIndex() === 0" (click)="onTabChange(0)">
        Explore
      </button>
      <button class="clips-tab" [class.active]="selectedTabIndex() === 1" (click)="onTabChange(1)">
        Following
      </button>
      <button class="clips-tab" [class.active]="selectedTabIndex() === 2" (click)="onTabChange(2)">
        For You
      </button>
    </div>
    <span class="panel-header-spacer"></span>

    <button mat-icon-button (click)="refresh()" [disabled]="loading()" matTooltip="Refresh clips">
      <mat-icon>refresh</mat-icon>
    </button>
    <button mat-icon-button [matMenuTriggerFor]="clipsFiltersMenu" matTooltip="Clips filters">
      <mat-icon>tune</mat-icon>
    </button>
    <button mat-icon-button [matMenuTriggerFor]="clipsTopMenu" matTooltip="More options">
      <mat-icon>more_vert</mat-icon>
    </button>
    <mat-menu #clipsFiltersMenu="matMenu">
      <button mat-menu-item (click)="toggleIncludeArchive()">
        <mat-icon>{{ includeArchive() ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
        <span>Include archive</span>
      </button>
      <button mat-menu-item (click)="toggleArchiveOnly()">
        <mat-icon>{{ archiveOnly() ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
        <span>Archive only</span>
      </button>
    </mat-menu>
    <button mat-icon-button (click)="openSettings()" matTooltip="Clips relay settings">
      <mat-icon>settings</mat-icon>
    </button>
  </div>

  <div class="clips-tabs" aria-label="Clips tabs">
    <button mat-icon-button class="clips-tabs-create-button" (click)="createClip()" aria-label="Create clip"
      matTooltip="Create clip">
      <mat-icon>add</mat-icon>
    </button>
    <button class="clips-tab" [class.active]="selectedTabIndex() === 0" (click)="onTabChange(0)">
      Explore
    </button>
    <button class="clips-tab" [class.active]="selectedTabIndex() === 1" (click)="onTabChange(1)">
      Following
    </button>
    <button class="clips-tab" [class.active]="selectedTabIndex() === 2" (click)="onTabChange(2)">
      For You
    </button>
    <button mat-icon-button class="clips-tabs-menu-button" [matMenuTriggerFor]="clipsTopMenu" aria-label="More options"
      matTooltip="More options">
      <mat-icon>more_vert</mat-icon>
    </button>
  </div>

  <div class="clips-tab-content">
    @if (selectedTabIndex() === 0) {
    <div class="explore-content">
      @if (loading()) {
      <div class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Loading clips...</p>
      </div>
      } @else if (exploreClips().length === 0) {
      <div class="empty-state">
        <mat-icon>movie</mat-icon>
        <p>No clips found for current filters.</p>
      </div>
      } @else {
      <div class="explore-list">
        @for (clip of visibleExploreClips(); track clip.id) {
        <button class="explore-card" (click)="openClipFromExplore(clip)" aria-label="Open clip in For You view">
          @if (getClipPoster(clip)) {
          <img [src]="getClipPoster(clip)" [alt]="getClipTitle(clip)" title="Clip thumbnail" class="explore-thumb" />
          } @else {
          <div class="explore-thumb explore-thumb-fallback">
            <mat-icon>movie</mat-icon>
          </div>
          }
          <div class="explore-card-title">{{ getClipTitle(clip) }}</div>
        </button>
        }
      </div>
      @if (hasMoreExploreClips()) {
      <div class="explore-load-more">
        <div #exploreLoadSentinel class="explore-load-sentinel" aria-hidden="true"></div>
        <button mat-flat-button (click)="loadMoreExploreClips()">Load more</button>
      </div>
      }
      }
    </div>
    }

    @if (selectedTabIndex() === 1) {
    <div class="swipe-content" appSwipeGesture [threshold]="95" [horizontalSwipe]="false" [verticalSwipe]="true"
      [trackProgress]="true" (swipeProgress)="onSwipeProgress($event, 'following')"
      (swipe)="onSwipe($event, 'following')" (swipeEnd)="onSwipeEnd('following')">
      @if (loading()) {
      <div class="loading-container fullscreen-loading">
        <mat-spinner diameter="40"></mat-spinner>
      </div>
      } @else {
      @let clip = currentFollowingClip();
      @if (clip) {
      <div class="swipe-card" [class.animating]="isCardAnimating('following')"
        [style.transform]="getCardTransform('following')">
        <app-clips-video-card [event]="clip" [active]="selectedTabIndex() === 1" (commentsClick)="openComments(clip)" />
      </div>
      <div class="desktop-nav-buttons">
        <button mat-mini-fab class="desktop-nav-btn" aria-label="Previous clip" matTooltip="Previous (↑ / k)"
          (click)="previousClip('following')" [disabled]="!canNavigate('following', -1)">
          <mat-icon>keyboard_arrow_up</mat-icon>
        </button>
        <button mat-mini-fab class="desktop-nav-btn" aria-label="Next clip" matTooltip="Next (↓ / j)"
          (click)="nextClip('following')" [disabled]="!canNavigate('following', 1)">
          <mat-icon>keyboard_arrow_down</mat-icon>
        </button>
      </div>
      <div class="swipe-position">{{ followingIndex() + 1 }} / {{ followingClips().length }}</div>
      } @else {
      <div class="empty-state fullscreen-empty">
        <mat-icon>movie</mat-icon>
        <p>No clips from people you follow.</p>
      </div>
      }
      }
    </div>
    }

    @if (selectedTabIndex() === 2) {
    <div class="swipe-content" appSwipeGesture [threshold]="95" [horizontalSwipe]="false" [verticalSwipe]="true"
      [trackProgress]="true" (swipeProgress)="onSwipeProgress($event, 'foryou')" (swipe)="onSwipe($event, 'foryou')"
      (swipeEnd)="onSwipeEnd('foryou')">
      @if (loading()) {
      <div class="loading-container fullscreen-loading">
        <mat-spinner diameter="40"></mat-spinner>
      </div>
      } @else {
      @let clip = currentForYouClip();
      @if (clip) {
      <div class="swipe-card" [class.animating]="isCardAnimating('foryou')"
        [style.transform]="getCardTransform('foryou')">
        <app-clips-video-card [event]="clip" [active]="selectedTabIndex() === 2" (commentsClick)="openComments(clip)" />
      </div>
      <div class="desktop-nav-buttons">
        <button mat-mini-fab class="desktop-nav-btn" aria-label="Previous clip" matTooltip="Previous (↑ / k)"
          (click)="previousClip('foryou')" [disabled]="!canNavigate('foryou', -1)">
          <mat-icon>keyboard_arrow_up</mat-icon>
        </button>
        <button mat-mini-fab class="desktop-nav-btn" aria-label="Next clip" matTooltip="Next (↓ / j)"
          (click)="nextClip('foryou')" [disabled]="!canNavigate('foryou', 1)">
          <mat-icon>keyboard_arrow_down</mat-icon>
        </button>
      </div>
      <div class="swipe-position">{{ forYouIndex() + 1 }} / {{ forYouClips().length }}</div>
      } @else {
      <div class="empty-state fullscreen-empty">
        <mat-icon>movie</mat-icon>
        <p>No clips found for current filters.</p>
      </div>
      }
      }
    </div>
    }
  </div>
</div>

@if (showSettingsDialog()) {
<app-clips-settings-dialog (closed)="onSettingsDialogClosed($event)"></app-clips-settings-dialog>
}

@if (commentsOpen() && commentsEvent(); as clipEvent) {
<button class="comments-backdrop" (click)="closeComments()" aria-label="Close comments"></button>
<div class="comments-sheet" role="dialog" aria-label="Clip comments">
  <div class="comments-header">
    <h3>Comments</h3>
    <button mat-icon-button (click)="closeComments()" aria-label="Close comments">
      <mat-icon>close</mat-icon>
    </button>
  </div>
  <div class="comments-content">
    <app-comments-list [event]="clipEvent" [autoExpand]="true"></app-comments-list>
  </div>
</div>
}