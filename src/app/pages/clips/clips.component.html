<div class="clips-container">
  <div class="clips-mobile-menu">
    <button mat-icon-button [matMenuTriggerFor]="clipsTopMenu" aria-label="Clips options">
      <mat-icon>more_vert</mat-icon>
    </button>
  </div>

  <mat-menu #clipsTopMenu="matMenu">
    <button mat-menu-item (click)="refresh()" [disabled]="loading()">
      <mat-icon>refresh</mat-icon>
      <span>Refresh</span>
    </button>
    <button mat-menu-item (click)="openSettings()">
      <mat-icon>settings</mat-icon>
      <span>Relay settings</span>
    </button>
    <button mat-menu-item (click)="toggleIncludeArchive()">
      <mat-icon>{{ includeArchive() ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
      <span>Include archive</span>
    </button>
    <button mat-menu-item (click)="toggleArchiveOnly()">
      <mat-icon>{{ archiveOnly() ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
      <span>Archive only</span>
    </button>
  </mat-menu>

  <div class="panel-header">
    <h2 class="panel-title title-font">Clips</h2>
    <span class="panel-header-spacer"></span>

    <button mat-icon-button (click)="refresh()" [disabled]="loading()" matTooltip="Refresh clips">
      <mat-icon>refresh</mat-icon>
    </button>
    <button mat-icon-button (click)="openSettings()" matTooltip="Clips relay settings">
      <mat-icon>settings</mat-icon>
    </button>
  </div>

  <div class="clips-filters">
    <mat-slide-toggle [checked]="includeArchive()" (change)="onIncludeArchiveChanged($event.checked)">
      Include archive
    </mat-slide-toggle>
    <mat-slide-toggle [checked]="archiveOnly()" (change)="onArchiveOnlyChanged($event.checked)">
      Archive only
    </mat-slide-toggle>
  </div>

  <mat-tab-group [selectedIndex]="selectedTabIndex()" (selectedIndexChange)="onTabChange($event)">
    <mat-tab>
      <ng-template mat-tab-label>
        <span>Explore</span>
      </ng-template>

      <div class="explore-content">
        @if (loading()) {
        <div class="loading-container">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading clips...</p>
        </div>
        } @else if (exploreClips().length === 0) {
        <div class="empty-state">
          <mat-icon>movie</mat-icon>
          <p>No clips found for current filters.</p>
        </div>
        } @else {
        <div class="explore-list">
          @for (clip of visibleExploreClips(); track clip.id) {
          <app-clips-video-card class="explore-clip-card" [event]="clip" [active]="false"
            (commentsClick)="openComments(clip)" />
          }
        </div>
        @if (hasMoreExploreClips()) {
        <div class="explore-load-more">
          <button mat-flat-button (click)="loadMoreExploreClips()">Load more</button>
        </div>
        }
        }
      </div>
    </mat-tab>

    <mat-tab>
      <ng-template mat-tab-label>
        <span>Following</span>
      </ng-template>

      <div class="swipe-content" appSwipeGesture [threshold]="95" [horizontalSwipe]="false" [verticalSwipe]="true"
        [trackProgress]="true" (swipeProgress)="onSwipeProgress($event, 'following')"
        (swipe)="onSwipe($event, 'following')" (swipeEnd)="onSwipeEnd('following')">
        @if (loading()) {
        <div class="loading-container fullscreen-loading">
          <mat-spinner diameter="40"></mat-spinner>
        </div>
        } @else {
        @let clip = currentFollowingClip();
        @if (clip) {
        <div class="swipe-card" [class.animating]="isCardAnimating('following')"
          [style.transform]="getCardTransform('following')">
          <app-clips-video-card [event]="clip" [active]="selectedTabIndex() === 1"
            (commentsClick)="openComments(clip)" />
        </div>
        <div class="swipe-position">{{ followingIndex() + 1 }} / {{ followingClips().length }}</div>
        } @else {
        <div class="empty-state fullscreen-empty">
          <mat-icon>movie</mat-icon>
          <p>No clips from people you follow.</p>
        </div>
        }
        }
      </div>
    </mat-tab>

    <mat-tab>
      <ng-template mat-tab-label>
        <span>For You</span>
      </ng-template>

      <div class="swipe-content" appSwipeGesture [threshold]="95" [horizontalSwipe]="false" [verticalSwipe]="true"
        [trackProgress]="true" (swipeProgress)="onSwipeProgress($event, 'foryou')" (swipe)="onSwipe($event, 'foryou')"
        (swipeEnd)="onSwipeEnd('foryou')">
        @if (loading()) {
        <div class="loading-container fullscreen-loading">
          <mat-spinner diameter="40"></mat-spinner>
        </div>
        } @else {
        @let clip = currentForYouClip();
        @if (clip) {
        <div class="swipe-card" [class.animating]="isCardAnimating('foryou')"
          [style.transform]="getCardTransform('foryou')">
          <app-clips-video-card [event]="clip" [active]="selectedTabIndex() === 2"
            (commentsClick)="openComments(clip)" />
        </div>
        <div class="swipe-position">{{ forYouIndex() + 1 }} / {{ forYouClips().length }}</div>
        } @else {
        <div class="empty-state fullscreen-empty">
          <mat-icon>movie</mat-icon>
          <p>No clips found for current filters.</p>
        </div>
        }
        }
      </div>
    </mat-tab>
  </mat-tab-group>
</div>

@if (showSettingsDialog()) {
<app-clips-settings-dialog (closed)="onSettingsDialogClosed($event)"></app-clips-settings-dialog>
}

@if (commentsOpen() && commentsEvent(); as clipEvent) {
<button class="comments-backdrop" (click)="closeComments()" aria-label="Close comments"></button>
<div class="comments-sheet" role="dialog" aria-label="Clip comments">
  <div class="comments-header">
    <h3>Comments</h3>
    <button mat-icon-button (click)="closeComments()" aria-label="Close comments">
      <mat-icon>close</mat-icon>
    </button>
  </div>
  <div class="comments-content">
    <app-comments-list [event]="clipEvent" [autoExpand]="true"></app-comments-list>
  </div>
</div>
}