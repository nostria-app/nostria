@if (!app.authenticated()) {
<div class="unauthenticated-state">
  <mat-icon>account_circle</mat-icon>
  <h2>Sign in to see your Summary</h2>
  <p>Get a quick overview of what's happening in your network.</p>
</div>
} @else {
<div class="summary-page">
  <!-- Panel Header -->
  <div class="panel-header">
    <h2 class="panel-title title-font">Summary</h2>
    <button mat-stroked-button cdkOverlayOrigin #timeOrigin="cdkOverlayOrigin" (click)="toggleTimePanel()"
      class="time-badge-btn" matTooltip="Change time range">
      <mat-icon>schedule</mat-icon>
      <span>{{ selectedTimeLabel() }}</span>
    </button>
    <span class="panel-header-spacer"></span>
    <div class="panel-actions">
      <!-- List Filter -->
      <app-list-filter-menu storageKey="summary" [showPublicOption]="false" defaultFilter="following"
        [initialFilter]="urlListFilter()" (filterChanged)="onFilterChanged($event)"
        (followSetChanged)="onFollowSetChanged($event)" />

      @if (isFetching()) {
      <mat-spinner diameter="20" strokeWidth="3"></mat-spinner>
      } @else {
      <button mat-icon-button (click)="refresh()" matTooltip="Refresh" [disabled]="isLoading()">
        <mat-icon>refresh</mat-icon>
      </button>
      }
    </div>
  </div>

  <!-- Time Range Panel Overlay -->
  <ng-template cdkConnectedOverlay [cdkConnectedOverlayOrigin]="timeOrigin" [cdkConnectedOverlayOpen]="timePanelOpen()"
    [cdkConnectedOverlayPositions]="timePanelPositions" [cdkConnectedOverlayHasBackdrop]="true"
    cdkConnectedOverlayBackdropClass="time-panel-backdrop" (backdropClick)="closeTimePanel()">
    <div class="time-panel">
      <div class="time-panel-header">
        <mat-icon>schedule</mat-icon>
        <span>Time Range</span>
      </div>
      <div class="time-panel-content">
        <button mat-stroked-button class="time-option" [class.active]="selectedPreset() === null"
          (click)="resetToLastVisit()">
          <mat-icon>history</mat-icon>
          <span>Since last visit</span>
          @if (selectedPreset() === null) {
          <mat-icon class="check-icon">check</mat-icon>
          }
        </button>
        <mat-divider></mat-divider>
        @for (preset of timePresets; track preset.hours) {
        <button mat-stroked-button class="time-option" [class.active]="selectedPreset() === preset.hours"
          (click)="selectPreset(preset.hours)">
          <span>{{ preset.label }}</span>
          @if (selectedPreset() === preset.hours) {
          <mat-icon class="check-icon">check</mat-icon>
          }
        </button>
        }
      </div>
    </div>
  </ng-template>

  @if (isLoading()) {
  <div class="loading-state">
    <mat-spinner diameter="48"></mat-spinner>
    <p>Loading your summary...</p>
  </div>
  } @else {

  <!-- Empty States -->
  @if (!hasFollowing()) {
  <section class="empty-state">
    <mat-icon>group_add</mat-icon>
    <h3>Start Following People</h3>
    <p>Follow people to see activity summaries here.</p>
    <a mat-flat-button routerLink="/people/discover">
      <mat-icon>explore</mat-icon>
      Discover People
    </a>
  </section>
  } @else if (!hasActivity()) {
  <section class="no-activity-state">
    <mat-icon>inbox</mat-icon>
    <h3>No New Activity</h3>
    <p>There's no new activity from the people you follow during this time period.</p>
  </section>
  } @else {
  <!-- Summary Content - Scrollable -->
  <div class="summary-content">
    <!-- Who Posted Expander -->
    @if (activePosters().length > 0) {
    <mat-expansion-panel class="summary-panel who-posted-panel" [expanded]="!postersCollapsed()"
      (expandedChange)="postersCollapsed.set(!$event)">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>group</mat-icon>
          <span>Who Posted</span>
          <span class="panel-count-badge">{{ totalPostersCount() }}</span>
        </mat-panel-title>
        <mat-panel-description>
          @if (selectedPosters().size > 0) {
          <span class="filter-active-hint">{{ selectedPosters().size }} selected</span>
          } @else {
          <span class="filter-hint-inline">Click to filter</span>
          }
        </mat-panel-description>
      </mat-expansion-panel-header>
      <div class="panel-content">
        <div class="poster-grid">
          @for (poster of activePosters(); track poster.pubkey) {
          <div class="poster-card" [class.selected]="isPosterSelected(poster.pubkey)"
            (click)="togglePosterSelection(poster.pubkey)" (keydown.enter)="togglePosterSelection(poster.pubkey)"
            (keydown.space)="togglePosterSelection(poster.pubkey); $event.preventDefault()" role="checkbox" tabindex="0"
            [attr.aria-checked]="isPosterSelected(poster.pubkey)">
            <div class="poster-avatar">
              <app-user-profile [pubkey]="poster.pubkey" view="icon" [disableLink]="true"
                [disableHoverCard]="true"></app-user-profile>
              @if (isPosterSelected(poster.pubkey)) {
              <div class="selection-indicator">
                <mat-icon>check_circle</mat-icon>
              </div>
              }
            </div>
            <div class="poster-stats-badge">
              <span class="stat-item" matTooltip="Notes">
                <mat-icon>chat</mat-icon>
                {{ poster.notesCount }}
              </span>
              @if (poster.articlesCount > 0) {
              <span class="stat-item" matTooltip="Articles">
                <mat-icon>article</mat-icon>
                {{ poster.articlesCount }}
              </span>
              }
              @if (poster.mediaCount > 0) {
              <span class="stat-item" matTooltip="Media">
                <mat-icon>perm_media</mat-icon>
                {{ poster.mediaCount }}
              </span>
              }
            </div>
          </div>
          }
        </div>
        @if (hasMorePosters()) {
        <div class="load-more-container compact">
          <button mat-stroked-button (click)="loadMorePosters(); $event.stopPropagation()">
            <mat-icon>expand_more</mat-icon>
            Load More
          </button>
        </div>
        }
      </div>
    </mat-expansion-panel>
    }

    <!-- Articles Expander -->
    @if (articleEvents().length > 0) {
    <mat-expansion-panel class="summary-panel articles-panel" [expanded]="!articlesCollapsed()"
      (expandedChange)="articlesCollapsed.set(!$event)">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>article</mat-icon>
          <span>Articles</span>
          <span class="panel-count-badge">{{ articleEvents().length }}</span>
        </mat-panel-title>
        <mat-panel-description>
          <span class="filter-hint-inline">Long-form articles published recently</span>
        </mat-panel-description>
      </mat-expansion-panel-header>
      <div class="panel-content">
        <div class="articles-grid">
          @for (event of articleEvents(); track event.id) {
          <div class="article-card" (click)="openArticle(event)" (keydown.enter)="openArticle(event)" tabindex="0"
            role="button">
            @if (getArticleImage(event); as imageUrl) {
            <div class="article-image">
              <img [src]="imageUrl" alt="Article cover" loading="lazy" />
            </div>
            } @else {
            <div class="article-image article-placeholder">
              <mat-icon>article</mat-icon>
            </div>
            }
            <div class="article-content">
              <h3 class="article-title">{{ getArticleTitle(event) }}</h3>
              <p class="article-summary">{{ getArticleSummary(event) }}</p>
              <div class="article-footer">
                <app-user-profile [pubkey]="event.pubkey" view="icon" class="article-author"></app-user-profile>
                <span class="article-time">{{ event.created_at | ago }}</span>
              </div>
            </div>
          </div>
          }
        </div>
      </div>
    </mat-expansion-panel>
    }

    <!-- Media Expander -->
    @if (mediaEvents().length > 0) {
    <mat-expansion-panel class="summary-panel media-panel" [expanded]="!mediaCollapsed()"
      (expandedChange)="mediaCollapsed.set(!$event)">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>perm_media</mat-icon>
          <span>Media</span>
          <span class="panel-count-badge">{{ mediaEvents().length }}</span>
        </mat-panel-title>
        <mat-panel-description>
          <span class="filter-hint-inline">Photos and videos shared recently</span>
        </mat-panel-description>
      </mat-expansion-panel-header>
      <div class="panel-content">
        <div class="media-grid">
          @for (event of mediaEvents(); track event.id) {
          @if (getMediaUrl(event); as mediaUrl) {
          <div class="media-card" (click)="openMediaDialog($event, event)" tabindex="0" role="button"
            (keydown.enter)="openMediaDialog($any($event), event)">
            <div class="media-preview">
              @if (isVideoUrl(mediaUrl)) {
              <div class="video-indicator">
                <mat-icon>play_circle</mat-icon>
              </div>
              }
              <img [src]="mediaUrl" alt="Media content" title="View media" loading="lazy" />
            </div>
            <div class="media-overlay">
              <app-user-profile [pubkey]="event.pubkey" view="icon" class="media-author"></app-user-profile>
              <a class="media-time" (click)="layout.openGenericEvent(event.id); $event.stopPropagation()"
                tabindex="0">{{ event.created_at | ago }}</a>
            </div>
          </div>
          }
          }
        </div>
      </div>
    </mat-expansion-panel>
    }

    <!-- Profile Updates Expander -->
    @if (profileUpdates().length > 0) {
    <mat-expansion-panel class="summary-panel profiles-panel" [expanded]="!profilesCollapsed()"
      (expandedChange)="profilesCollapsed.set(!$event)">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>badge</mat-icon>
          <span>Profile Updates</span>
          <span class="panel-count-badge">{{ profileUpdates().length }}</span>
        </mat-panel-title>
        <mat-panel-description>
          <span class="filter-hint-inline">People who updated their profiles</span>
        </mat-panel-description>
      </mat-expansion-panel-header>
      <div class="panel-content">
        <div class="poster-grid">
          @for (pubkey of profileUpdates(); track pubkey) {
          <a class="poster-card" (click)="onProfileClick($event, pubkey)">
            <div class="poster-avatar">
              <app-user-profile [pubkey]="pubkey" view="icon"></app-user-profile>
            </div>
          </a>
          }
        </div>
      </div>
    </mat-expansion-panel>
    }

    <!-- Timeline Expander -->
    <mat-expansion-panel class="summary-panel timeline-panel" [expanded]="!timelineCollapsed()"
      (expandedChange)="timelineCollapsed.set(!$event)">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>schedule</mat-icon>
          <span>Timeline</span>
          @if (totalTimelineCount() > 0) {
          <span class="panel-count-badge">{{ totalTimelineCount() }}</span>
          }
        </mat-panel-title>
        <mat-panel-description>
          <span class="filter-hint-inline">Recent activity from people you follow</span>
        </mat-panel-description>
      </mat-expansion-panel-header>
      <div class="panel-content">
        @if (timelineEvents().length > 0 || isFilterMode()) {
        <div class="section-header-with-actions">
          <div class="timeline-filter-actions">
            <button mat-stroked-button (click)="toggleGmFilter()" [class.active]="gmFilterMode() !== 'all'"
              [class.exclude]="gmFilterMode() === 'exclude'" [matTooltip]="getGmFilterTooltip()">
              <mat-icon>wb_sunny</mat-icon>
              {{ getGmFilterLabel() }}
            </button>
            @if (isFilterMode()) {
            <button mat-stroked-button (click)="clearPosterFilter(); clearGmFilter(); clearListFilter()"
              class="clear-filter-btn">
              <mat-icon>clear</mat-icon>
              Clear All Filters
            </button>
            }
          </div>
        </div>
        @if (timelineEvents().length > 0) {
        <div class="timeline">
          @for (event of timelineEvents(); track event.id) {
          <div class="timeline-item" (click)="openEventDialog($event, event)"
            (keydown.enter)="openEventDialog($any($event), event)" tabindex="0" role="button">
            <app-user-profile [pubkey]="event.pubkey" view="icon" class="timeline-author"></app-user-profile>
            <div class="timeline-content">
              <div class="timeline-header">
                <span class="timeline-type">{{ getEventKindLabel(event.kind) }}</span>
              </div>
              <p class="timeline-preview">{{ getEventPreview(event) }}</p>
            </div>
            <span class="timeline-time-external">{{ event.created_at | ago }}</span>
          </div>
          }
        </div>
        @if (hasMoreTimelineEvents()) {
        <div class="load-more-container">
          <button mat-stroked-button (click)="loadMoreTimelineEvents()">
            <mat-icon>expand_more</mat-icon>
            Load More
          </button>
          <!-- Sentinel for IntersectionObserver auto-loading -->
          <div #loadMoreSentinel class="load-more-sentinel"></div>
        </div>
        }
        } @else {
        <div class="no-filter-results">
          <mat-icon>filter_list_off</mat-icon>
          <p>No posts match the current filter.</p>
        </div>
        }
        } @else {
        <div class="no-filter-results">
          <mat-icon>schedule</mat-icon>
          <p>No activity in timeline yet.</p>
        </div>
        }
      </div>
    </mat-expansion-panel>
  </div>
  }
  }
</div>
}