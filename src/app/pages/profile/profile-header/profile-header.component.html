<div class="profile-header-container">
  <div class="profile-banner" [class.clickable]="profile()?.data.banner" [style.background-image]="
        profile()?.data.banner ? 'url(' + profile()!.data.banner + ')' : getDefaultBanner()
      " (click)="profile()?.data.banner && layout.openProfileBanner(profile()!)"
    (keydown.enter)="profile()?.data.banner && layout.openProfileBanner(profile()!)"
    (keydown.space)="profile()?.data.banner && layout.openProfileBanner(profile()!)"
    [tabindex]="profile()?.data.banner ? 0 : -1" [attr.role]="profile()?.data.banner ? 'button' : null"
    [attr.aria-label]="profile()?.data.banner ? 'View full size banner image' : null"></div>
  <div class="profile-info-container" [class.mobile]="layoutService.isHandset()">
    <div class="profile-avatar-wrapper">
      <!-- Muted you label - shown to left of avatar on mobile -->
      @if (hasMutedMe() && layoutService.isHandset()) {
      <span class="muted-you-label">muted you</span>
      }

      <div class="profile-avatar" [class.clickable]="profile()?.data.picture" [class.mobile]="layoutService.isHandset()"
        (click)="profile()?.data.picture && layout.openProfilePicture(profile()!)"
        (keydown.enter)="profile()?.data.picture && layout.openProfilePicture(profile()!)"
        (keydown.space)="profile()?.data.picture && layout.openProfilePicture(profile()!)"
        [tabindex]="profile()?.data.picture ? 0 : -1" [attr.role]="profile()?.data.picture ? 'button' : null"
        [attr.aria-label]="profile()?.data.picture ? 'View full size profile picture' : null">
        @if (profile()?.data.picture) {
        <img [src]="profile()!.data.picture" alt="Profile picture" class="avatar-image" />
        } @else {
        <mat-icon class="default-avatar">account_circle</mat-icon>
        }
      </div>

      <!-- Muted you label - shown below avatar on desktop -->
      @if (hasMutedMe() && !layoutService.isHandset()) {
      <span class="muted-you-label">muted you</span>
      }

      <!-- Badges Section positioned relative to avatar -->
      @if (hasAcceptedBadges()) {
      <div class="profile-badges">
        @for (badge of topBadges(); track $index) {
        @let parsedBadge = parsedBadges()[$index];
        @let isTimedOut = isBadgeTimedOut()[$index];
        @if (!isTimedOut) {
        <a (click)="navigateToBadges($event)" class="badge-item"
          (mouseenter)="onBadgeMouseEnter($event, badge)" (mouseleave)="onBadgeMouseLeave()">
          @if (isBadgeFailed()[$index]) {
          <!-- Show failed badge placeholder -->
          <div class="badge-placeholder badge-failed" title="Failed to load badge">
            <mat-icon>error_outline</mat-icon>
          </div>
          } @else if (parsedBadge && (parsedBadge.thumb || parsedBadge.image)) {
          <!-- Show badge image when loaded -->
          <img [src]="parsedBadge.thumb || parsedBadge.image" [alt]="parsedBadge.name || 'Badge'"
            [title]="parsedBadge.name || 'Badge'" class="badge-image" loading="lazy"
            (error)="onBadgeImageError($event)" />
          } @else if (isBadgeLoading()[$index]) {
          <!-- Show loading spinner while badge is loading -->
          <div class="badge-loading" title="Loading badge...">
            <mat-spinner diameter="32"></mat-spinner>
          </div>
          } @else {
          <!-- Show default placeholder -->
          <div class="badge-placeholder" [title]="parsedBadge?.name || 'Badge'">
            <mat-icon>military_tech</mat-icon>
          </div>
          }
        </a>
        }
        }
      </div>
      }
    </div>

    <div class="profile-info">
      <div class="profile-menu-actions">
        @if (isOwnProfile()) {
        <button mat-flat-button routerLink="edit" class="hide-small">
          <mat-icon>edit</mat-icon> Edit Profile
        </button>
        } @else {
        @if (!isFollowing()) {

        <button mat-icon-button class="show-small" [matTooltip]="'Follow'" (click)="followUser()">
          <mat-icon>person_add</mat-icon>
        </button>

        <button mat-flat-button class="hide-small" (click)="followUser()">
          <mat-icon>person_add</mat-icon> {{ isFollowingMe() ? 'Follow Back' : 'Follow' }}
        </button>
        }
        }
      </div>

      <h1 class="profile-name">
        {{ name() }}
        @if (isPremium()) {
        @if (isPremiumPlus()) {
        <mat-icon class="premium-indicator premium-plus"
          matTooltip="This user is a Nostria Premium+ subscriber">workspace_premium</mat-icon>
        } @else {
        <mat-icon class="premium-indicator" matTooltip="This user is a Nostria Premium subscriber">star</mat-icon>
        }
        }
        @if (isFavorite()) {
        <mat-icon class="favorite-indicator" matTooltip="Favorite User">star</mat-icon>
        }
        @if (trustEnabled() && trustRank()) {
        <span class="trust-rank" [matTooltip]="'Trust Rank: ' + trustRank() + '/100'">
          <mat-icon>verified_user</mat-icon>
          {{ trustRank() }}
        </span>
        }
      </h1>

      <div class="profile-item pointer" title="{{ npub() }}">
        <mat-icon>key</mat-icon>
        <span (mouseenter)="showProfileQrCodeHandler()" (mouseleave)="hideProfileQrCodeHandler()"
          (click)="copyNpubToClipboard()" (keydown.enter)="copyNpubToClipboard()"
          (keydown.space)="copyNpubToClipboard()" tabindex="0" role="button"
          [attr.aria-label]="'Copy ' + npub() + ' to clipboard'">{{ npub() }}</span>
      </div>

      @if (showProfileQrCode()) {
      <div class="qr-code-container" (click)="copyNpubToClipboard()" (keydown.enter)="copyNpubToClipboard()"
        (keydown.space)="copyNpubToClipboard()" tabindex="0" role="button" title="Click to copy npub to clipboard"
        [attr.aria-label]="'Copy ' + npub() + ' to clipboard'">
        <qr-code [qrdata]="'nostr:' + npub()!" [width]="256" [errorCorrectionLevel]="'medium'"></qr-code>
      </div>
      }

      @if (profile()) {
      @let verifiedId = verifiedIdentifier();

      @if (verifiedId.value) {
      <div class="profile-item pointer" title="{{ verifiedId.status }}">
        @if (verifiedId.valid) {
        <mat-icon class="verified-icon">verified</mat-icon>
        } @else {
        <mat-icon class="verified-icon verified-icon-error">verified_off</mat-icon>
        }
        <span [class.strikethrough]="!verifiedId.valid" (click)="copyNip05ToClipboard()" (keydown.enter)="copyNip05ToClipboard()"
          (keydown.space)="copyNip05ToClipboard()" tabindex="0" role="button"
          [attr.aria-label]="'Copy ' + verifiedId.value + ' to clipboard'">{{ verifiedId.value }}</span>

        @if (verifiedFaviconUrl() && faviconVisible()) {
        <img [src]="verifiedFaviconUrl()" alt="favicon" class="verified-favicon" (error)="onFaviconError($event)" />
        }
      </div>
      }

      @let lightningAddress = profile()?.data.lud16 || profile()?.data.lud06;

      @if (lightningAddress) {
      <div class="profile-item lightning-item">
        <mat-icon>⚡️</mat-icon>
        <span (mouseenter)="showQrCodeHandler()" (mouseleave)="hideQrCodeHandler()"
          (click)="copyLightningAddressToClipboard()" (keydown.enter)="copyLightningAddressToClipboard()"
          (keydown.space)="copyLightningAddressToClipboard()" tabindex="0" role="button"
          [attr.aria-label]="'Copy ' + lightningAddress + ' to clipboard'">{{ lightningAddress }}</span>
      </div>

      @if (showQrCode()) {
      <div class="qr-code-container" (click)="copyLightningAddressToClipboard()"
        (keydown.enter)="copyLightningAddressToClipboard()" (keydown.space)="copyLightningAddressToClipboard()"
        tabindex="0" role="button" title="Click to copy lightning address to clipboard"
        [attr.aria-label]="'Copy ' + lightningAddress + ' to clipboard'">
        <qr-code [qrdata]="lightningAddress" [width]="256" [errorCorrectionLevel]="'medium'"></qr-code>
      </div>
      }
      }
      }

      @if (profile()?.data.website) {
      <div class="profile-item" title="{{ websiteUrl() }}">
        <mat-icon>link</mat-icon>
        <span><a [href]="websiteUrl()" target="_blank" rel="noopener noreferrer">{{
            profile()!.data.website
            }}</a></span>
      </div>
      }

      @if (profile()?.data.about) {
      <div class="profile-bio">
        <div class="bio-text" [class.bio-expanded]="isBioExpanded()">
          <app-bio-content [content]="displayedBio()"></app-bio-content>
        </div>
        @if (shouldShowExpander()) {
        @if (isBioExpanded()) {
        <button mat-button class="bio-expand-btn" (click)="toggleBioExpansion()">
          <mat-icon>expand_less</mat-icon>
          Show less
        </button>
        } @else {
        <button mat-button class="bio-expand-btn" (click)="toggleBioExpansion()">
          <mat-icon>expand_more</mat-icon>
          Show more
        </button>
        }
        }
      </div>
      }

      <div class="profile-extra-info">
        <a class="following-count" [routerLink]="'following'" [queryParamsHandling]="'preserve'">
          Following {{ profileState.followingList().length }}
        </a>

        <!-- @if (profileState.relay?.userRelaysFound()) { -->
        @if (getUserRelays() && getUserRelays().length > 0) {
        <a class="following-count" [routerLink]="'relays'" [queryParamsHandling]="'preserve'">
          Relays {{ getUserRelays().length }}
        </a>
        } @else if (!isLoadingRelays()) {
        <span class="inline-error"> <mat-icon>error</mat-icon>&nbsp; No relays found! </span>
        }

        @if (badgeCount() > 0) {
        <a class="following-count" (click)="navigateToBadges($event)">
          Badges {{ badgeCount() }}
        </a>
        }
      </div>
    </div>
  </div>
</div>