<div class="profile-header-container">
  <div class="profile-banner" [class.clickable]="profile()?.data.banner" [style.background-image]="
        profile()?.data.banner ? 'url(' + profile()!.data.banner + ')' : getDefaultBanner()
      " (click)="profile()?.data.banner && layout.openProfileBanner(profile()!)"
    (keydown.enter)="profile()?.data.banner && layout.openProfileBanner(profile()!)"
    (keydown.space)="profile()?.data.banner && layout.openProfileBanner(profile()!)"
    [tabindex]="profile()?.data.banner ? 0 : -1" [attr.role]="profile()?.data.banner ? 'button' : null"
    [attr.aria-label]="profile()?.data.banner ? 'View full size banner image' : null"></div>
  <div class="profile-info-container" [class.mobile]="layoutService.isHandset()">
    <div class="profile-avatar-wrapper">
      <div class="profile-avatar" [class.clickable]="profile()?.data.picture" [class.mobile]="layoutService.isHandset()"
        (click)="profile()?.data.picture && layout.openProfilePicture(profile()!)"
        (keydown.enter)="profile()?.data.picture && layout.openProfilePicture(profile()!)"
        (keydown.space)="profile()?.data.picture && layout.openProfilePicture(profile()!)"
        [tabindex]="profile()?.data.picture ? 0 : -1" [attr.role]="profile()?.data.picture ? 'button' : null"
        [attr.aria-label]="profile()?.data.picture ? 'View full size profile picture' : null">
        @if (profile()?.data.picture) {
        <img [src]="profile()!.data.picture" alt="Profile picture" class="avatar-image" />
        } @else {
        <mat-icon class="default-avatar">account_circle</mat-icon>
        }
      </div>

      <!-- Badges Section positioned relative to avatar -->
      @if (hasAcceptedBadges()) {
      <div class="profile-badges">
        @for (badge of topBadges(); track $index) {
        @if (parsedBadges()[$index]; as parsedBadge) {
        <a [routerLink]="['/p', npub() || pubkey(), 'badges']" class="badge-item"
          (mouseenter)="onBadgeMouseEnter($event, badge)" (mouseleave)="onBadgeMouseLeave()">
          @if (parsedBadge.thumb || parsedBadge.image) {
          <img [src]="parsedBadge.thumb || parsedBadge.image" class="badge-image" loading="lazy"
            (error)="onBadgeImageError($event)" />
          } @else {
          <div class="badge-placeholder" [title]="parsedBadge.name">
            <mat-icon>military_tech</mat-icon>
          </div>
          }
        </a>
        } @else if (!isBadgeFailed()[$index]) {
        <a [routerLink]="['/p', npub() || pubkey(), 'badges']" class="badge-item">
          <div class="badge-loading" title="Loading badge...">
            <mat-spinner diameter="32"></mat-spinner>
          </div>
        </a>
        }
        }
      </div>
      }
    </div>

    <div class="profile-info">
      <div class="profile-menu-actions">
        @if (isOwnProfile()) {
        <button mat-flat-button routerLink="edit" class="hide-small">
          <mat-icon>edit</mat-icon> Edit Profile
        </button>
        } @else {
        @if (!isFollowing()) {
        <button mat-flat-button class="hide-small" (click)="followUser()">
          <mat-icon>person_add</mat-icon> {{ isFollowingMe() ? 'Follow Back' : 'Follow' }}
        </button>
        } @else {
        <!-- <button mat-flat-button color="warn" (click)="unfollowUser()">
                    <mat-icon>person_remove</mat-icon> Unfollow
                </button> -->
        }

        <!-- <button class="hide-tiny" mat-stroked-button (click)="layoutService.openSendMessage(currentPubkey())">
          <mat-icon>message</mat-icon>
          <span class="hide-small"> Message</span>
        </button> -->

        <button class="hide-tiny" [matTooltip]="'Send private message'" mat-icon-button
          (click)="layoutService.openSendMessage(pubkey())">
          <mat-icon>message</mat-icon>
        </button>

        <!-- Zap Button -->
        @if (hasLightningAddress()) {
        <app-zap-button [recipientPubkey]="pubkey()" class="hide-tiny"> </app-zap-button>
        }
        }

        <button mat-icon-button class="profile-menu-button" [matMenuTriggerFor]="profileMenu">
          <mat-icon>more_vert</mat-icon>
        </button>
      </div>

      <h1 class="profile-name">
        {{ name() }}
        @if (isPremium()) {
        <mat-icon class="premium-indicator"
          matTooltip="This user is a Nostria Premium or Premium+ subscriber">star</mat-icon>
        }
        @if (isFavorite()) {
        <mat-icon class="favorite-indicator" matTooltip="Favorite User">star</mat-icon>
        }
        @if (trustEnabled() && trustRank()) {
        <span class="trust-rank" [matTooltip]="'Trust Rank: ' + trustRank() + '/100'">
          <mat-icon>verified_user</mat-icon>
          {{ trustRank() }}
        </span>
        }
      </h1>

      <div class="profile-item pointer" title="{{ npub() }}">
        <mat-icon>key</mat-icon>
        <span (mouseenter)="showProfileQrCodeHandler()" (mouseleave)="hideProfileQrCodeHandler()"
          (click)="copyNpubToClipboard()" (keydown.enter)="copyNpubToClipboard()"
          (keydown.space)="copyNpubToClipboard()" tabindex="0" role="button"
          [attr.aria-label]="'Copy ' + npub() + ' to clipboard'">{{ npub() }}</span>
      </div>

      @if (showProfileQrCode()) {
      <div class="qr-code-container" (click)="copyNpubToClipboard()" (keydown.enter)="copyNpubToClipboard()"
        (keydown.space)="copyNpubToClipboard()" tabindex="0" role="button" title="Click to copy npub to clipboard"
        [attr.aria-label]="'Copy ' + npub() + ' to clipboard'">
        <qr-code [qrdata]="'nostr:' + npub()!" [width]="256" [errorCorrectionLevel]="'medium'"></qr-code>
      </div>
      }

      @if (profile()) {
      @let verifiedId = verifiedIdentifier();

      @if (verifiedId.value) {
      <div class="profile-item" title="{{ verifiedId.status }}">
        @if (verifiedId.valid) {
        <mat-icon class="verified-icon">verified</mat-icon>
        } @else {
        <mat-icon class="verified-icon verified-icon-error">verified_off</mat-icon>
        }
        <span [class.strikethrough]="!verifiedId.valid">{{ verifiedId.value }}</span>
      </div>
      }

      @let lightningAddress = profile()?.data.lud16 || profile()?.data.lud06;

      @if (lightningAddress) {
      <div class="profile-item lightning-item">
        <mat-icon>⚡️</mat-icon>
        <span (mouseenter)="showQrCodeHandler()" (mouseleave)="hideQrCodeHandler()"
          (click)="copyLightningAddressToClipboard()" (keydown.enter)="copyLightningAddressToClipboard()"
          (keydown.space)="copyLightningAddressToClipboard()" tabindex="0" role="button"
          [attr.aria-label]="'Copy ' + lightningAddress + ' to clipboard'">{{ lightningAddress }}</span>
      </div>

      @if (showQrCode()) {
      <div class="qr-code-container" (click)="copyLightningAddressToClipboard()"
        (keydown.enter)="copyLightningAddressToClipboard()" (keydown.space)="copyLightningAddressToClipboard()"
        tabindex="0" role="button" title="Click to copy lightning address to clipboard"
        [attr.aria-label]="'Copy ' + lightningAddress + ' to clipboard'">
        <qr-code [qrdata]="lightningAddress" [width]="256" [errorCorrectionLevel]="'medium'"></qr-code>
      </div>
      }
      }
      }

      @if (profile()?.data.website) {
      <div class="profile-item" title="{{ websiteUrl() }}">
        <mat-icon>link</mat-icon>
        <span><a [href]="websiteUrl()" target="_blank" rel="noopener noreferrer">{{
            profile()!.data.website
            }}</a></span>
      </div>
      }

      @if (profile()?.data.about) {
      <div class="profile-bio">
        <div class="bio-text" [class.bio-expanded]="isBioExpanded()">{{ displayedBio() }}</div>
        @if (shouldShowExpander()) {
        @if (isBioExpanded()) {
        <button mat-button class="bio-expand-btn" (click)="toggleBioExpansion()">
          <mat-icon>expand_less</mat-icon>
          Show less
        </button>
        } @else {
        <button mat-button class="bio-expand-btn" (click)="toggleBioExpansion()">
          <mat-icon>expand_more</mat-icon>
          Show more
        </button>
        }
        }
      </div>
      }

      <div class="profile-extra-info">
        <a class="following-count" [routerLink]="'following'" [queryParamsHandling]="'preserve'">
          Following {{ profileState.followingList().length }}
        </a>

        <!-- @if (profileState.relay?.userRelaysFound()) { -->
        @if (
        getUserRelays() && getUserRelays().length > 0
        ) {
        <a class="following-count" [routerLink]="'relays'" [queryParamsHandling]="'preserve'">
          Relays {{ getUserRelays().length }}
        </a>
        } @else {
        <span class="inline-error"> <mat-icon>error</mat-icon>&nbsp; No relays found! </span>
        }

        @if (badgeCount() > 0) {
        <a class="following-count" [routerLink]="'badges'" [queryParamsHandling]="'preserve'">
          Badges {{ badgeCount() }}
        </a>
        }
      </div>

      <mat-menu #profileMenu="matMenu">
        @if (!isOwnProfile()) {
        @if (!isFollowing()) {
        <button mat-menu-item (click)="followUser()">
          <mat-icon>person_add</mat-icon>
          <span>{{ isFollowingMe() ? 'Follow Back' : 'Follow' }}</span>
        </button>
        } @else {
        <button mat-menu-item (click)="unfollowUser()">
          <mat-icon>person_remove</mat-icon>
          <span>Unfollow</span>
        </button>
        }

        <button mat-menu-item (click)="toggleFavorite()">
          <mat-icon>{{ isFavorite() ? 'heart_minus' : 'heart_plus' }}</mat-icon>
          <span>{{ isFavorite() ? 'Unfavorite' : 'Favorite' }}</span>
        </button>

        @if (hasLightningAddress()) {
        <button mat-menu-item (click)="zapUser()">
          <mat-icon>bolt</mat-icon>
          <span>Zap</span>
        </button>
        }
        }

        @if (isOwnProfile()) {
        <button class="hide-small" mat-menu-item routerLink="edit" [queryParamsHandling]="'preserve'">
          <mat-icon>edit</mat-icon>
          <span>Edit Profile</span>
        </button>
        }

        <button mat-menu-item (click)="layoutService.openSendMessage(pubkey())">
          <mat-icon>message</mat-icon>
          <span>Message</span>
        </button>

        <button mat-menu-item [matMenuTriggerFor]="copyMenu">
          <mat-icon>content_copy</mat-icon>
          <span>Copy</span>
        </button>

        <button mat-menu-item [matMenuTriggerFor]="shareMenu">
          <mat-icon>share</mat-icon>
          <span>Share</span>
        </button>

        <button mat-menu-item [matMenuTriggerFor]="publishEventMenu">
          <mat-icon>publish</mat-icon>
          <span>Publish Event</span>
        </button>

        <button mat-menu-item routerLink="details" [queryParamsHandling]="'preserve'">
          <mat-icon>info</mat-icon>
          <span>Details</span>
        </button>

        @if (!isOwnProfile()) {
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="reportUser()">
          <mat-icon>warning</mat-icon>
          <span>Report User</span>
        </button>
        @if (isUserBlocked()) {
        <button mat-menu-item (click)="blockUser()">
          <mat-icon>check_circle</mat-icon>
          <span>Unblock User</span>
        </button>
        } @else {
        <button mat-menu-item (click)="blockUser()">
          <mat-icon>block</mat-icon>
          <span>Block User</span>
        </button>
        }
        }
      </mat-menu>

      <mat-menu #copyMenu="matMenu">
        <button mat-menu-item (click)="copyInviteLink()">
          <mat-icon>person_add</mat-icon>
          <span>Invite Link</span>
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="layout.copyToClipboard(this.npub(), 'npub')">
          <span>Identifier (npub)</span>
        </button>
        <button mat-menu-item (click)="layout.copyToClipboard(this.pubkey(), 'hex')">
          <span>Identifier (hex)</span>
        </button>
        <button mat-menu-item (click)="layout.copyToClipboard(this.pubkey(), 'nprofile')">
          <span>Identifier (nprofile)</span>
        </button>
        <button mat-menu-item (click)="copyProfileData()">
          <span>Profile Data</span>
        </button>
        <button mat-menu-item (click)="layout.copyProfileUrl(this.npub(), this.profileUsername())">
          <mat-icon>link</mat-icon>
          <span>Profile URL</span>
        </button>
        <button mat-menu-item (click)="copyFollowingList()">
          <span>Following List</span>
        </button>
        <button mat-menu-item (click)="copyRelayList()">
          <span>Relay List</span>
        </button>
      </mat-menu>

      <mat-menu #shareMenu="matMenu">
        <button mat-menu-item (click)="shareInviteLink()">
          <mat-icon>person_add</mat-icon>
          <span>Invitation</span>
        </button>
        <button mat-menu-item (click)="layout.shareProfile(this.npub(), this.name())">
          <mat-icon>share</mat-icon>
          <span>Profile</span>
        </button>

      </mat-menu>

      <mat-menu #publishEventMenu="matMenu">
        <button mat-menu-item (click)="publishProfileEvent()">
          <mat-icon>account_circle</mat-icon>
          <span>Profile</span>
        </button>
        <button mat-menu-item (click)="publishRelayListEvent()">
          <mat-icon>dns</mat-icon>
          <span>Relay List</span>
        </button>
        <button mat-menu-item (click)="publishFollowingListEvent()">
          <mat-icon>people</mat-icon>
          <span>Following List</span>
        </button>
      </mat-menu>
    </div>
  </div>
</div>