<!-- Header template - used by RightPanelHeaderService when in right panel -->
<ng-template #headerTemplate>
  <div class="panel-header">
    <button mat-icon-button (click)="goBack()" matTooltip="Back">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h2 class="panel-title title-font">{{ profileDisplayName() }}</h2>
    <span class="panel-header-spacer"></span>

    @if (!isOwnProfile() && !isLoading() && !error()) {
    <!-- Send private message button -->
    <button mat-icon-button matTooltip="Send private message" (click)="openSendMessage()">
      <mat-icon>message</mat-icon>
    </button>

    <!-- Zap Button -->
    @if (hasLightningAddress()) {
    <app-zap-button [recipientPubkey]="pubkey()"></app-zap-button>
    }

    <!-- Gift Premium Button - Only show if user doesn't have premium -->
    @if (!isPremium()) {
    <button mat-icon-button matTooltip="Gift Premium subscription" (click)="giftPremium()">
      <mat-icon>card_giftcard</mat-icon>
    </button>
    }
    }

    <button mat-icon-button cdkOverlayOrigin #filterTrigger="cdkOverlayOrigin" (click)="toggleFilterPanel()"
      matTooltip="Display options">
      <mat-icon>tune</mat-icon>
    </button>

    <ng-template cdkConnectedOverlay [cdkConnectedOverlayOrigin]="filterTrigger"
      [cdkConnectedOverlayOpen]="filterPanelOpen()" [cdkConnectedOverlayHasBackdrop]="true"
      [cdkConnectedOverlayBackdropClass]="'cdk-overlay-transparent-backdrop'" (backdropClick)="closeFilterPanel()"
      [cdkConnectedOverlayPositions]="filterPanelPositions" [cdkConnectedOverlayPush]="true">
      <app-profile-view-options-inline></app-profile-view-options-inline>
    </ng-template>

    @if (!isLoading() && !error()) {
    <button mat-icon-button [matMenuTriggerFor]="profileMenu" matTooltip="More options">
      <mat-icon>more_vert</mat-icon>
    </button>
    }

    <!-- Profile Menu (moved from profile-header) -->
    <mat-menu #profileMenu="matMenu">
      @if (!isOwnProfile()) {
      <button mat-menu-item (click)="openSendMessage()">
        <mat-icon>message</mat-icon>
        <span>Message</span>
      </button>

      @if (hasLightningAddress()) {
      <button mat-menu-item (click)="zapUser()">
        <mat-icon>bolt</mat-icon>
        <span>Zap</span>
      </button>
      }

      <!-- Gift Premium - Only show if user doesn't have premium -->
      @if (!isPremium()) {
      <button mat-menu-item (click)="giftPremium()">
        <mat-icon>card_giftcard</mat-icon>
        <span>Gift Premium</span>
      </button>
      }
      }

      <mat-divider></mat-divider>
      @if (!isFollowing()) {
      <button mat-menu-item (click)="followUser()">
        <mat-icon>person_add</mat-icon>
        <span>{{ isFollowingMe() ? 'Follow Back' : 'Follow' }}</span>
      </button>
      } @else {
      <button mat-menu-item (click)="unfollowUser()">
        <mat-icon>person_remove</mat-icon>
        <span>Unfollow</span>
      </button>
      }

      <button mat-menu-item (click)="toggleFavorite()">
        <mat-icon>{{ isFavorite() ? 'heart_minus' : 'heart_plus' }}</mat-icon>
        <span>{{ isFavorite() ? 'Unfavorite' : 'Favorite' }}</span>
      </button>
      <button mat-menu-item [matMenuTriggerFor]="followSetsMenu">
        <mat-icon>group_add</mat-icon>
        <span>Add to list</span>
      </button>

      @if (isOwnProfile()) {
      <button mat-menu-item routerLink="edit" [queryParamsHandling]="'preserve'">
        <mat-icon>edit</mat-icon>
        <span>Edit Profile</span>
      </button>
      }

      <button mat-menu-item [matMenuTriggerFor]="copyMenu">
        <mat-icon>content_copy</mat-icon>
        <span>Copy</span>
      </button>

      <button mat-menu-item (click)="openShareProfileDialog()">
        <mat-icon>share</mat-icon>
        <span>Share</span>
      </button>

      @if (isOwnProfile()) {
      <button mat-menu-item (click)="openShareInviteDialog()">
        <mat-icon>person_add</mat-icon>
        <span>Invitation</span>
      </button>
      }

      <button mat-menu-item [matMenuTriggerFor]="publishEventMenu">
        <mat-icon>publish</mat-icon>
        <span>Publish Event</span>
      </button>

      <button mat-menu-item routerLink="details" [queryParamsHandling]="'preserve'">
        <mat-icon>info</mat-icon>
        <span>Details</span>
      </button>

      @if (!isOwnProfile()) {
      <mat-divider></mat-divider>
      <button mat-menu-item (click)="reportUser()">
        <mat-icon>warning</mat-icon>
        <span>Report User</span>
      </button>
      @if (isUserBlocked()) {
      <button mat-menu-item (click)="blockUser()">
        <mat-icon>check_circle</mat-icon>
        <span>Unblock User</span>
      </button>
      } @else {
      <button mat-menu-item (click)="blockUser()">
        <mat-icon>block</mat-icon>
        <span>Block User</span>
      </button>
      }
      }
    </mat-menu>

    <mat-menu #copyMenu="matMenu">
      <button mat-menu-item (click)="copyProfileUrl()">
        <mat-icon>link</mat-icon>
        <span>Profile Link</span>
      </button>
      <mat-divider></mat-divider>
      <button mat-menu-item (click)="copyNpub()">
        <span>ID</span>
      </button>
      <button mat-menu-item (click)="copyHex()">
        <span>ID (hex)</span>
      </button>
      <button mat-menu-item (click)="copyNprofile()">
        <span>ID (nprofile)</span>
      </button>
    </mat-menu>

    <mat-menu #publishEventMenu="matMenu">
      <button mat-menu-item (click)="publishProfileEvent()">
        <mat-icon>account_circle</mat-icon>
        <span>Profile</span>
      </button>
      <button mat-menu-item (click)="publishRelayListEvent()">
        <mat-icon>dns</mat-icon>
        <span>Relay List</span>
      </button>
      <button mat-menu-item (click)="publishFollowingListEvent()">
        <mat-icon>people</mat-icon>
        <span>Following List</span>
      </button>
    </mat-menu>

    <!-- Submenu for Lists -->
    <mat-menu #followSetsMenu="matMenu">
      @for (set of availableFollowSets(); track set.id) {
      <button mat-menu-item (click)="addToFollowSet(set.dTag)">
        <mat-icon>{{ isInFollowSet(set.dTag) ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
        <span>{{ set.title }}</span>
      </button>
      }
      <mat-divider></mat-divider>
      <button mat-menu-item (click)="createNewFollowSet()">
        <mat-icon>add_circle</mat-icon>
        <span>Create new list</span>
      </button>
    </mat-menu>
  </div>
</ng-template>

<!-- Header is always rendered by the panel header service at app level -->
<!-- This ensures proper sticky behavior in both left and right panels -->

<div class="profile-page">
  @if (isLoading()) {
  <div class="profile-loading-container">
    <div class="profile-loading-content">
      <!-- Profile skeleton -->
      <div class="profile-loading-skeleton">
        <!-- Banner skeleton -->
        <div class="banner-skeleton"></div>

        <!-- Avatar and info skeleton -->
        <div class="profile-info-skeleton">
          <div class="avatar-skeleton"></div>
          <div class="profile-details-skeleton">
            <div class="name-skeleton"></div>
            <div class="npub-skeleton"></div>
            <div class="bio-skeleton"></div>
          </div>
        </div>

        <!-- Actions skeleton -->
        <div class="actions-skeleton">
          <div class="action-button-skeleton"></div>
          <div class="action-button-skeleton"></div>
        </div>
      </div>

      <!-- Loading spinner and message -->
      <div class="loading-spinner-section">
        <mat-spinner diameter="48"></mat-spinner>
        @if (deepDiscoveryStatus(); as status) {
          <p class="loading-message">Deep discovery in progress</p>
          <p class="loading-submessage">{{ status.message }}</p>
          @if (status.phase === 'observed-relays' && status.totalBatches > 0) {
            <div class="discovery-progress">
              <div class="discovery-progress-bar">
                <div class="discovery-progress-fill" [style.width.%]="(status.currentBatch / status.totalBatches) * 100"></div>
              </div>
              <span class="discovery-progress-text">{{ status.currentBatch }} / {{ status.totalBatches }}</span>
            </div>
          }
        } @else {
          <p class="loading-message">Loading profile...</p>
          <p class="loading-submessage">Fetching user data from the network</p>
        }
      </div>
    </div>
  </div>
  } @else if (error()) {
  <div class="error-container">
    <mat-icon>error</mat-icon>
    <h2>{{ error() }}</h2>
    <p>The profile you're looking for couldn't be loaded or doesn't exist.</p>
    <p>
      The user is likely not found on your Discovery Relays. You can add
      <a [routerLink]="['/settings']">additional ones</a> and try again.
    </p>
    <p class="profile-link-container">
      @if (utilities.isValidPubkey(pubkey())) {
      <a class="wrap-link" [href]="'https://nostr.at/' + getSafeFormattedNpub()" target="_blank"
        rel="noopener noreferrer">https://nostr.at/{{ getSafeFormattedNpub() }}</a>
      } @else {
      <span class="invalid-pubkey">Invalid pubkey: {{ pubkey() }}</span>
      }
    </p>
  </div>
  }
  @if (!isLoading() && !error()) {
  <!-- Blocked Profile Overlay -->
  @if (isProfileBlocked() && !isBlockedProfileRevealed()) {
  <div class="blocked-profile-overlay">
    <div class="blocked-profile-content">
      <mat-icon class="blocked-icon">block</mat-icon>
      <h2>Profile Blocked</h2>
      <p>You have blocked this user. Their profile and content are hidden from view.</p>
      <div class="blocked-profile-actions">
        <button mat-raised-button color="primary" (click)="revealBlockedProfile()">
          <mat-icon>visibility</mat-icon>
          Reveal Profile
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Normal Profile Content (only shown when not blocked or revealed) -->
  @if (!isProfileBlocked() || isBlockedProfileRevealed()) {
  <div class="profile-header">
    <app-profile-header [profile]="userMetadata()" [pubkey]="pubkey()"></app-profile-header>
  </div>

  <div class="profile-outlet" [class.mobile]="layoutService.isHandset()">
    @if (isInRightPanel()) {
    <!-- When in right panel (auxiliary outlet), render profile-home directly without nested routing -->
    <!-- This avoids Angular router state tree issues with nested children in auxiliary outlets -->
    <app-profile-home></app-profile-home>
    } @else {
    <router-outlet></router-outlet>
    }
  </div>
  }
  }
</div>