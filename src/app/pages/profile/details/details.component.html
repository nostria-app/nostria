<div class="panel-header">
  <button mat-icon-button (click)="goBack()" matTooltip="Back">
    <mat-icon>arrow_back</mat-icon>
  </button>

  @if (viewingProfile(); as profile) {
  @if (profile.data?.picture) {
  <img class="profile-avatar" [src]="profile.data.picture" alt="Profile picture" />
  }
  <h2 class="panel-title title-font">{{ getProfileDisplayName() }}'s Details</h2>
  } @else {
  <h2 class="panel-title title-font">Profile Details</h2>
  }

  <span class="panel-header-spacer"></span>
</div>

<div class="info-container">
  @if (profileUpdatedAt(); as updatedAt) {
  <div class="profile-updated-info">
    <mat-icon>schedule</mat-icon>
    <span>
      Profile updated {{ updatedAt | ago }} &middot; {{ updatedAt | timestamp: 'medium' }}
    </span>
  </div>
  }

  @if (isLoadingModerationSignals()) {
  <div class="profile-updated-info">
    <mat-icon>downloading</mat-icon>
    <span>Downloading report and mute-list signals...</span>
  </div>
  }

  @if (moderationOverview(); as moderation) {
  <div class="metrics-section">
    <h3>Safety Signals</h3>

    <div class="metrics-grid">
      <div class="metric-item highlight">
        <mat-icon>gavel</mat-icon>
        <span class="metric-label">Reports Against User:</span>
        <span class="metric-value">{{ moderation.totalReports }}</span>
      </div>

      <div class="metric-item">
        <mat-icon>campaign</mat-icon>
        <span class="metric-label">Unique Reporters:</span>
        <span class="metric-value">{{ moderation.uniqueReporters }}</span>
      </div>

      <div class="metric-item">
        <mat-icon>volume_off</mat-icon>
        <span class="metric-label">People Muting This User:</span>
        <span class="metric-value">{{ moderation.uniqueMuters }}</span>
      </div>

      <div class="metric-item">
        <mat-icon>download_done</mat-icon>
        <span class="metric-label">Downloaded Report Events:</span>
        <span class="metric-value">{{ moderation.downloadedReportEvents }}</span>
      </div>

      <div class="metric-item">
        <mat-icon>download_done</mat-icon>
        <span class="metric-label">Downloaded Mute Lists:</span>
        <span class="metric-value">{{ moderation.downloadedMuteListEvents }}</span>
      </div>

      <div class="metric-item">
        <mat-icon>help_outline</mat-icon>
        <span class="metric-label">Unknown Report Type:</span>
        <span class="metric-value">{{ moderation.unknownTypeReports }}</span>
      </div>

      @if (moderation.latestReportAt) {
      <div class="metric-item">
        <mat-icon>schedule</mat-icon>
        <span class="metric-label">Latest Report:</span>
        <span class="metric-value">{{ formatTimestamp(moderation.latestReportAt) }}</span>
      </div>
      }
    </div>

    @if (reportTypeBreakdown().length > 0) {
    <div class="report-type-list">
      <h4>Report Type Breakdown</h4>
      <div class="metrics-grid">
        @for (reportType of reportTypeBreakdown(); track reportType.type) {
        <div class="metric-item">
          <mat-icon>label</mat-icon>
          <span class="metric-label">{{ reportType.type }}:</span>
          <span class="metric-value">{{ reportType.count }}</span>
        </div>
        }
      </div>
    </div>
    }
  </div>
  }

  @if (metrics()) {
  <div class="metrics-section">
    <h3>Algorithm Metrics</h3>
    <div class="metrics-grid">
      <div class="metric-item">
        <mat-icon>visibility</mat-icon>
        <span class="metric-label">Views:</span>
        <span class="metric-value">{{ metrics()!.viewed }}</span>
      </div>

      <div class="metric-item">
        <mat-icon>touch_app</mat-icon>
        <span class="metric-label">Profile Clicks:</span>
        <span class="metric-value">{{ metrics()!.profileClicks }}</span>
      </div>

      <div class="metric-item">
        <mat-icon>favorite</mat-icon>
        <span class="metric-label">Liked:</span>
        <span class="metric-value">{{ metrics()!.liked }}</span>
      </div>

      <div class="metric-item">
        <mat-icon>article</mat-icon>
        <span class="metric-label">Read:</span>
        <span class="metric-value">{{ metrics()!.read }}</span>
      </div>

      <div class="metric-item">
        <mat-icon>reply</mat-icon>
        <span class="metric-label">Replied:</span>
        <span class="metric-value">{{ metrics()!.replied }}</span>
      </div>

      <div class="metric-item">
        <mat-icon>repeat</mat-icon>
        <span class="metric-label">Reposted:</span>
        <span class="metric-value">{{ metrics()!.reposted }}</span>
      </div>

      <div class="metric-item">
        <mat-icon>format_quote</mat-icon>
        <span class="metric-label">Quoted:</span>
        <span class="metric-value">{{ metrics()!.quoted }}</span>
      </div>

      <div class="metric-item">
        <mat-icon>message</mat-icon>
        <span class="metric-label">Messaged:</span>
        <span class="metric-value">{{ metrics()!.messaged }}</span>
      </div>

      <div class="metric-item">
        <mat-icon>alternate_email</mat-icon>
        <span class="metric-label">Mentioned:</span>
        <span class="metric-value">{{ metrics()!.mentioned }}</span>
      </div>

      <div class="metric-item">
        <mat-icon>schedule</mat-icon>
        <span class="metric-label">Time Spent:</span>
        <span class="metric-value">{{ metrics()!.timeSpent }}s</span>
      </div>

      <div class="metric-item highlight">
        <mat-icon>insights</mat-icon>
        <span class="metric-label">Engagement Score:</span>
        <span class="metric-value">{{ metrics()!.engagementScore }}</span>
      </div>

      <div class="metric-item">
        <mat-icon>access_time</mat-icon>
        <span class="metric-label">Avg Time Per View:</span>
        <span class="metric-value">{{ metrics()!.averageTimePerView?.toFixed(2) || 0 }}s</span>
      </div>
    </div>
  </div>
  }

  @if (trustDisplayItems().length > 0) {
  <div class="metrics-section">
    <h3>Web of Trust</h3>
    <div class="metrics-grid">
      @for (item of trustDisplayItems(); track item.key) {
      <div class="metric-item" [class.highlight]="item.highlight" [class.long-value]="item.key === 'authorPubkey'"
        [class.clickable]="!!item.targetPubkey" [attr.role]="item.targetPubkey ? 'button' : null"
        [attr.tabindex]="item.targetPubkey ? '0' : null" (click)="item.targetPubkey && openProfile(item.targetPubkey)"
        (keydown.enter)="item.targetPubkey && openProfile(item.targetPubkey)">
        <mat-icon>{{ item.icon }}</mat-icon>
        <span class="metric-label">{{ item.label }}:</span>
        <span class="metric-value">{{ item.value }}</span>
      </div>
      }
    </div>
  </div>
  } @else {
  <div class="empty-state">
    <mat-icon>verified_user</mat-icon>
    <p>No Web of Trust metrics available for this profile</p>
  </div>
  }

  @if (relayListInfo(); as relayList) {
  <div class="info-section">
    <h3>Relay Configuration</h3>

    <div class="info-grid">
      @if (relayList.hasRelayList) {
      <div class="info-item positive">
        <mat-icon>thumb_up</mat-icon>
        <span class="info-label">Has Relay List (kind 10002, NIP-65) with {{ relayList.relayCount }} relay{{
          relayList.relayCount !== 1 ? 's' : '' }}</span>
      </div>
      @if (relayList.updatedAt) {
      <div class="info-item neutral">
        <mat-icon>schedule</mat-icon>
        <span class="info-label">Relay List Updated: {{ formatTimestamp(relayList.updatedAt) }}</span>
      </div>
      }
      } @else {
      <div class="info-item negative">
        <mat-icon>thumb_down</mat-icon>
        <span class="info-label">No Relay List (kind 10002, NIP-65)</span>
      </div>
      }

      @if (contactListRelayInfo(); as contactRelays) {
      @if (contactRelays.hasRelaysInContacts) {
      <div class="info-item neutral">
        <mat-icon>info</mat-icon>
        <span class="info-label">Has relays in Contact List (kind 3) with {{ contactRelays.relayCount }} relay{{
          contactRelays.relayCount !== 1 ? 's' : '' }}</span>
      </div>
      } @else {
      <div class="info-item neutral">
        <mat-icon>info</mat-icon>
        <span class="info-label">No relays in Contact List (kind 3)</span>
      </div>
      }
      }
    </div>
  </div>
  }

  @if (info(); as infoData) {
  <div class="info-section">
    <h3>Profile Discovery Information</h3>

    <div class="info-grid">
      @if (infoData.hasRelayList) {
      <div class="info-item positive">
        <mat-icon>thumb_up</mat-icon>
        <span class="info-label">Has Relay List (NIP-65)</span>
      </div>
      } @else {
      <div class="info-item negative">
        <mat-icon>thumb_down</mat-icon>
        <span class="info-label">Relay list status unknown (cached info may be outdated)</span>
      </div>
      }

      @if (infoData.hasFollowingList) {
      <div class="info-item positive">
        <mat-icon>thumb_up</mat-icon>
        <span class="info-label">Has Following List</span>
      </div>
      }

      @if (infoData.hasFollowingListRelays) {
      <div class="info-item neutral">
        <mat-icon>info</mat-icon>
        <span class="info-label">Has Following List Relays</span>
      </div>
      }

      @if (infoData.foundOnDiscoveryRelays) {
      <div class="info-item positive">
        <mat-icon>thumb_up</mat-icon>
        <span class="info-label">Found on Discovery Relays</span>
      </div>
      } @else if (infoData.foundOnAccountRelays) {
      <div class="info-item negative">
        <mat-icon>thumb_down</mat-icon>
        <span class="info-label">Found on Account Relays (Fallback)</span>
      </div>
      }

      @if (infoData.foundMetadataOnUserRelays) {
      <div class="info-item positive">
        <mat-icon>thumb_up</mat-icon>
        <span class="info-label">Found Profile on User Relays</span>
      </div>
      } @else if (infoData.foundMetadataOnAccountRelays) {
      <div class="info-item negative">
        <mat-icon>thumb_down</mat-icon>
        <span class="info-label">Found Profile on Account Relays</span>
      </div>
      }

      @if (infoData.foundZeroRelaysOnAccountRelays) {
      <div class="info-item negative">
        <mat-icon>thumb_down</mat-icon>
        <span class="info-label">Unable to Find User Relays</span>
      </div>
      }

      @if (infoData.hasEmptyFollowingList) {
      <div class="info-item negative">
        <mat-icon>thumb_down</mat-icon>
        <span class="info-label">Empty Following List - Cannot Discover Profile</span>
      </div>
      }

      @if (infoData.relayCount !== undefined) {
      <div class="info-item neutral">
        <mat-icon>dns</mat-icon>
        <span class="info-label">Relay Count: {{ infoData.relayCount }}</span>
      </div>
      }

      @if (infoData.followingCount !== undefined) {
      <div class="info-item neutral">
        <mat-icon>people</mat-icon>
        <span class="info-label">Following Count: {{ infoData.followingCount }}</span>
      </div>
      }

      @if (infoData.updated) {
      <div class="info-item neutral">
        <mat-icon>schedule</mat-icon>
        <span class="info-label">Last Updated: {{ formatTimestamp(infoData.updated) }}</span>
      </div>
      }
    </div>

    <div class="info-actions">
      @if (infoData.foundMetadataOnAccountRelays) {
      <button mat-flat-button (click)="broadcastProfile()">
        <mat-icon>broadcast_on_personal</mat-icon>
        Broadcast Profile to User's Relays
      </button>
      }

      @if (infoData.hasRelayList && !infoData.foundOnDiscoveryRelays) {
      <button mat-flat-button (click)="broadcastRelayList()">
        <mat-icon>cloud_upload</mat-icon>
        Broadcast Relay List to Discovery Relays
      </button>
      }
    </div>
  </div>
  } @else {
  <div class="empty-state">
    <mat-icon>info_outline</mat-icon>
    <p>No discovery information available for this profile</p>
  </div>
  }
</div>