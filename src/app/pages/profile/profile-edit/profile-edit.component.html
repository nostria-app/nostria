<div class="panel-header">
  <button mat-icon-button (click)="goBack()" matTooltip="Back">
    <mat-icon>arrow_back</mat-icon>
  </button>
  <h2 class="panel-title title-font">Edit Profile</h2>
  <span class="panel-header-spacer"></span>
</div>

<div class="page">
  <mat-card>
    <mat-card-content>
      <div class="file-upload-section">
        <div class="section-header">
          <h3>Profile Image</h3>
          <div class="toggle-container">
            <span>File</span>
            <mat-slide-toggle [checked]="useProfileImageUrl()" (change)="toggleImageInputMethod('profile')"
              color="primary">
            </mat-slide-toggle>
            <span>URL</span>
          </div>
        </div>

        <!-- No media servers warning for file upload mode -->
        @if (!useProfileImageUrl() && !hasMediaServers()) {
        <div class="media-server-warning">
          <mat-icon color="warn">warning</mat-icon>
          <span>You need to configure a media server to upload image files</span>
          <button mat-flat-button color="primary" type="button" (click)="navigateToMediaSettings()">
            Configure Media Server
          </button>
        </div>
        }

        @if (!useProfileImageUrl()) {
        <div class="file-upload">
          <button mat-stroked-button type="button" (click)="profileImageInput.click()" [disabled]="!hasMediaServers()">
            <mat-icon>upload</mat-icon>
            Choose profile image
          </button>
          <input #profileImageInput type="file" hidden (change)="onFileSelected($event, 'profile')" accept="image/*" />
        </div>
        } @else {
        <mat-form-field appearance="outline" class="input-full-width">
          <mat-icon matPrefix>image</mat-icon>
          <mat-label>Profile Image URL</mat-label>
          <input matInput type="text" [(ngModel)]="pictureUrl" (blur)="onImageUrlChange('profile')"
            placeholder="https://example.com/image.png" />
          <mat-icon matSuffix>link</mat-icon>
        </mat-form-field>
        }

        @if (previewProfileImage()) {
        <div class="preview-container">
          <div class="preview-wrapper">
            <img [src]="previewProfileImage()" class="profile-preview" alt="Profile Preview" />
            <button mat-mini-fab color="warn" class="remove-button" (click)="removeImage('profile')"
              matTooltip="Remove profile image">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>
        }
      </div>

      <div class="file-upload-section">
        <div class="section-header">
          <h3>Profile Banner</h3>
          <div class="toggle-container">
            <span>File</span>
            <mat-slide-toggle [checked]="useBannerUrl()" (change)="toggleImageInputMethod('banner')" color="primary">
            </mat-slide-toggle>
            <span>URL</span>
          </div>
        </div>

        <!-- No media servers warning for file upload mode -->
        @if (!useBannerUrl() && !hasMediaServers()) {
        <div class="media-server-warning">
          <mat-icon color="warn">warning</mat-icon>
          <span>You need to configure a media server to upload banner files</span>
          <button mat-flat-button color="primary" type="button" (click)="navigateToMediaSettings()">
            Configure Media Server
          </button>
        </div>
        }

        @if (!useBannerUrl()) {
        <div class="file-upload">
          <button mat-stroked-button type="button" (click)="profileBannerInput.click()" [disabled]="!hasMediaServers()">
            <mat-icon>upload</mat-icon>
            Choose profile banner
          </button>
          <input #profileBannerInput type="file" hidden (change)="onFileSelected($event, 'banner')" accept="image/*" />
        </div>
        } @else {
        <mat-form-field class="input-full-width">
          <mat-icon matPrefix>image</mat-icon>
          <mat-label>Profile Banner URL</mat-label>
          <input matInput type="text" [(ngModel)]="bannerUrl" (blur)="onImageUrlChange('banner')"
            placeholder="https://example.com/banner.png" />
          <mat-icon matSuffix>link</mat-icon>
        </mat-form-field>
        }

        @if (previewBanner()) {
        <div class="preview-container">
          <div class="preview-wrapper">
            <img [src]="previewBanner()" class="banner-preview" alt="Banner Preview" />
            <button mat-mini-fab color="warn" class="remove-button" (click)="removeImage('banner')"
              matTooltip="Remove banner image">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>
        }
      </div>

      @if (profile()) {
      <p>
        <mat-form-field class="input-full-width">
          <mat-icon matPrefix>badge</mat-icon>
          <mat-label>Display Name</mat-label>
          <input matInput type="text" [(ngModel)]="displayName" />
        </mat-form-field>
      </p>
      <p>
        <mat-form-field class="input-full-width">
          <mat-icon matPrefix>alternate_email</mat-icon>
          <mat-label>Name</mat-label>
          <input matInput type="text" [(ngModel)]="name" />
        </mat-form-field>
      </p>
      <p>
        <mat-form-field class="input-full-width">
          <mat-icon matPrefix>help_outline</mat-icon>
          <mat-label>About</mat-label>
          <textarea matInput type="text" [(ngModel)]="about" rows="3"></textarea>
        </mat-form-field>
      </p>
      <!-- Multi-value Website Section -->
      <div class="multi-value-section">
        <div class="section-label">
          <mat-icon>public</mat-icon>
          <span>Website</span>
        </div>
        @for (website of websiteList(); track $index) {
        <div class="multi-value-row">
          <mat-form-field class="input-full-width">
            <mat-label>Website {{ websiteList().length > 1 ? $index + 1 : '' }}</mat-label>
            <input matInput type="text" [value]="website" (input)="updateWebsite($index, $any($event.target).value)"
              placeholder="https://" />
          </mat-form-field>
          @if (websiteList().length > 1) {
          <button mat-icon-button (click)="removeWebsite($index)" matTooltip="Remove website" class="remove-row-button">
            <mat-icon>remove_circle_outline</mat-icon>
          </button>
          }
        </div>
        }
        <button mat-stroked-button (click)="addWebsite()" class="add-row-button">
          <mat-icon>add</mat-icon>
          Add another website
        </button>
      </div>

      <!-- Multi-value NIP-05 Section -->
      <div class="multi-value-section">
        <div class="section-label">
          <mat-icon>how_to_reg</mat-icon>
          <span>E-mail/Domain Identifier (NIP-05)</span>
        </div>
        @for (nip05 of nip05List(); track $index) {
        <div class="multi-value-row">
          <mat-form-field class="input-full-width">
            <mat-label>NIP-05 {{ nip05List().length > 1 ? $index + 1 : '' }}</mat-label>
            <input matInput type="text" [value]="nip05" (input)="updateNip05($index, $any($event.target).value)"
              placeholder="user@domain.com" />
          </mat-form-field>
          @if (nip05List().length > 1) {
          <button mat-icon-button (click)="removeNip05($index)" matTooltip="Remove NIP-05" class="remove-row-button">
            <mat-icon>remove_circle_outline</mat-icon>
          </button>
          }
        </div>
        }
        <button mat-stroked-button (click)="addNip05()" class="add-row-button">
          <mat-icon>add</mat-icon>
          Add another NIP-05
        </button>
      </div>
      <p>
        <mat-form-field class="input-full-width">
          <mat-icon matPrefix>currency_bitcoin</mat-icon>
          <mat-label>Bitcoin Lightning Address</mat-label>
          <input matInput type="text" [(ngModel)]="lud16" placeholder="user@domain" />
        </mat-form-field>
      </p>

      <!-- External Identities Section -->
      <div class="external-identities-section">
        <h3>
          <mat-icon>public</mat-icon>
          External Identities
        </h3>

        @if (externalIdentities().length > 0) {
        <mat-list class="identities-list">
          @for (identity of externalIdentities(); track $index) {
          <mat-list-item>
            <mat-icon matListItemIcon>link</mat-icon>
            <div matListItemTitle>{{ identity.platform }}:{{ identity.identity }}</div>
            @if (identity.proof) {
            <div matListItemLine class="proof-text">Proof: {{ identity.proof }}</div>
            }
            <div matListItemMeta class="identity-actions">
              <button mat-icon-button (click)="editExternalIdentity($index)" matTooltip="Edit">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button (click)="removeExternalIdentity($index)" matTooltip="Remove">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </mat-list-item>
          }
        </mat-list>
        }

        <div class="add-identity-form">
          <div class="form-row">
            <mat-form-field class="platform-field">
              <mat-icon matPrefix>label</mat-icon>
              <mat-label>Platform</mat-label>
              <input matInput type="text" [(ngModel)]="newIdentityPlatformValue" placeholder="github" />
              <button mat-icon-button matSuffix [matMenuTriggerFor]="platformMenu" matTooltip="Select preset">
                <mat-icon>arrow_drop_down</mat-icon>
              </button>
            </mat-form-field>

            <mat-menu #platformMenu="matMenu">
              <button mat-menu-item (click)="selectPlatformPreset('github')">
                <mat-icon>code</mat-icon>
                <span>GitHub</span>
              </button>
              <button mat-menu-item (click)="selectPlatformPreset('twitter')">
                <mat-icon>alternate_email</mat-icon>
                <span>Twitter/X</span>
              </button>
              <button mat-menu-item (click)="selectPlatformPreset('mastodon')">
                <mat-icon>rss_feed</mat-icon>
                <span>Mastodon</span>
              </button>
              <button mat-menu-item (click)="selectPlatformPreset('telegram')">
                <mat-icon>send</mat-icon>
                <span>Telegram</span>
              </button>
              <button mat-menu-item (click)="selectPlatformPreset('linkedin')">
                <mat-icon>business</mat-icon>
                <span>LinkedIn</span>
              </button>
              <button mat-menu-item (click)="selectPlatformPreset('instagram')">
                <mat-icon>photo_camera</mat-icon>
                <span>Instagram</span>
              </button>
            </mat-menu>

            <mat-form-field class="identity-field">
              <mat-icon matPrefix>person</mat-icon>
              <mat-label>Identity</mat-label>
              <input matInput type="text" [(ngModel)]="newIdentityValueValue" placeholder="username" />
            </mat-form-field>
          </div>

          <mat-form-field class="input-full-width proof-field">
            <mat-icon matPrefix>verified</mat-icon>
            <mat-label>Proof (optional)</mat-label>
            <input matInput type="text" [(ngModel)]="newIdentityProofValue"
              placeholder="Gist ID, Tweet ID, or other proof URL/ID" />
          </mat-form-field>

          <div class="button-row">
            <button mat-stroked-button color="primary" (click)="addExternalIdentity()" class="add-button">
              <mat-icon>{{ editingIdentityIndex() >= 0 ? 'check' : 'add' }}</mat-icon>
              {{ editingIdentityIndex() >= 0 ? 'Update Identity' : 'Add Identity' }}
            </button>
            @if (editingIdentityIndex() >= 0) {
            <button mat-button (click)="cancelEditIdentity()" class="cancel-button">
              <mat-icon>close</mat-icon>
              Cancel
            </button>
            }
          </div>
        </div>
      </div>

      @if (accountState.profile()) {
      <p>Last updated: {{ accountState.profile()!.event.created_at | ago }}</p>
      } @else {
      <p><em>Creating new profile...</em></p>
      }
      }
    </mat-card-content>

    <mat-card-footer align="end">
      <button mat-button (click)="cancelEdit()">Cancel</button>&nbsp;
      <button mat-flat-button [disabled]="loading()" color="primary" (click)="updateMetadata()">
        @if (loading()) {
        <mat-spinner diameter="24"></mat-spinner>
        } @else {
        Save
        }
      </button>
    </mat-card-footer>
  </mat-card>
</div>