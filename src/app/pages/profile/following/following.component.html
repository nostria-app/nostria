<div @slideInOut #followingContainer>
  <div class="panel-header" @profileShrink>
    <button mat-icon-button (click)="goBack()" matTooltip="Back">
      <mat-icon>arrow_back</mat-icon>
    </button>

    @if (userProfile(); as profile) {
    @if (profile.picture) {
    <img class="profile-avatar" [src]="profile.picture" alt="Profile picture" />
    }
    <h2 class="panel-title title-font">{{ profile.name }}'s Following</h2>
    } @else {
    <h2 class="panel-title title-font">Following</h2>
    }

    <span class="panel-header-spacer"></span>

    <div class="header-controls">
      <!-- Sort button with menu -->
      <button mat-icon-button [matMenuTriggerFor]="sortMenu" matTooltip="Sort options">
        <mat-icon>sort</mat-icon>
      </button>

      <mat-menu #sortMenu="matMenu" class="sort-menu" [overlapTrigger]="false">
        <div class="filter-menu-header" (click)="preventPropagation($event)">
          <span>Sort By</span>
        </div>
        <mat-divider></mat-divider>

        <div class="filter-section" (click)="preventPropagation($event)">
          <mat-radio-group [value]="sortOption()" (change)="changeSortOption($event.value)">
            <mat-radio-button value="default" (click)="preventPropagation($event)">
              Default
            </mat-radio-button>
            <mat-radio-button value="reverse" (click)="preventPropagation($event)">
              Reverse
            </mat-radio-button>
            <mat-radio-button value="name-asc" (click)="preventPropagation($event)">
              Name (A to Z)
            </mat-radio-button>
            <mat-radio-button value="name-desc" (click)="preventPropagation($event)">
              Name (Z to A)
            </mat-radio-button>
          </mat-radio-group>
        </div>
      </mat-menu>

      <!-- Search input -->
      <div class="search-container">
        <mat-icon>search</mat-icon>
        <input type="text" placeholder="Filter..." [value]="searchTerm()"
          (input)="updateSearch($any($event.target).value)" />
        @if (searchTerm()) {
        <button mat-icon-button (click)="updateSearch('')" class="clear-search">
          <mat-icon>close</mat-icon>
        </button>
        }
      </div>
    </div>
  </div>

  <mat-tab-group class="following-tabs" [selectedIndex]="selectedTabIndex()"
    (selectedIndexChange)="onTabChanged($event)" animationDuration="300ms">
    <mat-tab class="following-tab" label="Connections">
      <div class="following-content">
        @if (isLoading()) {
        <div class="loading-container">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading following list...</p>
        </div>
        } @else if (error()) {
        <div class="error-container">
          <mat-icon>error</mat-icon>
          <p>{{ error() }}</p>
          <button mat-button color="primary"><mat-icon>refresh</mat-icon> Try Again</button>
        </div>
        } @else if (filteredFollowingList().length === 0) {
        <div class="empty-list">
          @if (searchTerm()) {
          <mat-icon>search_off</mat-icon>
          <p>No results for "{{ searchTerm() }}"</p>
          <button mat-button (click)="updateSearch('')">Clear search</button>
          } @else {
          <mat-icon>people_outline</mat-icon>
          <p>This user is not following anyone.</p>
          }
        </div>
        } @else {
        <cdk-virtual-scroll-viewport class="virtual-scroll-viewport" [itemSize]="itemSize" [minBufferPx]="minBufferPx"
          [maxBufferPx]="maxBufferPx">
          <mat-list class="full-width-list">
            @for (user of filteredFollowingList(); track user.id) {
            <app-user-profile [pubkey]="user.id"></app-user-profile>
            }
          </mat-list>
        </cdk-virtual-scroll-viewport>
        }
      </div>
    </mat-tab>

    <mat-tab class="following-tab" label="Mutual Connections">
      <div class="following-content">
        @if (mutualConnectionsList().length === 0) {
        <div class="empty-list">
          <mat-icon>people_alt</mat-icon>
          <p>No mutual connections found.</p>
        </div>
        } @else {
        <cdk-virtual-scroll-viewport class="virtual-scroll-viewport" [itemSize]="itemSize" [minBufferPx]="minBufferPx"
          [maxBufferPx]="maxBufferPx">
          <mat-list class="full-width-list">
            @for (user of mutualConnectionsList(); track user.id) {
            <app-user-profile [pubkey]="user.id"></app-user-profile>
            }
          </mat-list>
        </cdk-virtual-scroll-viewport>
        }
      </div>
    </mat-tab>
  </mat-tab-group>
</div>