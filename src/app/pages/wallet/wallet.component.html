<div class="wallet-page">
  <!-- Toolbar -->
  <div class="wallet-toolbar">
    <div class="toolbar-title">
      <mat-icon>account_balance_wallet</mat-icon>
      <h1 i18n="@@wallet.title">Wallet</h1>
    </div>
    @if (wallets.hasWallets()) {
      <div class="toolbar-balance">
        <span class="balance-value" style="cursor:pointer" tabindex="0" role="button" matTooltip="Click to show/hide balance"
      (click)="toggleHideWalletAmounts()"
      (keydown.enter)="toggleHideWalletAmounts()"
      (keydown.space)="toggleHideWalletAmounts()">
  {{ getTotalBalance() }}
</span>
        <span class="balance-label" i18n="@@wallet.sats">sats</span>
      </div>
    }
    <div class="toolbar-spacer"></div>
    <button mat-fab extended (click)="openAddWalletDialog()" class="add-wallet-btn">
      <mat-icon>add</mat-icon>
      <span i18n="@@wallet.add-wallet">Add Wallet</span>
    </button>
  </div>

  <!-- Tabs -->
  <mat-tab-group [selectedIndex]="activeTabIndex()" (selectedIndexChange)="onTabChange($event)" class="wallet-tabs">
    <!-- Wallets Tab -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon>wallet</mat-icon>
        <span i18n="@@wallet.tab.wallets">Wallets</span>
      </ng-template>

      <div class="tab-content">
        @if (wallets.hasWallets()) {
          @for (wallet of getWalletEntries(); track wallet[0]) {
            @let walletData = getWalletData(wallet[0]);
            <mat-card class="wallet-card">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>wallet</mat-icon>
                  @if (editingWallet() === wallet[0]) {
                    <mat-form-field appearance="outline" class="edit-name-field">
                      <input matInput [formControl]="editNameControl" placeholder="Wallet name"
                        (keydown.enter)="saveWalletName()" (keydown.escape)="cancelEditingWallet()" />
                    </mat-form-field>
                  } @else {
                    <span>{{ getWalletName(wallet[1]) }}</span>
                  }
                </mat-card-title>
                <!-- Balance shown prominently in header -->
                <div class="wallet-balance-header">
                  @if (walletData?.loading && !walletData?.balance) {
                    <mat-spinner diameter="20"></mat-spinner>
                  } @else if (walletData?.balance) {
                    <span class="balance-value" style="cursor:pointer" tabindex="0" role="button" matTooltip="Click to show/hide balance"
      (click)="toggleHideWalletAmounts()"
      (keydown.enter)="toggleHideWalletAmounts()"
      (keydown.space)="toggleHideWalletAmounts()">
  {{ getDisplayBalance(walletData!.balance!.balance) }}
</span>
                    <span class="balance-label" i18n="@@wallet.sats">sats</span>
                    <button mat-icon-button matTooltip="Refresh balance" i18n-matTooltip="@@wallet.refresh-balance"
                      (click)="refreshBalance(wallet[0]); $event.stopPropagation()" [disabled]="walletData?.loading"
                      class="refresh-btn">
                      @if (walletData?.loading) {
                        <mat-spinner diameter="16"></mat-spinner>
                      } @else {
                        <mat-icon>refresh</mat-icon>
                      }
                    </button>
                  } @else if (walletData?.error) {
                    <span class="balance-error" matTooltip="{{ walletData!.error }}">
                      <mat-icon>error_outline</mat-icon>
                    </span>
                    <button mat-icon-button matTooltip="Retry" i18n-matTooltip="@@wallet.retry" (click)="refreshBalance(wallet[0]); $event.stopPropagation()">
                      <mat-icon>refresh</mat-icon>
                    </button>
                  } @else {
                    <span class="balance-loading" i18n="@@wallet.loading">Loading...</span>
                  }
                </div>
              </mat-card-header>

              <mat-card-content>
                <div class="wallet-info">
                  <!-- Wallet Provider Profile -->
                  <div class="wallet-provider">
                    <strong i18n="@@wallet.provider">Provider:</strong>
                    <app-user-profile [pubkey]="wallet[0]" view="compact"></app-user-profile>
                  </div>
                </div>
              </mat-card-content>

              <mat-card-actions>
                @if (editingWallet() === wallet[0]) {
                  <button mat-button (click)="saveWalletName()" [disabled]="editNameControl.invalid">
                    <mat-icon>save</mat-icon>
                    <span i18n="@@wallet.save">Save</span>
                  </button>
                  <button mat-button (click)="cancelEditingWallet()">
                    <mat-icon>cancel</mat-icon>
                    <span i18n="@@wallet.cancel">Cancel</span>
                  </button>
                } @else {
                  <button mat-icon-button matTooltip="Edit wallet name" i18n-matTooltip="@@wallet.edit-name"
                    (click)="startEditingWallet(wallet[0], getWalletName(wallet[1]))">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button matTooltip="Copy connection string" i18n-matTooltip="@@wallet.copy-connection"
                    (click)="copyToClipboard(getFirstConnectionString(wallet[1]), 'Connection string')">
                    <mat-icon>content_copy</mat-icon>
                  </button>
                  <button mat-icon-button color="warn" matTooltip="Remove wallet" i18n-matTooltip="@@wallet.remove"
                    (click)="removeWallet(wallet[0])">
                    <mat-icon>delete</mat-icon>
                  </button>
                }
              </mat-card-actions>
            </mat-card>
          }

          <!-- Donation Card -->
          <mat-card class="donation-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>volunteer_activism</mat-icon>
                <span i18n="@@wallet.donation.title">Support Nostria Development</span>
              </mat-card-title>
              <mat-card-subtitle i18n="@@wallet.donation.subtitle">Help us keep building the future of Nostr</mat-card-subtitle>
            </mat-card-header>

            <mat-card-content>
              <div class="donation-content">
                <!-- Developer Profiles -->
                <div class="developers-section">
                  <h4 i18n="@@wallet.developers">Meet the Developers</h4>
                  <div class="developer-profiles">
                    @for (pubkey of developerPubkeys; track pubkey) {
                      <app-user-profile [pubkey]="pubkey" [view]="'small'" [hostWidthAuto]="true"></app-user-profile>
                    }
                  </div>
                </div>

                <!-- Wallet/Connection Selection (only if multiple connections) -->
                @if (getAllConnections().length > 1) {
                  <div class="wallet-selection">
                    <h4 i18n="@@wallet.select-connection">Select Wallet Connection</h4>
                    <mat-form-field appearance="outline" class="wallet-select-field">
                      <mat-label i18n="@@wallet.pay-from">Pay from</mat-label>
                      <mat-select [value]="selectedConnectionString()" (selectionChange)="selectConnection($event.value)">
                        @for (conn of getAllConnections(); track conn.connectionString) {
                          <mat-option [value]="conn.connectionString">
                            {{ conn.walletName }}
                          </mat-option>
                        }
                      </mat-select>
                    </mat-form-field>
                  </div>
                }

                <!-- Donation Amount Selection -->
                <div class="donation-amounts">
                  <h4 i18n="@@wallet.choose-amount">Choose Amount</h4>
                  <div class="amount-buttons">
                    <button mat-stroked-button [class.selected]="selectedDonationAmount() === 0.5"
                      (click)="selectDonationAmount(0.5)">
                      $0.50
                    </button>
                    <button mat-stroked-button [class.selected]="selectedDonationAmount() === 5"
                      (click)="selectDonationAmount(5)">
                      $5.00
                    </button>
                    <button mat-stroked-button
                      [class.selected]="selectedDonationAmount() === null && customDonationAmount.value"
                      (click)="selectCustomAmount()" i18n="@@wallet.custom">
                      Custom
                    </button>
                  </div>

                  @if (selectedDonationAmount() === null) {
                    <mat-form-field appearance="outline" class="custom-amount-field">
                      <mat-label i18n="@@wallet.custom-amount">Custom Amount (USD)</mat-label>
                      <span matPrefix>$&nbsp;</span>
                      <input matInput [formControl]="customDonationAmount" type="number" placeholder="Enter amount"
                        min="0.01" step="0.01" />
                      @if (customDonationAmount.hasError('min')) {
                        <mat-error i18n="@@wallet.min-amount-error">Minimum amount is $0.01</mat-error>
                      }
                    </mat-form-field>
                  }
                </div>

                @if (donationError()) {
                  <div class="donation-error">
                    <mat-icon>error</mat-icon>
                    <span>{{ donationError() }}</span>
                  </div>
                }

                @if (donationSuccess()) {
                  <div class="donation-success">
                    <mat-icon>check_circle</mat-icon>
                    <span i18n="@@wallet.donation.success">Thank you for your support!</span>
                  </div>
                }
              </div>
            </mat-card-content>

            <mat-card-actions>
              <button mat-flat-button (click)="donateWithSelectedWallet()"
                [disabled]="isDonating() || (!selectedDonationAmount() && !customDonationAmount.value) || (getAllConnections().length > 1 && !selectedConnectionString())">
                @if (isDonating()) {
                  <span i18n="@@wallet.processing">Processing...</span>
                } @else if (getDonationAmount()) {
                  <span i18n="@@wallet.donate-amount">Donate ${{ getDonationAmount()?.toFixed(2) }}</span>
                } @else {
                  <span i18n="@@wallet.select-amount">Select Amount</span>
                }
              </button>
            </mat-card-actions>
          </mat-card>
        } @else {
          <div class="empty-state">
            <mat-icon class="empty-icon">account_balance_wallet</mat-icon>
            <h2 i18n="@@wallet.empty.title">No Wallets Connected</h2>
            <p i18n="@@wallet.empty.description">Connect your first wallet to start sending and receiving payments.</p>
            <button mat-flat-button (click)="openAddWalletDialog()">
              <mat-icon>add</mat-icon>
              <span i18n="@@wallet.add-first-wallet">Add Your First Wallet</span>
            </button>
          </div>
        }
      </div>
    </mat-tab>

    <!-- Transactions Tab -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon>receipt_long</mat-icon>
        <span i18n="@@wallet.tab.transactions">Transactions</span>
      </ng-template>

      <div class="tab-content">
        @if (wallets.hasWallets()) {
          @if (isLoadingTransactions() && getAllTransactions().length === 0) {
            <div class="loading-state">
              <mat-spinner diameter="32"></mat-spinner>
              <span i18n="@@wallet.loading-transactions">Loading transactions...</span>
            </div>
          } @else if (getAllTransactions().length > 0) {
            <div class="transactions-list">
              @for (item of getAllTransactions(); track item.tx.payment_hash) {
                <div class="transaction-item" [class]="getTransactionClass(item.tx)">
                  <div class="tx-icon">
                    <mat-icon>{{ getTransactionIcon(item.tx) }}</mat-icon>
                  </div>
                  <div class="tx-details">
                    <span class="tx-description">{{ getTransactionDescription(item.tx) }}</span>
                    <span class="tx-meta">
                      <span class="tx-wallet">{{ item.walletName }}</span>
                      <span class="tx-separator">Â·</span>
                      <span class="tx-date">{{ formatTransactionDate(item.tx.created_at) | date:'short' }}</span>
                    </span>
                  </div>
                  <div class="tx-amount" [class]="getTransactionClass(item.tx)">
                    {{ formatTransactionAmount(item.tx) }}
                  </div>
                </div>
              }
            </div>
          } @else {
            <div class="empty-state">
              <mat-icon class="empty-icon">receipt_long</mat-icon>
              <h2 i18n="@@wallet.transactions.empty.title">No Transactions Yet</h2>
              <p i18n="@@wallet.transactions.empty.description">Your transaction history will appear here once you start sending or receiving payments.</p>
            </div>
          }
        } @else {
          <div class="empty-state">
            <mat-icon class="empty-icon">account_balance_wallet</mat-icon>
            <h2 i18n="@@wallet.transactions.no-wallet.title">No Wallet Connected</h2>
            <p i18n="@@wallet.transactions.no-wallet.description">Connect a wallet to view your transaction history.</p>
            <button mat-flat-button (click)="openAddWalletDialog()">
              <mat-icon>add</mat-icon>
              <span i18n="@@wallet.add-wallet">Add Wallet</span>
            </button>
          </div>
        }
      </div>
    </mat-tab>

    <!-- Zaps Tab -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon>bolt</mat-icon>
        <span i18n="@@wallet.tab.zaps">Zaps</span>
      </ng-template>

      <div class="tab-content">
        <div class="zaps-redirect">
          <mat-icon class="zaps-icon">bolt</mat-icon>
          <h2 i18n="@@wallet.zaps.title">Zap History</h2>
          <p i18n="@@wallet.zaps.description">View all your sent and received zaps in the dedicated Zaps page.</p>
          <button mat-flat-button routerLink="/zaps">
            <mat-icon>open_in_new</mat-icon>
            <span i18n="@@wallet.zaps.view-button">View Zap History</span>
          </button>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
