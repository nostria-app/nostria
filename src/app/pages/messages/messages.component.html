<div class="messages">
  @if (isLoading() && !selectedChat()) {
  <div class="loading-container">
    <app-loading-overlay message="Loading messages..."></app-loading-overlay>
    @if (encryption.pendingBunkerOperations() > 0) {
    <div class="remote-signer-status">
      <mat-icon class="rotating">sync</mat-icon>
      <span>Decrypting messages via remote signer... ({{ encryption.pendingBunkerOperations() }} remaining)</span>
      <p class="hint">This may take a few minutes for the initial load.</p>
    </div>
    }
    @if (encryption.isBunkerConnecting()) {
    <div class="remote-signer-status">
      <mat-icon class="rotating">sync</mat-icon>
      <span>Connecting to remote signer...</span>
    </div>
    }
  </div>
  } @else if (error()) {
  <div class="error-container">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ error() }}</p>
    <button mat-stroked-button color="primary" (click)="messaging.loadChats()">Try Again</button>
  </div>
  } @else {
  <div class="messages-left" [class.mobile-hidden]="layout.isHandset() && !showMobileList()">
    <div class="message-threads-header">
      <input class="chat-search-input" type="text" placeholder="Search chats..." [ngModel]="chatSearchQuery()"
        (ngModelChange)="chatSearchQuery.set($event)" />
      @if (chatSearchQuery()) {
      <button mat-icon-button class="clear-search-button" (click)="chatSearchQuery.set('')" aria-label="Clear search">
        <mat-icon>close</mat-icon>
      </button>
      }
      <div class="header-actions">
        <button mat-icon-button aria-label="New chat" (click)="startNewChat()" matTooltip="New chat">
          <mat-icon>edit</mat-icon>
        </button>
        @if (encryption.pendingBunkerOperations() > 0 || encryption.isBunkerConnecting()) {
        <button mat-icon-button
          [matTooltip]="encryption.isBunkerConnecting() ? 'Connecting to remote signer...' : 'Decrypting ' + encryption.pendingBunkerOperations() + ' messages via remote signer'"
          class="remote-signer-indicator">
          <mat-icon class="rotating">sync</mat-icon>
        </button>
        }
        <button mat-icon-button [matMenuTriggerFor]="chatSettingsMenu" aria-label="Chat settings">
          <mat-icon>settings</mat-icon>
        </button>
        <mat-menu #chatSettingsMenu="matMenu">
          <button mat-menu-item (click)="toggleShowHiddenChats()">
            <mat-icon>{{ showHiddenChats() ? 'visibility_off' : 'visibility' }}</mat-icon>
            <span>{{ showHiddenChats() ? 'Hide Hidden Chats' : 'Show Hidden Chats' }}</span>
          </button>
          <mat-divider></mat-divider>
          <button mat-menu-item (click)="markAllChatsAsRead()">
            <mat-icon>done_all</mat-icon>
            <span>Mark All as Read</span>
          </button>
          <button mat-menu-item (click)="resetLocalMessagesCache()">
            <mat-icon>delete_sweep</mat-icon>
            <span>Reset Messages Cache</span>
          </button>
        </mat-menu>
      </div>
    </div>
    <div class="message-threads" #messageThreads>
      @if (!hasChats()) {
      <div class="empty-chats">
        <mat-icon>forum</mat-icon>
        <p>No messages yet</p>
        <button mat-flat-button color="primary" (click)="startNewChat()">
          <mat-icon>add</mat-icon>
          Start a conversation
        </button>
      </div>
      } @else {
      <mat-tab-group [selectedIndex]="selectedTabIndex()" (selectedIndexChange)="onTabChange($event)" class="chat-tabs">
        <mat-tab label="Following">
          @if (hasFollowingChats()) {
          <div class="tab-content">
            <mat-nav-list class="chat-list">
              @for (item of followingChats(); track item.chat.id) {
              @let chat = item.chat;
              <a mat-list-item class="chat-item" [class.active]="selectedChat()?.id === chat.id"
                (click)="selectChat(chat)">
                <div class="chat-item-content">
                  <div class="chat-avatar">
                    @if (!chat.hasLegacyMessages) {
                    <mat-icon inline="true" class="chat-encryption-icon secure"
                      matTooltip="All messages use secure encryption (NIP-17)">verified_user</mat-icon>
                    } @else {
                    <mat-icon inline="true" class="chat-encryption-icon mixed"
                      matTooltip="Contains legacy messages (NIP-04)">shield</mat-icon>
                    }

                    <app-user-profile [pubkey]="chat.pubkey" view="icon" #profileComp>
                      <!-- {{ profileComp.profile() }} -->

                      <div class="chat-info">
                        <div class="chat-name-row">
                          <span class="chat-name">
                            @if (profileComp.profile()) {
                            {{ profileComp.profile().data | name }}
                            } @else {
                            Unknown
                            }
                          </span>
                          @if (chat.unreadCount > 0) {
                          <span class="unread-badge" matBadge="{{ chat.unreadCount }}" matBadgeOverlap="false"></span>
                          }
                          @if (chat.lastMessage?.created_at) {
                          <span class="message-time-chats">{{ chat.lastMessage?.created_at | ago }}</span>
                          }
                        </div>
                        <div class="chat-preview">
                          @if (chat.lastMessage) {
                          <span class="message-preview">
                            @if (chat.lastMessage.isOutgoing) {
                            <span class="outgoing-prefix">You: </span>
                            }
                            {{ chat.lastMessage.content }}
                          </span>
                          <!-- <span class="message-time">{{ chat.lastMessage?.created_at | ago }}</span> -->
                          } @else {
                          <span class="message-preview empty-message">New conversation</span>
                          }
                        </div>
                      </div>
                    </app-user-profile>
                  </div>
                </div>
              </a>
              }
            </mat-nav-list>

            <!-- Load more chats button for Following tab -->
            @if (messaging.hasMoreChats()) {
            <div class="load-more-chats">
              <button mat-stroked-button [disabled]="messaging.isLoadingMoreChats()" (click)="loadMoreChats()"
                class="load-more-chats-button">
                @if (messaging.isLoadingMoreChats()) {
                <mat-spinner diameter="20"></mat-spinner>
                <span>Loading...</span>
                } @else {
                <span>Load more conversations</span>
                }
              </button>
            </div>
            }
          </div>
          } @else {
          <div class="empty-tab-content">
            <mat-icon>people</mat-icon>
            <p>No messages from people you follow</p>
            <button mat-flat-button color="primary" (click)="startNewChat()">
              <mat-icon>add</mat-icon>
              Start a conversation
            </button>
          </div>
          }
        </mat-tab>

        <mat-tab label="Others">
          @if (hasOtherChats()) {
          <div class="tab-content">
            <mat-nav-list class="chat-list">
              @for (item of otherChats(); track item.chat.id) {
              @let chat = item.chat;
              <a mat-list-item class="chat-item" [class.active]="selectedChat()?.id === chat.id"
                (click)="selectChat(chat)">
                <div class="chat-item-content">
                  <div class="chat-avatar">
                    @if (!chat.hasLegacyMessages) {
                    <mat-icon inline="true" class="chat-encryption-icon secure"
                      matTooltip="All messages use secure encryption (NIP-17)">verified_user</mat-icon>
                    } @else {
                    <mat-icon inline="true" class="chat-encryption-icon mixed"
                      matTooltip="Contains legacy messages (NIP-04)">shield</mat-icon>
                    }

                    <app-user-profile [pubkey]="chat.pubkey" view="icon" #otherProfileComp>
                      <div class="chat-info">
                        <div class="chat-name-row">
                          <span class="chat-name">
                            @if (otherProfileComp.profile()) {
                            {{ otherProfileComp.profile().data | name }}
                            } @else {
                            Unknown
                            }
                          </span>
                          @if (chat.unreadCount > 0) {
                          <span class="unread-badge" matBadge="{{ chat.unreadCount }}" matBadgeOverlap="false"></span>
                          }
                          @if (chat.lastMessage?.created_at) {
                          <span class="message-time-chats">{{ chat.lastMessage?.created_at | ago }}</span>
                          }
                        </div>
                        <div class="chat-preview">
                          @if (chat.lastMessage) {
                          <span class="message-preview">
                            @if (chat.lastMessage.isOutgoing) {
                            <span class="outgoing-prefix">You: </span>
                            }
                            {{ chat.lastMessage.content }}
                          </span>
                          } @else {
                          <span class="message-preview empty-message">New conversation</span>
                          }
                        </div>
                      </div>
                    </app-user-profile>
                  </div>
                </div>
              </a>
              }
            </mat-nav-list>

            <!-- Load more chats button for Others tab -->
            @if (messaging.hasMoreChats()) {
            <div class="load-more-chats">
              <button mat-stroked-button [disabled]="messaging.isLoadingMoreChats()" (click)="loadMoreChats()"
                class="load-more-chats-button">
                @if (messaging.isLoadingMoreChats()) {
                <mat-spinner diameter="20"></mat-spinner>
                <span>Loading...</span>
                } @else {
                <span>Load more conversations</span>
                }
              </button>
            </div>
            }
          </div>
          } @else {
          <div class="empty-tab-content">
            <mat-icon>forum</mat-icon>
            <p>No messages from others</p>
            <button mat-flat-button color="primary" (click)="startNewChat()">
              <mat-icon>add</mat-icon>
              Start a conversation
            </button>
          </div>
          }
        </mat-tab>
      </mat-tab-group>
      }
    </div>
  </div>
  <div class="messages-right" [class.mobile-hidden]="layout.isHandset() && showMobileList()"
    [class.sidepanel-open]="showChatDetails()">
    @if (!selectedChat()) {
    <div class="no-chat-selected">
      <h2>Select a message</h2>
      <p>Choose from your existing conversations or start a new one.</p>
      <button mat-flat-button (click)="startNewChat()">
        New message
      </button>
    </div>
    } @else {
    <div class="chat-content-wrapper">
      <div class="message-list-header">
        <div class="chat-header-user">
          @if (layout.isHandset() && !showMobileList()) {
          <button mat-icon-button class="back-button" (click)="backToList()">
            <mat-icon>arrow_back</mat-icon>
          </button>
          }
          <app-user-profile [pubkey]="selectedChat()!.pubkey" view="thread"></app-user-profile>
        </div>
        <div class="chat-header-actions">
          <button mat-icon-button (click)="toggleChatDetails()" matTooltip="Chat details">
            <mat-icon>info</mat-icon>
          </button>
          <button mat-icon-button [matMenuTriggerFor]="chatOptionsMenu" matTooltip="More options">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #chatOptionsMenu="matMenu">
            <button mat-menu-item (click)="viewProfile()">
              <mat-icon>person</mat-icon>
              <span>View Profile</span>
            </button>
            @if (isSelectedChatHidden()) {
            <button mat-menu-item (click)="unhideChat()">
              <mat-icon>visibility</mat-icon>
              <span>Unhide Chat</span>
            </button>
            } @else {
            <button mat-menu-item (click)="hideChat()">
              <mat-icon>visibility_off</mat-icon>
              <span>Hide Chat</span>
            </button>
            }
          </mat-menu>
        </div>
      </div>

      <div class="message-list" #messagesWrapper>
        <router-outlet></router-outlet>

        @if (hasMoreMessages() && !isLoadingMore()) {
        <div class="load-more-indicator">
          <p class="load-more-hint">Scroll up to load older messages</p>
          <button mat-button (click)="loadMoreMessages()">
            <mat-icon>expand_less</mat-icon>
            Load older messages
          </button>
        </div>
        }

        @if (isLoadingMore()) {
        <div class="loading-more-indicator">
          <mat-spinner diameter="24"></mat-spinner>
          <p>Loading older messages...</p>
        </div>
        }

        @for (group of groupedMessages(); track group.dateTimestamp) {
        <div class="date-header">
          <span class="date-label">{{ group.dateLabel }}</span>
        </div>
        @for (message of group.messages; track message.id) {
        <div class="message-bubble-container" [class.outgoing]="message.isOutgoing">
          <div class="message-bubble" [class.outgoing]="message.isOutgoing" [class.pending]="message.pending"
            [class.failed]="message.failed">
            <span class="message-content" [innerHTML]="message.content | linkify"></span>
            <span class="message-inline-meta">
              <!-- Encryption status indicator -->
              @if (message.encryptionType === 'nip44') {
              <mat-icon class="encryption-icon secure" matTooltip="Secure (NIP-17)">verified_user</mat-icon>
              } @else {
              <mat-icon class="encryption-icon insecure" matTooltip="Legacy encryption (NIP-04)">block</mat-icon>
              }
              @if (message.pending) {
              <mat-spinner diameter="10" class="pending-spinner"></mat-spinner>
              } @else if (message.failed) {
              <mat-icon class="status-icon failed-icon">error_outline</mat-icon>
              } @else if (message.isOutgoing && message.read) {
              <mat-icon class="status-icon read-icon">done_all</mat-icon>
              } @else if (message.isOutgoing && message.received) {
              <mat-icon class="status-icon received-icon">done</mat-icon>
              }
            </span>
          </div>
          <span class="message-time-side">{{ formatMessageTime(message.created_at) }}</span>

          @if (message.failed) {
          <div class="message-actions">
            <button mat-icon-button class="retry-button" (click)="retryMessage(message)">
              <mat-icon>refresh</mat-icon>
            </button>
          </div>
          }
        </div>
        }
        }
      </div>
      <div class="message-input-container">
        <input #messageInput class="message-input" [ngModel]="newMessageText()"
          (ngModelChange)="newMessageText.set($event)" placeholder="Your message" [disabled]="isSending()"
          (keyup.enter)="sendMessage()" />
        @if (isVoiceListening()) {
        <button mat-icon-button type="button" class="voice-button recording" (click)="stopVoiceRecording()"
          [disabled]="isSending()" matTooltip="Stop recording">
          <mat-icon class="pulse-icon">stop</mat-icon>
        </button>
        } @else {
        <button mat-icon-button type="button" class="voice-button" (click)="startVoiceInput()"
          [disabled]="isVoiceTranscribing() || isSending()" matTooltip="Voice input">
          @if (isVoiceTranscribing()) {
          <mat-icon class="spinning-icon">sync</mat-icon>
          } @else {
          <mat-icon>mic</mat-icon>
          }
        </button>
        }
        <button mat-icon-button type="button" class="send-button" [disabled]="!newMessageText().trim() || isSending()"
          (click)="sendMessage()" matTooltip="Send message">
          @if (isSending()) {
          <mat-spinner diameter="24"></mat-spinner>
          } @else {
          <mat-icon>send</mat-icon>
          }
        </button>
      </div>
    </div>

    <!-- Chat Details Sidepanel -->
    @if (showChatDetails()) {
    <div class="chat-details-panel">
      <div class="chat-details-header">
        <h3>Chat Details</h3>
        <button mat-icon-button (click)="closeChatDetails()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="chat-details-content">
        <!-- Chat Stats -->
        <div class="chat-stats-section">
          <div class="stat-item">
            <mat-icon>chat</mat-icon>
            <div class="stat-info">
              <span class="stat-value">{{ chatMessageCount() }}</span>
              <span class="stat-label">Messages</span>
            </div>
          </div>
          @if (chatStartDate(); as startDate) {
          <div class="stat-item">
            <mat-icon>event</mat-icon>
            <div class="stat-info">
              <span class="stat-value">{{ startDate | timestamp }}</span>
              <span class="stat-label">Chat Started</span>
            </div>
          </div>
          }
        </div>

        <!-- Shared Links -->
        @if (sharedLinks().length > 0) {
        <div class="chat-section">
          <div class="section-header">
            <mat-icon>link</mat-icon>
            <span>Shared Links</span>
            <span class="section-count">{{ sharedLinks().length }}</span>
          </div>
          <div class="shared-links-list">
            @for (link of sharedLinks().slice(0, 10); track link.url + link.timestamp) {
            <a class="shared-link-item" [href]="link.url" target="_blank" rel="noopener noreferrer">
              <mat-icon class="link-icon">open_in_new</mat-icon>
              <span class="link-text">{{ getDisplayUrl(link.url) }}</span>
            </a>
            }
            @if (sharedLinks().length > 10) {
            <div class="see-all-hint">+ {{ sharedLinks().length - 10 }} more links</div>
            }
          </div>
        </div>
        }

        <!-- Shared Files -->
        @if (sharedFiles().length > 0) {
        <div class="chat-section">
          <div class="section-header">
            <mat-icon>attach_file</mat-icon>
            <span>Shared Files</span>
            <span class="section-count">{{ sharedFiles().length }}</span>
          </div>
          <div class="shared-links-list">
            @for (file of sharedFiles().slice(0, 10); track file.url + file.timestamp) {
            <a class="shared-link-item" [href]="file.url" target="_blank" rel="noopener noreferrer">
              <mat-icon class="link-icon">description</mat-icon>
              <span class="link-text">{{ getDisplayUrl(file.url) }}</span>
            </a>
            }
            @if (sharedFiles().length > 10) {
            <div class="see-all-hint">+ {{ sharedFiles().length - 10 }} more files</div>
            }
          </div>
        </div>
        }

        <!-- Shared Media -->
        @if (sharedMedia().length > 0) {
        <div class="chat-section">
          <div class="section-header">
            <mat-icon>photo_library</mat-icon>
            <span>Shared Media</span>
            <span class="section-count">{{ sharedMedia().length }}</span>
          </div>
          <div class="shared-links-list">
            @for (media of sharedMedia().slice(0, 10); track media.url + media.timestamp) {
            <a class="shared-link-item" [href]="media.url" target="_blank" rel="noopener noreferrer">
              <mat-icon class="link-icon">image</mat-icon>
              <span class="link-text">{{ getDisplayUrl(media.url) }}</span>
            </a>
            }
            @if (sharedMedia().length > 10) {
            <div class="see-all-hint">+ {{ sharedMedia().length - 10 }} more media</div>
            }
          </div>
        </div>
        }

        @if (sharedLinks().length === 0 && sharedFiles().length === 0 && sharedMedia().length === 0) {
        <div class="empty-details">
          <mat-icon>folder_open</mat-icon>
          <p>No shared content yet</p>
        </div>
        }
      </div>
    </div>
    }
    }
  </div>
  }
</div>