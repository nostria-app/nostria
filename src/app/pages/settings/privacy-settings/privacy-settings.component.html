<div class="panel-header">
  <button mat-icon-button (click)="goBack()" matTooltip="Back" i18n-matTooltip="@@common.back">
    <mat-icon>arrow_back</mat-icon>
  </button>
  <h2 class="panel-title title-font" i18n="@@settings.sections.privacy">Privacy & Safety</h2>
  <span class="panel-header-spacer"></span>
</div>

<div class="content-medium">
  <section class="sharing-section">
    <h3 i18n="@@settings.privacy.url.title">URL Privacy</h3>
    <div class="settings-option">
      <mat-checkbox [checked]="localSettingsService.removeTrackingParameters()"
        (change)="toggleRemoveTrackingParameters()">
        <span i18n="@@settings.privacy.url.remove-tracking">Remove tracking parameters from pasted URLs</span>
      </mat-checkbox>
      <app-info-tooltip [content]="trackingRemovalInfoContent"
        ariaLabel="Learn about URL tracking parameter removal"></app-info-tooltip>
    </div>
  </section>

  <mat-divider></mat-divider>

  <section class="sharing-section">
    <h3 i18n="@@settings.privacy.image-cache.title">Image Cache Service</h3>
    <div class="settings-option">
      <mat-checkbox [checked]="settingsService.settings().imageCacheEnabled" (change)="toggleImageCache()">
        <span i18n="@@settings.privacy.image-cache.enable">Enable image cache</span>
      </mat-checkbox>
      <app-info-tooltip [content]="imageCacheInfoContent"
        ariaLabel="Learn about image cache service"></app-info-tooltip>
    </div>

    <div class="settings-option">
      <mat-checkbox [checked]="settingsService.settings().googleFaviconEnabled" (change)="toggleGoogleFavicon()">
        <span i18n="@@settings.privacy.google-favicon.enable">Enable Google API for favicons</span>
      </mat-checkbox>
    </div>

    @if (settingsService.settings().imageCacheEnabled) {
    <div class="cache-actions">
      <button mat-raised-button color="warn" (click)="clearImageCache()">
        <mat-icon>delete</mat-icon>
        <span i18n="@@settings.privacy.image-cache.clear">Clear Cache</span>
      </button>
    </div>
    }
  </section>

  <section class="sharing-section">
    <h3 i18n="@@settings.privacy.social-sharing.title">Social Sharing Options</h3>
    <div class="settings-option">
      <mat-checkbox [checked]="settingsService.settings().socialSharingPreview" (change)="toggleSocialSharingPreview()">
        <span i18n="@@settings.privacy.social-sharing.enable">Enable social sharing preview</span>
      </mat-checkbox>
      <app-info-tooltip [content]="socialSharingInfoContent"
        ariaLabel="Learn about social sharing preview"></app-info-tooltip>
    </div>
  </section>

  <mat-divider></mat-divider>

  <section class="report-settings-section">
    <h3 i18n="@@settings.privacy.reported.title">Reported Content Settings</h3>
    <p class="section-description" i18n="@@settings.privacy.reported.description">
      Choose which types of reported content to automatically hide. When content is hidden, you can
      still choose to reveal it.
    </p>

    @for (reportType of reportTypes; track reportType.key) {
    <div class="settings-option">
      <mat-checkbox [checked]="isReportTypeHidden(reportType.key)"
        (change)="toggleReportTypeVisibility(reportType.key)">
        <div class="report-type-option">
          <mat-icon [fontIcon]="reportType.icon"></mat-icon>
          <span>Hide {{ reportType.label }}</span>
        </div>
      </mat-checkbox>
    </div>
    }
  </section>

  <mat-divider></mat-divider>

  <section class="mute-section">
    <h3 i18n="@@settings.privacy.blocked.title">Blocked Accounts</h3>
    <div class="muted-section">
      @if (mutedAccounts().length > 0) {
      <mat-list>
        @for (pubkey of mutedAccounts(); track pubkey) {
        <mat-list-item>
          <span matListItemTitle>
            <app-user-profile [pubkey]="pubkey" view="compact"></app-user-profile>
          </span>
          <button mat-icon-button (click)="removeMutedItem('account', pubkey); $event.stopPropagation()"
            matListItemMeta>
            <mat-icon>close</mat-icon>
          </button>
        </mat-list-item>
        }
      </mat-list>
      } @else {
      <p class="empty-state" i18n="@@settings.privacy.blocked.empty">No blocked accounts.</p>
      }
    </div>
  </section>

  <section class="mute-section">
    <h3 i18n="@@settings.privacy.muted-words.title">Muted Words</h3>
    <div class="add-mute-item">
      <mat-form-field appearance="outline">
        <mat-label i18n="@@settings.privacy.muted-words.add-label">Add word to mute</mat-label>
        <input matInput [(ngModel)]="newMutedWord" (keyup.enter)="addMutedWord()" placeholder="Enter word">
      </mat-form-field>
      <button mat-flat-button (click)="addMutedWord()" [disabled]="!newMutedWord.trim()">
        <mat-icon>add</mat-icon>
        <span i18n="@@settings.privacy.muted-words.add-button">Add</span>
      </button>
    </div>
    <div class="muted-section">
      @if (mutedWords().length > 0) {
      <mat-list>
        @for (word of mutedWords(); track $index) {
        <mat-list-item>
          <span matListItemTitle>{{ word }}</span>
          <button mat-icon-button (click)="removeMutedItem('word', word); $event.stopPropagation()" matListItemMeta>
            <mat-icon>close</mat-icon>
          </button>
        </mat-list-item>
        <mat-divider></mat-divider>
        }
      </mat-list>
      } @else {
      <p class="empty-state" i18n="@@settings.privacy.muted-words.empty">No muted words.</p>
      }
    </div>
  </section>

  <section class="mute-section">
    <h3 i18n="@@settings.privacy.muted-tags.title">Muted Tags</h3>
    <div class="add-mute-item">
      <mat-form-field appearance="outline">
        <mat-label i18n="@@settings.privacy.muted-tags.add-label">Add tag to mute</mat-label>
        <input matInput [(ngModel)]="newMutedTag" (keyup.enter)="addMutedTag()" placeholder="Enter tag (without #)">
        <span matTextPrefix>#</span>
      </mat-form-field>
      <button mat-flat-button (click)="addMutedTag()" [disabled]="!newMutedTag.trim()">
        <mat-icon>add</mat-icon>
        <span i18n="@@settings.privacy.muted-tags.add-button">Add</span>
      </button>
    </div>
    <div class="muted-section">
      @if (mutedTags().length > 0) {
      <mat-list>
        @for (tag of mutedTags(); track $index) {
        <mat-list-item>
          <span matListItemTitle>#{{ tag }}</span>
          <button mat-icon-button (click)="removeMutedItem('tag', tag); $event.stopPropagation()" matListItemMeta>
            <mat-icon>close</mat-icon>
          </button>
        </mat-list-item>
        <mat-divider></mat-divider>
        }
      </mat-list>
      } @else {
      <p class="empty-state" i18n="@@settings.privacy.muted-tags.empty">No muted tags.</p>
      }
    </div>
  </section>

  <section class="mute-section">
    <h3 i18n="@@settings.privacy.muted-threads.title">Muted Threads</h3>
    <div class="muted-section">
      @if (mutedThreads().length > 0) {
      <mat-list>
        @for (thread of mutedThreads(); track $index) {
        <mat-list-item>
          <span matListItemTitle>{{ thread }}</span>
          <button mat-icon-button (click)="removeMutedItem('thread', thread); $event.stopPropagation()" matListItemMeta>
            <mat-icon>close</mat-icon>
          </button>
        </mat-list-item>
        <mat-divider></mat-divider>
        }
      </mat-list>
      } @else {
      <p class="empty-state" i18n="@@settings.privacy.muted-threads.empty">No muted threads.</p>
      }
    </div>
  </section>

  <section class="mute-section">
    <h3>Trusted Media Authors</h3>
    <p class="section-description">
      Users whose media content (photos and videos) will always be shown without blur, even if they are not in your
      following list.
    </p>
    <div class="muted-section">
      @if (trustedMediaAuthors().length > 0) {
      <mat-list>
        @for (pubkey of trustedMediaAuthors(); track pubkey) {
        <mat-list-item>
          <span matListItemTitle>
            <app-user-profile [pubkey]="pubkey" view="compact"></app-user-profile>
          </span>
          <button mat-icon-button (click)="removeTrustedMediaAuthor(pubkey); $event.stopPropagation()" matListItemMeta
            matTooltip="Remove from trusted media authors">
            <mat-icon>close</mat-icon>
          </button>
        </mat-list-item>
        }
      </mat-list>
      } @else {
      <p class="empty-state">No trusted media authors. When viewing blurred media, you can choose "Always reveal this
        user" to add them here.</p>
      }
    </div>
  </section>

  <mat-divider></mat-divider>

  <section class="delete-section">
    <h3 i18n="@@settings.privacy.event-management.title">Event Management</h3>
    <p class="section-description" i18n="@@settings.privacy.event-management.description">
      Manage and delete events you've published on Nostr.
    </p>
    <div class="delete-actions">
      <button mat-raised-button color="primary" (click)="navigateToDeleteEventPage()">
        <mat-icon>delete_outline</mat-icon>
        <span i18n="@@settings.privacy.event-management.delete-event">Delete Specific Event</span>
      </button>
      <button mat-raised-button color="warn" (click)="navigateToDeleteAccountPage()">
        <mat-icon>delete_forever</mat-icon>
        <span i18n="@@settings.privacy.event-management.delete-account">Delete All Account Data</span>
      </button>
    </div>
  </section>

  <!-- Template definitions for tooltip content -->
  <ng-template #trackingRemovalInfoContent>
    <mat-card-header>
      <mat-card-title>
        <div class="info-title">
          <mat-icon class="info-icon">link_off</mat-icon>
          <span i18n="@@settings.privacy.info.tracking.title">URL Tracking Parameter Removal</span>
        </div>
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <p i18n="@@settings.privacy.info.tracking.p1">
        When enabled, tracking parameters are automatically removed from URLs you paste.
      </p>
      <p i18n="@@settings.privacy.info.tracking.p2">
        This removes parameters like utm_*, fbclid, gclid, and other tracking codes used by
        YouTube, Twitter/X, Facebook, and other platforms to track your activity across the web.
      </p>
      <p i18n="@@settings.privacy.info.tracking.p3">
        Disable if you need to preserve all URL parameters, though this may reduce your privacy.
      </p>
    </mat-card-content>
  </ng-template>

  <ng-template #imageCacheInfoContent>
    <mat-card-header>
      <mat-card-title>
        <div class="info-title">
          <mat-icon class="info-icon">cached</mat-icon>
          <span i18n="@@settings.privacy.info.image-cache.title">Image Cache Service</span>
        </div>
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <p i18n="@@settings.privacy.info.image-cache.p1">
        When enabled, profile images and other images are optimized and cached using Angular Service
        Worker for improved loading times and offline availability.
      </p>
      <p i18n="@@settings.privacy.info.image-cache.p2">
        Images are cached for up to 7 days and automatically managed. This reduces bandwidth usage
        and improves performance, especially on slower connections.
      </p>
      <p i18n="@@settings.privacy.info.image-cache.p3">
        Disable if you want to ensure images are always loaded directly from the source, which will
        increase bandwidth usage and loading times.
      </p>
    </mat-card-content>
  </ng-template>

  <ng-template #socialSharingInfoContent>
    <mat-card-header>
      <mat-card-title>
        <div class="info-title">
          <mat-icon class="info-icon">share</mat-icon>
          <span i18n="@@settings.privacy.info.social.title">Social Sharing Preview</span>
        </div>
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <p i18n="@@settings.privacy.info.social.description">When enabled, content previews will be shown for external
        links shared in posts.</p>
    </mat-card-content>
  </ng-template>
</div>