# Fix: Mention Hover Tooltip Issue

## Problem

Hovering over @mentions in posts was not showing the profile hover tooltip, even though the feature was implemented.

## Root Cause

The application renders mentions in two different ways:

1. **Template-based rendering**: Regular notes/posts use Angular templates with the `NoteContentComponent`
2. **innerHTML rendering**: Articles and markdown content use `[innerHTML]` binding with HTML generated by `FormatService`

The initial implementation only added hover event handlers to the template-based approach. However, Angular **cannot bind events to content rendered through `[innerHTML]`** for security reasons (XSS prevention).

When viewing articles or any content using `[innerHTML]`, the mention links were rendered as plain HTML:
```html
<a href="/p/${npub}" class="nostr-mention" data-pubkey="${pubkey}">@username</a>
```

Without event listeners, hovering did nothing.

## Solution

Created a **dual approach** to handle both rendering methods:

### 1. Template-Based (Already Implemented)

For `NoteContentComponent` where mentions are rendered through Angular templates:
- Added `(mouseenter)` and `(mouseleave)` event bindings directly in template
- Handlers call `onMentionMouseEnter()` and `onMentionMouseLeave()` methods

### 2. Directive-Based (New Implementation)

Created `MentionHoverDirective` (`src/app/directives/mention-hover.directive.ts`) for content rendered via `[innerHTML]`:

**Key Features:**
- **Event Delegation**: Attaches listeners at container level using capture phase
- **Dynamic Element Detection**: Traverses DOM to find `.nostr-mention` elements
- **Data Attribute Reading**: Extracts `data-pubkey` and `data-type` from HTML
- **Shared Logic**: Uses same overlay positioning and state management as template approach

**Usage:**
```html
<div class="markdown-content" [innerHTML]="parsedContent()" appMentionHover></div>
```

## Files Modified

1. **Created:**
   - `src/app/directives/mention-hover.directive.ts` - New directive for innerHTML content

2. **Updated:**
   - `src/app/pages/article/article.component.html` - Added `appMentionHover` directive
   - `src/app/pages/article/article.component.ts` - Imported directive
   - `src/app/components/event-types/article-event.component.html` - Added `appMentionHover` directive
   - `src/app/components/event-types/article-event.component.ts` - Imported directive
   - `src/app/components/content/note-content/note-content.component.html` - Improved formatting
   - `docs/MENTION_HOVER_TOOLTIP.md` - Updated documentation

## How the Directive Works

1. **Attachment**: Directive is added to container elements that use `[innerHTML]`
2. **Event Capture**: Listens for mouseenter/mouseleave at container level with `{ capture: true }`
3. **Element Detection**: When event fires, `findMentionLink()` traverses DOM hierarchy to find parent with `.nostr-mention` class
4. **Validation**: Checks `data-type="profile"` and `data-pubkey` attributes
5. **Hover Card**: Shows profile hover card using same CDK Overlay logic as other components
6. **State Tracking**: Maintains separate state from template-based approach
7. **Cleanup**: Removes event listeners in `ngOnDestroy()`

## Coverage

Mention hover tooltips now work in:

✅ User profile components (original implementation)  
✅ Regular notes/posts rendered through templates  
✅ Article pages rendered through innerHTML  
✅ Article preview cards rendered through innerHTML  
✅ Any future content using innerHTML with `.nostr-mention` links

## Testing

To verify the fix:

1. **Regular Notes**: Hover over @mentions in standard posts - tooltip should appear
2. **Articles**: Open any article, hover over @mentions in content - tooltip should appear
3. **Article Cards**: View article previews in feed, hover mentions - tooltip should appear
4. **Context Menu**: Click menu button in tooltip, verify it stays open
5. **Transitions**: Hover from mention to card and back - should remain open

## Technical Details

**Why Event Delegation?**
- innerHTML creates new DOM elements after Angular's change detection
- Direct event binding won't work on dynamically created elements
- Event delegation attaches listener to parent that exists during component initialization
- Capture phase ensures we intercept events before they reach dynamic children

**Why Capture Phase?**
```typescript
this.el.nativeElement.addEventListener('mouseenter', handler, true); // true = capture phase
```
- Capture phase travels from root to target (top-down)
- Bubble phase travels from target to root (bottom-up)
- Using capture ensures we catch events before any child handlers

**Security Note:**
- Directive only reads existing data attributes
- Doesn't inject any new content
- Same security model as clicking the mention link
- Profile hover card is the same trusted component used elsewhere

## Future Considerations

If more components need mention hover tooltips:
1. Import `MentionHoverDirective`
2. Add to component's `imports` array
3. Add `appMentionHover` to the element with `[innerHTML]`

No additional code needed - the directive is fully self-contained and reusable.
